<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>é€±é–“æ‰‹è¡“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</title>
  <style>
    :root{--slot-h:28px;--gap:0}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN','Meiryo',sans-serif}
    .topbar{display:flex;flex-wrap:wrap;justify-content:space-between;gap:8px;padding:8px 12px;border-bottom:1px solid #ddd;position:sticky;top:0;background:#fff;z-index:5}
    .group{display:flex;gap:8px;align-items:center}
    button{padding:6px 10px;border:1px solid #bbb;background:#fff;border-radius:6px;cursor:pointer}
    button.primary{background:#2563eb;color:#fff;border-color:#1e40af}
    .icon-btn{background:transparent!important;border:none!important;padding:0!important;margin-left:6px;font-size:14px;cursor:pointer}
    .icon-btn:hover{opacity:.8}
    #schedule{padding:12px;display:grid;grid-template-columns:1fr 1fr;column-gap:16px;row-gap:0}
    .column{display:flex;flex-direction:column;row-gap:16px}
    .day{border:2px solid #000;background:#fff;position:relative}
    .day-header{display:flex;align-items:center;justify-content:space-between;gap:12px;min-height:32px;padding:4px 8px;background:#f7f7f7;border-bottom:1px solid #ddd;font-weight:700}
    .day-header-date{white-space:nowrap}
    .day-note-inline{flex:1 1 auto;display:flex;justify-content:flex-end;min-width:0}
    .day-note-input{width:100%;min-width:0;height:auto;line-height:1.4;padding:6px 8px;border:1px solid #d1d5db;border-radius:6px;font-size:13px;outline:none;white-space:pre-wrap;word-break:break-word;overflow:auto;resize:none;min-height:2.8em;max-height:2.8em}
    .day-note-input:focus{border-color:#2563eb;box-shadow:0 0 0 1px rgba(37,99,235,.2)}
    .section-title{margin:0;padding:2px 6px;font-size:12px;font-weight:600;border-top:1px solid #999;border-bottom:1px solid #999;background:#f8f8f8;display:flex;align-items:center}
.slots{
  display:grid;
  /* â˜… æœ€ä½é«˜ã•ã¯ --slot-hã€å¿…è¦ãªã‚‰ä¸­èº«ã«åˆã‚ã›ã¦ä¼¸ã³ã‚‹ */
  grid-auto-rows:minmax(var(--slot-h), auto);
  row-gap:var(--gap);
  padding:0;
  position:relative;
}
.slot{
  border-top:1px solid #d0d5dd;
  padding:3px 5px;
  background:#fff;
  display:grid;
  grid-template-columns:46px 1fr;  /* â† ã“ã“ãŒåŠ¹ã„ã¦ã„ã‚‹ */
  gap:6px;
  align-items:start;
  cursor:grab;
  position:relative;
}    .slot.empty{opacity:.8;background:#fbfbfb}
	    /* â˜… RLã‚»ãƒƒãƒˆç”¨ï¼šå·¦ç«¯ã®ç´°ã„ç¸¦ãƒãƒ¼ */
    .slot.rl-set-slot::before{
      content:"";
      position:absolute;
      left:1px;              /* æ ã®ä¸€ç•ªå·¦ã«å¯„ã›ã‚‹ */
      top:0;                 /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ä¸Šä¸‹ã„ã£ã±ã„ã«ä¼¸ã°ã™ */
      bottom:0;
      width:3px;             /* ç´°ã„ãƒãƒ¼ */
      border-radius:0;       /* â† è§’ã®ä¸¸ã¿ã‚’ãªãã™ */
      background:#94a3b8;    /* ã»ã‚“ã®ã‚Šã‚°ãƒ¬ãƒ¼å¯„ã‚Šã®è‰²ï¼ˆä»–ã¨ã‚±ãƒ³ã‚«ã—ã«ãã„ï¼‰ */
      opacity:0.9;
      pointer-events:none;   /* ã‚¯ãƒªãƒƒã‚¯åˆ¤å®šã«ã¯å¹²æ¸‰ã—ãªã„ */
    }
    /* ã‚»ãƒƒãƒˆã®ä¸€ç•ªä¸Šã ã‘ã€ä¸Šå´ã«å°‘ã—éš™é–“ã‚’ç©ºã‘ã‚‹ */
    .slot.rl-set-top::before{
      border-top-left-radius:999px;
      border-top-right-radius:999px;
      top:4px;               /* ä¸Šã« 4px ã®ä½™ç™½ â†’ ä¸Šã®æ ã¨ã¯åˆ‡ã‚Œã‚‹ */
    }
    /* ã‚»ãƒƒãƒˆã®ä¸€ç•ªä¸‹ã ã‘ã€ä¸‹å´ã«å°‘ã—éš™é–“ã‚’ç©ºã‘ã‚‹ */
    .slot.rl-set-bottom::before{
      border-bottom-left-radius:999px;
      border-bottom-right-radius:999px;
      bottom:4px;            /* ä¸‹ã« 4px ã®ä½™ç™½ â†’ ä¸‹ã®æ ã¨ã¯åˆ‡ã‚Œã‚‹ */
    }

.time{
   font-weight:700;
   text-align:left;
   padding:0 18px 0 0px;   /* å³å´ã«âœ“ç”¨ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ */
   user-select:none;
   cursor:pointer;
   position: relative;          /* â† è¿½åŠ ï¼ˆåŸºæº–ç‚¹ï¼‰ */
}
    .content{display:flex;align-items:center;justify-content:space-between;gap:6px;font-size:13px}
    .content-left{flex:1 1 auto;min-width:0;padding-right:52px}
    .surgeon-tag{position:absolute;top:4px;right:6px;white-space:nowrap;font-weight:600;padding:2px 6px;border:1px solid #1e3a8a;border-radius:10px;font-size:12px}
    .slot.empty .surgeon-tag{display:none}

    /* arrival âœ“ï¼ˆè¡¨ç¤ºå°‚ç”¨ï¼‰ï¼šæ™‚åˆ»ã®å³æ¨ª */
    .arrival-check{
      font-size:15px;       /* å°ã•ã‚ */
      font-weight:700;
      opacity:.8;
      pointer-events:none;  /* â† Step1ï¼šæ“ä½œä¸å¯ */
      user-select:none;
	  color: #16a34a;
	  position: absolute;
	  right: 0px;
	  top: 0.6em;           /* â† ã“ã“ãŒè‚ï¼šæ™‚åˆ»ãƒ†ã‚­ã‚¹ãƒˆã®è¡Œã«è¿½å¾“ */
	  transform: translateY(-50%);
	  width: 8px;           /* æ¨ªã‚ºãƒ¬ï¼†é‡ãªã‚Šé˜²æ­¢ï¼ˆã‚»ãƒ³ã‚¿ãƒªãƒ³ã‚°æ ï¼‰ */
      text-align: center;  
    }
/* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—å…±é€šï¼ˆâœ“ã®è–„ã•ã¨ç„¡é–¢ä¿‚ã«ã™ã‚‹ï¼‰ */
.arrival-check::after{
  content: "æ™‚åˆ»é€£çµ¡æ¸ˆ";
  position: absolute;
  left: calc(110% + 4px);
  top: 50%;
  transform: translateY(-50%);
  white-space: nowrap;
  background: #111827;
  color: #fff;
  font-size: 11px;
  padding: 4px 6px;
  border-radius: 6px;

  opacity: 0;              /* åˆæœŸã¯éè¡¨ç¤º */
  pointer-events: none;
  transition: opacity .15s;
}

/* arrivalãƒ¢ãƒ¼ãƒ‰ä¸­ï¼šhover ã§å¿…ãšé€šå¸¸è¡¨ç¤º */
body.arrivalModeOn .arrival-check:hover::after{
  opacity: 1;              /* â† ã“ã“ã¯å¸¸ã«1 */
}

/* OFFæ™‚ã®æ–‡è¨€ã ã‘åˆ‡æ›¿ï¼ˆè¡¨ç¤ºã®æ¿ƒã•ã¯å¤‰ãˆãªã„ï¼‰ */
.arrival-check.is-off::after{
  content: "æ™‚åˆ»é€£çµ¡ãªã—";
}	

/* âœ“ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ä¸­ã ã‘ âœ“ ã‚’æ“ä½œå¯èƒ½ã«ã™ã‚‹ */
body.arrivalModeOn .arrival-check{
  pointer-events:auto;
  cursor:pointer;
}
	
 /* ===== arrival âœ“ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼ˆStep2: éª¨çµ„ã¿ï¼‰ ===== */
 #arrivalModeBanner{
   position: fixed;
   top: 56px;              /* topbarã®ä¸‹ */
   left: 12px;
   z-index: 2000;
   padding: 6px 10px;
   border: 1px solid #e5e7eb;
   background: rgba(255,255,255,.98);
   border-radius: 10px;
   box-shadow: 0 2px 10px rgba(0,0,0,.10);
   font-size: 12px;
   display: none;
 }
 body.arrivalModeOn #arrivalModeBanner{ display: block; }

 /* ãƒ¢ãƒ¼ãƒ‰ONä¸­ï¼šâœ“ä»¥å¤–ã®æ“ä½œã‚’ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆStep2ã§ã¯ã€Œè§¦ã‚Œãªã„ã€ã‚’å„ªå…ˆï¼‰ */
 body.arrivalModeOn #schedule{
   pointer-events: none;
 }
 body.arrivalModeOn .topbar .group *{
   pointer-events: none;
 }
 body.arrivalModeOn #arrivalModeBtn{
  pointer-events: auto;
  background: #2563eb;
  color: #fff;
  border-color: #1e40af;
  font-weight: 700;
}
.arrival-check.is-off { 
  color: rgba(156, 163, 175, .4); 
 }
body:not(.arrivalModeOn) .arrival-check.is-off { display: none !important; } /* é€šå¸¸æ™‚ã¯trueã®ã¿è¡¨ç¤º */

 /* ===== ãƒ‘ã‚¹ â—ï¼ˆé»’ï¼‰ãƒ¢ãƒ¼ãƒ‰ï¼šé®æ–­ï¼ˆarrivalæ€æƒ³ï¼‰ ===== */
 body.pathModeOn #schedule{ pointer-events:none; }
 body.pathModeOn .topbar .group *{ pointer-events:none; }
 body.pathModeOn #pathModeBtn{
   pointer-events:auto;
   background:#111827;
   color:#fff;
   border-color:#000;
   font-weight:700;
 }

 /* ãƒ‘ã‚¹ãƒ¢ãƒ¼ãƒ‰ä¸­ï¼šé’æ /å¤–æ æ®‹éª¸ã‚’éè¡¨ç¤ºï¼ˆIOLã¨åŒã˜ï¼‰ */
 body.pathModeOn .slot.focused,
 body.pathModeOn .slot.is-selected,
 body.pathModeOn .slot.multiSelected{
   outline:none !important;
   box-shadow:none !important;
 }
 body.pathModeOn .multiRangeOutline{ display:none !important; }
 body.pathModeOn .path-check{ pointer-events:auto; cursor:pointer; }

#pathModeBanner{
  position: fixed;
  top: 56px;        /* arrival / IOL ã¨åŒã˜é«˜ã• */
  left: 12px;
  z-index: 2000;
  padding: 6px 10px;
  border: 1px solid #e5e7eb;
  background: rgba(255,255,255,.98);
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0,0,0,.10);
  font-size: 12px;
  display: none;
}
body.pathModeOn #pathModeBanner{ display:block; }

#pathModeBtn{
  width: 32px;
  height: 32px;
  padding: 0;
  line-height: 32px;
  font-size: 16px;
  /* é€šå¸¸æ™‚ï¼šé»’ãƒ‰ãƒƒãƒˆ */
  color: #111827;
}

/* ãƒ‘ã‚¹å…¥åŠ›æ¸ˆã¿ï¼ˆå…¥ï¼å½“ï¼‰ï¼šæ™‚åˆ»ã®å³æ¨ªï¼ˆarrival âœ“ ã¨åŒã˜ä½ç½®ï¼‰ */
.path-check{
  position:absolute;
  right:0px;
  top:8px;                 /* â˜… ã“ã“ï¼š8px */
  width:4px;
  height:4px;
  border-radius:50%;
  background:#111827;
  display:inline-block;
  font-size:0;
  line-height:0;
  pointer-events:none;
  user-select:none;
}

.path-check.is-off{
  opacity:.25;  
}
body:not(.pathModeOn) .path-check.is-off{ display:none !important; } /* é€šå¸¸æ™‚ã¯trueã®ã¿è¡¨ç¤ºï¼ˆarrivalã¨åŒæ€æƒ³ï¼‰ */
body.pathModeOn .path-check{ pointer-events:auto; cursor:pointer; }  /* å¾Œã§ãƒ¢ãƒ¼ãƒ‰å…¥ã‚ŒãŸã‚‰ã‚¯ãƒªãƒƒã‚¯å¯ */

/* â˜… å½“ãŸã‚Šåˆ¤å®šï¼ˆé€æ˜ï¼‰ */
.path-check::before{
  content:'';
  position:absolute;
  left:-8px;
  top:-8px;
  width:20px;   /* â† IOLãƒ‰ãƒƒãƒˆç›¸å½“ã®ãƒ’ãƒƒãƒˆæ„Ÿ */
  height:20px;
  background:transparent;
}


/* ===== IOL â—ï¼ˆç™ºæ³¨æ¸ˆè¡¨ç¤ºï¼šStepB=è¡¨ç¤ºã ã‘ï¼‰ ===== */
.iol-dot{
  display:inline-block;
  width:4px;            /* â† ã“ã“ãŒã‚µã‚¤ã‚ºã®æœ¬ä½“ */
  height:4px;
  margin-left:3px;
  border-radius:50%;
  background:#dc2626;
  opacity:.85;
  vertical-align:middle;
  position: relative;
  top: 0.2em;  
}

/* OFF */
.iol-dot.is-off{
  opacity:.25;
}

/* æ–‡å­—ã¯ä¸è¦ãªã®ã§æ¶ˆã™ */
.iol-dot{
  font-size:0;
}

/* é€šå¸¸æ™‚ï¼šç™ºæ³¨æ¸ˆ(true)ã ã‘è¡¨ç¤ºï¼ˆarrivalã¨åŒã˜ï¼‰ */
body:not(.iolModeOn) .iol-dot.is-off{ display:none !important; }

/* IOLãƒ¢ãƒ¼ãƒ‰ä¸­ã ã‘ï¼šãƒ›ãƒãƒ¼èª¬æ˜ã¯å‡ºã›ã‚‹ï¼ˆã¾ã ã‚¯ãƒªãƒƒã‚¯ã¯ã—ãªã„ï¼‰ */
body.iolModeOn .iol-dot{ pointer-events:auto; cursor:help; }
body.iolModeOn .iol-dot:hover::after{
  content:"IOLç™ºæ³¨æ¸ˆ";
  position:absolute;
  left:calc(100% + 8px);
  top:50%;
  transform:translateY(-50%);
  background:rgba(0,0,0,.85);
  color:#fff;
  font-size:12px;
  padding:4px 8px;
  border-radius:8px;
  white-space:nowrap;
  z-index:4000;
  pointer-events:none;
}

    /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆ‡æ›¿ç”¨ */
    body.fiveCols #schedule{grid-template-columns:repeat(5,minmax(var(--col-min-5,300px),1fr));gap:16px;align-items:start;overflow-x:auto;-webkit-overflow-scrolling:touch}
    body.fiveCols #leftCol, body.fiveCols #rightCol{display:contents}
    body.fourCols #schedule{grid-template-columns:repeat(4,minmax(var(--col-min-4,360px),1fr));gap:16px;align-items:start;overflow-x:auto;-webkit-overflow-scrolling:touch}
    body.fourCols #leftCol, body.fourCols #rightCol{display:contents}
    body.fourCols .dayStack{display:flex;flex-direction:column;gap:16px;min-width:0;width:100%}
    body.fiveCols .dayStack{display:flex;flex-direction:column;gap:16px;min-width:0;width:100%}

    /* é€±æœ« è‡¨æ™‚æ‰‹è¡“ï¼ˆã¾ã¨ã‚ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ */
    .weekend{ border:2px dashed #cbd5e1; background:#fafafa; position:relative; }
    .weekend .day-header{ background:#f3f4f6; border-bottom:1px dashed #cbd5e1; }
    .weekend .section-title{ background:#f8fafc; justify-content:flex-start; }

    /* ä¼‘æ­¢æ—¥ï¼ˆçµ‚æ—¥ or ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰è¦‹ãŸç›® */
    .day.is-off { background:#f5f5f5; opacity:.9; }
.day.is-off .slot:not(.temp-slot):not(.emergency-slot),
.slots.section-off .slot:not(.temp-slot):not(.emergency-slot) {
      pointer-events: none;
      background: #eee !important;
      opacity: .8;
    }
    .day.is-off .slots,
    .slots.section-off { filter: grayscale(1) contrast(.9); }

/* ç·Šæ€¥ãŒ1ã¤ã§ã‚‚ã‚ã‚Œã°ãƒ•ã‚£ãƒ«ã‚¿è§£é™¤ï¼ˆ:has ã¯å¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ç”¨ï¼‰ */
.day.is-off:has(.emergency-slot) .slots,
.slots.section-off:has(.emergency-slot) {filter: none !important;}

/* :has éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ç”¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆJSã§ .has-emergency ã‚’ä»˜ã‘ã‚‹ï¼‰ */
.day.is-off.has-emergency .slots,
.slots.section-off.has-emergency {filter: none !important;}

    /* è‡¨æ™‚ï¼ˆtempï¼‰ã¯å¸¸ã«èµ¤ï¼†æ“ä½œå¯ */
    .temp-slot{ background: rgba(255, 100, 100, .15) !important; }
    .day.is-off .temp-slot,
    .slots.section-off .temp-slot {
      filter: none; pointer-events: auto; opacity: 1;
    }

/* â–¼ ã“ã®ã€Œoffã€ã®å®šç¾©ãŒå¼·ã„ã®ã§ã€ç·Šæ€¥ãƒ»è‡¨æ™‚ã¯é™¤å¤–ã—ã¦ãŠã */
.slot.off:not(.emergency-slot):not(.temp-slot){
  background:#bbb !important; opacity:1; pointer-events:auto;}

/* ãƒ›ãƒãƒ¼ã®è–„ã„é’ï¼ˆoffãƒ»ç·Šæ€¥ãƒ»è‡¨æ™‚ã¯å¡—ã‚Šæ›¿ãˆãªã„ï¼‰ */
/* â˜… ç©ºæ ã®ã¿ hover ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆãƒ‡ãƒ¼ã‚¿å…¥ã‚Šã¯å…ƒã®è‰²ã‚’ä¿æŒï¼‰ */
.slot.empty:hover:not(.off):not(.emergency-slot):not(.temp-slot) {
  background: rgba(37, 99, 235, 0.08) !important;
}

    /* ç¥æ—¥è¦‹ãŸç›® */
    .day.is-holiday .day-header{ background: #fff5f5; }
    .day.is-holiday .day-header-date::after{
      content: " ç¥"; display:inline-block; margin-left:.5em; padding:0 .4em; font-size:.85em; color:#b91c1c; border:1px solid #fca5a5; border-radius:6px; background:#ffe4e6;
    }
    /* ç¥æ—¥ã§ã‚‚å³ã‚¯ãƒªãƒƒã‚¯ã‚’é€šã™ä¿é™º */
    .day.is-off .slot, .day.is-holiday .slot { pointer-events:auto; }
    .day.is-off .slots, .day.is-holiday .slots { pointer-events:auto; }

    /* ç¥æ—¥ã®æ èƒŒæ™¯ã¯ #bbbï¼ˆè‡¨æ™‚ã¯é™¤å¤–ï¼‰ */
    .day.is-holiday .slot:not(.temp-slot):not(.emergency-slot) { background:#bbb !important; opacity:1 !important; }

/* ç¥æ—¥ã§ã‚‚å³ã‚¯ãƒªãƒƒã‚¯ã‚’é€šã™ï¼ˆæœ€å„ªå…ˆã§è¨±å¯ï¼‰ */
.day.is-holiday .slot,
.day.is-holiday .slot.off,
.day.is-holiday .slots {
  pointer-events: auto !important;
}

/* ç·Šæ€¥ï¼ˆç¥æ—¥ãƒ»ä¼‘æ­¢ã§ã‚‚æœ€å„ªå…ˆã§èµ¤ï¼†æ“ä½œå¯ï¼‰â€” Aã‚ˆã‚Šå¾Œã‚ã«ç½®ã */
.day.is-off  .slot.emergency-slot,
.day.is-holiday .slot.emergency-slot,
.slots.section-off .slot.emergency-slot {
  background: rgba(255,100,100,.15) !important;
  opacity: 1 !important;
  filter: none !important;
  pointer-events: auto !important;
}


/* tailè¡Œã¯ DOM ã¯æ®‹ã—ã¦éè¡¨ç¤ºï¼ˆé«˜ã•0ï¼‰ */
.hiddenRow { display:none !important; }

/* ãƒ–ãƒ©ã‚¦ã‚¶æ—¢å®šã®é»’ã„ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ ã‚’ç„¡åŠ¹åŒ–ï¼ˆé’æ ã¯ .focused ã§ä»˜ã‘ã‚‹ï¼‰ */
.slot:focus,
.slot:focus-visible {
  outline: none !important;
}

/* ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠã•ã‚ŒãŸæ ã®è¦‹ãŸç›®ï¼ˆç”»é¢è¡¨ç¤ºå°‚ç”¨ï¼‰ */
@media screen {
  body:not(.arrivalModeOn) .slot.focused{
    outline: 2px solid #2563eb;
    outline-offset: -2px;
    background: rgba(37,99,235,0.06);
  }
  /* â˜… RLå¤–å‘¨é¸æŠï¼ˆmultiSelectedï¼‰ä¸­ã¯ã€focusedé’æ ã‚’æ¶ˆã—ã¦ã€ŒçœŸã‚“ä¸­ç·šãŒé’ã€ã‚’é˜²ã */
  body:not(.arrivalModeOn) .slot.focused.multiSelected{
    outline: none !important;
    outline-offset: 0 !important;
  }  
}

/* ã‚¹ãƒ­ãƒƒãƒˆå¢ƒç•Œã‹ã‚‰ä¸‹ã¸ã®â€œã«ã˜ã¿â€ã‚’æ­¢ã‚ã‚‹ */
.slot { overflow: hidden; }

.content { overflow: hidden; }
 .content-left{
  line-height: 1.2;
  overflow: hidden;                 /* ã¯ã¿å‡ºã—éè¡¨ç¤ºï¼ˆå…±é€šï¼‰ */
  display: block;                   /* é«˜ã•è¨ˆç®—ãŒå®‰å®š */
  max-height: calc(var(--slot-h) - 6px); /* æ é«˜(28px) - ä¸Šä¸‹padding(3+3) */
  word-break: break-word;
  white-space: normal;
}

/* é€±è¡¨ç¤ºãƒ»ã‚¹ãƒ­ãƒƒãƒˆå·¦å´ãƒ†ã‚­ã‚¹ãƒˆ */
.slot .content-left{
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: 2;       /* 2è¡Œã§ã‚«ãƒƒãƒˆ */
  max-height: calc(2 * 1.2em + 2px); /* 2è¡Œåˆ† + Î±ï¼ˆèª¤å·®å¸åç”¨ã®ä½™è£•ï¼‰ */
  font-size: 13px;             /* é€±è¡¨ç¤ºã§ã¯ 13px å›ºå®š */
}
/* å…±é€šï¼šåˆ—ãƒ»ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ãƒ¼ */
.slot .content-left .slot-col{
  display: inline-block;
  vertical-align: top;
}

.slot .content-left .slot-sep{
  display: inline-block;
  padding: 0 px;   /* ã€Œï½œã€å‰å¾Œã®ä½™ç™½ */
}
 
  /* å…¥ãƒ»å¤–ãƒ»å½“æ—¥ï¼ˆ1æ–‡å­—å¹…ï¼‹ä¸­å¤®å¯„ã›ï¼‰ */
  .slot .content-left .slot-col-io{
    min-width: 1ch;
    text-align: center;
  }
 
  /* æ°åï¼ˆåŠè§’ã‚«ãƒŠ11æ–‡å­—ï¼‹ä¸­å¤®å¯„ã›ï¼‰ */
  .slot .content-left .slot-col-name{
    min-width: 11.5ch;
    text-align: center;
  }
 
  /* IDï¼ˆ10æ¡ï¼‹ä¸­å¤®å¯„ã›ï¼‰ */
  .slot .content-left .slot-col-pid{
    min-width: 10ch;
    text-align: center;
  }
 
  /* çœ¼ R/L/Bï¼ˆ1æ–‡å­—ï¼‹ä¸­å¤®å¯„ã›ï¼‰ */
  .slot .content-left .slot-col-eye{
    min-width: 1.5ch;
    text-align: center;
  }
 
  /* å¹´é½¢ï¼ˆåŠè§’3æ¡ï¼‹ä¸­å¤®å¯„ã›ï¼‰ */
  .slot .content-left .slot-col-age{
    min-width: 3ch;
    text-align: center;
  }
 
  /* IOLç¨®é¡ãƒ»åº¦æ•°ï¼ˆãã‚Šãã‚Šå…¥ã‚‹ï¼‹ä¸­å¤®å¯„ã›ï¼‰ */
  .slot .content-left .slot-col-iol{
    min-width: 7.7ch;   /* è¶³ã‚Šãªã‘ã‚Œã°ã“ã“ã‚’å°‘ã—å¢—ã‚„ã™ */
    text-align: center;
  }
 
  /* è¡“å¼1ã€œ2ï¼ˆå·¦å¯„ã›ï¼‰ */
 .slot .content-left .slot-col-proc1,
 .slot .content-left .slot-col-proc2{
    min-width: 6ch;
    text-align: left;
  }
 
  /* å‚™è€ƒï¼šæœ«å°¾ãªã®ã§è‡ªç”± */
  .slot .content-left .slot-col-note{
    padding-left: 4px;
  }

.slot .content-left .iol-use{
  font-size: 0.85em;
  opacity: 0.85;
}

/* çœ¼ã®èµ¤å¼·èª¿ï¼ˆãŠå¥½ã¿ã§ï¼‰ */
.eye-mark{
  color: #b91c1c;
  font-weight: bold;
}

.proc2-badge {
  background: #bfdbfe;   /* è‰²ã¯ç¾çŠ¶ç¶­æŒ */
  color: #1e3a8a;
  padding: 0 4px;        /* ä¸Šä¸‹0ã§é«˜ã•ã‚’æŠ‘ãˆã€æ¨ªã‚‚å°‘ã—ã ã‘ç´°ã */
  border-radius: 0;      /* è§’ã¯ãã®ã¾ã¾ç›´è§’ */
  font-size: 0.9em;      /* å°‘ã—ã ã‘å°ã•ãï¼ˆ13pxãƒ™ãƒ¼ã‚¹ãªã‚‰ç´„11.7pxï¼‰ */
  font-weight: 700;
  display: inline-block;
  line-height: 1.0;      /* è¡Œã®é«˜ã•ã‚’è©°ã‚ã¦â€œèƒŒã‚’ä½ãâ€ */
  position: relative;      /* â˜… å³ä¸‹ãƒ‰ãƒƒãƒˆã®åŸºæº– */
  padding-right: 10px;     /* â˜… å³ä¸‹ãƒ‰ãƒƒãƒˆã®é€ƒã’ */ 
}

/* ===== ãƒ‡ãƒã‚¤ã‚¹(proc2)ç”¨ï¼šå³ä¸‹ èµ¤â—ï¼ˆIOLã¨åŒç³»çµ±ï¼‰ ===== */
.device-dot{
  position:absolute;
  right:1px;
  bottom:1px;
  width:4px;
  height:4px;
  border-radius:50%;
  background:#dc2626;      /* èµ¤ï¼ˆIOLã¨åŒè‰²ï¼‰ */
  opacity:.85;
  font-size:0;
  pointer-events:none;     /* é€šå¸¸ã¯è§¦ã‚Œãªã„ */
  user-select:none;
}
.device-dot.is-off{ opacity:.25; }
body:not(.iolModeOn) .device-dot.is-off{ display:none !important; }
body.iolModeOn .device-dot{ pointer-events:auto; cursor:pointer; }
body.iolModeOn .device-dot::before{
  content:"";
  position:absolute;
  left:-9px; top:-9px;
  width:22px; height:22px;   /* â˜… ãƒ’ãƒƒãƒˆç¯„å›²æ‹¡å¤§ï¼ˆIOLã¨åŒç­‰ï¼‰ */
  background:transparent;
  border-radius:12px;
  pointer-events:auto;
}

/* â‘¡ çµåˆæ ï¼ˆheadï¼‰ã¯è¡Œæ•°åˆ¶é™ã‚’è§£é™¤ã—ã¦è‡ªç”±ã«è¡¨ç¤º */
.slot.mergeHead .content-left{
  /* è¡Œæ•°åˆ¶é™ï¼†é«˜ã•åˆ¶é™ã‚’è§£é™¤ */
  -webkit-line-clamp: unset;
  max-height: none;
  overflow: visible;
  /* -webkit-box ã ã¨è¡Œæ•°åˆ¶å¾¡å‰æã«ãªã‚‹ã®ã§é€šå¸¸ãƒ–ãƒ­ãƒƒã‚¯ã«æˆ»ã™ */
  display: block;

  /* å¥½ã¿ã§ï¼šçµåˆæ å†…ã¯é€šå¸¸ã‚µã‚¤ã‚ºã«æˆ»ã™ï¼ˆä»»æ„ï¼‰ */
  font-size: 13px;
  line-height: 1.3;
}

/* çµåˆæ (head)ã®ç®±å´ã§ä¸­èº«ã‚’ã‚¯ãƒªãƒƒãƒ—ã—ãªã„ */
.slot.mergeHead{ overflow: visible; }

 /* é€šå¸¸æ ï¼ˆãƒ‡ãƒ¼ã‚¿ã‚ã‚Šï¼‰ã¯è‰²ã‚’å¤‰ãˆãªã„ï¼ˆæ„ŸæŸ“ç—‡ã‚ã‚Š/ãªã—ã ã‘ã§è‰²ã‚’ã¤ã‘ã‚‹ï¼‰ */
 .slot:not(.empty){
   background: transparent;
 }


/* æ™‚é–“ãƒãƒƒã‚¸ï¼ˆçµåˆãƒãƒƒã‚¸ã‚’æ¨ªé•·ãƒ”ãƒ«ã«çµ±ä¸€ï¼‰ */
.merge-badge,
.span-badge,
.mergeSpan-badge,
.badge-merge{
  display: inline-block !important;
  writing-mode: horizontal-tb !important; /* æ¨ªæ›¸ãã«å¼·åˆ¶ */
  white-space: nowrap !important;         /* æ”¹è¡Œã—ãªã„ */
  width: auto !important;
  height: auto !important;

  font-size: 11px;
  line-height: 1;
  padding: 1px 6px;
  border-radius: 9999px;

  /* è¦‹ãŸç›®ã¯æ§ãˆã‚ãªã‚°ãƒ¬ãƒ¼ç³»ãƒ”ãƒ«ï¼ˆå¿…è¦ãªã‚‰èª¿æ•´OKï¼‰ */
  border: 1px solid #9ca3af;
  background: #f3f4f6;
  color: #111827;

  /* GA/æ„ŸæŸ“ã¨ã®é–“éš”ï¼ˆå¿…è¦ãªã‚‰å¾®èª¿æ•´ï¼‰ */
  margin-bottom: 4px;
}

/* ãƒãƒƒã‚¸ã‚’ç¸¦ç©ã¿ã—ãŸã„å ´åˆã«åŠ¹ã‹ã›ã‚‹ï¼ˆä»»æ„ï¼‰ */
.ga-badge,
.infection-badge,
.merge-badge,
.span-badge,
.mergeSpan-badge,
.badge-merge{
  display: inline-block;
}

/* å…¨éº»ãƒãƒƒã‚¸ï¼šæ¨ªé•·ãƒ”ãƒ«ï¼ˆâ€œ4æ â€ã¨åŒã˜ã‚µã‚¤ã‚ºæ„Ÿï¼‰ */
.ga-badge{
  display: inline-block;       /* 1æ–‡å­—ãšã¤ç¸¦å´©ã‚Œé˜²æ­¢ */
  writing-mode: horizontal-tb; /* å¿µã®ãŸã‚ */
  white-space: nowrap;         /* æ”¹è¡Œãªã— */

  font-size: 11px;
  line-height: 1;
  padding: 1px 6px;
  border-radius: 9999px;
  border: 1px solid #f59e0b;
  background: #fef3c7;
  color: #92400e;

  pointer-events: none;
  user-select: none;

  margin-top: auto; /* çµåˆãƒãƒƒã‚¸ã®ä¸‹å´ã«å¯„ã›ã‚‹ç”¨é€”ï¼ˆå¿…è¦ãªã‚‰æ®‹ã™ï¼‰ */
}

/* å±€éº»ãƒãƒƒã‚¸ï¼ˆå…¨éº»ã¨åŒã˜å½¢ãƒ»å¤§ãã•ã§è‰²ã ã‘ç·‘ï¼‰ */
.local-badge{
  display: inline-block;        /* 1æ–‡å­—ãšã¤ç¸¦å´©ã‚Œé˜²æ­¢ */
  writing-mode: horizontal-tb;  /* â˜…å¼·åˆ¶çš„ã«æ¨ªæ›¸ãã«ã™ã‚‹ */
  white-space: nowrap;          /* æ”¹è¡Œãªã— */

  font-size: 11px;
  line-height: 1;
  padding: 1px 6px;
  border-radius: 9999px;

  border: 1px solid #22c55e;    /* ç·‘ç³»ã®æ ç·š */
  background: #dcfce7;          /* è–„ã„ç·‘ */
  color: #166534;               /* æ¿ƒã„ç·‘ */

  pointer-events: none;
  user-select: none;

  margin-top: auto;             /* æ‰€è¦æ™‚é–“ãƒãƒƒã‚¸ã®ä¸‹å´ã«å¯„ã›ã‚‹ï¼ˆga-badge ã¨åŒã˜ï¼‰ */
}

/* æ„ŸæŸ“ç—‡ãƒãƒƒã‚¸ï¼šå…±é€šãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆå…¨éº»ãƒãƒƒã‚¸ã¨åŒç³»è‰²ã®ãƒ”ãƒ«ï¼‰ */
.infection-badge{
  writing-mode: horizontal-tb;
  white-space: nowrap;

  font-size: 11px;
  line-height: 1;
  padding: 0px 6px;              /* ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã®é«˜ã•ã‚’ã‚ã¾ã‚Šå¢—ã‚„ã•ãªã„ã‚ˆã†ã«ç¸¦æ–¹å‘ã‚’è–„ã */
  border-radius: 9999px;
  border: 1px solid #a855f7;     /* ç´«ç³»ã®æ ç·š */
  background: #f5f3ff;           /* è–„ã„ç´«ã®èƒŒæ™¯ */
  color: #6b21a8;                /* æ¿ƒã„ã‚ã®ç´«æ–‡å­— */

  pointer-events: none;
  user-select: none;

  margin-left: 0;
  margin-top: 0;
  vertical-align: baseline;
}

/* ç”»é¢ï¼ˆscreenï¼‰ã§ã¯æ„ŸæŸ“ãƒãƒƒã‚¸ã‚’éè¡¨ç¤ºã«ã™ã‚‹ */
@media screen {
  .infection-badge {
    display: none !important;
  }
}

/* å°åˆ·æ™‚ã ã‘æ„ŸæŸ“ãƒãƒƒã‚¸é¢¨ãƒ”ãƒ«ã‚’æç”»ã™ã‚‹ */
@media print {
  /* JS ã§ç”Ÿæˆã—ãŸ span.infection-badge è‡ªä½“ã¯å°åˆ·ã§ã¯ä½¿ã‚ãªã„ */
  .infection-badge {
    display: none !important;
  }

  /* â‘  ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆnoteï¼‰ãŒã‚ã‚‹ã‚¹ãƒ­ãƒƒãƒˆï¼šå‚™è€ƒã®æœ«å°¾ã«ä»˜ã‘ã‚‹ */
  .slot.infection-slot .slot-col-note::after,

  /* â‘¡ ã‚³ãƒ¡ãƒ³ãƒˆãŒç„¡ã„ã‚¹ãƒ­ãƒƒãƒˆï¼šå·¦å´ãƒ†ã‚­ã‚¹ãƒˆ(content-left)ã®æœ«å°¾ã«ä»˜ã‘ã‚‹ */
  .slot.infection-slot:not(:has(.slot-col-note)) .content-left::after {
    content: ' æ„ŸæŸ“';
    display: inline-block;
    writing-mode: horizontal-tb;
    white-space: nowrap;

    font-size: 9px;
    line-height: 1;
    padding: 0px 6px;
    border-radius: 9999px;
    border: 1px solid #a855f7;   /* ç´«ç³»ã®æ ç·š */
    background: #f5f3ff;         /* è–„ã„ç´«ã®èƒŒæ™¯ */
    color: #6b21a8;              /* æ¿ƒã„ã‚ã®ç´«æ–‡å­— */

    vertical-align: baseline;
    margin-left: 4px;            /* æ‰‹å‰ã®æ–‡å­—ã¨å°‘ã—é–“éš”ã‚’ç©ºã‘ã‚‹ */
  }
}

/* ç¥æ—¥/ä¼‘æ­¢ã‚’å„ªå…ˆã—ãŸã„ãªã‚‰ä½•ã‚‚ã—ãªã„ï¼ˆâ†ã“ã®ã¾ã¾ï¼‰ */
/* ã‚‚ã—ç¥æ—¥/ä¼‘æ­¢ã§ã‚‚é»„è‰²ã«ã—ãŸã„ãªã‚‰ã€ä¸‹ã‚’æœ‰åŠ¹åŒ–ï¼š
.day.is-holiday .slot.ga-slot:not(.temp-slot):not(.emergency-slot),
.slot.off.ga-slot {
  background: #fff9c4 !important;
}
*/

/* --- æ„ŸæŸ“ç—‡ã‚ã‚Šï¼šç´« --- */
.slot.infection-slot {
  background: rgba(180, 100, 255, 0.18) !important;
}

/* --- æ„ŸæŸ“ç—‡ãªã—ï¼šå¾“æ¥ã®â€œè–„ã„ç·‘â€ã‚’ã“ã“ã«ç§»ã™ --- */
.slot.noninfection-slot {
  /* ã“ã“ã«ã•ã£ãã® .slot:not(.empty) ã®è‰²ã‚’å…¥ã‚Œã‚‹ */
  background: #e8f7ec !important;  /* â† å…ƒã®è–„ã„ç·‘ã®è‰² */
}

/* --- GA(å…¨éº») ã¯è–„ã„é»„è‰² --- */
.slot.ga-slot {
  background: #fff9c4 !important;
}

/* â˜… æ„ŸæŸ“ç—‡ã‚ã‚Š + å…¨éº» ã®ã¨ãã‚‚ GA ã®é»„è‰²ã‚’å„ªå…ˆ */
.slot.ga-slot.infection-slot {
  background: #fff9c4 !important;
}

/* æ„ŸæŸ“ç—‡ãƒ»å…¨éº»ã‚’ç¸¦ä¸¦ã³ã«ã™ã‚‹ */
#editorForm label[for="infection"],
#editorForm label[for="ga"] {
  grid-column: 1 / -1;   /* 2åˆ—ã‚’ã¾ãŸã„ã§é…ç½® */
}


/* === æ—¥ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è¡¨ç¤ºï¼ˆæ–¹å¼Aï¼‰ ===================== */
body.dayFocus { --slot-h: 44px; }              /* ã‚¹ãƒ­ãƒƒãƒˆã‚’å°‘ã—èƒŒé«˜ã« */
body.dayFocus #schedule { grid-template-columns: 1fr; }
body.dayFocus .day { display:none; }           /* ä»–æ—¥ã¯éš ã™ */
body.dayFocus .day[data-focus="true"] {display:block;}

/* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®æ–‡å­—ã‚µã‚¤ã‚ºã‚’å°‘ã—ã‚¢ãƒƒãƒ—ï¼ˆãŠå¥½ã¿ã§ï¼‰ */
body.dayFocus .time { font-size: 18px; }
body.dayFocus .content-left { font-size: 20px; line-height: 1.3; }

/* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ï¼šçµåˆæ ã‚‚åŒã˜ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã«ã™ã‚‹ */
body.dayFocus .slot.mergeHead .content-left {
  font-size: 20px !important;
  line-height: 1.3;
}


/* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®æˆ»ã‚‹ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ */
#focusBackBtn {
  position: fixed;
  top: 56px;            /* ãƒˆãƒƒãƒ—ãƒãƒ¼ã®ä¸‹ã‚ãŸã‚Šã« */
  right: 16px;
  z-index: 1000;
  padding: 6px 10px;
  border: 1px solid #bbb;
  background: #fff;
  border-radius: 6px;
  cursor: pointer;
  box-shadow: 0 2px 10px rgba(0,0,0,.08);
}

/* --- ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã«éš ã™ã‚‚ã® --- */
body.dayFocus #mode2col,
body.dayFocus #mode4col,
body.dayFocus #mode5col,
body.dayFocus .topbar [aria-label="ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆ‡æ›¿"] {
  display: none !important;
}

/* --- æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®é…ç½® --- */
/* é€šå¸¸ã¯éè¡¨ç¤ºã€ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã«ãƒˆãƒƒãƒ—ãƒãƒ¼å³ç«¯ã¸è¡¨ç¤º */
#focusBackBtn {
  display: none;
  padding: 6px 10px;
  border: 1px solid #bbb;
  background: #fff;
  border-radius: 6px;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  font-size: 0.9rem;
  align-self: center; /* ãƒˆãƒƒãƒ—ãƒãƒ¼å†…ã§ç¸¦ä½ç½®ã‚’ãã‚ãˆã‚‹ */
  margin-left: 8px;   /* éš£ã®ãƒœã‚¿ãƒ³ã¨ã®é–“éš” */
}
body.dayFocus #focusBackBtn {
  display: inline-flex;
  position: static;   /* â† fixedã‚’è§£é™¤ã—ã¦1è¡Œå†…ã« */
}

/* --- ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã«æ®‹ã™ã‚‚ã®ï¼ˆãƒ”ãƒƒã‚«ãƒ¼ç­‰ï¼‰ --- */
body.dayFocus #prevWeek,
body.dayFocus #nextWeek,
body.dayFocus #todayBtn,
body.dayFocus #weekPicker {
  display: inline-flex !important;
}

/* ===== çµ±ä¸€ç‰ˆï¼šå°åˆ·ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆæ•´ç†æ¸ˆã¿ï¼‰ ===== */
@media print {
  @page { size: A4 portrait; margin: 10mm; }

  /* ç”»é¢UIã¯éš ã™ */
  .topbar,
  .ctx-menu {
    display: none !important;
  }

  /* é€±é–“ã§ã‚‚ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã§ã‚‚ï¼šA4ã„ã£ã±ã„ãƒ»1åˆ—åŒ– */
  #schedule {
    grid-template-columns: 1fr !important;
    column-gap: 0 !important;
    width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
  }
  #schedule .column { display: contents !important; }

  /* è¡Œé«˜ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆé€šå¸¸å°åˆ·å´ï¼‰ */
  :root { --print-slot-h: 8mm; }
  .slots { grid-auto-rows: var(--print-slot-h) !important; }

  /* åŸºæœ¬ã¯é€”ä¸­ã§åˆ‡ã‚‰ãªã„ï¼ˆ2ãƒšãƒ¼ã‚¸å°åˆ·å´ã§ã‚ã¨ã‹ã‚‰ä¸Šæ›¸ãï¼‰ */
  .day,
  .slots,
  .slot {
    break-inside: avoid;
    page-break-inside: avoid;
  }

  /* å³ã‚¯ãƒªãƒƒã‚¯é¸æŠå°åˆ·ã§ä½¿ã†ãƒ•ãƒ©ã‚° */
  .hide-on-print { display: none !important; }

  /* === é€±è¡¨ç¤ºã®é€šå¸¸å°åˆ·ï¼šæœˆã€œé‡‘ã ã‘ã‚’1æ—¥1ãƒšãƒ¼ã‚¸ãšã¤ === */

  /* åœŸæ—¥ã‚’å®Œå…¨ã«å°åˆ·å¯¾è±¡ã‹ã‚‰é™¤å¤– */
  body:not(.printWeek2p):not(.dayFocus) #schedule .day[data-day-key="Sat"],
  body:not(.printWeek2p):not(.dayFocus) #schedule .day[data-day-key="Sun"] {
    display: none !important;
  }

  /* æœˆã€œé‡‘ã¯å¿…ãš1æ—¥1ãƒšãƒ¼ã‚¸ */
  body:not(.printWeek2p):not(.dayFocus) #schedule .day {
    break-after: page;
    page-break-after: always;
  }

  /* è‡¨æ™‚/ç·Šæ€¥æ ã®æ•°ã«å¿œã˜ãŸè‡ªå‹•åœ§ç¸®ï¼ˆé€šå¸¸å°åˆ·ã®ã¿ï¼‰ */
  /* 1ã€œ2æ è¿½åŠ  â†’ ã¡ã‚‡ã£ã¨ã ã‘åœ§ç¸® */
  body:not(.printWeek2p):not(.dayFocus) #schedule .day.print-tight {
    --print-slot-h: 7.6mm;   /* 8mm â†’ 7.6mm */
  }

  /* 3æ ä»¥ä¸Šè¿½åŠ  â†’ ã‚‚ã†ä¸€æ®µåœ§ç¸® */
  body:not(.printWeek2p):not(.dayFocus) #schedule .day.print-tighter {
    --print-slot-h: 7.2mm;   /* 8mm â†’ 7.2mm */
  }

  /* === å¹³æ—¥2ãƒšãƒ¼ã‚¸å°åˆ·ãƒ¢ãƒ¼ãƒ‰å°‚ç”¨ã®èª¿æ•´ === */

  /* 1è¡Œã®é«˜ã•ã‚’ã‹ãªã‚Šè©°ã‚ã‚‹ï¼ˆé€šå¸¸8mm â†’ 4.8mmï¼‰ */
  body.printWeek2p {
    --print-slot-h: 4.8mm;
  }

  /* ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å…¨ä½“ã®ç¸¦ã®éš™é–“ã‚’ã»ã¼ã‚¼ãƒ­ã« */
  body.printWeek2p #schedule {
    row-gap: 0 !important;
  }
  body.printWeek2p .column {
    row-gap: 0 !important;
  }
  body.printWeek2p .dayStack {
    gap: 0 !important;
  }

  /* å„æ›œæ—¥ã®ä¸Šä¸‹ä½™ç™½ã‚‚è©°ã‚ã‚‹ */
  body.printWeek2p .day {
    margin-top: 0 !important;
    margin-bottom: 0 !important;
  }

  /* 2ãƒšãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ‰ã§ã¯æ ã¯é€”ä¸­ã§åˆ‡ã‚Œã¦OKï¼ˆãƒšãƒ¼ã‚¸å„ªå…ˆï¼‰ */
  body.printWeek2p .day,
  body.printWeek2p .slots,
  body.printWeek2p .slot {
    break-inside: auto !important;
    page-break-inside: auto !important;
  }

/* 2ãƒšãƒ¼ã‚¸å°åˆ·ç”¨ã®ãƒ•ã‚©ãƒ³ãƒˆãƒ»è¦‹ãŸç›®èª¿æ•´ */
body.printWeek2p .content-left {
  font-size: 13px !important;
  display: flex;
  align-items: center;   /* å·¦å´ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ»ãƒãƒƒã‚¸å…¨ä½“ã‚’ç¸¦ä¸­å¤®å¯„ã› */
  line-height: 1.1;
}

/* time ã¯ç¸¦æ–¹å‘ã«ä¸­å¤®å¯„ã›ï¼‹ãƒãƒƒã‚¸ã¯ä¸‹ã«ã¶ã‚‰ä¸‹ã’ã‚‹ */
body.printWeek2p .time {
  font-size: 11px !important;
  display: flex;
  flex-direction: column;        /* ä¸Š:æ™‚åˆ» / ä¸‹:ãƒãƒƒã‚¸ ã«ç¸¦ç©ã¿ */
  justify-content: center;       /* ã‚¹ãƒ­ãƒƒãƒˆé«˜ã•ã®ä¸­å¤®ã«å¯„ã›ã‚‹ */
  align-items: flex-start;       /* å·¦æƒãˆã®ã¾ã¾ */
  line-height: 1.1;
}

  /* 2ãƒšãƒ¼ã‚¸å°åˆ·æ™‚ã®è¡“è€…ãƒãƒƒã‚¸ï¼šå°‘ã—å°ã•ã‚ï¼†ç¸¦ä¸­å¤®å¯„ã› */
  body.printWeek2p .surgeon-tag {
    font-size: 9px !important;      /* ã¡ã‚‡ã„å°ã•ãã—ã¦ä¸‹ãŒåˆ‡ã‚Œãªã„ã‚ˆã†ã« */
    padding: 0 4px !important;
    line-height: 1.2 !important;    /* ãƒãƒƒã‚¸å†…ã®æ–‡å­—ã‚‚ä¸­å¤®å¯„ã›æ°—å‘³ã« */
    top: 50% !important;            /* ã‚¹ãƒ­ãƒƒãƒˆã®ç¸¦ä¸­å¤®ã«é…ç½® */
    transform: translateY(-50%) !important;
  }
  /* çµåˆæ (head)ã®è¡“è€…ãƒãƒƒã‚¸ã ã‘ã¯ã€Œå…¨ä½“ã®ä¸­å¤®ã€ã§ã¯ãªã head ã®ä¸Šè¾ºã«æƒãˆã‚‹ */
body.printWeek2p .slot.mergeHead .surgeon-tag {
  top: 2px !important;              /* é€šå¸¸æ ã¨åŒã˜ãã‚‰ã„ã®ä½ç½®ã« */
  transform: none !important;       /* ä¸­å¤®å¯„ã›ã‚’è§£é™¤ */
}
  
  /* åˆå‰ï¼åˆå¾Œå¸¯ã‚’è–„ãä½ã */
  body.printWeek2p .section-title {
    font-size: 9px !important;
    line-height: 1.0 !important;
    padding-top: 0 !important;
    padding-bottom: 0 !important;
    height: 10px !important;
    min-height: 10px !important;
    margin-top: 0 !important;
    margin-bottom: 0 !important;
  }

  /* ã‚¹ãƒ­ãƒƒãƒˆå…¨ä½“ã‚’ç¸¦æ–¹å‘ã‚»ãƒ³ã‚¿ãƒ¼æƒãˆï¼ˆçµåˆheadã ã‘ä¸Šå¯„ã›ï¼‰ */
  body.printWeek2p .slot {
    align-items: center !important;
  }
  body.printWeek2p .slot.mergeHead {
    align-items: flex-start !important;
  }
}

/* === ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è¡¨ç¤ºå°‚ç”¨ï¼šå°åˆ·ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ === */
@media print {

  /* --- ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å°åˆ·ï¼šæ™‚åˆ»ã®ãƒ•ã‚©ãƒ³ãƒˆ --- */
  body.dayFocus .time {
    font-size: 16px;
  }

  /* --- ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å°åˆ·ï¼šslots ã‚’ block ã«ã™ã‚‹ï¼ˆãŸã ã— hide-on-print ã¯å°Šé‡ï¼‰ --- */
  body.dayFocus #schedule .slots {
    display: block;   /* !important ã‚’å¤–ã—ã¦ã€hide-on-print ã®æ–¹ã‚’å„ªå…ˆã•ã›ã‚‹ */
  }

  /* --- ã‚¹ãƒ­ãƒƒãƒˆæœ¬ä½“ã¯ grid ã®ã¾ã¾ï¼ˆæ™‚åˆ»ï¼‹å†…å®¹ã‚’æ¨ªä¸¦ã³ç¶­æŒï¼‰ --- */
  body.dayFocus .slot {
    display: grid !important;
    grid-template-columns: 60px 1fr;   /* æ™‚åˆ» 60px + å†…å®¹ã‚¨ãƒªã‚¢ */
    width: 100%;
    align-items: flex-start;
  }

  /* --- çµåˆæ  tailï¼ˆhiddenRowï¼‰ã¯å®Œå…¨ã«éè¡¨ç¤º --- */
  body.dayFocus .slot.hiddenRow {
    display: none !important;
  }

  /* --- æ™‚åˆ»éƒ¨åˆ†ï¼šå›ºå®šå¹…ã§å·¦å´ã«é…ç½® --- */
  body.dayFocus .slot .time {
    display: inline-block;
    width: 40px;
    vertical-align: top;
  }

  /* --- å†…å®¹éƒ¨åˆ†ï¼šæ™‚åˆ»ã®å³ã«ä¸¦ã¹ã‚‹ï¼ˆæŠ˜ã‚Šè¿”ã—ã‚‚è‡ªç„¶ã«ï¼‰ --- */
  body.dayFocus .slot .content {
    display: inline-block;
    width: calc(100% - 40px);
    vertical-align: top;
    align-items: flex-start;
  }

  /* --- å†…å®¹ãƒ†ã‚­ã‚¹ãƒˆï¼šæ™®é€šã®ãƒ–ãƒ­ãƒƒã‚¯ã«æˆ»ã—ã¦è‡ªç„¶ãªæŠ˜ã‚Šè¿”ã—ã« --- */
  body.dayFocus .content-left {
    font-size: 18px;
    line-height: 1.3;
    display: block;
    white-space: normal !important;
    overflow: visible !important;
  }

  /* --- çµåˆæ  head ã®ãƒ†ã‚­ã‚¹ãƒˆã‚‚é€šå¸¸ã¨åŒã˜æ‰±ã„ã«çµ±ä¸€ --- */
  body.dayFocus .slot.mergeHead .content-left {
    font-size: 18px !important;
    line-height: 1.3 !important;
  }

  /* --- ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å°åˆ·ï¼šé€”ä¸­ã§åˆ‡ã‚Œã¦ OKï¼ˆslot å˜ä½ã§æ”¹ãƒšãƒ¼ã‚¸è¨±å¯ï¼‰ --- */
  body.dayFocus .day,
  body.dayFocus .slots,
  body.dayFocus .slot {
    break-inside: auto !important;
    page-break-inside: auto !important;
  }

  /* --- ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å°åˆ·ï¼šç©ºã‚¹ãƒ­ãƒƒãƒˆ (.slot.empty) ã¯éè¡¨ç¤º --- */
  body.dayFocus .slot.empty {
    display: none !important;
  }

}





/* é€±ãƒ”ãƒƒã‚«ãƒ¼å³ã®æ›œæ—¥ãƒãƒƒã‚¸ */
#weekPickerWeekday {
  margin-left: .5rem;
  font-size: 0.95em;
  opacity: .8;
}
#weekPickerWeekday { display: none; }
body.dayFocus #weekPickerWeekday { display: inline; }

    /* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã«å…¥ã£ãŸã¨ãã®è¦‹ãŸç›®ï¼ˆé‡ãªã‚Šå›é¿ï¼‰ */
    #helpBtn.docked{
      position: static;
      width: 32px; height: 32px; line-height: 32px;
      border-radius: 50%;
      box-shadow: none;
      margin-left: 8px;
      vertical-align: middle;
    }
/* ===== FINAL OVERRIDE: ç·Šæ€¥ã¯ã©ã“ã§ã‚‚èµ¤ & æ“ä½œå¯ï¼ˆå¿…ãšCSSã®æœ€ä¸‹éƒ¨ã«ç½®ãï¼‰ ===== */
:where(.day.is-off, .day.is-holiday, .slots.section-off) .slot.emergency-slot,
.slot.off.emergency-slot,
.slot.emergency-slot {
  background: rgba(255,100,100,.15) !important;
  opacity: 1 !important;
  filter: none !important;
  pointer-events: auto !important;
}
/* ç·Šæ€¥/è‡¨æ™‚ã« .focused ãŒä»˜ã„ãŸã‚‰å¿…ãšé’æ ã‚’è¡¨ç¤ºï¼ˆâ€»ç”»é¢è¡¨ç¤ºå°‚ç”¨ï¼‰ */
@media screen {
  .slot.emergency-slot.focused,
  .slot.temp-slot.focused {
    outline: 2px solid #2563eb;
    outline-offset: -2px;
  }
}

/* â˜… ã‚¹ãƒŠãƒƒãƒ—çµ±ä¸€ï¼šãƒ–ãƒ©ã‚¦ã‚¶ã®æ»‘ã‚‰ã‹ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç„¡åŠ¹åŒ– */
html, body, #schedule, .day, .day .slots {
  scroll-behavior: auto;
}

.eye-mark{
  color: #b91c1c;      /* èµ¤ */
  font-weight: bold;
}

/* çµåˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼†ãƒ©ãƒ™ãƒ«ã‚’éè¡¨ç¤ºã«ã—ãŸã„å ´åˆï¼ˆä»»æ„ï¼‰ */
#mergeSlots,
label[for="mergeSlots"] {
  display: none;
}

/* é€£ç¶šé¸æŠã•ã‚Œã¦ã„ã‚‹ã‚¹ãƒ­ãƒƒãƒˆè‡ªä½“ã®è¦‹ãŸç›®ï¼ˆè–„ã„èƒŒæ™¯ã ã‘ã«ã™ã‚‹ä¾‹ï¼‰ */
.slot.multiSelected {
  background-color: rgba(0, 0, 255, 0.04);  /* ã»ã‚“ã®ã‚Šé’ç³»ã§ã‚‚ã‚°ãƒ¬ãƒ¼ã§ã‚‚ */
  outline: none;
}
/* ã‚¹ãƒ­ãƒƒãƒˆã®ç¸¦ä¸¦ã³ã‚³ãƒ³ãƒ†ãƒŠ */
.slots {
  position: relative; /* é’æ ã‚’ä¸­ã§çµ¶å¯¾é…ç½®ã™ã‚‹ãŸã‚ */
}
/* é€£ç¶šé¸æŠå…¨ä½“ã‚’å›²ã‚€å¤–å‘¨é’æ  */
.multiRangeOutline {
  position: absolute;
  left: 0;
  right: 0;
  top: 0;              /* â† é‡è¦ï¼šå¤–å‘¨ã‚’æ ä½ç½®ã«åˆã‚ã›ã‚‹ãŸã‚ */
  border: 2px solid #2563eb;      /* â† å˜æ ã¨åŒã˜è‰²ã¸çµ±ä¸€ */
  border-radius: 0px;              /* â† è§’ãªã—ï¼ˆå˜æ ã«åˆã‚ã›ã‚‹ï¼‰ */
  pointer-events: none;
  box-sizing: border-box;
}
  </style>
  <style>
   #helpBtn{
     position: fixed; top: 12px; right: 12px;
     width: 32px; height: 32px; line-height: 32px;
     padding: 0; font: inherit; font-size: 16px;
     border: 1px solid #ddd; border-radius: 50%;
     background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,.08);
     text-align: center; cursor: pointer; z-index: 10000;
   }
    #helpBtn:hover{ box-shadow: 0 4px 16px rgba(0,0,0,.12); }
    @media print{ #helpBtn{ display: none !important; } }
	
    /* Help dialog basic styling */
    #helpDialog{ border:none; padding:0; }
    #helpDialog::backdrop{ background: rgba(0,0,0,.35); }
    #helpDialog > div{
      max-height: min(70vh, 600px);
      overflow:auto;
      background:#fff;
      border-radius:12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
    }
    #helpDialog h2{ margin:0 0 .5rem; font-size:1.1rem; }
    #helpCloseBtn{
      display:block; margin:16px 0 0 auto;
      height:32px; padding:0 12px; border:1px solid #ddd;
      border-radius:8px; background:#fff; cursor:pointer;
    }
    @media print{ #helpDialog{ display:none !important; } }

    /* help content: keyboard key, table */
    #helpDialog kbd{
      display:inline-block; min-width:1.6em; padding:.15em .4em;
      border:1px solid #ccc; border-bottom-width:2px; border-radius:6px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:.92em; background:#f8f8f8;
    }
    #helpDialog table.help-table{
      width:100%; border-collapse:collapse; margin:.5rem 0 0;
      font-size:.95em;
    }
    #helpDialog table.help-table th,
    #helpDialog table.help-table td{
      border-top:1px solid #eee; padding:.5rem .25rem; text-align:left; vertical-align:top;
    }
    #helpDialog table.help-table th{ width:32%; font-weight:600; }
	
/* ã‚°ãƒ«ãƒ¼ãƒ—å…¨ä½“ã‚’å³ç«¯ã«å¯„ã›ã¦ã€ãƒœã‚¿ãƒ³åŒå£«ã¯ãã£ã¡ã‚Šè©°ã‚ã‚‹ */
.json-controls {
  display: inline-flex;
  align-items: center;
  gap: 4px;           /* ãƒœã‚¿ãƒ³é–“ã®ã™ãé–“ */
  margin-left: auto;  /* ã“ã“ã§ã€Œå³å¯„ã›ã€ã®å½¹å‰²ã‚’æ‹…å½“ */
}

/* ? ãƒœã‚¿ãƒ³ã¯ã‚°ãƒ«ãƒ¼ãƒ—ã®ã™ãå³ã«è»½ããã£ã¤ã‘ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ */
#helpBtn {
  margin-left: 4px !important;  /* ã‚‚ã—å…ƒCSSã§ auto ã«ãªã£ã¦ã„ã¦ã‚‚ä¸Šæ›¸ã */
}

/* ä¿å­˜æƒ…å ±ã®æ–‡å­—ã‚’å°‘ã—ã ã‘å°ã•ãï¼†æŠ˜ã‚Šè¿”ã—ã«ãã */
#saveInfo.save-info {
  margin-left: 8px;
  white-space: nowrap;
  font-size: 11px;
}

/* èª­è¾¼ãƒ»ä¿å­˜ãƒœã‚¿ãƒ³ã®ä½™ç™½ã‚’å°‘ãªã‚ã« */
#loadJsonBtn,
#saveJsonBtn {
  margin-left: 0;
  margin-right: 0;
}

	/* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è¡¨ç¤ºã§ã¯ 2På°åˆ·ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º */
body.dayFocus #printWeek2pBtn {
  display: none !important;
}



.iol-table-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  column-gap: 12px;
  row-gap: 0;              /* â˜… è¡Œé–“ã‚¹ã‚­ãƒãªã— */
  margin-top: 4px;
}


.iol-header,
.iol-cell {
  margin: 0;
  padding: 2px 8px;        /* â˜… ç¸¦æ–¹å‘ã®ä½™ç™½ã‚’å°ã•ã */
  font-size: 13px;
}
/* IOLã®å„è¡Œï¼ˆç¨®é¡ãƒ»åº¦æ•°ãƒ»ç”¨é€”ï¼‰ã‚’æ¨ªä¸¦ã³ã§çµ±ä¸€ */
.iol-cell {
  display: flex;
  align-items: center;
  gap: 4px;
}

/* ç¨®é¡ãƒ»åº¦æ•°ãƒ»ç”¨é€”ï¼šã‚°ãƒ¬ãƒ¼æ ã®ä¸­ã§å°‘ã—å¹…åºƒã« */
.iol-input,
.iol-select {
  width: 6.5em;        /* â˜… ã“ã“ã‚’åºƒã’ã‚‹ã ã‘ï¼ˆ6.5ã€œ8emãã‚‰ã„ã§å¥½ã¿èª¿æ•´OKï¼‰ */
  padding: 1px 3px;
  height: 1.8em;
  box-sizing: border-box;
}

/* IOLâ‘  ãƒ˜ãƒƒãƒ€ */
.iol-table-grid > .iol-header:nth-child(1) {
  background: #fafafa;
  border: 1px solid #ddd;
  border-bottom: none;
  border-radius: 4px 4px 0 0;
  padding: 4px 8px;
}

/* IOLâ‘  ç¨®é¡ãƒ»åº¦æ•°è¡Œ */
/* IOLâ‘  ç¨®é¡è¡Œï¼ˆå¸¸ã«ä¸­æ®µï¼‰ */
.iol-table-grid > .iol-cell:nth-child(4) {
  background: #fafafa;
  border-left: 1px solid #ddd;
  border-right: 1px solid #ddd;
  padding: 4px 8px;
}

/* IOLâ‘  åº¦æ•°è¡Œï¼šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã“ã“ã§ã‚«ãƒ¼ãƒ‰ã‚’é–‰ã˜ã‚‹ */
.iol-table-grid > .iol-cell:nth-child(7) {
  background: #fafafa;
  border-left: 1px solid #ddd;
  border-right: 1px solid #ddd;
  border-bottom: 1px solid #ddd;
  border-radius: 0 0 4px 4px;
  padding: 4px 8px;
}

/* IOLâ‘  ç”¨é€”è¡Œï¼ˆshowIolUseæ™‚ã ã‘ä¸‹ç«¯ã¨ã—ã¦è¡¨ç¤ºï¼‰ */
#editor.showIolDetail .iol-table-grid > .iol-cell:nth-child(10) {
  background: #fafafa;
  border: 1px solid #ddd;
  border-top: none;
  border-radius: 0 0 4px 4px;
  padding: 4px 8px;
}

/* showIolUseä¸­ã¯åº¦æ•°è¡Œã‚’ä¸­æ®µæ‰±ã„ã«å¤‰æ›´ */
#editor.showIolDetail .iol-table-grid > .iol-cell:nth-child(7) {
  border-bottom: none;
  border-radius: 0;
}

/* IOLâ‘¡ ãƒ˜ãƒƒãƒ€ */
.iol-table-grid > .iol-header:nth-child(2) {
  background: #fafafa;
  border: 1px solid #ddd;
  border-bottom: none;
  border-radius: 4px 4px 0 0;
  padding: 4px 8px;
}

/* IOLâ‘¡ ç¨®é¡è¡Œ */
.iol-table-grid > .iol-cell:nth-child(5) {
  background: #fafafa;
  border-left: 1px solid #ddd;
  border-right: 1px solid #ddd;
  padding: 4px 8px;
}

/* IOLâ‘¡ åº¦æ•°è¡Œï¼šé€šå¸¸ã¯ã“ã“ã§ã‚«ãƒ¼ãƒ‰ã‚’é–‰ã˜ã‚‹ */
.iol-table-grid > .iol-cell:nth-child(8) {
  background: #fafafa;
  border-left: 1px solid #ddd;
  border-right: 1px solid #ddd;
  border-bottom: 1px solid #ddd;
  border-radius: 0 0 4px 4px;
  padding: 4px 8px;
}

/* IOLâ‘¡ ç”¨é€”è¡Œï¼šè©³ç´°è¡¨ç¤ºæ™‚ã ã‘ä¸‹ç«¯ã«ã™ã‚‹ */
#editor.showIolDetail .iol-table-grid > .iol-cell:nth-child(11) {
  background: #fafafa;
  border: 1px solid #ddd;
  border-top: none;            /* â˜… ã“ã“ã§äºŒé‡ç·šã‚’é˜²ã */
  border-radius: 0 0 4px 4px;
  padding: 4px 8px;
}

/* è©³ç´°è¡¨ç¤ºä¸­ã¯åº¦æ•°è¡Œã‚’ä¸­æ®µæ‰±ã„ã«å¤‰æ›´ */
#editor.showIolDetail .iol-table-grid > .iol-cell:nth-child(8) {
  border-bottom: none;         /* â˜… ä¸‹ã®ç·šã‚’æ¶ˆã—ã¦ç”¨é€”ã«å¼•ãç¶™ã */
  border-radius: 0;
}


/* IOLâ‘¢ ãƒ˜ãƒƒãƒ€ */
.iol-table-grid > .iol-header:nth-child(3) {
  background: #fafafa;
  border: 1px solid #ddd;
  border-bottom: none;
  border-radius: 4px 4px 0 0;
  padding: 4px 8px;
}

/* IOLâ‘¢ ç¨®é¡è¡Œ */
.iol-table-grid > .iol-cell:nth-child(6) {
  background: #fafafa;
  border-left: 1px solid #ddd;
  border-right: 1px solid #ddd;
  padding: 4px 8px;
}

/* IOLâ‘¢ åº¦æ•°è¡Œï¼šé€šå¸¸ã¯ã“ã“ã§ã‚«ãƒ¼ãƒ‰ã‚’é–‰ã˜ã‚‹ */
.iol-table-grid > .iol-cell:nth-child(9) {
  background: #fafafa;
  border-left: 1px solid #ddd;
  border-right: 1px solid #ddd;
  border-bottom: 1px solid #ddd;
  border-radius: 0 0 4px 4px;
  padding: 4px 8px;
}

/* IOLâ‘¢ ç”¨é€”è¡Œï¼šè©³ç´°è¡¨ç¤ºæ™‚ã ã‘ä¸‹ç«¯ã«ã™ã‚‹ */
#editor.showIolDetail .iol-table-grid > .iol-cell:nth-child(12) {
  background: #fafafa;
  border: 1px solid #ddd;
  border-top: none;            /* â˜… äºŒé‡ç·šé˜²æ­¢ */
  border-radius: 0 0 4px 4px;
  padding: 4px 8px;
}

/* è©³ç´°è¡¨ç¤ºä¸­ã¯åº¦æ•°è¡Œã‚’ä¸­æ®µæ‰±ã„ã«å¤‰æ›´ */
#editor.showIolDetail .iol-table-grid > .iol-cell:nth-child(9) {
  border-bottom: none;         /* â˜… ä¸‹ç·šã‚’ç”¨é€”ã«è­²ã‚‹ */
  border-radius: 0;
}


/* â‘  IOLâ‘¡ãƒ»â‘¢ã®ã‚»ãƒ«ï¼šä½ç½®ã¯ç¶­æŒã—ã¦ä¸­èº«ã ã‘éš ã™ */
.iol-extra-cell {
  visibility: hidden;   /* â† display:none ã‚’ã‚„ã‚ã¦ visibility ã§éš ã™ */
}

/* â‘¡ ç”¨é€”è¡Œã¯è¡Œã”ã¨æ¶ˆã—ãŸã„ã®ã§ display:none ã®ã¾ã¾ */
.iol-use-cell {
  display: none;
}

/* â‘¢ è©³ç´°è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼šIOLâ‘¡ãƒ»â‘¢ï¼‹ç”¨é€”ã‚’ã„ã£ã—ã‚‡ã«è¡¨ç¤º */
#editor.showIolDetail .iol-extra-cell {
  visibility: visible;
}

#editor.showIolDetail .iol-use-cell {
  display: flex;        /* ä»–ã® .iol-cell ã¨åŒã˜ flex ã§è¡¨ç¤º */
}

@media screen {
  body.arrivalModeOn .slot.focused,
  body.arrivalModeOn .slot.emergency-slot.focused,
  body.arrivalModeOn .slot.temp-slot.focused{
    outline: none !important;
    box-shadow: none !important;
  }
  body.arrivalModeOn .multiRangeOutline{
    display:none !important;
  }
}
@media screen{
  /* é¸æŠæ ï¼šæ ç·šã ã‘ï¼ˆãƒ‡ãƒ¼ã‚¿å…¥ã‚Šã®è‰²ã¯æ½°ã•ãªã„ï¼‰ */
  body:not(.arrivalModeOn) .slot.focused{
    outline: 2px solid #2563eb;
    outline-offset: -2px;
    /* background ã¯æ›¸ã‹ãªã„ï¼ */
  }

  /* ç©ºæ ã ã‘ï¼šè–„é’èƒŒæ™¯ã‚’ä»˜ã‘ã‚‹ */
  body:not(.arrivalModeOn) .slot.focused.empty{
    background: rgba(37,99,235,0.06);
  }
}

/* ===== IOL â—ï¼ˆç™ºæ³¨æ¸ˆï¼‰ ===== */
.iol-dot{
  display:inline-block;
  margin-left:2px;
  font-size:12px;
  line-height:1;
  color:#dc2626;         /* èµ¤ */
  opacity:.85;
  user-select:none;
  pointer-events:none;   /* é€šå¸¸ã¯è§¦ã‚Œãªã„ */
  position:relative;     /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—åŸºæº– */
}

.iol-dot.is-off{ opacity:.20; }

/* é€šå¸¸æ™‚ï¼šç™ºæ³¨æ¸ˆ(true)ã ã‘è¡¨ç¤ºï¼ˆarrival ã¨åŒã˜æ€æƒ³ï¼‰ */
body:not(.iolModeOn) .iol-dot.is-off{ display:none !important; }

/* IOLãƒ¢ãƒ¼ãƒ‰ä¸­ï¼šâ—ã‚’æ“ä½œå¯èƒ½ã« */
body.iolModeOn .iol-dot{
  pointer-events:auto;
  cursor:pointer;
  position: relative;
}

body.iolModeOn .iol-dot::before{
  content:"";
  position:absolute;
  left:-8px;
  top:-8px;
  width:22px;
  height:22px;
  /* è¦‹ãˆãªã„ */
  background:transparent;
  border-radius:12px;
  /* ã“ã“ãŒé‡è¦ï¼šã‚¯ãƒªãƒƒã‚¯åˆ¤å®šã‚’ã“ã®ç–‘ä¼¼è¦ç´ ã«ã‚‚ä¹—ã›ã‚‹ */
  pointer-events:auto;
}

/* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ï¼šå³å´ã«å‡ºã™ï¼ˆå·¦è¦‹åˆ‡ã‚Œå›é¿ï¼‰ */
body.iolModeOn .iol-dot:hover::after{
  content:"IOLç¢ºèªæ¸ˆ";
  position:absolute;
  left: calc(100% + 12px);  /* â† å³ã«é€ƒãŒã™ï¼ˆ8â†’12pxï¼‰ */
  top: 50%;
  transform: translateY(-50%);
  background: rgba(0,0,0,.85);
  color: #fff;
  font-size: 12px;
  padding: 4px 8px;
  border-radius: 8px;
  white-space: nowrap;
  z-index: 9999;
  pointer-events: none;
}

/* IOLãƒ‰ãƒƒãƒˆã®ãƒ›ãƒãƒ¼ãŒè¦‹åˆ‡ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ */
.slot,
.slot .content,
.slot .content-left{
  overflow: visible !important;
}

 body.iolModeOn #iolModeBtn{
   background:#dc2626;
   color:#fff;
   border-color:#991b1b;
   font-weight:700;
 }
 /* âœ“ãƒœã‚¿ãƒ³ã¨åŒå¯¸ã«ã™ã‚‹ */
#iolModeBtn{
  width: 32px;
  height: 32px;
  padding: 0;
  line-height: 32px;
  font-size: 16px;
  /* â˜… é€šå¸¸æ™‚ã‚‚ã€ŒIOL=èµ¤ã€ã‚’åˆ†ã‹ã‚‹ã‚ˆã†ã« */
  border-color: #bbb;
  color: #dc2626;
}
/* ===== IOLç¢ºèªãƒ¢ãƒ¼ãƒ‰ä¸­ï¼šâ—ä»¥å¤–ã®æ“ä½œã‚’ãƒ–ãƒ­ãƒƒã‚¯ ===== */
body.iolModeOn #schedule{ pointer-events:none; }
body.iolModeOn .topbar .group *{ pointer-events:none; }

/* ä¾‹å¤–ï¼šãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã¨â—ã ã‘è§¦ã‚Œã‚‹ */
body.iolModeOn #iolModeBtn{ pointer-events:auto; }
body.iolModeOn .iol-dot{ pointer-events:auto; }

/* ===== IOLç¢ºèªãƒ¢ãƒ¼ãƒ‰ä¸­ï¼šé¸æŠã‚¹ãƒ­ãƒƒãƒˆã®é’ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’æ¶ˆã™ ===== */
body.iolModeOn .slot.focused,
body.iolModeOn .slot.is-selected,
body.iolModeOn .slot.multiSelected {
  outline: none !important;
  box-shadow: none !important;
}
body.iolModeOn .multiRangeOutline{ display:none !important; }

#iolModeBanner{
  position: fixed;
  top: 56px;        /* arrivalã¨åŒã˜é«˜ã•ã§OK */
  left: 12px;
  z-index: 2000;
  padding: 6px 10px;
  border: 1px solid #e5e7eb;
  background: rgba(255,255,255,.98);
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0,0,0,.10);
  font-size: 12px;
  display: none;
}

body.iolModeOn #iolModeBanner{
  display: block;
}

#todoListExec {
  display: none;
}

/* ===== ãƒ¢ãƒ¼ãƒ‰ä¸­ï¼šãƒˆãƒƒãƒ—ãƒãƒ¼å†…ã¯ã™ã¹ã¦é€šå¸¸ã‚«ãƒ¼ã‚½ãƒ«ï¼ˆâ‡–ï¼‰ã«çµ±ä¸€ ===== */
body.arrivalModeOn .topbar *,
body.iolModeOn .topbar *,
body.pathModeOn .topbar *{
  cursor: default !important;
}

/* ä¾‹å¤–ï¼šãƒ¢ãƒ¼ãƒ‰è§£é™¤ãƒœã‚¿ãƒ³ã ã‘ã¯ pointer ã«æˆ»ã™ */
body.arrivalModeOn #arrivalModeBtn,
body.iolModeOn #iolModeBtn,
body.pathModeOn #pathModeBtn{
  cursor: pointer !important;
}
/* ===== ãƒ¢ãƒ¼ãƒ‰ä¸­ï¼šãƒˆãƒƒãƒ—ãƒãƒ¼ã® hover/active/focus ã‚’ç„¡åŠ¹åŒ–ï¼ˆãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³è‡ªèº«ã¯é™¤å¤–ï¼‰ ===== */
body.arrivalModeOn .topbar *:hover:not(#arrivalModeBtn):not(#iolModeBtn):not(#pathModeBtn),
body.arrivalModeOn .topbar *:active:not(#arrivalModeBtn):not(#iolModeBtn):not(#pathModeBtn),
body.arrivalModeOn .topbar *:focus:not(#arrivalModeBtn):not(#iolModeBtn):not(#pathModeBtn),
body.iolModeOn .topbar *:hover:not(#arrivalModeBtn):not(#iolModeBtn):not(#pathModeBtn),
body.iolModeOn .topbar *:active:not(#arrivalModeBtn):not(#iolModeBtn):not(#pathModeBtn),
body.iolModeOn .topbar *:focus:not(#arrivalModeBtn):not(#iolModeBtn):not(#pathModeBtn),
body.pathModeOn .topbar *:hover:not(#arrivalModeBtn):not(#iolModeBtn):not(#pathModeBtn),
body.pathModeOn .topbar *:active:not(#arrivalModeBtn):not(#iolModeBtn):not(#pathModeBtn),
body.pathModeOn .topbar *:focus:not(#arrivalModeBtn):not(#iolModeBtn):not(#pathModeBtn){
  background: none !important;
  box-shadow: none !important;
  filter: none !important;
  outline: none !important;
}

/* æœªå®Œäº†ãƒªã‚¹ãƒˆç”¨ å°ãƒ‰ãƒƒãƒˆ */
.todo-dot{
  display:inline-block;
  width:6px;
  height:6px;
  border-radius:50%;
  vertical-align:middle;
  margin:0 4px;
}

.todo-dot.iol{
  background:#dc2626;   /* èµ¤ï¼ˆIOLï¼‰ */
}

.todo-dot.path{
  background:#111827;   /* é»’ï¼ˆãƒ‘ã‚¹ï¼‰ */
}


  </style>
  </head>
<body>
  <header class="topbar">
    <div class="group">
      <button id="prevWeek">Â« å‰é€±</button>
      <input type="date" id="weekPicker" />
      <button id="nextWeek">æ¬¡é€± Â»</button>
      <button id="todayBtn">ä»Šé€±</button>
ã€€ã€€ã€€ <button id="settingsBtn">è¨­å®š</button>
      <button id="printBtn">å°åˆ·</button>
	  <button id="printWeek2pBtn">2På°åˆ·</button>
    </div>
    <div class="group">
      <button id="editBtn" class="primary">ç·¨é›†</button>
      <button id="undoBtn">å…ƒã«æˆ»ã™</button>
      <button id="redoBtn">ã‚„ã‚Šç›´ã—</button>
    </div>
    <div class="group" aria-label="ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆ‡æ›¿">
      <span>ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ:</span>
      <button id="mode2col">2åˆ—</button>
      <button id="mode4col">4åˆ—</button>
      <button id="mode5col">5åˆ—</button>
      <button id="arrivalModeBtn" title="æ¥é™¢æ™‚åˆ»âœ“ (Ctrl+K)">âœ“</button>
	  <button id="iolModeBtn" class="modeBtn" title="IOLãƒ»DEVç¢ºèª">â—</button>	  
	  <button id="pathModeBtn" class="modeBtn" title="ãƒ‘ã‚¹å…¥åŠ›æ¸ˆ">â—</button>
	  <button id="globalSearchBtn" title="å…¨é€±æ¤œç´¢">ğŸ”</button>
	  <button id="todoListBtn" title="æœªå®Œäº†ãƒªã‚¹ãƒˆï¼ˆâœ“/â—ï¼‰">ğŸ“‹</button>
    </div>
  </header>
  <main id="schedule">
    <div class="column" id="leftCol"></div>
    <div class="column" id="rightCol"></div>
  </main>

<!-- â–¼ ç·¨é›†ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆæ—§ç‰ˆã¨äº’æ›ã®æœ€å°é …ç›®ï¼‰ -->
<dialog id="editor">
  <form id="editorForm" method="dialog" style="min-width:520px;max-width:720px">
    <h3 id="editorTitle" style="margin:0 0 8px;font-size:16px">æ ã®ç·¨é›†</h3>
<div style="display:grid;grid-template-columns:120px 1fr;gap:8px;align-items:center">
  <!-- åŸºæœ¬æƒ…å ± -->
  <label>æ°å</label><input name="name" />
  <label>æ‚£è€…ID</label><input name="pid" />
  <label>å¹´é½¢</label><input name="age" />
  
    <!-- å…¥å¤–å½“ã‚’å…ˆã«å›ºã‚ã‚‹ -->
  <label>å…¥/å¤–/å½“æ—¥å…¥é™¢</label>
  <select name="io">
    <option></option><option>å…¥</option><option>å¤–</option><option>å½“</option>
  </select>
  
  <label>çœ¼</label>
  <div style="display:flex; align-items:center; gap:8px;">
    <select name="eye" style="width:5em;">
      <option value=""></option>
      <option>R</option>
      <option>L</option>
      <option>B</option>
    </select>

    <label for="rlSet" style="white-space:nowrap; font-size:13px;">
      <input type="checkbox" id="rlSet" name="rlSet">
      å¯¾çœ¼ã‚‚é€£ç¶šä½œæˆï¼ˆRLã‚»ãƒƒãƒˆï¼‰
    </label>
  </div>

  <!-- æ¬¡ã«è¡“è€… -->
  <label>è¡“è€…</label>
  <div style="display:flex;gap:4px;align-items:center;">
    <select name="surgeon" style="min-width:7em;"></select>
    <input name="surgeonFree" placeholder="ãã®ä»–ï¼ˆè‡ªç”±å…¥åŠ›ï¼‰" style="flex:1;">
  </div>

  <!-- è¡“å¼1ãƒ»2 -->
  <label>è¡“å¼1</label><input name="proc1" />
  <label>
    è¡“å¼2
    <span style="font-size:11px;color:#777;margin-left:4px;">ï¼ˆãƒ‡ãƒã‚¤ã‚¹ç³»ï¼‰</span>
  </label>
  <input name="proc2"
         placeholder="ä¾‹ï¼‰iStent / ã‚¢ãƒ¼ãƒ¡ãƒ‰ / Preserflo / æ¶™ç‚¹ãƒ—ãƒ©ã‚° ãªã©" />

  <!-- å‚™è€ƒ -->
  <label>å‚™è€ƒ</label><textarea name="note" rows="3" style="resize:vertical"></textarea>

  <!-- â–¼ æ–° IOL 3ã‚«ãƒ©ãƒ ãƒ–ãƒ­ãƒƒã‚¯ -->
<label>IOLæƒ…å ±</label>
<div>
  <div class="iol-table-grid">
    <!-- â–¼ 1è¡Œç›®ï¼šãƒ˜ãƒƒãƒ€ -->
    <div class="iol-header">IOLâ‘ </div>
	<div class="iol-header iol-extra-cell">IOLâ‘¡</div>
	<div class="iol-header iol-extra-cell">IOLâ‘¢</div>

    <!-- â–¼ 2è¡Œç›®ï¼šç¨®é¡ -->
    <div class="iol-cell">
      ç¨®é¡ <input name="iolType"   list="iolTypes"  class="iol-input">
    </div>
    <div class="iol-cell iol-extra-cell">
      ç¨®é¡ <input name="iolType2"  list="iolTypes"  class="iol-input">
    </div>
    <div class="iol-cell iol-extra-cell">
      ç¨®é¡ <input name="iolType3"  list="iolTypes"  class="iol-input">
    </div>

    <!-- â–¼ 3è¡Œç›®ï¼šåº¦æ•° -->
    <div class="iol-cell">
      åº¦æ•° <input name="iolPower"  list="iolPowers" class="iol-input">
    </div>
    <div class="iol-cell iol-extra-cell">
      åº¦æ•° <input name="iolPower2" list="iolPowers" class="iol-input">
    </div>
    <div class="iol-cell iol-extra-cell">
      åº¦æ•° <input name="iolPower3" list="iolPowers" class="iol-input">
    </div>

    <!-- â–¼ 4è¡Œç›®ï¼šç”¨é€” -->
    <div class="iol-cell iol-use-cell">
      ç”¨é€”
      <input name="iolUse1" class="iol-input" list="iolUses">
    </div>
    <div class="iol-cell iol-use-cell">
      ç”¨é€”
      <input name="iolUse2" class="iol-input" list="iolUses">
    </div>
    <div class="iol-cell iol-use-cell">
      ç”¨é€”
      <input name="iolUse3" class="iol-input" list="iolUses">
    </div>
  </div> <!-- /.iol-table-grid -->

  <div style="text-align:right; font-size:11px; margin-top:2px;">
    <button type="button"
            id="toggleIolUseRow"
            style="border:none; background:none; color:#2563eb; cursor:pointer; padding:0;">
      IOLâ‘¡ãƒ»â‘¢ã‚’è¡¨ç¤º
    </button>
  </div>
</div>



  <!-- å…¥é€€å®¤æ™‚é–“ -->
<label>å…¥é€€å®¤æ™‚é–“</label>
<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
  <input name="durationH" type="text" inputmode="numeric" style="width:2.5em" placeholder="0">
  <span>æ™‚é–“</span>
  <input name="durationM" type="text" inputmode="numeric" style="width:2.5em" placeholder="0">
  <span>åˆ†</span>

  <!-- å³ç«¯ã®æ³¨é‡ˆ -->
  <span style="font-size:12px;color:#666;white-space:nowrap; margin-left:8px;">
    ï¼ˆæœªå…¥åŠ›ï¼20åˆ†ï¼‰
  </span>
</div>

  <!-- çµåˆï¼ˆæ æ•°ï¼‰ã¯éè¡¨ç¤ºã®ã¾ã¾ç¶­æŒ -->
  <label style="display:none">çµåˆï¼ˆæ æ•°ï¼‰</label>
  <div style="display:none">
    <input type="checkbox" id="mergeSlots" name="mergeSlots">
    <label for="mergeSlots">ã“ã®æ ã‹ã‚‰</label>
    <input name="mergeSpan" type="number" min="1" value="1" style="width:5em"> æ 
  </div>

  <!-- æ„ŸæŸ“ç—‡ -->
  <label>æ„ŸæŸ“ç—‡</label>
  <div style="display:flex;gap:12px;align-items:center">
    <label><input type="radio" name="infection" value="ãªã—"> ãªã—</label>
    <label><input type="radio" name="infection" value="ã‚ã‚Š"> ã‚ã‚Š</label>
    <label><input type="radio" name="infection" value=""> æœªé¸æŠ</label>
  </div>

  <!-- å…¨éº» -->
  <label>å…¨éº»</label>
  <div>
    <input type="checkbox" id="ga" name="ga">
  </div>

  <!-- å±€éº»ï¼ˆæ–œè¦–ç­‰ã®ã¿ï¼‰ -->
  <label>
    å±€éº»
    <span style="font-size:11px;color:#555;margin-left:4px;">ï¼ˆæ–œè¦–ç­‰ã®ã¿ï¼‰</span>
  </label>
  <div>
    <input type="checkbox" id="local" name="local">
  </div>

</div>




    <menu style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button type="button" value="clear" style="color:#b91c1c">ã‚¯ãƒªã‚¢</button>
      <button value="cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button value="save" class="primary">ä¿å­˜</button>
    </menu>
  </form>
</dialog>

<!-- datalistï¼ˆIOLå€™è£œï¼‰ -->
<datalist id="iolTypes"></datalist>
<datalist id="iolPowers"></datalist>
<datalist id="iolUses">
  <option value="in">
  <option value="out">
  <option value="fix">
</datalist>


  <template id="slotTemplate">
    <div class="slot" draggable="false">
      <div class="time"></div>
      <div class="content">
		<span class="arrival-check" hidden>âœ“</span>
        <span class="content-left"></span>
        <span class="surgeon-tag" title="è¡“è€…"></span>
      </div>
    </div>
  </template>

<!-- â–¼â–¼ é¸æŠè‚¢ã®ä¾›çµ¦å…ƒï¼šdatalistï¼ˆã‚¨ãƒ‡ã‚£ã‚¿ã®å…¥åŠ›æ¬„ã® list="" ã‹ã‚‰å‚ç…§ï¼‰ -->
<datalist id="iolTypes"></datalist>
<datalist id="procList"></datalist>
<datalist id="procList2"></datalist>
<datalist id="surgeonsList"></datalist>

<!-- â–¼â–¼ è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
<dialog id="settings" style="width:min(720px, 92vw); padding:16px;">
  <form id="settingsForm" method="dialog" style="display:flex; flex-direction:column; gap:12px;">
    <h3 style="margin:0 0 8px;">å€™è£œãƒªã‚¹ãƒˆã®ç·¨é›†</h3>

    <label style="display:flex; gap:8px;">
      <span style="width:120px; padding-top:6px;">IOLç¨®é¡</span>
      <textarea id="optIolTypes" rows="4" style="flex:1;"></textarea>
    </label>

    <label style="display:flex; gap:8px;">
      <span style="width:120px; padding-top:6px;">è¡“å¼ï¼‘</span>
      <textarea id="optProc1" rows="4" style="flex:1;"></textarea>
    </label>

    <label style="display:flex; gap:8px;">
      <span style="width:120px; padding-top:6px;">è¡“å¼ï¼’</span>
      <textarea id="optProc2" rows="4" style="flex:1;"></textarea>
    </label>

    <label style="display:flex; gap:8px;">
      <span style="width:120px; padding-top:6px;">è¡“è€…</span>
      <textarea id="optSurgeons" rows="4" style="flex:1;"></textarea>
    </label>

    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
      <button value="cancel">é–‰ã˜ã‚‹</button>
      <button class="primary" id="settingsSaveBtn" value="save">ä¿å­˜</button>
    </div>
  </form>
</dialog>

<dialog id="globalSearchDialog">
  <form method="dialog" style="min-width:520px;max-width:720px;padding:16px">
    <h3 style="margin:0 0 8px;">å…¨é€±æ¤œç´¢</h3>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
      <input id="globalSearchInput" placeholder="æ‚£è€…å ã¾ãŸã¯ ID" style="flex:1">
      <button id="globalSearchExec" type="button" class="primary">æ¤œç´¢</button>
    </div>
    <div id="globalSearchResult" style="max-height:50vh;overflow:auto;font-size:13px;"></div>
    <menu style="display:flex;justify-content:flex-end;margin-top:8px">
      <button value="cancel">é–‰ã˜ã‚‹</button>
    </menu>
  </form>
</dialog>

  <script>
  "use strict";

  // ===== åŸºæœ¬è¨­å®š =====
  const CONFIG = {
    Mon: [{ title: "åˆå‰ï¼ˆæ‰‹è¡“å®¤1ï¼‰", start: "09:30", slots: 8 }],
    Tue: [
      { title: "åˆå‰ï¼ˆæ‰‹è¡“å®¤1ï¼‰", start: "09:30", slots: 8 },
      { title: "åˆå¾Œï¼ˆæ‰‹è¡“å®¤1ï¼‰", start: "13:00", slots: 12 },
      { title: "åˆå¾Œï¼ˆæ‰‹è¡“å®¤8ï¼‰", start: "13:00", slots: 10 }
    ],
    Wed: [{ title: "åˆå‰ï¼ˆæ‰‹è¡“å®¤9ï¼‰", start: "09:30", slots: 8 }],
    Thu: [{ title: "åˆå‰ï¼ˆæ‰‹è¡“å®¤1ï¼‰", start: "09:30", slots: 8 }],
    Fri: [
      { title: "åˆå‰ï¼ˆæ‰‹è¡“å®¤1ï¼‰", start: "09:30", slots: 8 },
      { title: "åˆå¾Œï¼ˆæ‰‹è¡“å®¤1ï¼‰", start: "13:00", slots: 12 },
      { title: "åˆå¾Œï¼ˆæ‰‹è¡“å®¤8ï¼‰", start: "13:00", slots: 10 }
    ],
    Weekend: [{ title: "é€±æœ«è‡¨æ™‚æ‰‹è¡“ï¼ˆSat/Sunï¼‰", start: "09:30", slots: 0 }]
  };


  // è¦ç´ å‚ç…§
  const leftCol  = document.getElementById('leftCol');
  const rightCol = document.getElementById('rightCol');
  const weekPicker = document.getElementById('weekPicker');
  const prevWeekBtn = document.getElementById('prevWeek');
  const nextWeekBtn = document.getElementById('nextWeek');
  const todayBtn        = document.getElementById('todayBtn');
  const printBtn        = document.getElementById('printBtn');
  const printWeek2pBtn  = document.getElementById('printWeek2pBtn');
  const slotTpl     = document.getElementById('slotTemplate');
  const mode2 = document.getElementById('mode2col');
  const mode4 = document.getElementById('mode4col');
  const mode5 = document.getElementById('mode5col');
  const editBtn     = document.getElementById('editBtn'); 
  const arrivalModeBtn = document.getElementById('arrivalModeBtn');
  const pathModeBtn    = document.getElementById('pathModeBtn');

  // ===== arrival âœ“ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼ˆStep2: éª¨çµ„ã¿ï¼‰=====
  let arrivalModeOn = false;
  let pathModeOn = false;
  let arrivalModeTimer = null;
  let pathModeTimer = null;
  let iolModeTimer = null;
  let arrivalModeLastActive = 0;
  let pathModeLastActive = 0;
  let iolModeLastActive = 0;

  function ensureArrivalBanner(){
    if (document.getElementById('arrivalModeBanner')) return;
    const b = document.createElement('div');
    b.id = 'arrivalModeBanner';
    b.textContent = 'âœ“ ç·¨é›†ä¸­ï¼ˆEscã§çµ‚äº†ï¼‰';
    document.body.appendChild(b);
  }
function ensureIolBanner(){
  if (document.getElementById('iolModeBanner')) return;
  const b = document.createElement('div');
  b.id = 'iolModeBanner';
  b.textContent = 'â— IOLç¢ºèªãƒ¢ãƒ¼ãƒ‰ä¸­ï¼ˆEscã§çµ‚äº†ï¼‰';
  document.body.appendChild(b);
}

function ensurePathBanner(){
  if (document.getElementById('pathModeBanner')) return;
  const b = document.createElement('div');
  b.id = 'pathModeBanner';
  b.textContent = 'â— ãƒ‘ã‚¹ç¢ºèªãƒ¢ãƒ¼ãƒ‰ä¸­ï¼ˆEscã§çµ‚äº†ï¼‰';
  document.body.appendChild(b);
}

  function scheduleArrivalAutoOff(){
    clearTimeout(arrivalModeTimer);
    arrivalModeTimer = setTimeout(()=>{
      const now = Date.now();
      if (arrivalModeOn && (now - arrivalModeLastActive) >= 30000){
        setArrivalMode(false);
      } else if (arrivalModeOn){
        scheduleArrivalAutoOff();
      }
    }, 1000);
  }

  function touchArrivalActivity(){
    arrivalModeLastActive = Date.now();
    if (arrivalModeOn) scheduleArrivalAutoOff();
  }

  function setArrivalMode(on){
    ensureArrivalBanner();
    arrivalModeOn = !!on;
    document.body.classList.toggle('arrivalModeOn', arrivalModeOn);
    if (arrivalModeOn){
      clearActiveSlot?.();   // â† æ—¢å­˜ã®é¸æŠè§£é™¤é–¢æ•°ï¼ˆã‚ã‚Œã°ï¼‰
ã€€   // â˜… arrivalãƒ¢ãƒ¼ãƒ‰é–‹å§‹æ™‚ï¼šRLå¤–æ /è¤‡æ•°é¸æŠ/å¤–æ æ®‹éª¸ã‚’å®Œå…¨ã‚¯ãƒªã‚¢ï¼ˆé’æ æ®‹ã‚Šå¯¾ç­–ï¼‰
ã€€   document.querySelectorAll('.multiRangeOutline').forEach(el => el.remove());
ã€€   document.querySelectorAll('.slot.multiSelected, .slot.is-selected, .slot.focused')
ã€€     .forEach(el => {
ã€€       el.classList.remove('multiSelected');
ã€€       el.classList.remove('is-selected');
ã€€       el.classList.remove('focused');
ã€€     });
ã€€   if (window.multiSelected) {
ã€€     try { window.multiSelected.clear(); } catch(_){}
ã€€   }
ã€€   window.currentRLSetId = null;	  
      touchArrivalActivity();
    } else {
      clearTimeout(arrivalModeTimer);
      arrivalModeTimer = null;
    }
  }

function scheduleIolAutoOff(){
  clearTimeout(iolModeTimer);
  iolModeTimer = setTimeout(()=>{
    const now = Date.now();
    if (iolModeOn && (now - iolModeLastActive) >= 30000){
      setIolMode(false);
    } else if (iolModeOn){
      scheduleIolAutoOff();
    }
  }, 1000);
}

function touchIolActivity(){
  iolModeLastActive = Date.now();
  if (iolModeOn) scheduleIolAutoOff();
}

function schedulePathAutoOff(){
  clearTimeout(pathModeTimer);
  pathModeTimer = setTimeout(()=>{
    const now = Date.now();
    if (pathModeOn && (now - pathModeLastActive) >= 30000){
      setPathMode(false);
    } else if (pathModeOn){
      schedulePathAutoOff();
    }
  }, 1000);
}
function touchPathActivity(){
  pathModeLastActive = Date.now();
  if (pathModeOn) schedulePathAutoOff();
}

function setPathMode(on){
  ensurePathBanner();
  pathModeOn = !!on;
  document.body.classList.toggle('pathModeOn', pathModeOn);

  // arrival / IOL ã¨æ’ä»–
  if (pathModeOn){
    setArrivalMode(false);
    setIolMode(false);
  }

  if (pathModeOn){
    clearActiveSlot?.();
    // é’æ æ®‹éª¸ã‚’æ¶ˆã™ï¼ˆarrival/IOLã¨åŒã˜ï¼‰
    document.querySelectorAll('.multiRangeOutline').forEach(el => el.remove());
    document.querySelectorAll('.slot.multiSelected, .slot.is-selected, .slot.focused')
      .forEach(el => {
        el.classList.remove('multiSelected');
        el.classList.remove('is-selected');
        el.classList.remove('focused');
      });
    if (window.multiSelected) { try { window.multiSelected.clear(); } catch(_){} }
    window.currentRLSetId = null;
    touchPathActivity();
  } else {
    clearTimeout(pathModeTimer);
    pathModeTimer = null;
  }
}  
  
  // ===== IOL â— ãƒ¢ãƒ¼ãƒ‰ =====
let iolModeOn = false;

function setIolMode(on){
	ensureIolBanner();
	
  iolModeOn = !!on;
  document.body.classList.toggle('iolModeOn', iolModeOn);

  // arrival ã¨æ’ä»–
  if (iolModeOn){
    setArrivalMode(false);
  }

  if (iolModeOn){
    clearActiveSlot?.();

    // arrival ã¨åŒã˜ãã€Œé’æ æ®‹éª¸ã€ã‚‚æ¶ˆã™
    document.querySelectorAll('.multiRangeOutline').forEach(el => el.remove());
    document.querySelectorAll('.slot.multiSelected, .slot.is-selected, .slot.focused')
      .forEach(el => {
        el.classList.remove('multiSelected');
        el.classList.remove('is-selected');
        el.classList.remove('focused');
      });
    if (window.multiSelected) {
      try { window.multiSelected.clear(); } catch(_){}
    }
    window.currentRLSetId = null;

    touchIolActivity();
  } else {
    clearTimeout(iolModeTimer);
    iolModeTimer = null;
  }
}



 // arrival âœ“ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼šç„¡æ“ä½œ30ç§’ã§è‡ªå‹•OFFï¼ˆæ´»å‹•æ¤œçŸ¥ï¼‰
 ['mousedown','mousemove','keydown','touchstart'].forEach(ev=>{
   document.addEventListener(ev, ()=>{
     if (arrivalModeOn) touchArrivalActivity();
	 if (iolModeOn)     touchIolActivity();
	 if (pathModeOn)    touchPathActivity();
   }, true);
 });

// â˜… ãƒ¢ãƒ¼ãƒ‰ä¸­ã¯ãƒŠãƒ“ç³»ã‚­ãƒ¼æ“ä½œã‚’æ­¢ã‚ã‚‹ï¼ˆarrival / IOL å…±é€šï¼‰
document.addEventListener('keydown', (e)=>{
  if (!(arrivalModeOn || iolModeOn || pathModeOn)) return;

  const t = e.target;
  const tag = t?.tagName?.toLowerCase();
  if (tag === 'input' || tag === 'textarea' || t?.isContentEditable) return;

  const keys = [
    'ArrowUp','ArrowDown','ArrowLeft','ArrowRight',
    'PageUp','PageDown','Home','End','Tab'
  ];
  if (keys.includes(e.key)){
    e.preventDefault();
    e.stopImmediatePropagation();
  }
}, true);
  
  arrivalModeBtn?.addEventListener('click', (e)=>{
    e.preventDefault();
    e.stopImmediatePropagation();
    setArrivalMode(!arrivalModeOn);
  });
  
iolModeBtn?.addEventListener('click', (e)=>{
  e.preventDefault();
  e.stopImmediatePropagation();
  setIolMode(!iolModeOn);
});  

pathModeBtn?.addEventListener('click', (e)=>{
  e.preventDefault();
  e.stopImmediatePropagation();
  setPathMode(!pathModeOn);
});

// â˜… ãƒ¢ãƒ¼ãƒ‰ä¸­ã¯ãƒˆãƒƒãƒ—ãƒãƒ¼ã®ãƒœã‚¿ãƒ³æ“ä½œã‚’å…¨éƒ¨æ­¢ã‚ã‚‹ï¼ˆarrival / IOL / path å…±é€šï¼‰
document.addEventListener('click', (e)=>{
  if (!(arrivalModeOn || iolModeOn || pathModeOn)) return;

  const btn = e.target.closest('button');
  if (!btn) return;

  // ä¾‹å¤–ï¼šãƒ¢ãƒ¼ãƒ‰è§£é™¤ã«å¿…è¦ãªãƒœã‚¿ãƒ³ã ã‘ã¯è¨±å¯
  if (btn.id === 'arrivalModeBtn' || btn.id === 'iolModeBtn' || btn.id === 'pathModeBtn') return;

  // ãƒˆãƒƒãƒ—ãƒãƒ¼å†…ã®ãƒœã‚¿ãƒ³ã¯å…¨éƒ¨æ­¢ã‚ã‚‹ï¼ˆãƒ˜ãƒ«ãƒ—/èª­è¾¼/ä¿å­˜ã‚‚å«ã‚ã¦ï¼‰
  if (btn.closest('.topbar')){
    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation();
  }
}, true);

// â˜… ãƒ‘ã‚¹ãƒ¢ãƒ¼ãƒ‰ä¸­ï¼šæ™‚åˆ»æ¨ªã®ãƒ‘ã‚¹ãƒ‰ãƒƒãƒˆï¼ˆ.path-checkï¼‰ã‚¯ãƒªãƒƒã‚¯ã§ãƒˆã‚°ãƒ«
document.addEventListener('click', (e)=>{
  if (!pathModeOn) return;

  const hit = e.target.closest('.path-check');
  if (!hit) return;

  const slot = e.target.closest('.slot');
  const key = slot?.dataset?.key;
  if (!key) return;

  const store = loadWeek(currentMonday) || {};
  const d = store[key];
  if (!d || d.tail) return;

  const io = (d.io || '').trim();
  if (!(io === 'å…¥' || io === 'å½“')) return;

  // pathDone ã‚’åè»¢ï¼ˆRLã‚»ãƒƒãƒˆãªã‚‰ç›¸æ–¹ã‚‚åŒã˜å€¤ã«æƒãˆã‚‹ï¼‰
  const newVal = !d.pathDone;
  d.pathDone = newVal;

  const rlId = d?.meta?.rlSetId;
  if (rlId){
    for (const k of Object.keys(store)){
      const r = store[k];
      if (!r || r.tail) continue;
      if (r?.meta?.rlSetId !== rlId) continue;
      const io2 = (r.io || '').trim();
      if (!(io2 === 'å…¥' || io2 === 'å½“')) continue;  // ãƒ‘ã‚¹å¯¾è±¡ã ã‘
      r.pathDone = newVal;                              // â† ç›¸æ–¹ã‚‚åŒæ™‚ã«æƒãˆã‚‹
    }
  }
  saveWeek(currentMonday, store);
  paintSlotsFromStore();

  e.preventDefault();
  e.stopPropagation();
  e.stopImmediatePropagation();
}, true);

// ===== arrival âœ“ ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ï¼ˆStep3-â‘¡ æœ¬ä½“ï¼‰=====
document.addEventListener('click', (e)=>{
  const checkEl = e.target.closest('.arrival-check');
  if (!checkEl) return;

  // âœ“ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ä»¥å¤–ã¯ç„¡åŠ¹
  if (!arrivalModeOn) return;

  e.preventDefault();
  e.stopPropagation();

  const slotEl = checkEl.closest('.slot');
  const key = slotEl?.dataset?.key;
  if (!key) return;

  const store = loadWeek(currentMonday) || {};
  const d = store[key];

  // å®‰å…¨æ¡ä»¶
  if (!d || d.tail || d.io !== 'å¤–') return;

  // arrivalFixed ã‚’åè»¢ï¼ˆRLã‚»ãƒƒãƒˆãªã‚‰ç›¸æ–¹ã‚‚åŒã˜å€¤ã«æƒãˆã‚‹ï¼‰
  const newVal = !d.arrivalFixed;
  d.arrivalFixed = newVal;

  const rlId = d?.meta?.rlSetId;
  if (rlId){
    for (const k of Object.keys(store)){
      const r = store[k];
      if (!r || r.tail) continue;
      if (r?.meta?.rlSetId !== rlId) continue;
      if (r.io !== 'å¤–') continue;         // å¿µã®ãŸã‚ arrival å¯¾è±¡ã ã‘
      r.arrivalFixed = newVal;             // â† ç›¸æ–¹ã‚‚åŒæ™‚ã«æƒãˆã‚‹
    }
  }
  saveWeek(currentMonday, store);
  paintSlotsFromStore();
}, true);

// ===== IOL â— ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ï¼ˆStepC æœ¬ä½“ï¼‰=====
document.addEventListener('click', (e)=>{
  const dotEl = e.target.closest('.iol-dot');
  if (!dotEl) return;

  // IOLãƒ¢ãƒ¼ãƒ‰ä»¥å¤–ã¯ç„¡åŠ¹
  if (!iolModeOn) return;

  e.preventDefault();
  e.stopPropagation();

  const slotEl = dotEl.closest('.slot');
  const key = slotEl?.dataset?.key;
  if (!key) return;

  const idx = Number(dotEl.dataset.iolIdx || 0);
  if (!(idx === 1 || idx === 2 || idx === 3)) return;

  const store = loadWeek(currentMonday) || {};
  const d = store[key];
  if (!d || d.tail) return;

  const field = `iolOrdered${idx}`;
  d[field] = !d[field];     // â˜… åè»¢

  saveWeek(currentMonday, store);
  paintSlotsFromStore();    // â˜… é€±ç§»å‹•ã›ãšå³åæ˜ 
  
  touchIolActivity();
}, true);  

// ===== ãƒ‡ãƒã‚¤ã‚¹(proc2) â— ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ï¼šdeviceOrdered =====
document.addEventListener('click', (e)=>{
  const dotEl = e.target.closest('.device-dot');
  if (!dotEl) return;
  if (!iolModeOn) return;          // IOLç¢ºèªãƒ¢ãƒ¼ãƒ‰ä¸­ã®ã¿

  e.preventDefault();
  e.stopPropagation();

  const slotEl = dotEl.closest('.slot');
  const key = slotEl?.dataset?.key;
  if (!key) return;

  const store = loadWeek(currentMonday) || {};
  const d = store[key];
  if (!d || d.tail) return;
  if (!String(d.proc2 || '').trim()) return;   // proc2ç„¡ã—ãªã‚‰å¯¾è±¡å¤–

  d.deviceOrdered = !d.deviceOrdered;
  saveWeek(currentMonday, store);
  paintSlotsFromStore();
  touchIolActivity();
}, true);

// ==== ã‚·ãƒ³ãƒ—ãƒ«â‡…ï¼šclickã§ç¾åœ¨slotã‚’è¨˜éŒ²ã—ã€hiddenRowã‚’é£›ã°ã—ã¦ç§»å‹• ====
(function(){
  if (window.__navHeadSimpleBound) return;
  window.__navHeadSimpleBound = true;

  // 1) ã‚¯ãƒªãƒƒã‚¯ã§ç¾åœ¨slotã‚’è¨˜éŒ²ï¼ˆtailãªã‚‰headã¸å¯„ã›ã‚‹ï¼‰
  document.addEventListener('click', (e)=>{
    const slot = e.target.closest?.('.slot');
    if (!slot) return;
    // æŠ¼ã—ãŸâ€œå®Ÿéš›ã®è¡Œâ€ã®Yä¸­å¿ƒã‚’è¨˜éŒ²ï¼ˆhiddenã§ã‚‚OKï¼‰
    window.__navRowY = (slot.getBoundingClientRect().top + slot.getBoundingClientRect().bottom) / 2;	
    window.__navCurSlot = slot.classList.contains('hiddenRow')
      ? (function upToHead(n){ while(n && n.classList.contains('hiddenRow')) n = n.previousElementSibling; return n || slot; })(slot)
      : slot;
  }, {capture:true});

  // 2) â‡…ã§headå˜ä½ã«ç§»å‹•ï¼ˆhiddenRowã¯åœè»Šã—ãªã„ï¼‰
  document.addEventListener('keydown', (e)=>{
  // arrival âœ“ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ä¸­ã¯ â‡… ãƒŠãƒ“ã‚’å®Œå…¨åœæ­¢
  if (arrivalModeOn) return;  
    if (e.key!=='ArrowDown' && e.key!=='ArrowUp') return;
    // CtrlæŠ¼ä¸‹æ™‚ãƒ»å…¥åŠ›ä¸­ãƒ»ãƒ€ã‚¤ã‚¢ãƒ­ã‚°é–‹ä¸­ã¯ç„¡åŠ¹åŒ–
    if (e.ctrlKey) return;
    const t = e.target, tag = t?.tagName?.toLowerCase();
    if (tag==='input' || tag==='textarea' || t?.isContentEditable) return;
    const ed=document.getElementById('editor'), st=document.getElementById('settings');
    if ((ed&&(ed.open||ed.classList?.contains('is-open'))) || 
        (st&&(st.open||st.classList?.contains('is-open')))) return;	
    // Ctrl æŠ¼ä¸‹ä¸­ã¯ã“ã®ç°¡æ˜“ãƒŠãƒ“ã‚’ç„¡åŠ¹åŒ–ï¼ˆã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã«è­²ã‚‹ï¼‰
    if (e.ctrlKey) return;
    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è¡¨ç¤ºä¸­ã¯ã“ã®ç°¡æ˜“ãƒŠãƒ“ã‚’ç„¡åŠ¹åŒ–ï¼ˆåŒæ—¥å†…ãƒ­ã‚¸ãƒƒã‚¯ã«è­²ã‚‹ï¼‰
    if (document.body.classList.contains('dayFocus')) return;	

    // ä»–ãƒãƒ³ãƒ‰ãƒ©ã‚’æ­¢ã‚ã¦è‡ªå‰åˆ¶å¾¡
    e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
	
    // dayFocus ä¸­ã¯ã“ã®ãƒãƒ³ãƒ‰ãƒ©ã‚’ç„¡åŠ¹åŒ–ï¼ˆå°‚ç”¨ãƒ­ã‚¸ãƒƒã‚¯ã«å§”è­²ï¼‰
    if (document.body.classList.contains('dayFocus')) return;	

    // ç¾åœ¨åœ°ï¼šè‡ªå‰è¨˜éŒ² â†’ æ—¢å­˜activeç³»ã®é †ã§fallback
    let cur = window.__navCurSlot
           || window.activeSlotEl
           || document.querySelector('.slot.active, .slot.is-active, .slot.selected')
           || null;

    // åˆå›ãªã©æœªé¸æŠãªã‚‰ã€ç”»é¢ä¸Šã®æœ€åˆ/æœ€å¾Œã®éhiddenRowã‚’é¸ã¶
    if (!cur) {
      const root = document.getElementById('schedule') || document;
  const heads0 = Array.from(root.querySelectorAll('.slot')).filter(s => {
    if (typeof window.isSelectableSlot === 'function') return window.isSelectableSlot(s);
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆä»¥å‰ã®åŸºæº–ã‚’æ¸©å­˜ï¼‰
    if (!s || !s.classList?.contains('slot')) return false;
    if (s.classList.contains('hiddenRow')) return false;
    if (s.hidden || s.classList.contains('disabled') || s.classList.contains('locked')) return false;
    const day = s.closest?.('.day');
    if (!day) return false;
    if (day.classList.contains('is-holiday') || day.classList.contains('is-off')) return false;
    const wrap = s.closest?.('.slots');
    if (wrap?.classList?.contains('section-off')) return false;
    if (s.classList.contains('off')) return false;
    return (getComputedStyle(s).display !== 'none');
  });
      if (!heads0.length) return;
      const initTarget = (e.key==='ArrowDown') ? heads0[0] : heads0[heads0.length-1];
      initTarget.dispatchEvent(new MouseEvent('click', {bubbles:true}));
      const target = window.activeSlotEl || initTarget;
      window.__navCurSlot = target;
      // â˜… é€±è¡¨ç¤ºã®åˆå›ã‚¸ãƒ£ãƒ³ãƒ—ã‚‚ã€å³æ™‚ã«ä¸­å¤®ã¸ã‚¹ãƒŠãƒƒãƒ—
      target.scrollIntoView({ block: 'center', inline: 'nearest', behavior: 'auto' });
      return;
    }

    // â˜… RLã‚»ãƒƒãƒˆå¤–å‘¨é¸æŠä¸­ã¯ã€â‡…ã®åŸºæº–ã‚’ã€Œã‚»ãƒƒãƒˆã®å…ˆé ­/æœ«å°¾ã€ã«å¯„ã›ã¦
    //    ã‚»ãƒƒãƒˆå˜ä½ã§ã‚¸ãƒ£ãƒ³ãƒ—ã™ã‚‹
    if (window.currentRLSetId) {
      const selEls = Array.from(document.querySelectorAll('.slot.multiSelected'));
      if (selEls.length >= 1) {
        // DOMé †ã«ã‚½ãƒ¼ãƒˆï¼ˆä¸Šã‹ã‚‰é †ï¼‰
        const sorted = selEls.slice().sort((a, b) => {
          if (a === b) return 0;
          const pos = a.compareDocumentPosition(b);
          if (pos & Node.DOCUMENT_POSITION_FOLLOWING) return -1;
          if (pos & Node.DOCUMENT_POSITION_PRECEDING) return 1;
          return 0;
        });
        if (e.key === 'ArrowDown') {
          // â†“ ã®å ´åˆï¼šã‚»ãƒƒãƒˆæœ«å°¾ã‚’ç¾åœ¨åœ°ã¨ã—ã¦æ‰±ã† â†’ æ¬¡ã®åœè»Šé§…ã¯ã€Œã‚»ãƒƒãƒˆã®ã™ãä¸‹ã€
          cur = sorted[sorted.length - 1];
        } else if (e.key === 'ArrowUp') {
          // â†‘ ã®å ´åˆï¼šã‚»ãƒƒãƒˆå…ˆé ­ã‚’ç¾åœ¨åœ°ã¨ã—ã¦æ‰±ã† â†’ æ¬¡ã®åœè»Šé§…ã¯ã€Œã‚»ãƒƒãƒˆã®ã™ãä¸Šã€
          cur = sorted[0];
        }
      }
    }

  // ç”»é¢å…¨ä½“ã®ã€Œåœè»Šé§…ã€ï¼â€œé¸æŠå¯èƒ½ã‚¹ãƒ­ãƒƒãƒˆâ€ã®ã¿ï¼ˆç¥æ—¥/ä¼‘æ­¢/section-off/off/hiddenRowç­‰ã‚’ä¸€æ‹¬é™¤å¤–ï¼‰
    const root = document.getElementById('schedule') || document;
    const list = Array.from(root.querySelectorAll('.slot'));
  const heads = list.filter(s => {
    if (typeof window.isSelectableSlot === 'function') return window.isSelectableSlot(s);
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆâ†‘ã¨åŒã˜åˆ¤å®šï¼‰
    if (!s || !s.classList?.contains('slot')) return false;
    if (s.classList.contains('hiddenRow')) return false;
    if (s.hidden || s.classList.contains('disabled') || s.classList.contains('locked')) return false;
  // ç·Šæ€¥/è‡¨æ™‚ã¯ç‰¹åˆ¥æ‰±ã„ï¼ˆå¸¸ã«å€™è£œã«å«ã‚ã‚‹ï¼‰
  const isEmOrTemp = s.classList.contains('emergency-slot') || s.classList.contains('temp-slot');
    const day = s.closest?.('.day');
    if (!day) return false;
  // ç¥æ—¥ãƒ»ä¼‘è¨ºæ—¥ã§ã‚‚ã€Œç·Šæ€¥/è‡¨æ™‚ã€ã¯ä¾‹å¤–ã§é€šã™
  if ((day.classList.contains('is-holiday') || day.classList.contains('is-off')) && !isEmOrTemp) return false;
    const wrap = s.closest?.('.slots');
  // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ä¼‘æ­¢ã§ã‚‚ã€Œç·Šæ€¥/è‡¨æ™‚ã€ã¯ä¾‹å¤–
  if (wrap?.classList?.contains('section-off') && !isEmOrTemp) return false;
  // å€‹åˆ¥offã§ã‚‚ã€Œç·Šæ€¥/è‡¨æ™‚ã€ã¯ä¾‹å¤–
  if (s.classList.contains('off') && !isEmOrTemp) return false;
    return (getComputedStyle(s).display !== 'none');
  });
    if (!heads.length) return;

    // ç¾åœ¨åœ°ãŒtailãªã‚‰headã¸å¯„ã›ã‚‹
    if (cur.classList.contains('hiddenRow')) {
      let p = cur.previousElementSibling;
      while (p && p.classList.contains('hiddenRow')) p = p.previousElementSibling;
      if (p) cur = p;
    }

    // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ â†’ æ¬¡ã®åœè»Šé§…
    const i = heads.indexOf(cur);
    if (i < 0) return;
    const next = heads[i + (e.key==='ArrowDown' ? 1 : -1)];
    if (!next) return;

    // æ—¢å­˜ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ã«å§”è­²ã—ã¦é¸æŠæ›´æ–°
    next.dispatchEvent(new MouseEvent('click', {bubbles:true}));

    // â˜… å®Ÿéš›ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ãƒ­ãƒƒãƒˆã‚’å–å¾—ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§åˆ‡ã‚Šæ›¿ã‚ã£ã¦ã„ã‚‹å¯èƒ½æ€§ã«å¯¾å¿œï¼‰
    const target = window.activeSlotEl || next;
    window.__navCurSlot = target; // è‡ªå‰ã®ç¾åœ¨åœ°ã‚‚æ›´æ–°

target.scrollIntoView({
  block:  'center',   // ç¸¦æ–¹å‘ã¯æ—¢å­˜ã©ãŠã‚Š
  inline: 'center',  // â˜… æ¨ªæ–¹å‘ã‚‚ä¸­å¤®å¯„ã›ã«ã™ã‚‹ï¼ˆé‡è¦ï¼‰
  behavior: 'auto'    // ãƒ‘ãƒƒã¨ç§»å‹•
});
  }, {capture:true});
})();

// ==== å³ç§»å‹•ï¼ˆã‚·ãƒ³ãƒ—ãƒ«å®Œå…¨ç‰ˆï¼‰ï¼šçœŸæ¨ªã¸ â†’ hiddenRowãªã‚‰headã«æ­£è¦åŒ– ==== 
(function(){
  if (window.__arrowRightSimpleBound) return;
  window.__arrowRightSimpleBound = true;

  // headå–å¾—ï¼ˆhiddenRowãªã‚‰ä¸Šã¸é¡ã‚‹ï¼‰
  function getHead(el){ let n=el; while(n && n.classList.contains('hiddenRow')) n=n.previousElementSibling; return n||el; }
  // ä¼‘æ—¥åˆ¤å®šï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰
  function isOffDay(el){ const d=el?.closest?.('.day'); return !!(d && (d.classList.contains('is-holiday')||d.classList.contains('is-off'))); }

  // å³éš£ã®â€œéš£åˆ—â€ã§æœ€ã‚‚è¿‘ã„è¡Œã®slotã‚’è¿”ã™ï¼ˆhiddenRowã¯ç€åœ°å€™è£œã«å«ã‚ãªã„ï¼‰
  function nearestRightSlot(fromEl){
    if (!fromEl) return null;
    const cur = getHead(fromEl).getBoundingClientRect();
    const EPSX = 3, EPSY = 4;
    const root = document.getElementById('schedule') || document;

    // å³å´å€™è£œï¼ˆhiddenRowé™¤å¤–ï¼‰
    const all = Array.from(root.querySelectorAll('.slot')).filter(s => !s.classList.contains('hiddenRow'));
    const right = [];
    for (const el of all){
      const r = el.getBoundingClientRect(); if (!r) continue;
      if (r.left < cur.right - EPSX) continue; // å³å´ã®ã¿
      right.push({el, left:r.left, top:r.top, bottom:r.bottom});
    }
    if (!right.length) return null;

    // éš£åˆ—ã ã‘ã«å›ºå®šï¼ˆæœ€å°leftã®åˆ—ï¼‰
    const minLeft = Math.min(...right.map(c=>c.left));
    const sameCol = right.filter(c => c.left <= minLeft + EPSX);
    if (!sameCol.length) return null;

   // ã¾ãšã€Œã‚¯ãƒªãƒƒã‚¯ã—ãŸå®Ÿéš›ã®è¡ŒYã€ã§éš£åˆ—ã®åŒã˜è¡Œå¸¯ã‚’å„ªå…ˆ
   const rowY = (window.__navRowY ?? ((cur.top + cur.bottom)/2));
   const inRow = sameCol.filter(c => rowY >= c.top - EPSY && rowY <= c.bottom + EPSY);
    const pick = (inRow.length ? inRow : sameCol).sort((a,b)=>{
       if (inRow.length){
         const cya = (a.top + a.bottom)/2, cyb = (b.top + b.bottom)/2;
         const ya = Math.abs(cya - rowY),     yb = Math.abs(cyb - rowY);
         if (ya !== yb) return ya - yb;                 // è¡Œä¸­å¿ƒã«è¿‘ã„æ–¹ã‚’æœ€å„ªå…ˆï¼ˆ= headå¸¯ãŒå‹ã¤ï¼‰
         const dxA = Math.max(0, a.left - cur.right);
         const dxB = Math.max(0, b.left - cur.right);
         if (dxA !== dxB) return dxA - dxB;             // æ¬¡ã«æ¨ªã®è¿‘ã•
         return a.top - b.top;                          // æœ€å¾Œã«ä¸Šå¯„ã‚Šã§å®‰å®šåŒ–
       }else{
         const dyA = Math.min(Math.abs(a.bottom - cur.top), Math.abs(a.top - cur.bottom));
         const dyB = Math.min(Math.abs(b.bottom - cur.top), Math.abs(b.top - cur.bottom));
         if (dyA !== dyB) return dyA - dyB;             // ç¸¦è·é›¢
         const dxA = Math.max(0, a.left - cur.right);
         const dxB = Math.max(0, b.left - cur.right);
         return dxA - dxB;                              // æ¨ªè·é›¢
       }
     });
    // â˜… ä¼‘æ—¥åˆ—ã§ã‚‚ã€Œç·Šæ€¥/è‡¨æ™‚ã€ãŒã‚ã‚Œã°ç€åœ°ã‚’è¨±å¯
    for (const c of pick){
      const el = c.el;
      const isEmOrTemp = el.classList.contains('emergency-slot') || el.classList.contains('temp-slot');
      if (isEmOrTemp) return el;
      if (!isOffDay(el)) return el;
    }
    return null; // éš£åˆ—ãŒä¼‘æ—¥ã®ã¿ãªã‚‰ç€åœ°ãªã—ï¼ˆä¸Šä½ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã™ã‚Œã°OKï¼‰
  }

  // â†’ã‚­ãƒ¼ã§ç§»å‹•ï¼ˆhiddenRowã«å½“ãŸã£ãŸã‚‰headã¸æ­£è¦åŒ–ã—ã¦é¸æŠï¼‰
  document.addEventListener('keydown', (e)=>{
    if (arrivalModeOn) return;
    if (e.key !== 'ArrowRight') return;
    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ä¸­ã¯ã“ã®æ¨ªç§»å‹•ã‚’ç„¡åŠ¹åŒ–ï¼ˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç”¨ãƒ­ã‚¸ãƒƒã‚¯ã«å§”è­²ï¼‰
    if (document.body.classList.contains('dayFocus')) return;	
    // Ctrl+â†’ ã¯é€±/æ—¥ã‚¸ãƒ£ãƒ³ãƒ—ã«è­²ã‚‹ï¼ˆé€šå¸¸ã®æ¨ªç§»å‹•ã¯ç„¡åŠ¹åŒ–ï¼‰
    if (e.ctrlKey) return;
	const t = e.target, tag = t?.tagName?.toLowerCase();
	if (tag==='input' || tag==='textarea' || t?.isContentEditable) return;
	const ed=document.getElementById('editor'), st=document.getElementById('settings');
	if ((ed&&(ed.open||ed.classList?.contains('is-open'))) || (st&&(st.open||st.classList?.contains('is-open')))) return;


    // ç¾åœ¨ä½ç½®ã®å–å¾—ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§é¸ã‚“ã è¦ç´ ã‚’å„ªå…ˆï¼‰
    let cur = window.__navCurSlot
            || window.activeSlotEl
            || document.querySelector('.slot.active, .slot.is-active, .slot.selected');
    if (!cur) return;

    // è¡çªå›é¿
    e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();

 // â˜…ç›´å‰ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å½±éŸ¿ã‚’é¿ã‘ã‚‹ãŸã‚ã€æ¯å›ã“ã“ã§ rowY ã‚’â€œä»Šã®rectâ€ã‹ã‚‰æ±ºå®š
 { const head = getHead(cur); const r = head.getBoundingClientRect();
   window.__navRowY = head.classList.contains('mergeHead') ? (r.top + 1) : ((r.top + r.bottom)/2);
 }
  
    // å‡ºç™ºç‚¹ã¯headåŸºæº–
    cur = getHead(cur);

    let next = nearestRightSlot(cur);
    if (!next) return;

    // --- ç€åœ°ã®æ­£è¦åŒ–ï¼ˆä¼‘æ­¢/ç¥æ—¥/ã‚»ã‚¯ã‚·ãƒ§ãƒ³ä¼‘æ­¢ã‚’å›é¿ï¼‰---
    const isSel = (el)=>{
      if (window.isSelectableSlot) return window.isSelectableSlot(el);
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå¿µã®ãŸã‚ï¼‰
      if (!el || !el.classList?.contains('slot')) return false;
      if (el.hidden || el.classList.contains('hiddenRow') || el.classList.contains('disabled') || el.classList.contains('locked')) return false;
      const isEmOrTemp = el.classList.contains('emergency-slot') || el.classList.contains('temp-slot');
      const day = el.closest?.('.day');
      const slotsWrap = el.closest?.('.slots');
      if (day && (day.classList.contains('is-off') || day.classList.contains('is-holiday')) && !isEmOrTemp) return false;
      if (slotsWrap?.classList?.contains('section-off') && !isEmOrTemp) return false;
      if (el.classList.contains('off') && !isEmOrTemp) return false;
      return true;
    };

    // ã¾ãš head ã‚’åŸºæº–ã«åˆ¤å®š
    let head = getHead(next);
    if (!isSel(head)) {
      const day = head.closest?.('.day');
      // åŒæ—¥å†…ã®ã€Œé¸æŠå¯èƒ½ã€å€™è£œã‚’åé›†
      const allInDay = day ? Array.from(day.querySelectorAll('.slot')).filter(isSel) : [];
      if (allInDay.length) {
        // ã‚¯ãƒªãƒƒã‚¯è¡ŒYï¼ˆ__navRowYï¼‰ã«æœ€ã‚‚è¿‘ã„å€™è£œã¸å¯„ã›ã‚‹
        const targetY = (()=>{
          if (typeof window.__navRowY === 'number') return window.__navRowY;
          const r = head.getBoundingClientRect(); return (r.top + r.bottom) / 2;
        })();
        head = allInDay
          .map(el => ({ el, r: el.getBoundingClientRect() }))
          .sort((a,b)=>{
            const ya = Math.abs(((a.r.top+a.r.bottom)/2) - targetY);
            const yb = Math.abs(((b.r.top+b.r.bottom)/2) - targetY);
            if (ya !== yb) return ya - yb;
            return a.r.top - b.r.top; // åŒè·é›¢ãªã‚‰ä¸Šå¯„ã‚Šã§å®‰å®š
          })[0].el;
      } else {
        // åŒæ—¥å†…ã«é¸æŠå¯èƒ½æ ãŒç„¡ã‘ã‚Œã°ã€Œå³å´ã®å–¶æ¥­æ—¥ã€ã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        const days = Array.from(document.querySelectorAll('.day'));
        const i = days.indexOf(day);
        let found = null;
        for (let j = i + 1; j < days.length; j++) {
          const f = window.findFirstSelectableInDay?.(days[j]);
          if (f && isSel(f)) { found = f; break; }
        }
        if (!found) return; // ç€åœ°å…ˆãªã— â†’ ä½•ã‚‚ã—ãªã„
        head = found;
      }
    }

    head.dispatchEvent(new MouseEvent('click', {bubbles:true}));
    window.__navCurSlot = head;
    { const rr = head.getBoundingClientRect();
      window.__navRowY = head.classList.contains('mergeHead') ? (rr.top + 1) : ((rr.top + rr.bottom)/2);
    }	
    (window.activeSlotEl || head).scrollIntoView({
      block:  'center',
      inline: 'center',   // â˜… å·¦å³ã‚‚ä¸­å¤®å¯„ã›ã«ã™ã‚‹
      behavior: 'auto'    // â˜… ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—ã§ä¸€ç™ºã‚¹ãƒŠãƒƒãƒ—
    });
  }, {capture:true});

  // ã‚¯ãƒªãƒƒã‚¯ã§ç¾åœ¨åœ°ã‚’è¨˜éŒ²ï¼ˆæ¬¡å›ã®èµ·ç‚¹ã«ã™ã‚‹ï¼‰
  document.addEventListener('click', (e)=>{
    const slot = e.target.closest?.('.slot'); if (!slot) return;
    const r = slot.getBoundingClientRect();
    window.__navRowY = slot.classList.contains('mergeHead') ? (r.top + 1) : ((r.top + r.bottom)/2);	
    window.__navCurSlot = getHead(slot);
  }, {capture:true});
})();

// ==== å·¦ç§»å‹•ï¼ˆã‚·ãƒ³ãƒ—ãƒ«å®Œå…¨ç‰ˆï¼‰ï¼šçœŸæ¨ªã¸ â†’ hiddenRowãªã‚‰headã«æ­£è¦åŒ– ==== 
(function(){
  if (window.__arrowLeftSimpleBound) return;
  window.__arrowLeftSimpleBound = true;

  // headå–å¾—ï¼ˆhiddenRowãªã‚‰ä¸Šã¸é¡ã‚‹ï¼‰
  function getHead(el){ let n=el; while(n && n.classList.contains('hiddenRow')) n=n.previousElementSibling; return n||el; }
  // ä¼‘æ—¥åˆ¤å®šï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰
  function isOffDay(el){ const d=el?.closest?.('.day'); return !!(d && (d.classList.contains('is-holiday')||d.classList.contains('is-off'))); }

  // å·¦éš£ã®â€œéš£åˆ—â€ã§æœ€ã‚‚è¿‘ã„è¡Œã®slotã‚’è¿”ã™ï¼ˆhiddenRowã¯ç€åœ°å€™è£œã«å«ã‚ãªã„ï¼‰
  function nearestLeftSlot(fromEl){
    if (!fromEl) return null;
    const cur = getHead(fromEl).getBoundingClientRect();
    const EPSX = 3, EPSY = 3;
    const root = document.getElementById('schedule') || document;

    // å·¦å´å€™è£œï¼ˆhiddenRowé™¤å¤–ï¼‰
    const all = Array.from(root.querySelectorAll('.slot')).filter(s => !s.classList.contains('hiddenRow'));
    const left = [];
    for (const el of all){
      const r = el.getBoundingClientRect(); if (!r) continue;
      if (r.right > cur.left + EPSX) continue; // å·¦å´ã®ã¿
      left.push({el, right:r.right, top:r.top, bottom:r.bottom});
    }
    if (!left.length) return null;

    // éš£åˆ—ã ã‘ã«å›ºå®šï¼ˆæœ€å¤§rightã®åˆ—ï¼‰
    const maxRight = Math.max(...left.map(c=>c.right));
    const sameCol = left.filter(c => c.right >= maxRight - EPSX);
    if (!sameCol.length) return null;

    // ã€Œã‚¯ãƒªãƒƒã‚¯ã—ãŸå®Ÿéš›ã®è¡ŒYã€ã§éš£åˆ—ã®åŒã˜è¡Œå¸¯ã‚’å„ªå…ˆ
    const rowY = (window.__navRowY ?? ((cur.top + cur.bottom)/2));
    const inRow = sameCol.filter(c => rowY >= c.top - EPSY && rowY <= c.bottom + EPSY);

    const pick = (inRow.length ? inRow : sameCol).sort((a,b)=>{
       if (inRow.length){
         const cya = (a.top + a.bottom)/2, cyb = (b.top + b.bottom)/2;
         const ya = Math.abs(cya - rowY),     yb = Math.abs(cyb - rowY);
         if (ya !== yb) return ya - yb;                 // è¡Œä¸­å¿ƒã«è¿‘ã„æ–¹ã‚’æœ€å„ªå…ˆ
         const dxA = Math.max(0, cur.left - a.right);
         const dxB = Math.max(0, cur.left - b.right);
         if (dxA !== dxB) return dxA - dxB;             // æ¬¡ã«æ¨ªã®è¿‘ã•
         return a.top - b.top;                          // æœ€å¾Œã«ä¸Šå¯„ã‚Šã§å®‰å®šåŒ–
       }else{
         const dyA = Math.min(Math.abs(a.bottom - cur.top), Math.abs(a.top - cur.bottom));
         const dyB = Math.min(Math.abs(b.bottom - cur.top), Math.abs(b.top - cur.bottom));
         if (dyA !== dyB) return dyA - dyB;
         const dxA = Math.max(0, cur.left - a.right);
         const dxB = Math.max(0, cur.left - b.right);
         return dxA - dxB;
       }
     });
    // â˜… ä¼‘æ—¥åˆ—ã§ã‚‚ã€Œç·Šæ€¥/è‡¨æ™‚ã€ãŒã‚ã‚Œã°ç€åœ°ã‚’è¨±å¯
    for (const c of pick){
      const el = c.el;
      const isEmOrTemp = el.classList.contains('emergency-slot') || el.classList.contains('temp-slot');
      if (isEmOrTemp) return el;
      if (!isOffDay(el)) return el;
    }
    return null;
  }

  // â†ã‚­ãƒ¼ã§ç§»å‹•ï¼ˆhiddenRowã«å½“ãŸã£ãŸã‚‰headã¸æ­£è¦åŒ–ã—ã¦é¸æŠï¼‰
  document.addEventListener('keydown', (e)=>{
    if (arrivalModeOn) return;
    if (e.key !== 'ArrowLeft') return;
    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ä¸­ã¯ã“ã®æ¨ªç§»å‹•ã‚’ç„¡åŠ¹åŒ–ï¼ˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç”¨ãƒ­ã‚¸ãƒƒã‚¯ã«å§”è­²ï¼‰
    if (document.body.classList.contains('dayFocus')) return;	
    // Ctrl+â† ã¯é€±/æ—¥ã‚¸ãƒ£ãƒ³ãƒ—ã«è­²ã‚‹ï¼ˆé€šå¸¸ã®æ¨ªç§»å‹•ã¯ç„¡åŠ¹åŒ–ï¼‰
    if (e.ctrlKey) return;
	const t = e.target, tag = t?.tagName?.toLowerCase();
    if (tag==='input' || tag==='textarea' || t?.isContentEditable) return;
    const ed=document.getElementById('editor'), st=document.getElementById('settings');
    if ((ed&&(ed.open||ed.classList?.contains('is-open'))) || (st&&(st.open||st.classList?.contains('is-open')))) return;


    // ç¾åœ¨ä½ç½®ã®å–å¾—ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§é¸ã‚“ã è¦ç´ ã‚’å„ªå…ˆï¼‰
    let cur = window.__navCurSlot
            || window.activeSlotEl
            || document.querySelector('.slot.active, .slot.is-active, .slot.selected');
    if (!cur) return;


  // --- ç¾åœ¨åœ°ãŒã€Œã‚ªãƒ•æ—¥ / ç¥æ—¥ã€ã®æ°´é¢ä¸‹ã«ã„ã‚‹å ´åˆã¯ã€å·¦å„ªå…ˆã§å–¶æ¥­æ—¥ã«æ­£è¦åŒ– ---
  (function(){
    const day0 = cur.closest?.('.day'); if (!day0) return;
    // â˜… ç·Šæ€¥/è‡¨æ™‚ã«å±…ã‚‹ãªã‚‰â€œå¯„ã›â€ã‚’è¡Œã‚ãšã€ãã®å ´ã‚’å„ªå…ˆ
    if (cur.classList?.contains('emergency-slot') || cur.classList?.contains('temp-slot')) return;

    const isOffDay = (d)=>{
      if (!d) return false;
      if (d.classList.contains('is-holiday') || d.classList.contains('is-off')) return true;
      // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ä¼‘æ­¢ãŒæ—¥å…¨ä½“ã«åŠã¶ã‚±ãƒ¼ã‚¹ã‚‚æƒ³å®šã—ã¦å¿µã®ãŸã‚ç¢ºèª
      const slotsWrap = d.querySelector('.slots');
      return !!(slotsWrap && slotsWrap.classList.contains('section-off'));
    };
    if (!isOffDay(day0)) return;
    const days = Array.from(document.querySelectorAll('.day'));
    const i = days.indexOf(day0);
    let found = null;
    // å·¦ï¼ˆéå»æ—¥ï¼‰ã‚’å„ªå…ˆ
    for (let j = i - 1; j >= 0; j--) {
      if (!isOffDay(days[j])) { found = days[j]; break; }
    }
    // å·¦ã«ç„¡ã‘ã‚Œã°å³ã¸
    if (!found) {
      for (let j = i + 1; j < days.length; j++) {
        if (!isOffDay(days[j])) { found = days[j]; break; }
      }
    }
    if (found) {
      const first = window.findFirstSelectableInDay?.(found);
      if (first) { setActiveSlot(first, {scroll:false}); cur = first; }
    }
  })();

    // è¡çªå›é¿
    e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();

 { const head = getHead(cur); const r = head.getBoundingClientRect();
   window.__navRowY = head.classList.contains('mergeHead') ? (r.top + 1) : ((r.top + r.bottom)/2);
 }

    // å‡ºç™ºç‚¹ã¯headåŸºæº–
    cur = getHead(cur);

    let next = nearestLeftSlot(cur);
    if (!next) return;

    // --- ç€åœ°ã®æ­£è¦åŒ–ï¼ˆâ†å°‚ç”¨ï¼šã‚ªãƒ•æ—¥/ç¥æ—¥ã¯ç„¡æ¡ä»¶ã§å›é¿ï¼‰---
    const isNavSelectable = (el)=>{
      if (!el || !el.classList?.contains('slot')) return false;
      const isEmOrTemp = el.classList.contains('emergency-slot') || el.classList.contains('temp-slot');
      // è¦ª day ãŒ is-off / is-holiday ãªã‚‰ â† ã§ã¯å¿…ãšä¸å¯
      const day = el.closest?.('.day');
      if (day && (day.classList.contains('is-off') || day.classList.contains('is-holiday')) && !isEmOrTemp) return false;
      // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ä¼‘æ­¢ã‚‚ä¸å¯
      const wrap = el.closest?.('.slots');
      if (wrap?.classList?.contains('section-off') && !isEmOrTemp) return false;
      // å€‹åˆ¥ off ã‚‚ä¸å¯
      if (el.classList.contains('off') && !isEmOrTemp) return false;
      // hiddenRow / lock / disabled ç­‰ã¯æ—¢å­˜ã®é¸åˆ¥ã«å§”è­²ï¼ˆå¿µã®ãŸã‚ï¼‰
      if (el.hidden || el.classList.contains('hiddenRow') || el.classList.contains('disabled') || el.classList.contains('locked')) return false;
      return true;
    };

    let target = getHead(next);
    // ç€åœ°ãŒãƒŠãƒ“ä¸Šä¸é©ãªã‚‰å¯„ã›ç›´ã—
    if (!isNavSelectable(target)) {
      const day = target.closest?.('.day');
      // 1) åŒæ—¥å†…ã®ã€ŒãƒŠãƒ“é¸æŠå¯ã€å€™è£œã‹ã‚‰ã€__navRowY ã«æœ€ã‚‚è¿‘ã„æ ã¸
      const sameDay = day ? Array.from(day.querySelectorAll('.slot')).map(getHead).filter(isNavSelectable) : [];
      if (sameDay.length) {
        const ty = (typeof window.__navRowY === 'number')
          ? window.__navRowY
          : ((target.getBoundingClientRect().top + target.getBoundingClientRect().bottom) / 2);
        target = sameDay
          .map(el => ({ el, r: el.getBoundingClientRect() }))
          .sort((a,b)=>{
            const ya = Math.abs(((a.r.top+a.r.bottom)/2) - ty);
            const yb = Math.abs(((b.r.top+b.r.bottom)/2) - ty);
            if (ya !== yb) return ya - yb;
            return a.r.top - b.r.top;
          })[0].el;
      } else {
        // 2) åŒæ—¥å†…ãŒå…¨æ»…ãªã‚‰ã€å·¦å´ã®å–¶æ¥­æ—¥ã§æœ€åˆã®é¸æŠå¯ã‚¹ãƒ­ãƒƒãƒˆã¸
        const days = Array.from(document.querySelectorAll('.day'));
        const i = days.indexOf(day);
        let found = null;
        for (let j = i - 1; j >= 0; j--) {
          const f = window.findFirstSelectableInDay?.(days[j]);
          if (f && isNavSelectable(f)) { found = f; break; }
        }
        if (!found) return; // ç€åœ°å…ˆãªã— â†’ ä½•ã‚‚ã—ãªã„
        target = getHead(found);
      }
    }
    const head = target;
    head.dispatchEvent(new MouseEvent('click', {bubbles:true}));
    window.__navCurSlot = head;
    { const rr = head.getBoundingClientRect();
      window.__navRowY = head.classList.contains('mergeHead') ? (rr.top + 1) : ((rr.top + rr.bottom)/2);
    }
    (window.activeSlotEl || head).scrollIntoView({
      block:  'center',
      inline: 'center',   // â˜… å·¦å³ã‚‚ä¸­å¤®å¯„ã›ã«
      behavior: 'auto'    // â˜… å³æ™‚ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    });
  }, {capture:true});
})();


   // ===== ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†èµ·å‹•ï¼ˆé€±/ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å…±é€šã€æœ€å„ªå…ˆã§æ‹¾ã†ï¼‰ =====
   (function(){
     const sched = document.getElementById('schedule');
     if (!sched) return;
 
     function isLockedOrHidden(slot){
       if (!slot || !slot.classList) return true;
       if (slot.classList.contains('hiddenRow')) return true;  // tailã¯ç·¨é›†ä¸å¯
       if (typeof isSlotLockedForEdit === 'function' && isSlotLockedForEdit(slot)) return true;
       return false;
     }
     function resolveSlot(node){
       if (!node) return null;
       return node.closest ? node.closest('.slot') : null;
     }
     function resolveHead(slot){
       // æ˜ç¤º head ãŒã‚ã‚Œã°ãã‚Œã€ãªã‘ã‚Œã° hiddenRow ã§ãªã„æ ï¼å˜ç‹¬=head
       let p = slot;
       while (p && p.classList && p.classList.contains('slot')){
         if (p.classList.contains('mergeHead')) return p;
         if (!p.classList.contains('hiddenRow')) return p;
         p = p.previousElementSibling;
       }
       return slot;
     }
     function fireEditFor(slot){
       if (!slot) return;
       // ã¾ãšã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ï¼ˆEnter/ãƒœã‚¿ãƒ³çµŒè·¯ã¨åŒæ¡ä»¶ã«æƒãˆã‚‹ï¼‰
       if (typeof setActiveSlot === 'function') setActiveSlot(slot);
       // æ—¢å­˜ã®ç·¨é›†èµ·å‹•çµŒè·¯ã‚’å„ªå…ˆçš„ã«ä½¿ç”¨
       if (editBtn && typeof editBtn.click === 'function') {
         editBtn.click();
         return;
       }
       if (typeof beginEditActive === 'function') {
         beginEditActive();
         return;
       }
       if (typeof openEditor === 'function') {
         const k = slot.dataset ? slot.dataset.key : undefined;
         if (k) openEditor([k]);
       }
     }
 
     // capture ã§æœ€å„ªå…ˆãƒ»ä»–ãƒãƒ³ãƒ‰ãƒ©ã«æ­¢ã‚ã‚‰ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹
     sched.addEventListener('dblclick', function(e){
       // å…¥åŠ›ä¸­/ãƒ¢ãƒ¼ãƒ€ãƒ«ä¸­/æ™‚åˆ»ã‚»ãƒ«ã¯é™¤å¤–ï¼ˆæ—¢å­˜ãƒ«ãƒ¼ãƒ«ã‚’è¸è¥²ï¼‰
       if (typeof isTypingContext === 'function' && isTypingContext(e)) return;
       if (document.querySelector('dialog[open], .modal.is-open, .editor.is-open')) return;
       if (e.target && e.target.closest && e.target.closest('.time')) return;
 
       const slot = resolveSlot(e.target);
       if (!slot) return;
       if (isLockedOrHidden(slot)) return;
 
       e.preventDefault();
       e.stopPropagation();
 
       const head = resolveHead(slot);
       fireEditFor(head);
     }, { capture: true });
   })();
// ==== è¨­å®šï¼ˆå€™è£œãƒªã‚¹ãƒˆï¼‰ ====
// ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼
const SETTINGS_KEY = 'schedule_lists_settings';

// æ—¢å®šå€¤
function defaultLists(){
  const powers = [];
  for (let v = 15.0; v <= 30.001; v += 0.5) powers.push(v.toFixed(1)); // ä½¿ã†ãªã‚‰
  return {
    iolTypes: ["Ni","Ho","HoT","Am","AmT","å‚","Le","LeT","Ko"],
    proc1: ["ç™½å†…éšœ","VIT+IOL","VITã®ã¿","IOLå¼·è†œå†…å›ºå®š","çœ¼ç¼å†…åæ‰‹è¡“"],
    proc2: ["iStent","ã‚¢ãƒ¼ãƒ¡ãƒ‰","ãƒ—ãƒªã‚¶ãƒ¼ãƒ•ãƒ­","æ¶™ç‚¹ãƒ—ãƒ©ã‚°"],
     // è¡“è€…ï¼šã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ:æ°å ã®å½¢å¼ï¼ˆè¨­å®šç”»é¢ã‹ã‚‰è‡ªç”±ã«ç·¨é›†å¯ï¼‰
     surgeons: [
       "k:æœ¨æ‘",
       "o:å²¡éƒ¨",
       "g:å¾Œè—¤ç”°",
       "mi:å®®éƒ¨",
       "i:é£¯ç”°",
       "mo:æ£®å±±",
       "h:ç§¦",
       "t:å†…åŒ "
     ]
  };
}

// èª­è¾¼ï¼ä¿å­˜
function loadSettings(){
  try{
    const s = localStorage.getItem(SETTINGS_KEY);
    const v = s ? JSON.parse(s) : {};
    // æ¬ ã‘ã¦ã„ã‚‹é…åˆ—ã¯æ—¢å®šã§è£œå®Œ
    return Object.assign(defaultLists(), v||{});
  }catch(_){
    return defaultLists();
  }
}
function saveSettings(obj){
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(obj||{}));
}

// datalist ã«åæ˜ 
function setOptions(dl, arr){
  if (!dl) return;
  dl.innerHTML = '';
  (arr||[]).forEach(v=>{
    const opt = document.createElement('option');
    opt.value = String(v);
    dl.appendChild(opt);
  });
}
// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãƒãƒƒãƒ—ã‚’æŒã¤
window.__surgeonShortcutMap = window.__surgeonShortcutMap || {};

function applyDatalists(lists){
  setOptions(document.getElementById('iolTypes'),  lists.iolTypes);
  setOptions(document.getElementById('procList'),  lists.proc1);
  setOptions(document.getElementById('procList2'), lists.proc2);

  // â”€â”€ è¡“è€…ï¼šè¨­å®šã®é…åˆ—ï¼ˆ"code:åå‰" or "åå‰"ï¼‰ã‹ã‚‰
  //     1) åå‰é…åˆ—
  //     2) ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãƒãƒƒãƒ—
  //     ã‚’ç”Ÿæˆã™ã‚‹
  const raw = lists.surgeons || [];
  const names = [];
  const map = {};

  raw.forEach(line => {
    const text = String(line || '').trim();
    if (!text) return;

    let code = '';
    let name = '';

    const idx = text.indexOf(':');
    if (idx > 0) {
      code = text.slice(0, idx).trim();
      name = text.slice(idx + 1).trim();
    } else {
      // ã€Œæœ¨æ‘ã€ã ã‘ã®è¡Œã‚‚ä¸€å¿œè¨±å®¹ï¼ˆã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãªã—ï¼‰
      name = text;
    }

    if (!name) return;
    names.push(name);
    if (code) {
      map[code.toLowerCase()] = name;
    }
  });

  // datalistï¼ˆã‚‚ã—ä»Šå¾Œã‚‚ä½¿ã†ãªã‚‰ï¼‰ã‚’åå‰ã ã‘ã§æ›´æ–°
  setOptions(document.getElementById('surgeonsList'), names);

  // ç·¨é›†ãƒ€ã‚¤ã‚¢ãƒ­ã‚°å†…ã® <select name="surgeon"> ã‚’æ›´æ–°
  const sSelect = document.querySelector('#editorForm select[name="surgeon"]');
  if (sSelect) {
    sSelect.innerHTML = '';

    const empty = document.createElement('option');
    empty.value = '';
    empty.textContent = '';
    sSelect.appendChild(empty);

    names.forEach(n => {
      const opt = document.createElement('option');
      opt.value = String(n);
      opt.textContent = String(n);
      sSelect.appendChild(opt);
    });
  }

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãƒãƒƒãƒ—ã«åæ˜ 
  window.__surgeonShortcutMap = map;
}


// ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
let appLists = loadSettings();

  // ===== æ—¥ä»˜ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
  let currentMonday = startOfWeek(new Date());
  function startOfWeek(d){ const x=new Date(d.getFullYear(), d.getMonth(), d.getDate()); const g=x.getDay(); const diff=(g===0?-6:1-g); x.setDate(x.getDate()+diff); x.setHours(0,0,0,0); return x; }
  function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
  function dateISO(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
  function weekKey(date){ return dateISO(startOfWeek(date)); }
  function formatDateJP(d){ const y=d.getFullYear(), m=d.getMonth()+1, day=d.getDate(); const w="æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ"[d.getDay()]; return `${y}/${m}/${day}ï¼ˆ${w}ï¼‰`; }
  function hhmmToMinutes(hhmm){ const [H, M] = String(hhmm).split(':').map(Number); return (isFinite(H) && isFinite(M)) ? H*60 + M : 0; }
  function addMinutes(hhmm, minutes){ let s = String(hhmm).trim().replace(/[ï¼-ï½]/g, c => String.fromCharCode(c.charCodeAt(0) - 0xFEE0)).replace(/ï¼š/g, ':'); const m = /^(\d{1,2}):(\d{2})$/.exec(s); if (!m) return null; const h = Number(m[1]), mm = Number(m[2]); const dt = new Date(2000,0,1,h,mm); if (isNaN(dt.getTime())) return null; dt.setMinutes(dt.getMinutes() + Number(minutes || 0)); return dt.toTimeString().slice(0,5); }
  function normalizeTimeInput(raw){ if(!raw) return null; let s = String(raw).trim(); let m = /^(\d{1,2}):(\d{2})$/.exec(s); if(m){ const h=Number(m[1]), mm=Number(m[2]); if(h>=0&&h<=23&&mm>=0&&mm<=59) return `${String(h).padStart(2,'0')}:${String(mm).padStart(2,'0')}`; return null; } s = s.replace(/\s+/g,'').replace(/[^\d]/g,''); if(s.length===3 || s.length===4){ const hh=s.slice(0,s.length-2), mm=s.slice(-2); const h=Number(hh), m2=Number(mm); if(h>=0&&h<=23&&m2>=0&&m2<=59) return `${String(h).padStart(2,'0')}:${String(m2).padStart(2,'0')}`; } return null; }


// === æ—¥ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒ»ãƒ˜ãƒ«ãƒ‘ãƒ¼ ==========================
function enterDayFocus(dayEl) {
  if (!dayEl) return;

  // â˜… focusæ™‚ï¼šè¤‡æ•°é¸æŠã¨å¤–æ ã‚’å®Œå…¨ã‚¯ãƒªã‚¢ï¼ˆãƒ€ãƒŸãƒ¼é’æ å¯¾ç­–ï¼‰
  document.querySelectorAll('.multiRangeOutline').forEach(el => el.remove());
  document.querySelectorAll('.slot.multiSelected, .slot.is-selected')
    .forEach(el => {
      el.classList.remove('multiSelected');
      el.classList.remove('is-selected');
    });
  if (window.multiSelected) {
    try { window.multiSelected.clear(); } catch(_){}
  }

  // --- çŠ¶æ…‹ã‚’ä¿å­˜ ---
  window.focusDate = dayEl?.dataset?.date || window.focusDate; // â† â˜…ã“ã‚Œ
  window.__weekStartBeforeFocus = document.getElementById('weekPicker')?.value;

  // --- ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚‹ ---
  document.body.classList.add('dayFocus');
  document.querySelectorAll('#schedule .day').forEach(d => {
    d.style.display = (d === dayEl) ? 'block' : 'none';
    if (d === dayEl) d.setAttribute('data-focus', 'true');
    else d.removeAttribute('data-focus');
  });

  // --- ãƒ”ãƒƒã‚«ãƒ¼/å†…éƒ¨çŠ¶æ…‹ã‚’å½“æ—¥ã«â€œçµ±ä¸€â€ï¼ˆchangeã¯ç™ºç«ã—ãªã„ï¼‰ ---
  (function syncPickerAndState(){
    const iso = dayEl?.dataset?.date; // ä¾‹: "2025-11-06"
    if (!iso) return;
    const [y,m,d] = iso.split('-').map(Number);
    const dt = new Date(y, m-1, d);

    // â‘  ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ—¥ã®å˜ä¸€ã®çœŸå®Ÿã‚’ç¢ºå®š
    if (typeof setFocusDateStore === 'function') setFocusDateStore(dt);
    else window.currentFocusDate = dt;
    if (typeof mondayOf === 'function') window.currentMonday = mondayOf(dt);

    // â‘¡ ãƒ”ãƒƒã‚«ãƒ¼ã¯å½“æ—¥ã¸ï¼ˆé€±ãƒ­ã‚¸ãƒƒã‚¯ã¯æŠ‘æ­¢ï¼šchangeã¯ç™ºç«ã—ãªã„ï¼‰
    const picker = document.getElementById('weekPicker');
    if (picker){
      window.__suppressWeekChange = true;
      picker.value = iso;
      window.__setWeekdayFromISO?.(iso); // ãƒãƒƒã‚¸ã ã‘åŒæœŸ
      window.__suppressWeekChange = false; // ã“ã“ã§å³è§£é™¤
    }
  })();
  // --- æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼ˆå­˜åœ¨ã—ãªã‘ã‚Œã°è¿½åŠ ï¼‰ ---
  if (!document.getElementById('focusBackBtn')) {
    const btn = document.createElement('button');
    btn.id = 'focusBackBtn';
    btn.textContent = 'æˆ»ã‚‹';
    btn.addEventListener('click', exitDayFocus);
    (document.querySelector('.topbar .group:nth-of-type(2)') ||
     document.querySelector('.topbar'))?.appendChild(btn);
  }

  // --- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã¯ãã®ã¾ã¾ï¼ˆä¸è¦ãªjumpæŠ‘åˆ¶ï¼‰ ---
  // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹çªå…¥æ™‚ï¼šæœªé¸æŠãªã‚‰å½“æ—¥ã®å…ˆé ­ã‚¹ãƒ­ãƒƒãƒˆã‚’é¸ã¶
  const cur = getActiveSlot?.();
  const curDay = cur?.closest?.('.day');
  if (!cur || curDay !== dayEl) ensureInitialSelectionForDay(dayEl);

  // â˜… ãƒ•ã‚©ãƒ¼ã‚«ã‚¹çªå…¥ç›´å¾Œï¼šç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ãƒ­ãƒƒãƒˆã‚’â€œãƒ‘ãƒƒâ€ã¨ã‚»ãƒ³ã‚¿ãƒªãƒ³ã‚°
  requestAnimationFrame(() => window.__centerActiveInWeekSoon?.());
}

function exitDayFocus() {

  // â˜… é€±è¡¨ç¤ºã¸æˆ»ã‚‹ã¨ãã‚‚æ®‹éª¸ã‚’ç¢ºå®Ÿã«å‰Šé™¤
  document.querySelectorAll('.multiRangeOutline').forEach(el => el.remove());
  document.querySelectorAll('.slot.multiSelected, .slot.is-selected')
    .forEach(el => {
      el.classList.remove('multiSelected');
      el.classList.remove('is-selected');
    });
  if (window.multiSelected) {
    try { window.multiSelected.clear(); } catch(_){}
  }

  // ---- ãƒ•ãƒ©ã‚°ï¼ˆå‘¼ã³å…ƒã§åˆ¶å¾¡ï¼‰----
  const skipRestore = !!window.__skipRestoreOnExit;         // Ctrl+, ãªã©ã€Œå¾©å…ƒã›ãšã«å¤–éƒ¨ã§åˆã‚ã›ã‚‹ã€ç”¨
  window.__skipRestoreOnExit = false;
  const targetMon = window.__targetMondayOnExit || null;    // æ˜ç¤ºã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼ˆæœˆæ›œDateï¼‰æŒ‡å®šç”¨ï¼ˆä»»æ„ï¼‰
  window.__targetMondayOnExit = null;

  // === é€±è¡¨ç¤ºã§ã€Œã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚’ä¸­å¤®ã€ã«å¯„ã›ã‚‹ãƒ¯ãƒ³ã‚·ãƒ§ãƒƒãƒˆï¼ˆé€±è¡¨ç¤ºå°‚ç”¨ã®ç®±ã‚’ä½¿ã†ï¼‰ ===
  function __centerActiveInWeekNow(){
    const el  = (window.getActiveSlot && window.getActiveSlot()) || document.querySelector('.slot.focused');
    if (!el) return;
    const box = (window.__getScrollBox && window.__getScrollBox()) || document.scrollingElement || document.documentElement;
    if (!box) return;

    const br  = box.getBoundingClientRect ? box.getBoundingClientRect() : {
      top: 0, left: 0,
      height: window.innerHeight,
      width:  window.innerWidth
    };
    const sr  = el.getBoundingClientRect();

    const currentTop  = box.scrollTop  || 0;
    const currentLeft = box.scrollLeft || 0;
    const viewH = ('clientHeight' in box ? box.clientHeight : window.innerHeight);
    const viewW = ('clientWidth'  in box ? box.clientWidth  : window.innerWidth);

    // --- ç¸¦æ–¹å‘ï¼šä¸­å¤®å¯„ã› ---
    let targetTop = (sr.top - br.top + currentTop) + (sr.height/2) - (viewH/2);
    const maxTop = Math.max(0, (box.scrollHeight || 0) - viewH);
    const nextTop = Math.max(0, Math.min(Math.round(targetTop), maxTop));

    // --- æ¨ªæ–¹å‘ï¼šä¸­å¤®å¯„ã› ---
    let targetLeft = (sr.left - br.left + currentLeft) + (sr.width/2) - (viewW/2);
    const maxLeft = Math.max(0, (box.scrollWidth || 0) - viewW);
    const nextLeft = Math.max(0, Math.min(Math.round(targetLeft), maxLeft));

    box.scrollTop  = nextTop;
    box.scrollLeft = nextLeft;
  }

  // å¾Œè¿½ã„ã§ã‚»ãƒ³ã‚¿ãƒªãƒ³ã‚°ï¼ˆæç”»å®Œäº†å¾Œã«ä¸€ç™ºã ã‘ï¼‰
  function __centerActiveInWeekSoon(){
    // 1ãƒ•ãƒ¬ãƒ¼ãƒ å¾Œã«ä¸€åº¦ã ã‘å®Ÿè¡Œ
    requestAnimationFrame(__centerActiveInWeekNow);
  }



  // ---- ãƒ¢ãƒ¼ãƒ‰è§£é™¤ï¼ˆUIã®ã¿ï¼‰----
  document.body.classList.remove('dayFocus');
  document.querySelectorAll('#schedule .day').forEach(d => {
    d.style.display = '';         // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã® inline ã‚’è§£é™¤
    d.removeAttribute('data-focus');
  });
  document.getElementById('focusBackBtn')?.remove();
  window.focusDate = null;

  // ä»¥é™ã¯ã€Œå¾©å…ƒã€ãƒ­ã‚¸ãƒƒã‚¯ã€‚ã‚¹ã‚­ãƒƒãƒ—æŒ‡å®šã§ã‚‚é€±è¡¨ç¤ºã§â€œå¿…ãšâ€ä¸­å¤®å¯„ã›ã‚’å¾Œè¿½ã„ã§å®Ÿè¡Œ
  if (skipRestore) {
    // â˜… ä¸Šå¯„ã›ãŒäºˆç´„ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ä¸­å¤®å¯„ã›ã‚’è¡Œã‚ãªã„ï¼ˆrenderå´ã§å®Ÿæ–½ï¼‰
    if (!window.__snapTopOnNextRender) {
      __centerActiveInWeekSoon();
    }
    return;
  }

  const picker = document.getElementById('weekPicker');
  const z = n => String(n).padStart(2,'0');
  const ymd = d => `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;

  // A) æ˜ç¤ºã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼ˆæœˆæ›œï¼‰ã«åˆã‚ã›ã‚‹æŒ‡ç¤ºãŒã‚ã‚‹å ´åˆ
  if (targetMon && picker instanceof HTMLInputElement) {
    const mon = new Date(targetMon.getFullYear(), targetMon.getMonth(), targetMon.getDate());
    window.currentMonday = mon;
    picker.value = ymd(mon);
    picker.dispatchEvent(new Event('change', { bubbles: true }));
    window.__weekStartBeforeFocus = null;
    // é€±ãƒ“ãƒ¥ãƒ¼æç”»å®Œäº†å¾Œã«ä¸­å¤®å¯„ã›ï¼ˆå¾Œè¿½ã„ã§è¤‡æ•°å›ï¼‰
    __centerActiveInWeekSoon();
    return;
  }

  // B) å¾“æ¥ã®ã€Œãƒ•ã‚©ãƒ¼ã‚«ã‚¹å‰ã®é€±ã€ã«æˆ»ã™ï¼ˆæˆ»ã‚‹ãƒœã‚¿ãƒ³ç­‰ï¼‰
  if (picker instanceof HTMLInputElement && window.__weekStartBeforeFocus) {
    // __weekStartBeforeFocus ã¯ "YYYY-MM-DD" æƒ³å®š
    const [Y,M,D] = String(window.__weekStartBeforeFocus).split('-').map(Number);
    const mon = new Date(Y, (M||1)-1, D||1);
    window.currentMonday = mon;
    picker.value = ymd(mon);
    picker.dispatchEvent(new Event('change', { bubbles: true }));
    // é€±ãƒ“ãƒ¥ãƒ¼æç”»å®Œäº†å¾Œã«ä¸­å¤®å¯„ã›ï¼ˆå¾Œè¿½ã„ã§è¤‡æ•°å›ï¼‰
    __centerActiveInWeekSoon();	
  }
  window.__weekStartBeforeFocus = null;
}

// å›ºå®šãƒ˜ãƒƒãƒ€ãƒ¼é«˜ï¼ˆå¸¸ã«å·®ã—å¼•ãï¼‰
function __getHeaderOffsetPx(){
  const topbar = document.querySelector('.topbar');
  return topbar ? Math.ceil(topbar.getBoundingClientRect().height) : 0;
}

// ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¦ª
function __getScrollParent(node){
  let p = node?.parentElement;
  while (p && p !== document.body){
    const s = getComputedStyle(p);
    const ovY = s.overflowY || s.overflow;
    if (/(auto|scroll)/.test(ovY) && p.scrollHeight > p.clientHeight) return p;
    p = p.parentElement;
  }
  return document.scrollingElement || document.documentElement;
}

function applyUndoWithFocus(){
  const preferKey = window.lastSelectedKey || null;
  const wasFocus = document.body.classList.contains('dayFocus');

  // æ—¢å­˜ã® undo ã‚’å®Ÿè¡Œï¼ˆå†…éƒ¨ã§ render() ã—ã¦ã„ã¦ã‚‚OKï¼‰
  try { if (typeof undo === 'function') undo(); } catch{}

  // æç”»ã®ä¸€æœ¬åŒ–ï¼šãƒ•ã‚©ãƒ¼ã‚«ã‚¹ä¸­ã¯å¿…ãšãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç¶­æŒã§ã€é€±è¡¨ç¤ºã¯å¿µã®ãŸã‚ render
  if (wasFocus) {
    reRenderPreservingFocus(preferKey);
  } else {
    try { render(); } catch{}
  }
}

function applyRedoWithFocus(){
  const preferKey = window.lastSelectedKey || null;
  const wasFocus = document.body.classList.contains('dayFocus');

  try { if (typeof redo === 'function') redo(); } catch{}

  if (wasFocus) {
    reRenderPreservingFocus(preferKey);
  } else {
    try { render(); } catch{}
  }
}

// é€±â†’æ—¥ å†å…¥ç”¨ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
function __findDayByISO(iso){
  if (!iso) return null;
  const esc = (window.CSS?.escape ? CSS.escape(iso) : iso);
  // data-day="YYYY-MM-DD" ã‚’å„ªå…ˆã€‚ãªã‘ã‚Œã°è¦‹å‡ºã—ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ä¸€è‡´ã‚’æ¢ã™
  return document.querySelector(`.day[data-day="${esc}"]`)
      || Array.from(document.querySelectorAll('.day'))
           .find(d => (d.querySelector('.day-header-date')?.textContent || '').includes(iso));
}

// ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç¶­æŒãƒ»å®Œå…¨å¾©å…ƒï¼ˆISOå„ªå…ˆï¼‰
 function reRenderPreservingFocus(preferKey){
   const inFocus = document.body.classList.contains('dayFocus');
 
   // â‘  ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ—¥ã‚’â€œUIã®çŠ¶æ…‹â€ã‹ã‚‰å–å¾—ï¼ˆpickerã‚ˆã‚Š window.focusDate ã‚’ä¿¡ç”¨ï¼‰
   let focusISO = inFocus ? (window.focusDate || null) : null;
   if (!focusISO && inFocus) {
     const txt = document.querySelector('.day[data-focus="true"] .day-header-date')?.textContent || '';
     const m = txt && txt.match(/(\d{4})\/(\d{2})\/(\d{2})/);
     if (m) focusISO = `${m[1]}-${m[2]}-${m[3]}`;
   }
 
   // â‘¡ ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã¯è§£é™¤ã›ãšã€ãã®ã¾ã¾é€±ã‚’å†æç”»
   preserveScrollWhile(()=> render());
 
   // é€±è¡¨ç¤ºãªã‚‰ã“ã“ã§çµ‚ã‚ã‚Š
   if (!inFocus) return;
 
   // â‘¢ ãƒ”ãƒƒã‚«ãƒ¼ã‚’å½“æ—¥ã«æˆ»ã™ï¼ˆchangeæŠ‘æ­¢ï¼‰ã€‚é€±ãƒŠãƒ“é–¢æ•°ã¯å‘¼ã°ãªã„
   if (focusISO){
     const picker = document.getElementById('weekPicker');
     if (picker){
       const prev = window.__suppressWeekChange;
       window.__suppressWeekChange = true;
       picker.value = focusISO;
       window.__suppressWeekChange = prev;
     }
     // UIåŸºæº–æ—¥ã‚‚ç¶­æŒ
     window.focusDate = focusISO;
   }
 
   // â‘£ å½“æ—¥ã® .day ã‚’æ®‹ã—ã¦ä»–æ—¥ã‚’éš ã™ï¼ˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹è¡¨ç¤ºã‚’å¾©å…ƒï¼‰
   if (typeof enforceFocusView === 'function') enforceFocusView();
 
   // â‘¤ ã‚¹ãƒ­ãƒƒãƒˆå†é¸æŠï¼špreferKey > lastSelectedKey > å½“æ—¥å…ˆé ­
   const dayEl = __findDayByISO?.(focusISO) || document.querySelector('body.dayFocus .day[data-focus="true"]');
   const pickByKey = (key)=>{
     if (!key) return null;
     const sel = `.slot[data-key="${(window.CSS?.escape ? CSS.escape(key) : key)}"]`;
     return (dayEl && dayEl.querySelector(sel)) || document.querySelector(sel);
   };
   const target = pickByKey(preferKey) || pickByKey(window.lastSelectedKey);
   if (target) setActiveSlot(target); else if (dayEl) ensureInitialSelectionForDay(dayEl);
 }



// Escã§è§£é™¤ï¼ˆ1å›ã ã‘ãƒã‚¤ãƒ³ãƒ‰ï¼‰
if (!window.__focusEscBound){
  document.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape'){
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ã‚‹ã¨ãã¯ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è§£é™¤ã«é€²ã¾ãªã„ï¼ˆ<dialog> ã®ESCãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé–‰ã˜ã‚’å„ªå…ˆï¼‰
        const modalOpen = document.querySelector('dialog[open]');
        if (modalOpen) return;
        if (document.body.classList.contains('dayFocus')){
          e.preventDefault();
          exitDayFocus();
        }
      }
  }, true);
  window.__focusEscBound = true;
}


  // ===== æ™‚åˆ»ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ï¼ˆé€±å˜ä½ï¼‰ =====
  function loadTimeOverrides(week){ try{ return JSON.parse(localStorage.getItem('timeovr_'+weekKey(week))) || {}; }catch(e){ return {}; } }
  function saveTimeOverrides(week, obj){ localStorage.setItem('timeovr_'+weekKey(week), JSON.stringify(obj||{})); }
  function setTimeOverride(week, dayKey, section, idx, hhmm){ const store = loadTimeOverrides(week); const key = `${dayKey}|${section}`; if(!store[key]) store[key] = {}; store[key][idx] = hhmm; saveTimeOverrides(week, store); }
  function clearTimeOverrideFrom(week, dayKey, section, idx){ const store = loadTimeOverrides(week); const key = `${dayKey}|${section}`; if(store[key]){ for(const k of Object.keys(store[key])){ if(Number(k) >= idx) delete store[key][k]; } if(Object.keys(store[key]).length===0) delete store[key]; saveTimeOverrides(week, store); } }
  function clearTimeOverrideAll(week, dayKey, section){ const store = loadTimeOverrides(week); const key = `${dayKey}|${section}`; if(store[key]){ delete store[key]; saveTimeOverrides(week, store); } }
  function getSlotTimeHHMMEx(baseHHMM, week, dayKey, section, idx){ let store = {}; try { store = JSON.parse(localStorage.getItem('timeovr_' + weekKey(week))) || {}; } catch(_) {} const table = store[`${dayKey}|${section}`] || {}; let anchorIdx = -1, anchorHHMM = baseHHMM; for (const k of Object.keys(table)){ const n = Number(k); if (Number.isFinite(n) && n <= idx && n > anchorIdx){ anchorIdx = n; anchorHHMM = table[k]; } } const steps = idx - (anchorIdx >= 0 ? anchorIdx : 0); return addMinutes(anchorHHMM, steps * 20); }
function debugTimeOverrides(label){
  try {
    const raw = localStorage.getItem('timeovr_' + weekKey(currentMonday));
    const store = raw ? JSON.parse(raw) : {};
    console.log('==== timeovr DEBUG:', label, '====');
    console.log(JSON.stringify(store, null, 2));
  } catch(e){
    console.warn('debugTimeOverrides failed:', e);
  }
}

// â˜…ã‚¹ãƒ­ãƒƒãƒˆå‰Šé™¤æ™‚ã«ã€æ‰€è¦æ™‚é–“ã‚¢ãƒ³ã‚«ãƒ¼ã‚’ç‰‡ä»˜ã‘ã‚‹å…±é€šãƒ˜ãƒ«ãƒ‘ãƒ¼
function cleanupTimeOverrideOnDelete(firstKey, store){
  try{
    if (!firstKey) return;

    let key = firstKey;
    let rec = store[key];

    // tail ã‚’æŒ‡å®šã—ã¦æ¶ˆã™ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚‚å¯¾å¿œï¼ˆtail.head ã« head ã®ã‚­ãƒ¼ãŒå…¥ã£ã¦ã„ã‚‹å‰æï¼‰
    if (rec && rec.tail && rec.head){
      key = rec.head;
      rec = store[key] || rec; // å¿µã®ãŸã‚
    }

    const p = parseKey(key);   // { d, day, section, idx }
    if (!p) return;

    // head ãªã‚‰ span ã‚’è¦‹ã‚‹ã€‚ãªã‘ã‚Œã°å˜æ æ‰±ã„ã§ 1
    const span = (rec && rec.head)
      ? Math.max(1, Number(rec.span || 1))
      : 1;

    // ã€Œå‰Šé™¤ã™ã‚‹ãƒ–ãƒ­ãƒƒã‚¯ã®æœ«å°¾ã®æ¬¡ã€ã‹ã‚‰å¾Œã‚ã®ã‚¢ãƒ³ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢
    clearTimeOverrideFrom(
      currentMonday,
      p.day,         // Mon / Tue ...
      p.section,     // 0,1,2...
      p.idx + span   // æœ«å°¾ idx + 1
    );
  }catch(e){
    console.warn('cleanupTimeOverrideOnDelete failed:', e);
  }
}

function autoRebuildTimeOverridesForSectionAfterDelete(anyKey, store){
  try{
    if (!anyKey) return;
    const { day, section } = parseKey(anyKey);
    if (!day || section == null) return;

    // 1) ã“ã® day/section ã®ã‚¢ãƒ³ã‚«ãƒ¼ã‚’ã„ã£ãŸã‚“å…¨å‰Šé™¤
    clearTimeOverrideFrom(
      currentMonday,
      day,
      section,
      0   // idx=0 ã‹ã‚‰å…ˆã‚’å…¨éƒ¨æ¶ˆã™ã‚¤ãƒ¡ãƒ¼ã‚¸
    );

    // 2) åŒã˜ day/section ã®ã€Œtail ä»¥å¤–ã€ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ idx æ˜‡é †ã«å–å¾—
    const entries = Object.keys(store)
      .map(k => ({ key: k, info: parseKey(k), rec: store[k] }))
      .filter(o =>
        o.rec &&
        !o.rec.tail &&
        o.info.day === day &&
        o.info.section === section
      )
      .sort((a, b) => a.info.idx - b.info.idx);

    if (!entries.length) return;

    // 3) å„ head / duration ä»˜ãæ ã«å¯¾ã—ã¦ã€å…ƒã®ãƒ­ã‚¸ãƒƒã‚¯ã¨åŒã˜æ–¹å¼ã§ã‚¢ãƒ³ã‚«ãƒ¼ã‚’å¼µã‚Šç›´ã™
    for (const { key, rec } of entries){
      const hasDuration = Number(rec.duration || 0) > 0;
      const isMergeHead = !!rec.head && Math.max(1, Number(rec.span || 1)) > 1;

      // duration ãŒå…¥ã£ã¦ã„ã‚‹æ ã€ã¾ãŸã¯çµåˆ head ã ã‘ãŒã€ŒæŠ¼ã—å‡ºã—ã®èµ·ç‚¹ã€ã«ãªã‚‹
      if (hasDuration || isMergeHead){
        applyDurationAnchorForHead(key, store);
      }
    }

    if (typeof debugTimeOverrides === 'function'){
      debugTimeOverrides('after autoRebuildTimeOverridesForSectionAfterDelete');
    }
  }catch(e){
    console.warn('autoRebuildTimeOverridesForSectionAfterDelete failed:', e);
  }
}


  // ===== ä¼‘æ­¢æƒ…å ± =====
  function loadDayOff(week){ try { return JSON.parse(localStorage.getItem('dayoff_'+weekKey(week))) || {}; } catch(_) { return {}; } }
  function saveDayOffRaw(week, obj){ localStorage.setItem('dayoff_'+weekKey(week), JSON.stringify(obj||{})); }
  function setDayOff(week, dayKey, patch, opts){ const map = loadDayOff(week); const cur = map[dayKey] || {}; map[dayKey] = Object.assign({}, cur, patch||{}); try{ if(opts?.snapshot){ undoStack.push(snapshotState()); redoStack.length=0; } }catch(_){} saveDayOffRaw(week, map); }
  function clearDayOffForDay(week, dayKey, opts){ const map = loadDayOff(week); if (map && map[dayKey] !== undefined) { try{ if(opts?.snapshot){ undoStack.push(snapshotState()); redoStack.length=0; } }catch(_){} delete map[dayKey]; saveDayOffRaw(week, map); } }

  // ===== å€‹åˆ¥æ ã®ã€Œè‡¨æ™‚åŒ–ï¼ˆç·Šæ€¥ï¼‰ã€ =====
  function loadEmerg(week){ try{ return JSON.parse(localStorage.getItem('emerg_' + weekKey(week))) || {}; } catch(_){ return {}; } }
  function saveEmergRaw(week, obj){ localStorage.setItem('emerg_' + weekKey(week), JSON.stringify(obj || {})); }
  function setEmergency(week, slotKey, enabled, opts){ const map = loadEmerg(week); if (enabled) map[slotKey] = true; else delete map[slotKey]; try{ if(opts?.snapshot){ undoStack.push(snapshotState()); redoStack.length=0; } }catch(_){} saveEmergRaw(week, map); }

  // ===== æ æ•°ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ï¼ˆè‡¨æ™‚æ ï¼‰ =====
  function loadSlotOverrides(week){ try{ return JSON.parse(localStorage.getItem('slotovr_'+weekKey(week))) || {}; }catch(e){ return {}; } }
  function saveSlotOverrides(week, obj){ localStorage.setItem('slotovr_'+weekKey(week), JSON.stringify(obj||{})); }
  function getSectionKey(dayKey, section){ return `${dayKey}|${section}`; }
  function ensureSlotOvrShape(ovr, dayKey, section){ const key = getSectionKey(dayKey, section); if (!ovr[key]) ovr[key] = {}; const s = ovr[key]; if (typeof s.extraHead !== 'number') s.extraHead = 0; if (typeof s.extraTail !== 'number') s.extraTail = 0; if (!Array.isArray(s.inserts)) s.inserts = []; s.inserts = Array.from(new Set(s.inserts.filter(n=>Number.isInteger(n) && n>=0))).sort((a,b)=>a-b); return s; }
  function getSectionOvr(week, dayKey, section){ const o = loadSlotOverrides(week) || {}; return ensureSlotOvrShape(o, dayKey, section); }
function resetSlotLayoutForDay(week, dayKey, opts = {}) {
   const ovr = loadSlotOverrides(week) || {};

  // ãã®æ—¥ã®å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆä¾‹: "Fri|0","Fri|1",...ï¼‰ã‚’å‰Šé™¤
  const prefix = `${dayKey}|`;
  let changed = false;
  Object.keys(ovr).forEach(k => {
    if (k.startsWith(prefix)) { delete ovr[k]; changed = true; }
  });
  if (!changed) return;

  // ä¿å­˜
  saveSlotOverrides(week, ovr);

  // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§å³åæ˜ 
   if (opts.snapshot) {
     // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ä¸­ã§ã‚‚é€±è¡¨ç¤ºã§ã‚‚æ­£ã—ãå¾©å¸°
     if (document.body.classList.contains('dayFocus')) {
       reRenderPreservingFocus();
     } else {
       render();
     }
   }
}

  function setSectionOvr(week, dayKey, section, patch){ const all = loadSlotOverrides(week) || {}; const s = ensureSlotOvrShape(all, dayKey, section); Object.assign(s, patch); saveSlotOverrides(week, all); }
  function getExtraTailSlots(week, dayKey, section){ return getSectionOvr(week, dayKey, section).extraTail|0; }
  function setExtraTailSlots(week, dayKey, section, n){ const v = Math.max(0, Number(n)||0); setSectionOvr(week, dayKey, section, { extraTail: v }); }
  function addExtraTailSlot(week, dayKey, section, n=1){ const s = getSectionOvr(week, dayKey, section); setSectionOvr(week, dayKey, section, { extraTail: s.extraTail + (Number(n)||0) }); }
  function removeExtraTailSlot(week, dayKey, section){ const cur = getExtraTailSlots(week, dayKey, section); if(cur > 0){ setExtraTailSlots(week, dayKey, section, cur - 1); } }
  function getSectionLayout(week, dayKey, section, baseCount){ const s = getSectionOvr(week, dayKey, section); const extraHead = s.extraHead|0; const extraTail = s.extraTail|0; const inserts = Array.from(new Set(s.inserts)).sort((a,b)=>a-b); const total = extraHead + baseCount + inserts.length + extraTail; function isTemp(idx){ if (idx < extraHead) return true; if (idx >= extraHead + baseCount + inserts.length) return true; const posInBody = idx - extraHead; return inserts.includes(posInBody); } function toBaseIndex(idx){ if (isTemp(idx)) return -1; const posInBody = idx - extraHead; const leftInserts = inserts.filter(n => n < posInBody).length; return posInBody - leftInserts; } return { total, isTemp, toBaseIndex, extraHead, extraTail, inserts }; }
  // æŒ‡å®š day / section ã®ã€Œidx >= fromIdxã€ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ã€delta åˆ†ã ã‘ idx ã‚·ãƒ•ãƒˆ
  function shiftSectionRecordsForTempInsert(week, dayKey, section, fromIdx, delta){
    if (!delta) return;

    const store = loadWeek(week) || {};

    // å¯¾è±¡ day / section ã§ idx >= fromIdx ã®ã‚‚ã®ã ã‘é›†ã‚ã‚‹
    const targets = Object.keys(store)
      .map(key => ({ key, info: parseKey(key) }))
      .filter(o =>
        o.info.day === dayKey &&
        o.info.section === section &&
        o.info.idx >= fromIdx
      );

    if (!targets.length) return;

    // å¾Œã‚ã‹ã‚‰å‰ã¸ãšã‚‰ã™ï¼ˆã‚­ãƒ¼è¡çªã‚’é˜²ãï¼‰
    targets.sort((a, b) => b.info.idx - a.info.idx);

    for (const { key, info } of targets){
      const rec = store[key];
      delete store[key];

      const meta = { ...info, idx: info.idx + delta };
      const newKey = slotKey(meta);
      store[newKey] = rec;
    }

    // schedule_ ã‚’ä¿å­˜
    saveWeek(week, store);

  // â˜… ã“ã® day / section ã® duration ã‚¢ãƒ³ã‚«ãƒ¼ã‚’ã€Œæœ€åˆã‹ã‚‰ã€çµ„ã¿ç›´ã™
  if (typeof rebuildDurationAnchorsForDaySection === 'function'){
    rebuildDurationAnchorsForDaySection(dayKey, section, store);    }
  }

  function insertTempBefore(week, dayKey, section, displayIndex){
    const all = loadSlotOverrides(week) || {};
    const s   = ensureSlotOvrShape(all, dayKey, section);

    // å…ˆé ­ã‚ˆã‚Šå‰ã«æŒ¿å…¥ã™ã‚‹ã‚±ãƒ¼ã‚¹
    if (displayIndex <= 0){
      // è¦‹ãŸç›®ä¸Šã®ã€Œé ­å‡ºã—ã€æ ã‚’ 1 ã¤å¢—ã‚„ã™
      s.extraHead += 1;
      saveSlotOverrides(week, all);

      // â˜… ãƒ‡ãƒ¼ã‚¿å´ã‚‚ idx 0 ä»¥é™ã‚’ 1 ã¤ä¸‹ã«æŠ¼ã—å‡ºã™ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒç„¡ã‘ã‚Œã°ä½•ã‚‚ã—ãªã„ï¼‰
      shiftSectionRecordsForTempInsert(week, dayKey, section, 0, +1);

      return;
    }

    // ãã‚Œä»¥å¤–ï¼ˆæœ¬æ–‡ä¸­ã«æŒ¿å…¥ï¼‰ã®ã‚±ãƒ¼ã‚¹
  const layout    = getSectionLayout(week, dayKey, section, CONFIG[dayKey][section].slots);
  const posInBody = Math.max(0, displayIndex - layout.extraHead);

  // â˜… ã™ã§ã«å­˜åœ¨ã™ã‚‹è‡¨æ™‚æ ã®ä½ç½®ã‚‚ã€æŒ¿å…¥ä½ç½®ä»¥é™ã¯ 1 ã¤å¾Œã‚ã«ãšã‚‰ã™
  if (Array.isArray(s.inserts) && s.inserts.length){
    s.inserts = s.inserts.map(n => (n >= posInBody ? n + 1 : n));
  }

  if (!s.inserts.includes(posInBody)){
    s.inserts.push(posInBody);
    s.inserts = Array.from(new Set(s.inserts)).sort((a,b)=>a-b);
    saveSlotOverrides(week, all);

    // å®Ÿãƒ‡ãƒ¼ã‚¿ã‚‚åŒã˜ fromIdx ä»¥é™ã‚’ 1 ã¤æŠ¼ã—å‡ºã™
    shiftSectionRecordsForTempInsert(week, dayKey, section, posInBody, +1);
  }
  }
  // çµåˆæ ã«ã‚‚å¯¾å¿œã—ãŸã€Œã“ã®æ ã®å¾Œã«è‡¨æ™‚æ ã‚’æŒ¿å…¥ã€
function insertTempAfter(week, dayKey, section, displayIndex){
  const all       = loadSlotOverrides(week) || {};
  const s         = ensureSlotOvrShape(all, dayKey, section);
  const baseCount = CONFIG[dayKey][section].slots;
  const layout    = getSectionLayout(week, dayKey, section, baseCount);

  // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸè¡¨ç¤º index ã«å¯¾å¿œã™ã‚‹ã€Œãƒ™ãƒ¼ã‚¹ indexã€ï¼ˆ0,1,2,...ï¼‰
  const baseIdx = Math.max(0, displayIndex - layout.extraHead);

  // å¯¾è±¡ã‚¹ãƒ­ãƒƒãƒˆã® span ã‚’å–å¾—ï¼ˆçµåˆæ ãªã‚‰ span>1ï¼‰
  const store = loadWeek(week) || {};
  let span    = 1;

  for (const key of Object.keys(store)){
    const info = parseKey(key);   // { d, day, section, idx }
    if (info.day === dayKey && info.section === section && info.idx === baseIdx){
      const rec     = store[key];
      const recSpan = Number(rec && rec.span);
      if (rec && !rec.tail && Number.isFinite(recSpan) && recSpan > 1){
        span = recSpan;          // çµåˆ head ã® span ã‚’æ¡ç”¨
      }
      break;
    }
  }

  // â˜… çµåˆæ å…¨ä½“ã®ã€Œå¾Œã‚ã€ã«æŒ¿å…¥ã—ãŸã„ã®ã§ã€baseIdx + span ã‚’æŒ¿å…¥ä½ç½®ã¨ã™ã‚‹
  const insertAt = baseIdx + span;

  // æ—¢å­˜ã®è‡¨æ™‚æ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§ã€æŒ¿å…¥ä½ç½®ä»¥é™ã®ã‚‚ã®ã¯ 1 ã¤å¾Œã‚ã¸ãšã‚‰ã™
  if (Array.isArray(s.inserts) && s.inserts.length){
    s.inserts = s.inserts.map(n => (n >= insertAt ? n + 1 : n));
  }

  // ä»Šå›ã®æŒ¿å…¥ä½ç½®ã‚’è¿½åŠ ï¼ˆé‡è¤‡ã¯é¿ã‘ã¦ã‚½ãƒ¼ãƒˆï¼‰
  if (!s.inserts.includes(insertAt)){
    s.inserts.push(insertAt);
    s.inserts = Array.from(new Set(s.inserts)).sort((a,b)=> a - b);
  }

  // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã‚’ä¿å­˜
  saveSlotOverrides(week, all);

  // å®Ÿãƒ‡ãƒ¼ã‚¿ï¼ˆschedule_ï¼‰ã‚’ã€insertAt ä»¥é™ 1 ã‚³ãƒåˆ†å¾Œã‚ã¸æŠ¼ã—å‡ºã™
  // â†’ ãã®å¾Œ rebuildDurationAnchorsForDaySection ã«ã‚ˆã‚Šçµåˆæ ã®æ™‚é–“ã‚‚å†è¨ˆç®—ã•ã‚Œã‚‹
  shiftSectionRecordsForTempInsert(week, dayKey, section, insertAt, +1);
}

  function removeTempAt(week, dayKey, section, displayIndex){
    const all = loadSlotOverrides(week) || {};
    const s = ensureSlotOvrShape(all, dayKey, section);
    const baseCount = CONFIG[dayKey][section].slots;
    const layout = getSectionLayout(week, dayKey, section, baseCount);

    if (!layout.isTemp(displayIndex)) return;

    if (displayIndex >= layout.total - 1 && s.extraTail > 0){
      s.extraTail -= 1;
      saveSlotOverrides(week, all);
      return;
    }

    if (displayIndex < s.extraHead && s.extraHead > 0){
      s.extraHead -= 1;
      saveSlotOverrides(week, all);
	  
	  // â˜… å…ˆé ­è‡¨æ™‚æ ã‚’å‰Šé™¤ã—ãŸå ´åˆã‚‚ã€idx=0 ä»¥é™ã‚’è©°ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹
	  slideSectionDataUpFromIndex(week, dayKey, section, 0);
	  
      return;
    }

    // â˜… æœ¬ä½“ã®é€”ä¸­ã«æŒ¿å…¥ã•ã‚Œã¦ã„ãŸè‡¨æ™‚æ ã‚’å‰Šé™¤ã™ã‚‹ã‚±ãƒ¼ã‚¹
  const posInBody = displayIndex - s.extraHead;
  const i = s.inserts.indexOf(posInBody);
  if (i >= 0){
    // 1) ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¸Šã®è‡¨æ™‚æ æƒ…å ±ã‚’å‰Šé™¤
    s.inserts.splice(i, 1);
    saveSlotOverrides(week, all);

    // 2) ã“ã®è‡¨æ™‚æ ãŒã€ŒæŒŸã¾ã£ã¦ã„ãŸä½ç½®ã€ãã®ã‚‚ã®ãŒ baseIdx ãªã®ã§ã€
    //    ãã®ä½ç½®ä»¥é™ã®ãƒ‡ãƒ¼ã‚¿ã‚’ 1 ã‚³ãƒå‰ã«è©°ã‚ã‚‹
    const baseIdx = posInBody;
    slideSectionDataUpFromIndex(week, dayKey, section, baseIdx);
  }
  }



// â˜… è‡¨æ™‚æ ã‚’å‰Šé™¤ã—ãŸã¨ãã«ã€
//    ãã®ç›´å¾Œï¼ˆbaseIdxï¼‰ä»¥é™ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã€
//    ã€Œãã®æ—¥ãƒ»ãã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§å®Ÿéš›ã«å­˜åœ¨ã™ã‚‹ä¸€ç•ªæœ€å¾Œã® idxã€ã¾ã§
//    ã™ã¹ã¦ 1 ã‚³ãƒãšã¤å‰ã«è©°ã‚ã‚‹ã€‚
//    â†’ ä¸€ç•ªæœ€å¾Œã® idx ã®æ ã ã‘ç©ºã«ãªã‚‹ï¼ˆèª°ã‚‚æ¶ˆãˆãªã„ï¼‰ã€‚
function slideSectionDataUpFromIndex(week, dayKey, section, baseIdx){
  const store = loadWeek(week) || {};

  // 1) ã“ã® day / section ã§å®Ÿéš›ã«å­˜åœ¨ã™ã‚‹æœ€å¤§ idx ã‚’æ±‚ã‚ã‚‹
  let maxIdx = -1;
  let dISOForKeys = null;

  for (const key of Object.keys(store)){
    const p = parseKey(key);  // { d, day, section, idx }
    if (!p) continue;
    if (p.day !== dayKey || p.section !== section) continue;
    if (p.idx > maxIdx){
      maxIdx = p.idx;
      dISOForKeys = p.d;  // å®Ÿéš›ã® d ã‚’ä½¿ã†
    }
  }

  // ãƒ‡ãƒ¼ã‚¿ãŒãªã„ï¼è©°ã‚ã‚‹ç¯„å›²ãŒå­˜åœ¨ã—ãªã„å ´åˆ
  if (maxIdx < 0 || baseIdx > maxIdx) {
    if (typeof rebuildDurationAnchorsForDaySection === 'function'){
      rebuildDurationAnchorsForDaySection(dayKey, section, store);
    }
    return;
  }

  // dISO ã¯ store ã«å®Ÿéš›ã«å…¥ã£ã¦ã„ã‚‹ã‚­ãƒ¼ã‹ã‚‰å–å¾—ã—ãŸã‚‚ã®ã‚’ä½¿ã†
  const dISO = dISOForKeys;

  // 2) baseIdx ã€œ maxIdx-1 ã¾ã§ã‚’ 1 ã‚³ãƒãšã¤å‰ã«è©°ã‚ã‚‹
  //    ä¾‹ï¼šbaseIdx=2 ã®ã¨ã
  //      idx=2 <- 3
  //      idx=3 <- 4
  //      ...
  //      idx=maxIdx-1 <- maxIdx
  for (let idx = baseIdx; idx < maxIdx; idx++){
    const fromKey = `${dISO}|${dayKey}|${section}|${idx+1}`;
    const toKey   = `${dISO}|${dayKey}|${section}|${idx}`;

    if (store[fromKey]){
      store[toKey] = store[fromKey];
    } else {
      delete store[toKey];
    }
  }

  // 3) ã„ã¡ã°ã‚“æœ€å¾Œã® idxï¼ˆmaxIdxï¼‰ã¯ã€å‰ã«è©°ã‚ãŸçµæœã€Œä½™ã‚Šã€ã«ãªã‚‹ã®ã§ç©ºã«ã™ã‚‹
  const lastKey = `${dISO}|${dayKey}|${section}|${maxIdx}`;
  delete store[lastKey];

  saveWeek(week, store);

  if (typeof rebuildDurationAnchorsForDaySection === 'function'){
    rebuildDurationAnchorsForDaySection(dayKey, section, store);
  }
}



  // ===== Undo / Redo =====
  let undoStack = [];
  let redoStack = [];

// === çµåˆâ†’å³ç·¨é›†ç”¨ã® Undo ãƒãƒƒãƒãŒé–‹ã„ã¦ã„ã‚‹ã‹ã©ã†ã‹ ===
let mergeEditBatchOpen = false;

  // === Undoå±¥æ­´ã®ãƒãƒƒãƒãƒ³ã‚°ç”¨ãƒ•ãƒ©ã‚° ===
  let undoBatchDepth = 0;
  let undoBatchSnapshot = null;

  function beginUndoBatch(){
    if (undoBatchDepth === 0){
      try{
        undoBatchSnapshot = snapshotState();  // ãƒãƒƒãƒé–‹å§‹æ™‚ã®çŠ¶æ…‹ã‚’1å›ã ã‘ä¿å­˜
      }catch(e){
        undoBatchSnapshot = null;
      }
    }
    undoBatchDepth++;
  }

  function endUndoBatch(){
    if (undoBatchDepth === 0) return;
    undoBatchDepth--;
    if (undoBatchDepth === 0 && undoBatchSnapshot){
      // ãƒãƒƒãƒã®æœ€åˆã®çŠ¶æ…‹ã‚’1ã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦ç©ã‚€
      undoStack.push(undoBatchSnapshot);
      redoStack.length = 0;
      undoBatchSnapshot = null;
    }
  }

  function inUndoBatch(){
    return undoBatchDepth > 0;
  }

  function snapshotState(){
    return {
      week:   loadWeek(currentMonday),             // â† â˜… æœ¬ä½“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
      timeovr: loadTimeOverrides(currentMonday),   // æ‰€è¦æ™‚é–“ã‚¢ãƒ³ã‚«ãƒ¼
      slotovr: loadSlotOverrides(currentMonday),
      notes:   loadNotes(currentMonday),
      dayoff:  loadDayOff(currentMonday),
      emerg:   loadEmerg(currentMonday)
    };
  }
  function restoreState(snap){
    if(!snap) return;
    const wk = weekKey(currentMonday);
 
    // â˜… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æœ¬ä½“ã‚’æˆ»ã™
    localStorage.setItem('schedule_' + wk, JSON.stringify(snap.week || {}));
 
    // æ‰€è¦æ™‚é–“ã‚¢ãƒ³ã‚«ãƒ¼ã‚„ãã®ä»–ã®æ‹¡å¼µãƒ†ãƒ¼ãƒ–ãƒ«ã‚‚æˆ»ã™
    localStorage.setItem('timeovr_' + wk, JSON.stringify(snap.timeovr || {}));
    localStorage.setItem('slotovr_' + wk, JSON.stringify(snap.slotovr || {}));
    localStorage.setItem('notes_'  + wk, JSON.stringify(snap.notes  || {}));
    localStorage.setItem('dayoff_' + wk, JSON.stringify(snap.dayoff || {}));
    localStorage.setItem('emerg_'  + wk, JSON.stringify(snap.emerg  || {}));
  }
const __saveTimeOverrides = saveTimeOverrides;
saveTimeOverrides = function(week, obj){
  try{
    // â˜… ãƒãƒƒãƒä¸­ã¯ã“ã“ã§ snapshot ã‚’ç©ã¾ãªã„
    if (!inUndoBatch()){
      undoStack.push(snapshotState());
      redoStack.length = 0;
    }
  }catch(e){}
  __saveTimeOverrides(week, obj);
};

const __saveSlotOverrides = saveSlotOverrides;
saveSlotOverrides = function(week, obj){
  try{
    if (!inUndoBatch()){
      undoStack.push(snapshotState());
      redoStack.length = 0;
    }
  }catch(e){}
  __saveSlotOverrides(week, obj);
};
// â­â­â­ â† ã“ã“ã«è¿½åŠ ï¼ˆsaveWeek ã®ãƒ©ãƒƒãƒ—ï¼‰
//
const __saveWeek = saveWeek;
saveWeek = function(week, obj){
  try{
    if (!inUndoBatch()){        // â˜… ãƒãƒƒãƒä¸­ã¯ç©ã¾ãªã„
      undoStack.push(snapshotState());
      redoStack.length = 0;
    }
  }catch(e){}

  __saveWeek(week, obj);        // æœ¬æ¥ã® saveWeek
};
  function undo(){ if(undoStack.length === 0){ alert('æˆ»ã›ã‚‹æ“ä½œãŒã‚ã‚Šã¾ã›ã‚“'); return; } const prev = undoStack.pop(); const cur  = snapshotState(); redoStack.push(cur); restoreState(prev); render(); }
  function redo(){ if(redoStack.length === 0){ alert('ã‚„ã‚Šç›´ã—å¯èƒ½ãªæ“ä½œãŒã‚ã‚Šã¾ã›ã‚“'); return; } const next = redoStack.pop(); const cur  = snapshotState(); undoStack.push(cur); restoreState(next); render(); }
  document.getElementById('undoBtn')?.addEventListener('click', undo);
  document.getElementById('redoBtn')?.addEventListener('click', redo);
  function isTypingContext(e){ const el = e.target; const tag = (el?.tagName || '').toLowerCase(); return el?.isContentEditable || tag === 'input' || tag === 'textarea' || tag === 'select'; }
document.addEventListener('keydown', (e)=>{
// ===== ãƒ¢ãƒ¼ãƒ‰ä¸­ã®ã‚­ãƒ¼æ“ä½œåˆ¶å¾¡ï¼ˆarrival / IOL / PATH å…±é€šï¼‰=====
if (arrivalModeOn || iolModeOn || pathModeOn) {
  const k = e.key.toLowerCase();

  // Escï¼šãƒ¢ãƒ¼ãƒ‰çµ‚äº†
  if (e.key === 'Escape') {
    e.preventDefault();
    setArrivalMode(false);
    setIolMode(false);
	setPathMode(false);
    return;
  }

  // Ctrl+Kï¼šarrivalãƒ¢ãƒ¼ãƒ‰çµ‚äº†ï¼ˆarrivalæ™‚ã®ã¿ï¼‰
  if (arrivalModeOn && (e.ctrlKey || e.metaKey) && !e.shiftKey && k === 'k') {
    e.preventDefault();
    setArrivalMode(false);
    return;
  }

  // ãã‚Œä»¥å¤–ã¯å®Œå…¨é®æ–­
  e.preventDefault();
  e.stopPropagation();
  e.stopImmediatePropagation();
  return;
}


  if(isTypingContext(e)) return;
  const k = e.key.toLowerCase(); 

  // arrival âœ“ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼šEscã§çµ‚äº†
  if (arrivalModeOn && e.key === 'Escape') {
    e.preventDefault();
    setArrivalMode(false);
    return;
  }

  // arrival âœ“ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼šCtrl+Kã§ãƒˆã‚°ãƒ«
  if ((e.ctrlKey || e.metaKey) && !e.shiftKey && k === 'k') {
    e.preventDefault();
    setArrivalMode(!arrivalModeOn);
    return;
  }
  if((e.ctrlKey || e.metaKey) && !e.shiftKey && k === 'z'){        // Undo
    e.preventDefault();
    applyUndoWithFocus();

  }else if((e.ctrlKey || e.metaKey) && (k === 'y' || (e.shiftKey && k === 'z'))){ // Redo
    e.preventDefault();
    applyRedoWithFocus();

  }else if ((e.ctrlKey || e.metaKey) && !e.shiftKey && k === 'm'){ // â˜… è¤‡æ•°ç©ºæ  â†’ çµåˆæ 
    e.preventDefault();
    createMergeFromMultiSelection();
  }
}, true);



// ===== ç·¨é›†ãƒ­ãƒƒã‚¯åˆ¤å®šï¼ˆç¥æ—¥/ä¼‘æ­¢â†’ç·¨é›†ä¸å¯ã€‚è‡¨æ™‚/ç·Šæ€¥ã¯é™¤å¤–ï¼‰ =====
function isSlotLockedForEdit(slotEl){
  if (!slotEl) return true;                       // è¦ç´ ãŒç„¡ã‘ã‚Œã°å®‰å…¨å´ã§ä¸å¯
  if (slotEl.classList.contains('emergency-slot')) return false; // ç·Šæ€¥ã¯å¸¸ã«å¯
  if (slotEl.classList.contains('temp-slot'))      return false; // è‡¨æ™‚ï¼ˆé€±æœ«ãªã©ï¼‰ã‚‚å¯

  // ã‚»ã‚¯ã‚·ãƒ§ãƒ³/æ™‚åˆ»ã«ã‚ˆã‚‹ä¼‘æ­¢ â†’ .off ãŒä»˜ã
  if (slotEl.classList.contains('off')) return true;

  // ç¥æ—¥ï¼ˆ.day ã« is-holiday ãŒä»˜ãï¼‰ã¯ç·¨é›†ä¸å¯
  const day = slotEl.closest('.day');
  if (day && day.classList.contains('is-holiday')) return true;

  return false;
}

  // ===== ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆ‡æ›¿ =====
  const MODE_KEY = 'layoutMode';
  let layoutMode = localStorage.getItem(MODE_KEY) || '2';
function applyLayout(mode){
  // dayFocus ä¸­ã¯ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå¤‰æ›´ã‚’ç„¡åŠ¹åŒ–
  if (document.body.classList.contains('dayFocus')) return;

  layoutMode = mode;
  document.body.classList.remove('fiveCols','fourCols');
  if(mode==='5') document.body.classList.add('fiveCols');
  if(mode==='4') document.body.classList.add('fourCols');
  localStorage.setItem(MODE_KEY, layoutMode);
  render();

  // â˜… ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå¤‰æ›´ç›´å¾Œã«ã‚‚ã€é€±ç§»å‹•ã¨åŒæ§˜ã«ã€Œã‚¢ã‚¯ãƒ†ã‚£ãƒ–ç¢ºå®šï¼‹ä¸­å¤®å¯„ã›ã€ã‚’å®Ÿè¡Œ
  window.__postWeekMoveCenter?.();
}


  mode2?.addEventListener('click', ()=> applyLayout('2'));
  mode4?.addEventListener('click', ()=> applyLayout('4'));
  mode5?.addEventListener('click', ()=> applyLayout('5'));

// === Ctrl+2 / Ctrl+4 / Ctrl+5 ã§ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆ‡æ›¿ï¼ˆ2åˆ—/4åˆ—/5åˆ—ï¼‰ ===
(function(){
  if (window.__bindCtrlLayout) return;
  window.__bindCtrlLayout = true;

  const isEditable = (t)=>{
    const tag = t?.tagName?.toLowerCase();
    return tag === 'input' || tag === 'textarea' || t?.isContentEditable;
  };
  const isDialogOpen = ()=>{
    const ed = document.getElementById('editor');
    const st = document.getElementById('settings');
    return !!((ed && (ed.open || ed.classList?.contains('is-open'))) ||
              (st && (st.open || st.classList?.contains('is-open'))));
  };

  document.addEventListener('keydown', (e)=>{
    if (!e.ctrlKey) return;
    if (isEditable(e.target) || isDialogOpen()) return;

    // æ•°å­—ã‚­ãƒ¼ï¼ˆä¸Šæ®µ/ãƒ†ãƒ³ã‚­ãƒ¼ä¸¡å¯¾å¿œï¼‰
    const k = e.key;                     // '2','4','5' ãªã©
    const c = e.code;                    // 'Digit2','Numpad2' ãªã©
    const is2 = (k === '2' || c === 'Digit2' || c === 'Numpad2');
    const is4 = (k === '4' || c === 'Digit4' || c === 'Numpad4');
    const is5 = (k === '5' || c === 'Digit5' || c === 'Numpad5');

    if (is2 || is4 || is5) {
      e.preventDefault(); e.stopImmediatePropagation();
      if (typeof window.applyLayout !== 'function') return;
      if (is2) return window.applyLayout('2');
      if (is4) return window.applyLayout('4');
      if (is5) return window.applyLayout('5');
    }
  }, {capture:true});
})();

  // ===== ç¥æ—¥ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³è‡ªå‹•è¨ˆç®—ï¼‹ä¸Šæ›¸ãï¼‰ =====
  function ymd(d){ return d.toISOString().slice(0,10); }
  function isoToDate(iso){ const [Y,M,D]=iso.split('-').map(Number); return new Date(Y, M-1, D); }
  function vernalEquinoxDay(Y){ return Math.floor(20.8431 + 0.242194*(Y-1980) - Math.floor((Y-1980)/4)); }
  function autumnalEquinoxDay(Y){ return Math.floor(23.2488 + 0.242194*(Y-1980) - Math.floor((Y-1980)/4)); }
  function nthWeekdayOfMonth(Y, M, weekday, n){ const d = new Date(Y, M-1, 1); const first = d.getDay(); const delta = (weekday - first + 7) % 7; return 1 + delta + 7*(n-1); }
  function genHolidaysAuto(year){ const H = new Set(); const push = (m, d)=> H.add(`${year}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`); push(1,1); push(2,11); if(year >= 2020) push(2,23); push(4,29); push(5,3); push(5,4); push(5,5); push(8,11); push(11,3); push(11,23); const MON=1,SUN=0; push(1, nthWeekdayOfMonth(year, 1, MON, 2)); push(7, nthWeekdayOfMonth(year, 7, MON, 3)); push(9, nthWeekdayOfMonth(year, 9, MON, 3)); push(10, nthWeekdayOfMonth(year,10, MON, 2)); push(3, vernalEquinoxDay(year)); push(9, autumnalEquinoxDay(year)); const isHoliday = (iso)=> H.has(iso); const addSubstitute = (isoStart)=>{ let d = isoToDate(isoStart); do { d.setDate(d.getDate()+1); } while (d.getDay() === SUN || isHoliday(ymd(d))); H.add(ymd(d)); }; for(const iso of Array.from(H)){ const dt = isoToDate(iso); if (dt.getDay() === SUN) addSubstitute(iso); } const span = (m)=> new Date(year, m, 0).getDate(); for(let m=1;m<=12;m++){ for(let d=2; d<span(m-1); d++){ const cur = `${year}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; const prev = ymd(new Date(year, m-1, d-1)); const next = ymd(new Date(year, m-1, d+1)); const wd = isoToDate(cur).getDay(); if (!H.has(cur) && H.has(prev) && H.has(next) && wd !== SUN){ H.add(cur); } } } return H; }
  function loadHolidayAuto(year){ try{ const s = localStorage.getItem('holidays_auto_'+year); return s? new Set(JSON.parse(s)) : new Set(); }catch(_){ return new Set(); }
  }
  function saveHolidayAuto(year, set){ localStorage.setItem('holidays_auto_'+year, JSON.stringify(Array.from(set||[]))); }
  function ensureHolidayAuto(year){ let s = loadHolidayAuto(year); if(!s || s.size===0){ s = genHolidaysAuto(year); saveHolidayAuto(year, s); } return s; }
  function loadHolidayPatch(year){ try{ return JSON.parse(localStorage.getItem('holidays_patch_'+year))||{}; }catch(_){ return {}; } }
  function loadHolidayManual(){ try{ return JSON.parse(localStorage.getItem('holidays_manual'))||{}; }catch(_){ return {}; } }
  function saveHolidayManual(obj){ localStorage.setItem('holidays_manual', JSON.stringify(obj||{})); }
  function isHolidayISO(iso){ const Y = Number(iso.slice(0,4)); const manual = loadHolidayManual(); if (manual[iso] === true)  return true; if (manual[iso] === false) return false; const patch = loadHolidayPatch(Y); if (patch[iso]) return true; const auto = ensureHolidayAuto(Y); return auto.has(iso); }
  function toggleHolidayManual(iso, toFlag){ const m = loadHolidayManual(); m[iso] = toFlag; saveHolidayManual(m); }

  // ===== ãƒãƒ¼ãƒˆ =====
  function loadNotes(week){ try{ return JSON.parse(localStorage.getItem('notes_'+weekKey(week))) || {}; }catch(e){ return {}; } }
  function getDayNote(week, dayKey){ const obj = loadNotes(week); return String(obj[dayKey]||''); }
  function setDayNote(week, dayKey, text, opts){ const o = loadNotes(week); o[dayKey] = String(text||''); try{ if(opts&&opts.snapshot){ undoStack.push(snapshotState()); redoStack.length=0; } }catch(_){ } localStorage.setItem('notes_'+weekKey(week), JSON.stringify(o)); }

 // æç”»å¾Œã®ã€Œé’æ å¾©å…ƒã€å°‚ç”¨ï¼šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯ä¸€åˆ‡ã•ã›ãªã„
 function restoreSelection(){
   try{
    // â˜… å…ˆé ­é¸æŠã‚’äºˆç´„ã—ã¦ã„ã‚‹ã¨ãã¯ã€æ—§é¸æŠã®å¾©å…ƒã‚’ã‚¹ã‚­ãƒƒãƒ—
    if (window.__selectFirstOnNextRender) return;   
     if (!window.lastSelectedKey) return;
     const el = document.querySelector(`.slot[data-key="${window.lastSelectedKey}"]`);
     if (el) {
       // â˜… å¿…ãšã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æŠ‘æ­¢
       setActiveSlot(el, { scroll: false });
       // â˜… ã“ã“ã§ã¯çµ¶å¯¾ã« scrollIntoView ã‚’å‘¼ã°ãªã„
     } else {
       setActiveSlot(null);
     }
   }catch(_){}
 }

// è¡¨ç¾å½¢ãƒ†ã‚­ã‚¹ãƒˆã‚’æ å†…ã«2è¡Œã¾ã§ã§åã‚ã‚‹ï¼ˆãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã¯å›ºå®šï¼‰
function autoFitContentLines(){
  // ã‚‚ã†ä½•ã‚‚ã—ãªã„ï¼ˆCSSã ã‘ã«ä»»ã›ã‚‹ï¼‰
}



function applyGaColoring(){
  const st = loadWeek(currentMonday);
  document.querySelectorAll('.slot').forEach(el=>{
    const d = st[el.dataset.key];
    // tail ã¯å¡—ã‚‰ãšã€head/å˜æ ã®ã¿è‰²ä»˜ã‘ï¼ˆæ–¹é‡ã©ãŠã‚Šï¼‰
    if (d && d.ga && !d.tail) el.classList.add('ga-slot');
    else el.classList.remove('ga-slot');
  });
}


  // ===== æç”» =====
  function render(){

if (!window.__initialRenderDone) {
  window.__initialRenderDone = true;

  requestAnimationFrame(() => {
    requestAnimationFrame(() => {          // â† ï¼’å›é…å»¶ãŒå¿…é ˆ
      const box = document.scrollingElement;
      if (box) box.scrollTop = 0;
    });
  });
}
ã€€ã€€applyDatalists(appLists);
   window.__setWeekdayFromISO?.(document.getElementById('weekPicker')?.value);
  if (document.body.classList.contains('dayFocus') && window.focusDate) {
    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ä¸­ã¯ãƒ”ãƒƒã‚«ãƒ¼ã‚’å½“æ—¥ã«ä¿ã¤ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆã¯ç™ºç«ã•ã›ãªã„ï¼‰
    window.__suppressWeekChange = true;
    weekPicker.value = window.focusDate;
    setTimeout(()=> window.__suppressWeekChange = false, 0);
  } else {
    weekPicker.value = dateISO(currentMonday);
  }
    leftCol.innerHTML=''; rightCol.innerHTML='';

    if(layoutMode==='5'){
      leftCol.appendChild(buildDay('Mon', 0));
      leftCol.appendChild(buildDay('Tue', 1));
      leftCol.appendChild(buildDay('Wed', 2));
      leftCol.appendChild(buildDay('Thu', 3));
      const friStack = document.createElement('div');
      friStack.className = 'dayStack';
      friStack.appendChild(buildDay('Fri', 4));
      friStack.appendChild(buildWeekend());
      leftCol.appendChild(friStack);
      restoreSelection();
ã€€ã€€ã€€paintSlotsFromStore();
ã€€ã€€ã€€autoFitContentLines();
      document.querySelectorAll('.slots').forEach(sl => applyMerges(sl, loadWeek(currentMonday)));
     applyGaColoring();
     // â˜… é€±è¡¨ç¤ºã®ã¨ãã ã‘ã€æç”»å®Œäº†å¾Œã«1å›ã ã‘ã‚¹ãƒŠãƒƒãƒ—ï¼ˆrAFã§DOMç¢ºå®šã‚’å¾…ã¤ï¼‰
     if (!document.body.classList.contains('dayFocus')) {
       requestAnimationFrame(()=> window.__centerActiveInWeekSoon?.());
     }
     return;
    }

    if(layoutMode==='4'){
      leftCol.appendChild(buildDay('Mon', 0));
      leftCol.appendChild(buildDay('Tue', 1));
      leftCol.appendChild(buildDayStack([
        ['Wed', 2, { combined: true }],
        ['Thu', 3, {}]
      ]));
      const friStack4 = document.createElement('div');
      friStack4.className = 'dayStack';
      friStack4.appendChild(buildDay('Fri', 4));
      friStack4.appendChild(buildWeekend());
      leftCol.appendChild(friStack4);
      restoreSelection();
ã€€ã€€ã€€paintSlotsFromStore();
ã€€ã€€ã€€autoFitContentLines();
      document.querySelectorAll('.slots').forEach(sl => applyMerges(sl, loadWeek(currentMonday)));
     applyGaColoring();
     if (!document.body.classList.contains('dayFocus')) {
       requestAnimationFrame(()=> window.__centerActiveInWeekSoon?.());
     }
     return;
    }

    leftCol.appendChild(buildDay('Mon', 0));
    leftCol.appendChild(buildDay('Tue', 1));
    leftCol.appendChild(buildDay('Wed', 2, { combined: true }));
    rightCol.appendChild(buildDay('Thu', 3));
    rightCol.appendChild(buildDay('Fri', 4));
    rightCol.appendChild(buildWeekend());
    restoreSelection();
ã€€ã€€paintSlotsFromStore();
ã€€ã€€autoFitContentLines();
    document.querySelectorAll('.slots').forEach(sl => applyMerges(sl, loadWeek(currentMonday)));
    applyGaColoring();
    enforceFocusView();

    // --- æ›œæ—¥ãƒãƒƒã‚¸æ›´æ–°ï¼ˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹ä¸­ã¯æ—¢ã«æ­£ã—ã„ã®ã§å†æ›´æ–°ã—ãªã„ï¼‰
    if (!document.body.classList.contains('dayFocus')) {
      const iso = document.getElementById('weekPicker')?.value;
      window.__setWeekdayFromISO?.(iso);
    }


// === æœªé¸æŠãªã‚‰é€±ã®æœ€åˆã®é¸æŠå¯èƒ½ã‚¹ãƒ­ãƒƒãƒˆã‚’è‡ªå‹•é¸æŠ ===
if (!document.body.classList.contains('dayFocus')) {
  const cur = document.querySelector('.slot.focused');
  if (!cur) {
    const days = Array.from(document.querySelectorAll('#schedule .day'));
    for (const d of days) {
      const first = window.findFirstSelectableInDay?.(d);
      if (first) {
        window.setActiveSlot?.(first, { scroll: false });
        break;
      }
    }
  }
}
// === ä¸­å¤®å¯„ã›/æœ€ä¸Šéƒ¨ã‚¹ãƒŠãƒƒãƒ—ãƒ»ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç§»è­² ===
if (!document.body.classList.contains('dayFocus')) {
  // â˜… é€±ç§»å‹•ç›´å¾Œã¯ã€Œæœ€ä¸Šéƒ¨ã‚¹ãƒŠãƒƒãƒ—ã€ã‚’å„ªå…ˆï¼ˆç¥æ—¥å¯„ã›ã«ã‚‚å¯¾å¿œï¼‰
  requestAnimationFrame(()=> {
    if (window.__snapTopOnNextRender) {
      const iso = window.__snapTopTargetISO;
      window.__snapTopOnNextRender = false;
      window.__snapTopTargetISO    = null;
      // å¯¾è±¡ã® day ã‚’å–å¾—ï¼šã¾ãšã€Œã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ãƒ­ãƒƒãƒˆã®å±ã™ã‚‹æ—¥ã€ã‚’å„ªå…ˆ
      let dayEl = null;
      const activeSlot =
        (window.getActiveSlot && window.getActiveSlot()) ||
        document.querySelector('.slot.focused');
      if (activeSlot) {
        dayEl = activeSlot.closest('.day');
      }
      // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãŒå–ã‚Œãªã„å ´åˆã¯ã€ã“ã‚Œã¾ã§é€šã‚Š ISOï¼ˆæœˆæ›œï¼‰â†’å…ˆé ­ day ã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      if (!dayEl && typeof __findDayByISO === 'function' && iso) {
        dayEl = __findDayByISO(iso);
      }
      if (!dayEl) {
        dayEl = document.querySelector('#schedule .day'); // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šå…ˆé ­ï¼ˆæ—¥=æœˆï¼‰
      }
      // ç¥æ—¥/ä¼‘è¨ºãªã‚‰ç¿Œå–¶æ¥­æ—¥ã«å¯„ã›ã‚‹ï¼ˆãªã‘ã‚Œã°ãã®ã¾ã¾ï¼‰
      if (typeof isOffDay === 'function' && dayEl) {
        if (isOffDay(dayEl)) {
          const days = Array.from(document.querySelectorAll('#schedule .day'));
          let i = days.indexOf(dayEl), found = dayEl;
          for (let j=i+1; j<days.length; j++){ if (!isOffDay(days[j])){ found = days[j]; break; } }
          dayEl = found || dayEl;
        }
      }
      // å³æ™‚ã‚¹ãƒŠãƒƒãƒ—ï¼ˆç¬é–“ï¼‰ï¼šscrollerè¨ˆç®—ã—ã¦ scrollTop ã‚’ç›´æ¥è¨­å®š
      if (dayEl) {
        const scroller = (typeof __getScrollParent==='function') ? __getScrollParent(dayEl)
                         : (document.scrollingElement || document.documentElement);
        if (scroller) {
          const headerH = (typeof __getHeaderOffsetPx==='function') ? __getHeaderOffsetPx() : 0;
          const viewH   = ('clientHeight' in scroller ? scroller.clientHeight : window.innerHeight) - headerH;
          // dayEl ã® scroller å†…ã‚ªãƒ•ã‚»ãƒƒãƒˆ
          const offsetTopWithin = (el, s)=>{
            let y=0,n=el; while(n && n!==s){ y += n.offsetTop||0; n = n.offsetParent; } return y;
          };
          const offset = offsetTopWithin(dayEl, scroller);
          const max    = Math.max(0, (scroller.scrollHeight - viewH));

          // â˜… â‘£' ãƒ­ã‚¸ãƒƒã‚¯ï¼š
          //   - ãƒšãƒ¼ã‚¸æœ€ä¸Šéƒ¨ï¼ˆscrollTop=0ï¼‰ã‹ã‚‰ã§ã‚‚ dayEl ãŒååˆ†ã€Œç”»é¢å†…ã€ã«å…¥ã‚‹ãªã‚‰ 0 ã‚¹ã‚¿ãƒ¼ãƒˆ
          //   - ãã†ã§ãªã‘ã‚Œã° dayEl ã‚’ãƒ˜ãƒƒãƒ€ç›´ä¸‹ã¾ã§ã‚¹ãƒŠãƒƒãƒ—
          //   ï¼ˆ2åˆ—è¡¨ç¤ºã§æ°´æ›œãŒä¸‹æ®µã«è¡Œãé€±ãªã©ã§ã¯ã€ã“ã“ã§ã‚¹ãƒŠãƒƒãƒ—ã•ã‚Œã‚‹ï¼‰
          const VISIBLE_RATIO = 0.7; // ç”»é¢é«˜ã•ã®ä½•å‰²ã‚ˆã‚Šä¸‹ãªã‚‰ã€Œè¦‹ãˆã«ãã„ã€ã¨ã¿ãªã™ã‹ã®é–¾å€¤

          let nextTop;
          if (offset <= viewH * VISIBLE_RATIO) {
            // ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã‹ã‚‰ã§ã‚‚ååˆ†è¦‹ãˆã‚‹ä½ç½® â†’ å…ˆé ­ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
            nextTop = 0;
          } else {
            // ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã§ã¯ dayEl ãŒã»ã¼è¦‹ãˆãªã„ â†’ å¾“æ¥ã©ãŠã‚Šãƒ˜ãƒƒãƒ€ç›´ä¸‹ã¾ã§ã‚¹ãƒŠãƒƒãƒ—
            const target = offset - headerH;
            nextTop = Math.max(0, Math.min(Math.round(target), max));
          }

          scroller.scrollTop = nextTop;

          // â˜… äºˆç´„ãŒã‚ã‚Œã°ã€Œä»Šé€±ã®å…ˆé ­â€œé¸æŠå¯èƒ½â€æ ã€ã‚’é’æ é¸æŠï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯ã—ãªã„ï¼‰
          if (window.__selectFirstOnNextRender) {
            window.__selectFirstOnNextRender = false;
            // ç¥æ—¥å¯„ã›å¾Œã® dayEl ã‹ã‚‰æœ€åˆã®ç·¨é›†å¯èƒ½ã‚¹ãƒ­ãƒƒãƒˆã‚’å–å¾—
            const first = (typeof findFirstSelectableInDay==='function') ? findFirstSelectableInDay(dayEl)
                          : dayEl.querySelector('.slot');
            if (first && typeof setActiveSlot==='function') {
              // è¤‡æ•°é¸æŠã¯ã‚¯ãƒªã‚¢ï¼ˆæ®‹éª¸å¯¾ç­–ï¼‰
              if (typeof multiSelected!=='undefined') {
                try { multiSelected.clear?.(); } catch(_) {}
                document.querySelectorAll('.slot.is-selected')?.forEach(el=> el.classList.remove('is-selected'));
              }
              setActiveSlot(first, { scroll:false });
              // â˜… æ—§å¾©å…ƒç³»ãŒå¾Œã‹ã‚‰è¢«ã›ãªã„ã‚ˆã†ã€lastSelectedKey ã‚’æ›´æ–°
              window.lastSelectedKey = first?.dataset?.key || null;
              if (window.__slotCursor) window.__slotCursor.activeSlotEl = first;
            }
          }		  
          return; // â–² æœ€ä¸Šéƒ¨ã‚¹ãƒŠãƒƒãƒ—ã‚’è¡Œã£ãŸã®ã§ä¸­å¤®å¯„ã›ã¯ã‚¹ã‚­ãƒƒãƒ—
        }
      }
    }
    // é€šå¸¸ã¯â€œç¬é–“ã‚»ãƒ³ã‚¿ãƒ¼ã‚¹ãƒŠãƒƒãƒ—â€ï¼ˆå¾®å°ç§»å‹•ã‚¹ã‚­ãƒƒãƒ—è¾¼ã¿ï¼‰
    window.__centerActiveInWeekSoon?.();
  });
  const sched = document.getElementById('schedule');
  if (sched && !document.activeElement.closest('#schedule')) {
    sched.setAttribute('tabindex', '-1');
    sched.focus({ preventScroll: true });
  }
}
  }

  
  // === ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¶­æŒãƒ˜ãƒ«ãƒ‘ ===
function __getScrollBox(){
  // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ä¸­ã¯ãã®æ—¥ã® .slots ãŒç¬¬ä¸€å€™è£œ
  const hit = document.querySelector('body.dayFocus .day[data-focus="true"] .slots');
  if (hit && hit.scrollHeight > hit.clientHeight) return hit;
  // æ¬¡ã« day å…¨ä½“
  const day = document.querySelector('body.dayFocus .day[data-focus="true"]');
  if (day && day.scrollHeight > day.clientHeight) return day;
  // é€±è¡¨ç¤ºãªã©ã¯ schedule ã‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
  const sch = document.getElementById('schedule');
  if (sch && sch.scrollHeight > sch.clientHeight) return sch;
  return document.scrollingElement || document.documentElement || document.body;
}

function preserveScrollWhile(doWork){
  const box = __getScrollBox();
  const top = box ? box.scrollTop : null;
  // å®Ÿè¡Œ
  const ret = doWork();
  // ä½•åº¦ã‹ãƒ•ãƒ¬ãƒ¼ãƒ è·¨ãã§å¾©å…ƒï¼ˆå†ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå¯¾ç­–ï¼‰
  const restore = ()=>{ if (box!=null && top!=null) box.scrollTop = top; };
  requestAnimationFrame(restore);
  requestAnimationFrame(()=> requestAnimationFrame(restore));
  return ret;
}

  // === ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒ¢ãƒ¼ãƒ‰æ™‚ã®å†è¡¨ç¤ºè£œæ­£ ===
function enforceFocusView(){

  if (!document.body.classList.contains('dayFocus') || !window.focusDate) return;

  const days = document.querySelectorAll('#schedule .day');
  let hit = null;
  days.forEach(d => {
    if (d.dataset && d.dataset.date === window.focusDate) {
      hit = d;
    }
  });
  if (!hit) {
    days.forEach(d => {
      const txt = d.querySelector('.day-header-date')?.textContent || '';
      const m = txt.match(/(\d{4})\/(\d{2})\/(\d{2})/);
      const iso = m ? `${m[1]}-${m[2]}-${m[3]}` : null;
      if (iso === window.focusDate) hit = d;
    });
  }
   if (!hit) return;

  days.forEach(d => {
    d.style.display = (d === hit) ? 'block' : 'none';
    if (d === hit) d.setAttribute('data-focus','true');
    else d.removeAttribute('data-focus');
  });
 
   // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è¡¨ç¤ºãŒç¢ºå®šã—ãŸæ™‚ç‚¹ã®ãƒ”ãƒƒã‚«ãƒ¼å€¤ã§æ›œæ—¥ãƒãƒƒã‚¸ã‚’æ›´æ–°
   const picker = document.getElementById('weekPicker');
   if (picker) window.__setWeekdayFromISO?.(picker.value); 
   window.__setWeekdayFromISO?.(window.focusDate);
}


  function buildDayStack(specList){
    const stack = document.createElement('div');
    stack.className = 'dayStack';
    for(const [dk, off, opt] of specList){ stack.appendChild(buildDay(dk, off, opt||{})); }
    return stack;
  }

  function buildDay(dayKey, offsetIdx, opt={}){
    const dayDate = addDays(currentMonday, offsetIdx);
    const wrap = document.createElement('section'); wrap.className = 'day';
    const iso = dateISO(dayDate);
    wrap.dataset.date = iso;             // â† â˜…ã“ã‚Œã‚’è¿½åŠ ï¼ˆYYYY-MM-DDï¼‰
    wrap.dataset.dayKey = dayKey;        // â† â˜…æ›œæ—¥ã‚‚æŒãŸã›ã‚‹ï¼ˆMon/Tue/...ï¼‰	
    const isHol = isHolidayISO(iso);
    if (isHol){ wrap.classList.add('is-holiday', 'is-off'); }

    const header = document.createElement('div'); header.className = 'day-header';
    const dateEl = document.createElement('div'); dateEl.className = 'day-header-date'; dateEl.textContent = formatDateJP(dayDate);
    const noteWrap = document.createElement('div'); noteWrap.className = 'day-note-inline';
    const noteInput = document.createElement('textarea'); noteInput.rows = 2; noteInput.className = 'day-note-input';
    noteWrap.appendChild(noteInput);
    noteInput.value = getDayNote(currentMonday, dayKey);
    noteInput.addEventListener('focus', ()=>{ try{ undoStack.push(snapshotState()); redoStack.length=0; }catch(_){}});
    noteInput.addEventListener('input', ()=>{ setDayNote(currentMonday, dayKey, noteInput.value); });
    header.appendChild(dateEl); header.appendChild(noteWrap); wrap.appendChild(header);
// æ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼ï¼šãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ON/OFF
header.addEventListener('dblclick', (e)=>{
  // æ—¢ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ä¸­ãªã‚‰è§£é™¤ã€ãã†ã§ãªã‘ã‚Œã°ã“ã®æ—¥ã‚’ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
  if (document.body.classList.contains('dayFocus')) {
    exitDayFocus();
  } else {
    enterDayFocus(wrap);
  }
});


    // æ›œæ—¥ãƒ˜ãƒƒãƒ€ å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼
    header.addEventListener('contextmenu', (e)=>{
      e.preventDefault(); e.stopPropagation();
      const off   = loadDayOff(currentMonday);
      const isOff = !!(off[dayKey]?.day);
      const menu = document.createElement('div');
      menu.className = 'ctx-menu';
      Object.assign(menu.style,{position:'fixed',zIndex:'99999',left:e.clientX+'px',top:e.clientY+'px',background:'#fff',border:'1px solid #ddd',borderRadius:'8px',boxShadow:'0 4px 18px rgba(0,0,0,.12)',padding:'6px',fontSize:'13px',minWidth:'220px'});
      const addItem=(label,fn,opts={})=>{ const it=document.createElement('div'); it.textContent=label; it.style.padding='6px 10px'; it.style.cursor=opts.disabled?'not-allowed':'pointer'; it.style.color=opts.danger?'#b91c1c':''; if(!opts.disabled){ it.addEventListener('mouseenter',()=>it.style.background='#f5f5f7'); it.addEventListener('mouseleave',()=>it.style.background=''); it.addEventListener('click',()=>{ fn(); menu.remove(); }); } menu.appendChild(it); };
      addItem(isHol ? 'ã“ã®æ—¥ã®ç¥æ—¥æ‰±ã„ã‚’è§£é™¤ï¼ˆæ‰‹å‹•ï¼‰' : 'ã“ã®æ—¥ã‚’ç¥æ—¥ã¨ã—ã¦æ‰±ã†ï¼ˆæ‰‹å‹•ï¼‰', ()=>{ toggleHolidayManual(iso, !isHol); render(); });
      addItem(isOff ? 'ã“ã®æ—¥ã®ã€Œçµ‚æ—¥ä¼‘æ­¢ã€ã‚’è§£é™¤' : 'ã“ã®æ—¥ã‚’ã€Œçµ‚æ—¥ä¼‘æ­¢ã€ã«ã™ã‚‹', ()=>{ setDayOff(currentMonday, dayKey, { day: !isOff }, { snapshot:true }); render(); });
      addItem('â”€â”€â”€â”€â”€â”€â”€â”€', ()=>{}, {disabled:true});
      addItem('ã“ã®æ—¥ã®ä¼‘æ­¢ã‚’ã€Œå…¨ãƒªã‚»ãƒƒãƒˆã€', ()=>{ if(confirm('ã“ã®æ—¥ã®ä¼‘æ­¢è¨­å®šï¼ˆçµ‚æ—¥/ã‚»ã‚¯ã‚·ãƒ§ãƒ³/ä»¥å¾Œ/ä»¥å‰ï¼‰ã‚’ã™ã¹ã¦è§£é™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')){ clearDayOffForDay(currentMonday, dayKey, { snapshot:true }); render(); } }, {danger:true});
      addItem('â”€â”€â”€â”€â”€â”€â”€â”€', ()=>{}, {disabled:true});
      addItem('ã“ã®æ—¥ã®ã€Œæ ã®å½¢ã€ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™', ()=>{ if (confirm('ã“ã®æ—¥ã®æ å½¢çŠ¶ï¼ˆå…ˆé ­è‡¨æ™‚ãƒ»é€”ä¸­æŒ¿å…¥ãƒ»æœ«å°¾è‡¨æ™‚ï¼‰ã‚’ã™ã¹ã¦è§£é™¤ã—ã¦ã€åˆæœŸã®æ æ•°ã«æˆ»ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) { resetSlotLayoutForDay?.(currentMonday, dayKey, { snapshot:true }); render(); } });
 addItem('ã“ã®æ—¥ã‚’å°åˆ·ï¼ˆA4ï¼‰', ()=> printDayElement(wrap));
      const close=(ev)=>{ if(!menu.contains(ev.target)){ document.removeEventListener('mousedown',close,true); menu.remove(); } };
      document.addEventListener('mousedown', close, true);
      document.body.appendChild(menu);
    });

    const sections = CONFIG[dayKey];
    const off = loadDayOff(currentMonday);
    const dayIsOff = !!(off[dayKey]?.day);

    // åˆå‰
    const am = sections[0];
    const stAm = document.createElement('div'); stAm.className = 'section-title thin';
    const titleSpan = document.createElement('span'); titleSpan.textContent = am.title; stAm.appendChild(titleSpan);
    wrap.appendChild(stAm);

// ã“ã“ã‹ã‚‰ç½®ãæ›ãˆ
stAm.addEventListener('contextmenu', (e)=>{
  e.preventDefault();
  e.stopPropagation();

  const off = loadDayOff(currentMonday);
  const cur = off[dayKey]?.sections?.[0] === true;

  // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ç”Ÿæˆ
  const menu = document.createElement('div');
  Object.assign(menu.style, {
    position: 'fixed',
    zIndex: '99999',
    left: e.clientX + 'px',
    top:  e.clientY + 'px',
    background: '#fff',
    border: '1px solid #ddd',
    borderRadius: '8px',
    boxShadow: '0 4px 18px rgba(0,0,0,.12)',
    padding: '6px',
    fontSize: '13px',
    minWidth: '240px'
  });

  const addItem = (label, onClick, opts={})=>{
    const it = document.createElement('div');
    it.textContent = label;
    it.style.padding = '8px 12px';
    it.style.cursor = opts.disabled ? 'not-allowed' : 'pointer';
    if (opts.danger) it.style.color = '#b91c1c';
    if (!opts.disabled) {
      it.addEventListener('mouseenter', ()=> it.style.background = '#f5f5f7');
      it.addEventListener('mouseleave', ()=> it.style.background = '');
      it.addEventListener('click', ()=>{
        // ã‚¯ãƒªãƒƒã‚¯æ™‚ã«é–‰ã˜ã‚‹ â†’ å®Ÿè¡Œ
        closeMenu();
        try { onClick(); } catch(err){ console.error(err); }
      });
    }
    menu.appendChild(it);
  };

  // é …ç›®ï¼šåˆå‰ã®ä¼‘æ­¢ON/OFF
  addItem(cur ? 'åˆå‰ã®ã€Œä¼‘æ­¢ã€ã‚’è§£é™¤' : 'åˆå‰ã‚’ã€Œä¼‘æ­¢ã€ã«ã™ã‚‹', ()=>{
    const sections = Object.assign({}, off[dayKey]?.sections||{}, { 0: !cur });
    setDayOff(currentMonday, dayKey, { sections }, { snapshot:true });
    render();
  });

  // ä»•åˆ‡ã‚Š
  addItem('â”€â”€â”€â”€â”€â”€â”€â”€', ()=>{}, { disabled:true });

// é …ç›®ï¼šã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å°åˆ·ï¼ˆåˆå‰=ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹0ã ã‘æ®‹ã™ï¼‰
addItem('ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å°åˆ·ï¼ˆA4æƒ³å®šï¼‰', ()=>{
  printDayKeepSections(wrap, [0]);   // â˜… wrap ã¯ buildDay() å†’é ­ã§ä½œã£ãŸ section è¦ç´ 
});
addItem('â”€â”€â”€â”€â”€â”€â”€â”€', ()=>{}, {disabled:true});

// ã“ã®æ—¥ã®ã€Œåˆå‰ï¼‹åˆå¾Œï¼ˆæ‰‹è¡“å®¤1ï¼‰ã€ã‚’å°åˆ·
addItem('åˆå‰ï¼‹åˆå¾Œï¼ˆæ‰‹è¡“å®¤1ï¼‰ã‚’å°åˆ·', ()=>{
  if (dayKey==='Tue' || dayKey==='Fri') {
    printDayKeepSections(wrap, [0,1]); // åˆå‰(0)ï¼‹åˆå¾Œ(æ‰‹è¡“å®¤1=1)
  } else {
    alert('ã“ã®æ›œæ—¥ã«ã¯åˆå¾Œï¼ˆæ‰‹è¡“å®¤1ï¼‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
  }
});


  // ç”»é¢ã«è¿½åŠ  & å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  const closeMenu = (ev)=>{
    if (!ev || !menu.contains(ev.target)) {
      document.removeEventListener('mousedown', closeMenu, true);
      if (menu.parentNode) menu.parentNode.removeChild(menu);
    }
  };
  document.addEventListener('mousedown', closeMenu, true);
  document.body.appendChild(menu);
});
// ã“ã“ã¾ã§ç½®ãæ›ãˆ


    const slotsAm = document.createElement('div'); slotsAm.className = 'slots';
slotsAm.dataset.day = (dayKey==='Wed'?'Wed':dayKey);  // â†è¿½åŠ 
slotsAm.dataset.section = '0';                         // â†è¿½åŠ 
    if (off[dayKey]?.sections?.[0]) { slotsAm.classList.add('section-off'); }
    let count = am.slots;
    if(dayKey==='Wed'){
      if(opt.half==='first'){ count = Math.floor(am.slots/2); }
      if(opt.half==='second'){ count = Math.ceil(am.slots/2); }
    }
    const dayId = (dayKey === 'Wed') ? 'Wed' : dayKey;
    const extraAm = getExtraTailSlots(currentMonday, dayId, 0);
    if (dayKey !== 'Wed' || opt.half === 'second' || opt.combined) count += extraAm;

    const baseCount = count;
    const layoutAm = getSectionLayout(currentMonday, (dayKey==='Wed'?'Wed':dayKey), 0, baseCount);
    for (let i = 0; i < layoutAm.total; i++){
      const time = getSlotTimeHHMMEx(am.start, currentMonday, (dayKey==='Wed'?'Wed':dayKey), 0, i);
      const slot = createSlot({ d: dateISO(dayDate), day: (dayKey==='Wed'?'Wed':dayKey), section: 0, idx: i }, time);
      if (layoutAm.isTemp(i)) slot.classList.add('temp-slot');
      const isTemp = slot.classList.contains('temp-slot');
      if (!isTemp) {
        if (dayIsOff) { slot.classList.add('off'); }
        const ca0 = off[dayKey]?.cutAfter?.[0];
        const cb0 = off[dayKey]?.cutBefore?.[0];
        if (ca0 && hhmmToMinutes(time) >= hhmmToMinutes(ca0)) slot.classList.add('off');
        if (cb0 && hhmmToMinutes(time) <= hhmmToMinutes(cb0)) slot.classList.add('off');
      }
      { const k = `${dateISO(dayDate)}|${(dayKey==='Wed'?'Wed':dayKey)}|0|${i}`;
        if (loadEmerg(currentMonday)[k]) { slot.classList.remove('off'); slot.classList.add('emergency-slot'); } }
      slotsAm.appendChild(slot);
    }
    wrap.appendChild(slotsAm);

    // åˆå¾Œï¼ˆç«ãƒ»é‡‘ï¼‰
    if (dayKey === 'Tue' || dayKey === 'Fri'){
      for (let sidx = 1; sidx < sections.length; sidx++){
        const sec = sections[sidx];
        const st = document.createElement('div'); st.className = 'section-title';
        const t = document.createElement('span'); t.textContent = sec.title; st.appendChild(t);
        wrap.appendChild(st);

// ã“ã“ã‹ã‚‰ç½®ãæ›ãˆ
st.addEventListener('contextmenu', (e)=>{
  e.preventDefault();
  e.stopPropagation();

  const off = loadDayOff(currentMonday);
  const cur = off[dayKey]?.sections?.[sidx] === true;

  // ã‚·ãƒ³ãƒ—ãƒ«ãªå³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼
  const menu = document.createElement('div');
  Object.assign(menu.style, {
    position: 'fixed',
    zIndex: '99999',
    left: e.clientX + 'px',
    top:  e.clientY + 'px',
    background: '#fff',
    border: '1px solid #ddd',
    borderRadius: '8px',
    boxShadow: '0 4px 18px rgba(0,0,0,.12)',
    padding: '6px',
    fontSize: '13px',
    minWidth: '240px'
  });

  const addItem = (label, onClick, opts={})=>{
    const it = document.createElement('div');
    it.textContent = label;
    it.style.padding = '8px 12px';
    it.style.cursor = opts.disabled ? 'not-allowed' : 'pointer';
    if (opts.danger) it.style.color = '#b91c1c';
    if (!opts.disabled) {
      it.addEventListener('mouseenter', ()=> it.style.background = '#f5f5f7');
      it.addEventListener('mouseleave', ()=> it.style.background = '');
      it.addEventListener('click', ()=>{
        closeMenu();
        try { onClick(); } catch(err){ console.error(err); }
      });
    }
    menu.appendChild(it);
  };

  // åˆå¾Œã®ä¼‘æ­¢ ON/OFF
  addItem(cur ? 'åˆå¾Œã®ã€Œä¼‘æ­¢ã€ã‚’è§£é™¤' : 'åˆå¾Œã‚’ã€Œä¼‘æ­¢ã€ã«ã™ã‚‹', ()=>{
    const sections = Object.assign({}, off[dayKey]?.sections||{}, { [sidx]: !cur });
    setDayOff(currentMonday, dayKey, { sections }, { snapshot:true });
    render();
  });

  // ä»•åˆ‡ã‚Š
  addItem('â”€â”€â”€â”€â”€â”€â”€â”€', ()=>{}, { disabled:true });

// é …ç›®ï¼šã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å°åˆ·ï¼ˆã“ã® sidx ã ã‘æ®‹ã™ï¼‰
addItem('ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å°åˆ·ï¼ˆA4æƒ³å®šï¼‰', ()=>{
  printDayKeepSections(wrap, [sidx]);  // åˆå¾Œ(æ‰‹è¡“å®¤1)=1 / åˆå¾Œ(æ‰‹è¡“å®¤8)=2
});

  // å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  const closeMenu = (ev)=>{
    if (!ev || !menu.contains(ev.target)) {
      document.removeEventListener('mousedown', closeMenu, true);
      if (menu.parentNode) menu.parentNode.removeChild(menu);
    }
  };
  document.addEventListener('mousedown', closeMenu, true);
  document.body.appendChild(menu);
});
// ã“ã“ã¾ã§ç½®ãæ›ãˆ


        const slotsEl = document.createElement('div'); slotsEl.className = 'slots';
        const offMap = loadDayOff(currentMonday);
        if (offMap[dayKey]?.sections?.[sidx]) { slotsEl.classList.add('section-off'); }
        const baseCount = sec.slots;
        const layout = getSectionLayout(currentMonday, dayKey, sidx, baseCount);
        for (let i = 0; i < layout.total; i++) {
          const time = getSlotTimeHHMMEx(sec.start, currentMonday, dayKey, sidx, i);
          const slot = createSlot({ d: dateISO(dayDate), day: dayKey, section: sidx, idx: i }, time);
          if (layout.isTemp(i)) slot.classList.add('temp-slot');
          const isTemp = slot.classList.contains('temp-slot');
          if (!isTemp) {
            const o = offMap[dayKey] || {};
            if (dayIsOff || (o.sections && o.sections[sidx])) { slot.classList.add('off'); }
            const caS = o.cutAfter && o.cutAfter[sidx];
            const cbS = o.cutBefore && o.cutBefore[sidx];
            if (caS && hhmmToMinutes(time) >= hhmmToMinutes(caS)) slot.classList.add('off');
            if (cbS && hhmmToMinutes(time) <= hhmmToMinutes(cbS)) slot.classList.add('off');
          }
          { const k = `${dateISO(dayDate)}|${dayKey}|${sidx}|${i}`;
            if (loadEmerg(currentMonday)[k]) { slot.classList.remove('off'); slot.classList.add('emergency-slot'); } }
          slotsEl.appendChild(slot);
        }
        wrap.appendChild(slotsEl);
      }
    }

    { const _off = loadDayOff(currentMonday); if(_off[dayKey]?.full === true){ wrap.classList.add('is-off'); } }
    return wrap;
  }

  function buildWeekend(){
    const dayKey = 'Weekend';
    const dayDate = addDays(currentMonday, 6);
    const wrap = document.createElement('section'); wrap.className = 'day weekend';
    const off = loadDayOff(currentMonday); const dayIsOff = !!(off['Weekend']?.day);

    const header = document.createElement('div'); header.className = 'day-header';
    const title = document.createElement('div'); title.className = 'day-header-date'; title.textContent = 'ï¼ˆåœŸ/æ—¥ï¼‰';
    const noteWrap = document.createElement('div'); noteWrap.className = 'day-note-inline';
    const noteInput = document.createElement('textarea'); noteInput.className = 'day-note-input'; noteInput.rows = 2; noteWrap.appendChild(noteInput);
    noteInput.value = getDayNote(currentMonday, dayKey);
    noteInput.addEventListener('focus', ()=>{ try{ undoStack.push(snapshotState()); redoStack.length=0; }catch(_){ }});
    noteInput.addEventListener('input', ()=>{ setDayNote(currentMonday, dayKey, noteInput.value); });
    header.appendChild(title); header.appendChild(noteWrap); wrap.appendChild(header);

    const secDef = CONFIG[dayKey][0];
    const st = document.createElement('div'); st.className = 'section-title thin';
    const addBtn = document.createElement('button'); addBtn.className = 'icon-btn'; addBtn.setAttribute('aria-label', 'é€±æœ«ã«è‡¨æ™‚æ è¿½åŠ '); addBtn.textContent = 'âŠ•'; addBtn.addEventListener('click', ()=>{ addExtraTailSlot(currentMonday, dayKey, 0, 1); render(); }); st.appendChild(addBtn);
    const subBtn = document.createElement('button'); subBtn.className = 'icon-btn'; subBtn.setAttribute('aria-label', 'é€±æœ«ã®è‡¨æ™‚æ ã‚’1ã¤å‰Šé™¤'); subBtn.textContent = 'âŠ–'; subBtn.addEventListener('click', ()=>{ removeExtraTailSlot(currentMonday, dayKey, 0); render(); }); st.appendChild(subBtn);
    wrap.appendChild(st);

    const slotsEl = document.createElement('div'); slotsEl.className = 'slots';
    if (off['Weekend']?.sections?.[0]) { slotsEl.classList.add('section-off'); }
    const cnt = (secDef.slots|0) + getExtraTailSlots(currentMonday, dayKey, 0);
    for(let i=0;i<cnt;i++){
      const time = getSlotTimeHHMMEx(secDef.start, currentMonday, dayKey, 0, i);
      const slot = createSlot({ d: dateISO(dayDate), day: dayKey, section: 0, idx: i }, time);
      slot.classList.add('temp-slot');
      slotsEl.appendChild(slot);
    }
    wrap.appendChild(slotsEl);
    if (dayIsOff) { wrap.classList.add('is-off'); }
    return wrap;
  }

  function createSlot(meta, time){
    const el = slotTpl.content.firstElementChild.cloneNode(true);
    const timeEl = el.querySelector('.time'); timeEl.textContent = time ? String(time).replace(/^0/, '') : '';
    // â˜… æ™‚åˆ»ã‚»ãƒ«ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ï¼šé–‹å§‹æ™‚åˆ»ã®æ‰‹å‹•å¤‰æ›´
    timeEl.addEventListener('dblclick', (e)=>{
      // Shift / Alt ä»˜ãã¯ä¸‹ã®ãƒãƒ³ãƒ‰ãƒ©ã«ä»»ã›ã‚‹
      if (e.shiftKey || e.altKey) return;
      e.preventDefault();
      e.stopPropagation();

      const dayKey = meta.day;
      const sec    = meta.section;
      const ii     = meta.idx;

      const base = (sec===0
        ? CONFIG[(dayKey==='Wed' ? 'Wed' : dayKey)][0].start
        : CONFIG[dayKey][sec].start
      );
      const cur  = getSlotTimeHHMMEx(base, currentMonday, dayKey, sec, ii);

      const input = prompt('ã“ã®æ ã®æ™‚åˆ»ï¼ˆä¾‹ 10:00 / 1000 / 950ï¼‰', cur);
      if (input == null) return;

      const hhmm = normalizeTimeInput(input);
      if (!hhmm){
        alert('å½¢å¼ãŒä¸æ­£ã§ã™ã€‚ä¾‹ï¼š10:00 / 1000 / 0950 / 950');
        return;
      }

      // ç›´å‰ã®æ ã‚ˆã‚Šã‚‚å¾Œã‚ã®æ™‚åˆ»ã§ã‚ã‚‹ã“ã¨ã‚’ãƒã‚§ãƒƒã‚¯
      if (ii > 0){
        const prevBase = (sec===0
          ? CONFIG[(dayKey==='Wed' ? 'Wed' : dayKey)][0].start
          : CONFIG[dayKey][sec].start
        );
        const prevHHMM = getSlotTimeHHMMEx(prevBase, currentMonday, dayKey, sec, ii-1);
        if (hhmmToMinutes(hhmm) <= hhmmToMinutes(prevHHMM)){
          alert(`ã“ã®æ ã¯ç›´å‰ã®æ ï¼ˆ${prevHHMM}ï¼‰ã‚ˆã‚Šé…ã„æ™‚åˆ»ã«ã—ã¦ãã ã•ã„ã€‚`);
          return;
        }
      }

      // â˜… æ‰‹å‹•å¤‰æ›´å¾Œã€ã“ã®æ ã‚’ã‚¢ãƒ³ã‚«ãƒ¼ã¨ã—ã¦ day/section å…¨ä½“ã‚’å†æ§‹æˆ
      beginUndoBatch();
      try {
        // 1) ã“ã®æ ã®é–‹å§‹æ™‚åˆ»ã‚’ã‚¢ãƒ³ã‚«ãƒ¼ã¨ã—ã¦è¨˜éŒ²
        setTimeOverride(currentMonday, dayKey, sec, ii, hhmm);

        // 2) æ‰€è¦æ™‚é–“ãƒ»çµåˆæ ã«åŸºã¥ãå¾Œç¶šã‚¢ãƒ³ã‚«ãƒ¼ã‚’å†è¨ˆç®—
        const store = loadWeek(currentMonday);
        rebuildDurationAnchorsForDaySection(dayKey, sec, store, {
          keepAnchor: { idx: ii, hhmm }
        });
      } finally {
        endUndoBatch();
      }

      render();
    });

    // Shiftï¼‹ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ï¼šã“ã®æ ä»¥é™ã® override ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
    timeEl.addEventListener('dblclick', (e)=>{
      if (!e.shiftKey) return;
      e.preventDefault();
      e.stopPropagation();
      const { day, section, idx } = meta;
      clearTimeOverrideFrom(currentMonday, day, Number(section), Number(idx));
      render();
    });

    // Altï¼‹ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ï¼šã“ã® day/section å…¨ä½“ã® override ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
    timeEl.addEventListener('dblclick', (e)=>{
      if (!e.altKey) return;
      e.preventDefault();
      e.stopPropagation();
      const { day, section } = meta;
      clearTimeOverrideAll(currentMonday, day, Number(section));
      render();
    }, { capture:true });
    timeEl.addEventListener('dblclick', (e)=>{ if(!e.shiftKey) return; e.preventDefault(); e.stopPropagation(); const { day, section, idx } = meta; clearTimeOverrideFrom(currentMonday, day, Number(section), Number(idx)); render(); });
    timeEl.addEventListener('dblclick', (e)=>{ if(!e.altKey) return; e.preventDefault(); e.stopPropagation(); const { day, section } = meta; clearTimeOverrideAll(currentMonday, day, Number(section)); render(); }, { capture:true });

    el.dataset.key = `${meta.d}|${meta.day}|${meta.section}|${meta.idx}`;
el.addEventListener('click', (e)=>{
  if (isSlotLockedForEdit(el)) return; 
  setActiveSlot(el);
  window.lastSelectedKey = el.dataset.key;
});
    const leftEl = el.querySelector('.content-left'); const surgEl = el.querySelector('.surgeon-tag');
    leftEl.textContent = 'ï¼ˆç©ºï¼‰'; surgEl.textContent = ''; el.classList.add('empty');


    el.addEventListener('contextmenu', (e)=>{
      e.preventDefault();
      const dayKey  = meta.day; const section = meta.section; const idx = meta.idx;
      const baseCount = CONFIG[dayKey][section].slots; const layout = getSectionLayout(currentMonday, dayKey, section, baseCount);
      const menu = document.createElement('div');
      Object.assign(menu.style,{position:'fixed',zIndex:'99999',left:e.clientX+'px',top:e.clientY+'px',background:'#fff',border:'1px solid #ddd',borderRadius:'8px',boxShadow:'0 4px 18px rgba(0,0,0,.12)',padding:'6px',fontSize:'13px',minWidth:'200px'});
      function addItem(label, onClick){ const it=document.createElement('div'); it.textContent=label; it.style.padding='8px 12px'; it.style.cursor='pointer'; it.addEventListener('mouseenter', ()=> it.style.background='#f5f5f7'); it.addEventListener('mouseleave', ()=> it.style.background=''); it.addEventListener('click', ()=>{ onClick(); document.body.removeChild(menu); }); menu.appendChild(it); }

      // å€‹åˆ¥ã€Œè‡¨æ™‚åŒ–ï¼ˆç·Šæ€¥ï¼‰ã€
      {
        const key  = el.dataset.key;
        const em   = loadEmerg(currentMonday) || {};
        const isEm = !!em[key];

        // æ—¥ä»˜ï¼ˆISOï¼‰ã‹ã‚‰ç¥æ—¥åˆ¤å®š
        const meta      = parseKey(key);   // { d, day, section, idx } ãªã©
        const iso       = meta && meta.d;
        const isHoliday = iso ? isHolidayISO(iso) : false;

        // â˜… ç¥æ—¥ã®ã¨ãã ã‘ã€Œè‡¨æ™‚åŒ–ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å‡ºã™
        if (isHoliday) {
          addItem(
            isEm ? 'ã“ã®æ ã®è‡¨æ™‚åŒ–ã‚’è§£é™¤' : 'ã“ã®æ ã‚’è‡¨æ™‚åŒ–ï¼ˆç·Šæ€¥ï¼‰',
            ()=>{
              try { undoStack.push(snapshotState()); redoStack.length = 0; } catch(_){}
              setEmergency(currentMonday, key, !isEm);
              render();
            }
          );
        }
      }


      // â˜… RLã‚»ãƒƒãƒˆé–¢é€£ãƒ•ãƒ©ã‚°
      //    isRLSingleMember: ç‰‡å´ã ã‘é¸ã°ã‚Œã¦ã„ã‚‹ã¨ã true
      //    rlBlockStartIdx / rlBlockEndIdx: ã‚»ãƒƒãƒˆå…¨ä½“ã®è¡¨ç¤º idx ç¯„å›²
      let isRLSingleMember = false;
      let rlBlockStartIdx = null;
      let rlBlockEndIdx   = null;

      try {
        if (typeof findRLSetRangeForSlot === 'function') {
          const data = loadWeek(currentMonday);
          const info = data && findRLSetRangeForSlot(el, data);
          const base = info && data[info.baseKey];
          const rlId = base && base.meta && base.meta.rlSetId;

          if (info && rlId && Array.isArray(info.keys) && info.keys.length >= 2) {
            // â–¼ ã‚»ãƒƒãƒˆå…¨ä½“ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
            let wholeSelected = true;
            for (const k of info.keys) {
              const slotEl = document.querySelector(`.slot[data-key="${k}"]`);
              if (!slotEl) {
                wholeSelected = false;
                break;
              }
              // ã‚»ãƒƒãƒˆé¸æŠæ™‚ã«ã¤ãã‚¯ãƒ©ã‚¹ï¼šmultiSelected
              if (!slotEl.classList.contains('multiSelected')) {
                wholeSelected = false;
                break;
              }
            }

            if (!wholeSelected) {
              // ç‰‡å´ã ã‘é¸ã°ã‚Œã¦ã„ã‚‹ â†’ æ§‹é€ å¤‰æ›´ç³»ã¯å…¨éƒ¨NG
              isRLSingleMember = true;
            } else {
              // ã‚»ãƒƒãƒˆå…¨ä½“ãŒé¸ã°ã‚Œã¦ã„ã‚‹
              // â†’ rlBlockStartIdx / rlBlockEndIdx ã‚’æ±ºã‚ã¦ã€Œ1ãƒ–ãƒ­ãƒƒã‚¯æ‰±ã„ã€ã«ã™ã‚‹
              const len = info.keys.length; // æ™®é€šã¯ 2

              if (el.classList.contains('rl-set-top')) {
                // ä¸Šå´ã‚’å³ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã„ã‚‹ â†’ ã“ã“ãŒå…ˆé ­
                rlBlockStartIdx = idx;
                rlBlockEndIdx   = idx + (len - 1);
              } else if (el.classList.contains('rl-set-bottom')) {
                // ä¸‹å´ã‚’å³ã‚¯ãƒªãƒƒã‚¯ â†’ ã“ã“ãŒæœ«å°¾
                rlBlockStartIdx = idx - (len - 1);
                rlBlockEndIdx   = idx;
              } else {
                // å¿µã®ãŸã‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šidx ã‚’ãã®ã¾ã¾ä½¿ã†
                rlBlockStartIdx = idx;
                rlBlockEndIdx   = idx + (len - 1);
              }
            }
          }
        }
      } catch(e){
        console && console.warn && console.warn('RL guard in ctx menu failed:', e);
      }



      if (!isRLSingleMember) {

        addItem('ã“ã®æ ã®å‰ã«è‡¨æ™‚æ ã‚’æŒ¿å…¥', ()=>{
          const batch = (typeof beginUndoBatch === 'function')
            ? beginUndoBatch('temp-insert-before')
            : null;
          try {
            // RLã‚»ãƒƒãƒˆãŒã‚»ãƒƒãƒˆé¸æŠã•ã‚Œã¦ã„ã‚Œã°ã€ãã®ã€Œå…ˆé ­ idxã€ã®å‰ã«æŒ¿å…¥
            const targetIdx = (rlBlockStartIdx != null ? rlBlockStartIdx : idx);
            insertTempBefore(currentMonday, dayKey, section, targetIdx);
          } finally {
            if (typeof endUndoBatch === 'function') {
              endUndoBatch(batch);
            }
          }
          render();
        });

        addItem('ã“ã®æ ã®å¾Œã«è‡¨æ™‚æ ã‚’æŒ¿å…¥', ()=>{
          const batch = (typeof beginUndoBatch === 'function')
            ? beginUndoBatch('temp-insert-after')
            : null;
          try {
            // RLã‚»ãƒƒãƒˆãŒã‚»ãƒƒãƒˆé¸æŠã•ã‚Œã¦ã„ã‚Œã°ã€ãã®ã€Œæœ«å°¾ idxã€ã®å¾Œã‚ã«æŒ¿å…¥
            const targetIdx = (rlBlockEndIdx != null ? rlBlockEndIdx : idx);
            insertTempAfter(currentMonday, dayKey, section, targetIdx);
          } finally {
            if (typeof endUndoBatch === 'function') {
              endUndoBatch(batch);
            }
          }
          render();
        });

        // ï¼ˆã“ã®ä¸‹ã®ã€Œè‡¨æ™‚æ å‰Šé™¤ã€ã€Œä¼‘æ­¢ç³»ã€ã¯ãã®ã¾ã¾ã§OKï¼‰
        if (layout.isTemp(idx)){
          addItem('ã“ã®è‡¨æ™‚æ ã‚’å‰Šé™¤', ()=>{
            const batch = (typeof beginUndoBatch === 'function')
              ? beginUndoBatch('temp-remove')
              : null;
            try {
              removeTempAt(currentMonday, dayKey, section, idx);
            } finally {
              if (typeof endUndoBatch === 'function') {
                endUndoBatch(batch);
              }
            }
            render();
          });
        }

      // ä¼‘æ­¢ï¼ˆæ™‚åˆ»åŸºæº–ï¼‰â€” ç¥æ—¥ã¯éè¡¨ç¤º
      (() => {
        const key = el.dataset.key;
        const metaInfo = parseKey(key);   // { d, day, section, idx } ãªã©
        const iso      = metaInfo && metaInfo.d;
        const isHoliday= iso ? isHolidayISO(iso) : false;
        if (isHoliday) return;

        // é€±ãƒ‡ãƒ¼ã‚¿ã¨ã“ã®æ ã®ãƒ¬ã‚³ãƒ¼ãƒ‰
        const store      = loadWeek(currentMonday) || {};
        const recHere    = store[key];
        const hasDataHere= !!recHere;

        // åŒã˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã®ã‚¹ãƒ­ãƒƒãƒˆä¸€è¦§ï¼ˆDOM é †ï¼‰
        const slotsContainer = el.parentElement; // .slots
        if (!slotsContainer) return;
        const slotEls = Array.from(slotsContainer.querySelectorAll('.slot'));
        const domIdx  = slotEls.indexOf(el);
        if (domIdx < 0) return;

        let hasDataBefore = false;
        let hasDataAfter  = false;

        for (let i = 0; i < slotEls.length; i++){
          const sEl = slotEls[i];
          const k   = sEl.dataset.key;
          if (!k) continue;
          const r = store[k];

          // â˜… tail ã ã‘ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆçµåˆã®å»¶é•·æ ï¼‰ã‚„
          //   ã‚´ãƒ¼ã‚¹ãƒˆ tail ã¯ã€Œãƒ‡ãƒ¼ã‚¿ã‚ã‚Šã€ã¨ã¯ã¿ãªã•ãªã„
          if (!r || r.tail) continue;

          if (i < domIdx) {
            hasDataBefore = true;
          } else if (i > domIdx) {
            hasDataAfter = true;
          }
          if (hasDataBefore && hasDataAfter) break;
        }


        // ã“ã®ãƒã‚¹è‡ªä½“ã¯ãƒ‡ãƒ¼ã‚¿ãªã— ã‹ã¤ å‰å¾Œã«ã©ã“ã¾ã§ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹
        const canPauseHere       = !hasDataHere;
        const canPauseBeforeHere = canPauseHere && !hasDataBefore;
        const canPauseAfterHere  = canPauseHere && !hasDataAfter;

        // ç¾åœ¨ã®ä¼‘æ­¢çŠ¶æ…‹
        const off       = loadDayOff(currentMonday);
        const cutAfter  = off[dayKey]?.cutAfter  || {};
        const cutBefore = off[dayKey]?.cutBefore || {};
        const hasOff    = !!(cutAfter[section] || cutBefore[section]);

        // ã€Œä»¥å‰/ä»¥å¾Œã€ã‚‚å‡ºã›ãšã€ã‚¯ãƒªã‚¢å¯¾è±¡ã®ä¼‘æ­¢ã‚‚ç„¡ã‘ã‚Œã°ä½•ã‚‚å‡ºã•ãªã„
        if (!canPauseBeforeHere && !canPauseAfterHere && !hasOff) return;

        addItem('â”€â”€â”€â”€â”€â”€â”€â”€', () => {});

        // ã“ã®æ ã®æ™‚åˆ»ï¼ˆHH:MMï¼‰
        const timeText = timeEl.textContent.trim();
        const slotHHMM = normalizeTimeInput(timeText) || timeText;

        // ã“ã®æ ã€Œä»¥å¾Œã€ã‚’ä¼‘æ­¢ï¼ˆâ˜…å¾Œã‚å´ã«ãƒ‡ãƒ¼ã‚¿ãŒãªã„ãƒã‚¹ã ã‘ï¼‰
        if (canPauseAfterHere) {
          addItem('ã“ã®æ ã€Œä»¥å¾Œã€ã‚’ä¼‘æ­¢', () => {
            const off0      = loadDayOff(currentMonday);
            const cutAfter0 = Object.assign({}, off0[dayKey]?.cutAfter || {});
            cutAfter0[section] = String(slotHHMM);
            setDayOff(currentMonday, dayKey, { cutAfter: cutAfter0 }, { snapshot: true });
            render();
          });
        }

        // ã“ã®æ ã€Œã‚ˆã‚Šå‰ã€ã‚’ä¼‘æ­¢ï¼ˆâ˜…å‰å´ã«ãƒ‡ãƒ¼ã‚¿ãŒãªã„ãƒã‚¹ã ã‘ï¼‰
        if (canPauseBeforeHere) {
          addItem('ã“ã®æ ã€Œã‚ˆã‚Šå‰ã€ã‚’ä¼‘æ­¢', () => {
            const off0       = loadDayOff(currentMonday);
            const cutBefore0 = Object.assign({}, off0[dayKey]?.cutBefore || {});
            cutBefore0[section] = String(slotHHMM);
            setDayOff(currentMonday, dayKey, { cutBefore: cutBefore0 }, { snapshot: true });
            render();
          });
        }

        // ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã€Œæ™‚åˆ»ä¼‘æ­¢ã€ã‚’ã‚¯ãƒªã‚¢ï¼ˆâ˜…ä½•ã‹ä¼‘æ­¢ãŒã‚ã‚‹ã¨ãã ã‘ï¼‰
        if (hasOff) {
          addItem('ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã€Œæ™‚åˆ»ä¼‘æ­¢ã€ã‚’ã‚¯ãƒªã‚¢', () => {
            const off1       = loadDayOff(currentMonday);
            const cutAfter1  = Object.assign({}, off1[dayKey]?.cutAfter  || {});
            const cutBefore1 = Object.assign({}, off1[dayKey]?.cutBefore || {});
            delete cutAfter1[section];
            delete cutBefore1[section];
            setDayOff(currentMonday, dayKey, { cutAfter: cutAfter1, cutBefore: cutBefore1 }, { snapshot: true });
            render();
          });
        }
      })();

      } // if (!isRLSingleMember) ã“ã“ã¾ã§

  // ==== RLã‚»ãƒƒãƒˆè§£é™¤ ====
  (()=>{
    try {
      const data = loadWeek(currentMonday);
      if (!data || typeof findRLSetRangeForSlot !== 'function') return;

      // ã“ã®ã‚¹ãƒ­ãƒƒãƒˆãŒ RLã‚»ãƒƒãƒˆã«å±ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹åˆ¤å®š
      const info = findRLSetRangeForSlot(el, data);
      const baseRec = info && data[info.baseKey];
      const rlId = baseRec?.meta?.rlSetId;
      if (!info || !rlId) return;  // RLã‚»ãƒƒãƒˆã§ãªã‘ã‚Œã°ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å‡ºã•ãªã„

      addItem('RLã‚»ãƒƒãƒˆã‚’è§£é™¤ï¼ˆãƒªãƒ³ã‚¯ã®ã¿ï¼‰', ()=>{
        if (!confirm('ã“ã®RLã‚»ãƒƒãƒˆã®ãƒªãƒ³ã‚¯ã‚’è§£é™¤ã—ã¾ã™ï¼ˆæ è‡ªä½“ã¯æ®‹ã‚Šã¾ã™ï¼‰ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
          return;
        }

        const data2 = loadWeek(currentMonday);
        const info2 = findRLSetRangeForSlot(el, data2);
        const base2 = info2 && data2[info2.baseKey];
        const rlId2 = base2?.meta?.rlSetId;
        if (!info2 || !rlId2) return;

        // R/L ä¸¡ãƒ˜ãƒƒãƒ‰ã‹ã‚‰ rlSetId ã‚’å¤–ã™
        for (const headKey of info2.keys) {
          const rec = data2[headKey];
          if (!rec || !rec.meta) continue;
          if (rec.meta.rlSetId !== rlId2) continue;
          delete rec.meta.rlSetId;
          // metaãŒç©ºã«ãªã£ãŸã‚‰ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã”ã¨å‰Šé™¤ã—ã¦ã‚¯ãƒªãƒ¼ãƒ³ã«
          if (!Object.keys(rec.meta).length) {
            delete rec.meta;
          }
        }

        saveWeek(currentMonday, data2);
        render();

        // ã‚»ãƒƒãƒˆé¸æŠçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
        if (typeof clearMultiSelection === 'function') {
          clearMultiSelection();
        }
        window.currentRLSetId = null;

        // æ“ä½œã—ãŸæ ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’æˆ»ã™
        const k = el.dataset.key;
        if (k && typeof setActiveSlot === 'function') {
          const el2 = document.querySelector(`.slot[data-key="${CSS.escape(k)}"]`);
          if (el2) setActiveSlot(el2);
        }
      });
    } catch (e) {
      console.warn('RLã‚»ãƒƒãƒˆè§£é™¤ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
    }
  })();
  
      function closeMenu(ev){ if (!menu.contains(ev.target)) { document.removeEventListener('mousedown', closeMenu, true); if (menu.parentNode) menu.parentNode.removeChild(menu); } }
      document.addEventListener('mousedown', closeMenu, true); document.body.appendChild(menu);
    }, {passive:false});

    return el;
  }

  // ===== ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ =====
prevWeekBtn.addEventListener('click', (e)=>{
  e.preventDefault();
  e.stopImmediatePropagation();

  // â˜… é€±ã¾ãŸãæ™‚ã¯è¤‡æ•°é¸æŠã‚’ã‚¯ãƒªã‚¢ï¼ˆå¾“æ¥ã®æŒ™å‹•ã¯ç¶­æŒï¼‰
  if (typeof multiSelected!=='undefined') { 
    multiSelected.clear?.(); 
    document.querySelectorAll('.slot.is-selected')
      ?.forEach(el => el.classList.remove('is-selected'));
  }

  // â˜… Ctrl+â† ã‚’æ“¬ä¼¼çš„ã«æŠ¼ã—ãŸã“ã¨ã«ã™ã‚‹
  const ev = new KeyboardEvent('keydown', {
    key: 'ArrowLeft',
    code: 'ArrowLeft',
    ctrlKey: true,
    bubbles: true
  });
  document.dispatchEvent(ev);
});

nextWeekBtn.addEventListener('click', (e)=>{
  e.preventDefault();
  e.stopImmediatePropagation();

  if (typeof multiSelected!=='undefined') { 
    multiSelected.clear?.(); 
    document.querySelectorAll('.slot.is-selected')
      ?.forEach(el => el.classList.remove('is-selected'));
  }

  // â˜… Ctrl+â†’ ã‚’æ“¬ä¼¼çš„ã«æŠ¼ã—ãŸã“ã¨ã«ã™ã‚‹
  const ev = new KeyboardEvent('keydown', {
    key: 'ArrowRight',
    code: 'ArrowRight',
    ctrlKey: true,
    bubbles: true
  });
  document.dispatchEvent(ev);
});

todayBtn.addEventListener('click', (e)=>{
  // é€šå¸¸ã®ãƒªãƒ³ã‚¯å‹•ä½œãªã©ã¯ç„¡åŠ¹åŒ–
  e.preventDefault();
  e.stopImmediatePropagation();

  // ãƒãƒ«ãƒé¸æŠçŠ¶æ…‹ã¯å¿µã®ãŸã‚ã‚¯ãƒªã‚¢ï¼ˆå¾“æ¥ã®æŒ™å‹•ã‚’ç¶­æŒã—ãŸã„å ´åˆï¼‰
  if (typeof multiSelected !== 'undefined') {
    multiSelected.clear?.();
    document.querySelectorAll('.slot.is-selected')
      ?.forEach(el => el.classList.remove('is-selected'));
  }

  // â˜… Ctrl+, ã‚’æ“¬ä¼¼çš„ã«æŠ¼ã—ãŸã“ã¨ã«ã™ã‚‹
  const ev = new KeyboardEvent('keydown', {
    key: ',',
    code: 'Comma',
    ctrlKey: true,
    bubbles: true
  });
  document.dispatchEvent(ev);
});

  weekPicker.addEventListener('change', (e)=>{ if (window.__suppressWeekChange) return;
    if (typeof multiSelected!=='undefined') { 
      multiSelected.clear?.(); 
      document.querySelectorAll('.slot.is-selected')?.forEach(el=> el.classList.remove('is-selected'));
    }
    if (window.__suppressWeekChange) return;  // â˜…ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ä¸­ãƒ”ãƒƒã‚«ãƒ¼æ›´æ–°ã‚’æŠ‘æ­¢
    const v=e.target.value; if(!v) return;
    const [y,m,d]=v.split('-').map(Number);
    const mon = startOfWeek(new Date(y, m-1, d));
    window.__suppressCenterN = (window.__suppressCenterN|0) + 2;
    window.__snapTopOnNextRender = true;
    window.__snapTopTargetISO   = (typeof dateISO==='function') ? dateISO(mon) : mon.toISOString().slice(0,10);
    currentMonday = mon;
    render();
    window.__postWeekMoveCenter?.();	
  });

// â˜… é€±è¡¨ç¤ºã®é€šå¸¸å°åˆ·ï¼šæœˆã€œé‡‘ã ã‘å°åˆ· ï¼‹ èƒŒãŒé«˜ã„æ›œæ—¥ã ã‘è‡ªå‹•ã§å°‘ã—ç¸®å°
printBtn.addEventListener('click', () => {
  const days = Array.from(document.querySelectorAll('#schedule .day'));
  if (!days.length) {
    window.print();
    return;
  }

  // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è¡¨ç¤ºä¸­ã¯ã€å¾“æ¥é€šã‚Šãã®æ—¥ã ã‘å°åˆ·
  if (document.body.classList.contains('dayFocus')) {
    window.print();
    return;
  }

  const weekendDays = [];
  const weekdayDays = [];

  // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã€Œ(åœŸ)/(æ—¥)ã€ã‚’è¦‹ã¦ã€å¹³æ—¥ã¨åœŸæ—¥ã«åˆ†ã‘ã‚‹
  for (const d of days) {
    const header = d.querySelector('.day-header-date');
    const txt = header?.textContent || '';
    if (txt.includes('åœŸ') || txt.includes('æ—¥')) {
      weekendDays.push(d);
    } else {
      weekdayDays.push(d);
    }
  }

  // â‘  åœŸæ—¥ã¯ hide-on-print ã§éš ã™
  const hiddenDays = [];
  weekendDays.forEach(d => {
    d.classList.add('hide-on-print');
    hiddenDays.push(d);
  });

  // â‘¡ ç·Šæ€¥æ /è‡¨æ™‚æ ã®ã€Œæ•°ã€ã«å¿œã˜ã¦åœ§ç¸®ãƒ¬ãƒ™ãƒ«ã‚’å¤‰ãˆã‚‹
  const tightDays = [];
  const tighterDays = [];
  weekdayDays.forEach(d => {
    const cnt = d.querySelectorAll('.slot.emergency-slot, .slot.temp-slot').length;
    if (cnt >= 1 && cnt <= 2) {
      d.classList.add('print-tight');
      tightDays.push(d);
    } else if (cnt >= 3) {
      d.classList.add('print-tighter');
      tighterDays.push(d);
    }
  });

  try {
    window.print();
  } finally {
    hiddenDays.forEach(d => d.classList.remove('hide-on-print'));
    tightDays.forEach(d => d.classList.remove('print-tight'));
    tighterDays.forEach(d => d.classList.remove('print-tighter'));
  }
});

// === 2ãƒšãƒ¼ã‚¸å°åˆ·ãƒ¢ãƒ¼ãƒ‰ï¼ˆä»Šã¯æœˆã€œé‡‘ï¼‹åœŸæ—¥ã‚‚å«ã‚ã¦2æšã«åã‚ã‚‹ï¼‰ ===
printWeek2pBtn?.addEventListener('click', ()=>{
  const days = Array.from(document.querySelectorAll('#schedule .day'));
  if (!days.length) {
    window.print();
    return;
  }

  // â˜… 2ãƒšãƒ¼ã‚¸å°åˆ·ãƒ¢ãƒ¼ãƒ‰ ONï¼ˆè¡Œé«˜ã‚„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ«åœ§ç¸®ãªã©ã®CSSãŒåŠ¹ãï¼‰
  document.body.classList.add('printWeek2p');

  try {
    window.print();
  } finally {
    document.body.classList.remove('printWeek2p');
  }
});


const printSelectionBtn = document.getElementById('printSelectionBtn');
printSelectionBtn?.addEventListener('click', ()=>{
  // ãƒ«ãƒ¼ãƒ«ï¼šã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ãƒ­ãƒƒãƒˆã®å±ã™ã‚‹ã€Œç›´è¿‘ã® .slotsã€ã‚’å°åˆ·
   const base = getActiveSlot?.() || document.querySelector('.slot');
  if(!base){
    alert('å°åˆ·ã™ã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒç‰¹å®šã§ãã¾ã›ã‚“ï¼ˆæ ã‚’1ã¤é¸æŠã—ã¦ã‹ã‚‰æŠ¼ã—ã¦ãã ã•ã„ï¼‰');
    return;
  }
  const slotsEl = base.closest('.slots');
  if(!slotsEl){
    alert('ã“ã®æ ã«å¯¾å¿œã™ã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
    return;
  }
  printSection(slotsEl);
});

// ==== è¨­å®šãƒœã‚¿ãƒ³ã¨ãƒ€ã‚¤ã‚¢ãƒ­ã‚° ====
const settingsBtn   = document.getElementById('settingsBtn');
const settingsDlg   = document.getElementById('settings');
const settingsForm  = document.getElementById('settingsForm');
const settingsSave  = document.getElementById('settingsSaveBtn');

// é–‹ãï¼šç¾åœ¨ã®å€¤ã‚’ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«æµã—è¾¼ã‚€ï¼ˆ1è¡Œ=1å€™è£œï¼‰
settingsBtn?.addEventListener('click', ()=>{
  document.getElementById('optIolTypes').value  = (appLists.iolTypes||[]).join('\n');
  document.getElementById('optProc1').value     = (appLists.proc1||[]).join('\n');
  document.getElementById('optProc2').value     = (appLists.proc2||[]).join('\n');
  document.getElementById('optSurgeons').value  = (appLists.surgeons||[]).join('\n');
  settingsDlg.showModal();
});

// ä¿å­˜
settingsForm?.addEventListener('close', ()=>{/* noopï¼ˆå¿µã®ãŸã‚ï¼‰ */});
settingsSave?.addEventListener('click', (e)=>{
  // <button value="save"> ãªã®ã§ dialog ã¯é–‰ã˜ã‚‹æŒ™å‹•ã§ã™ãŒã€ç¢ºå®Ÿã«å…ˆã«ä¿å­˜å‡¦ç†
  e.preventDefault();

  const lines = (t)=> t.split('\n').map(s=>s.trim()).filter(Boolean);

  const next = {
    iolTypes:  lines(document.getElementById('optIolTypes').value),
    proc1:     lines(document.getElementById('optProc1').value),
    proc2:     lines(document.getElementById('optProc2').value),
    surgeons:  lines(document.getElementById('optSurgeons').value)
  };

  appLists = next;
  saveSettings(appLists);
  applyDatalists(appLists);
  settingsDlg.close();  // é–‰ã˜ã‚‹
});

// åˆæœŸåæ˜ ï¼šèµ·å‹•æ™‚ã¨æ¯æç”»æ™‚ã«æœ€æ–°ã‚’åæ˜ 
applyDatalists(appLists);


  // ç¥æ—¥ãƒ‡ãƒ¼ã‚¿ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆå½“å¹´ï¼‹å‰å¾Œ1å¹´ï¼‰
  (function ensureHolidayCaches(){ const y = new Date().getFullYear(); [y - 1, y, y + 1].forEach(ensureHolidayAuto); })();

// â˜… ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ç·¨é›†ã‚’å§”è­²ã§ä¸€æ‹¬å¯¾å¿œï¼ˆF5ç›´å¾Œã§ã‚‚å¿…ãšåŠ¹ãï¼‰
 // =============================
 // é¸æŠçŠ¶æ…‹ï¼ˆSSTï¼‰ã¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 // =============================
 (function initSlotCursorCore(){
   if (!window.__slotCursor)
     window.__slotCursor = { activeSlotEl: null, activeDayIndex: null };
 
   // ç¾åœ¨é¸æŠã‚’å–å¾—
   window.getActiveSlot = function(){ return window.__slotCursor.activeSlotEl; };
 
function isSelectableSlot(el){
  // åŸºæœ¬ã‚¬ãƒ¼ãƒ‰
  if (!el || !el.classList?.contains('slot')) return false;
  if (el.hidden) return false;                              // <div hidden> å¯¾å¿œ
  if (el.classList.contains('hiddenRow')) return false;     // çµåˆæ  tail é™¤å¤–
  if (el.classList.contains('disabled')) return false;
  if (el.classList.contains('locked')) return false;
  if (getComputedStyle(el).display === 'none') return false; // CSSéè¡¨ç¤ºé™¤å¤–

  // ä¾‹å¤–ï¼šè‡¨æ™‚/ç·Šæ€¥ã¯æœ€å„ªå…ˆã§ã€Œé¸æŠå¯ã€
  const isTempOrEmergency = el.classList.contains('temp-slot') || el.classList.contains('emergency-slot');
  if (isTempOrEmergency) return true;

  // æ‰‹å‹•ã‚ªãƒ•ï¼ˆå€‹åˆ¥ä¼‘æ­¢ï¼‰ï¼åŸå‰‡ã€Œé¸æŠä¸å¯ã€
  if (el.classList.contains('off')) return false;

  // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ä¼‘æ­¢ï¼ˆè¦ª .slots.section-offï¼‰ï¼ã€Œé¸æŠä¸å¯ã€
  const slotsWrap = el.closest?.('.slots');
  if (slotsWrap?.classList?.contains('section-off')) return false;

  // ç¥æ—¥/çµ‚æ—¥ä¼‘æ­¢ï¼ˆè¦ª .day ãŒ is-holiday / is-offï¼‰ï¼ã€Œé¸æŠä¸å¯ã€
  const day = el.closest?.('.day');
  if (day && (day.classList.contains('is-holiday') || day.classList.contains('is-off'))) return false;

  return true;
}

// ç¥æ—¥/ä¼‘è¨ºæ—¥ã® day åˆ¤å®šï¼ˆé›†ä¸­ç®¡ç†ï¼‰
function isOffDay(dayEl){
  return !!(dayEl && (dayEl.classList.contains('is-holiday') || dayEl.classList.contains('is-off')));
}

  // å»ƒæ­¢: setActiveSlot ã«çµ±åˆæ¸ˆã¿ã€‚äº’æ›ç¢ºä¿ã®ãŸã‚å½“é¢ã¯ no-opï¼ˆå¾Œæ—¥å‰Šé™¤å¯ï¼‰
  function syncFocused(){ /* no-op */ }
 
// ï¼ˆé‡è¤‡ã—ã¦ã„ãŸæ—§çµ±åˆç‰ˆã¯å‰Šé™¤ï¼‰
  // çµ±åˆç‰ˆ: setActiveSlot ã¯é’æ ãƒ»çŠ¶æ…‹æ›´æ–°ãƒ»ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¾ã§ä¸€å…ƒç®¡ç†
  window.setActiveSlot = function(el, opts){
    opts = opts || {};
    const doScroll = opts.scroll !== false; // â˜… æ—¢å®šã¯ç¶­æŒã€‚é€±ç§»å‹•ç³»ã‹ã‚‰ã¯å¿…ãš {scroll:false}

    // ç„¡åŠ¹è¦ç´  â†’ å…¨è§£é™¤
    if (!isSelectableSlot(el)) {
      const prev0 = window.__slotCursor?.activeSlotEl || document.querySelector('.slot.focused');
      if (prev0?.classList) prev0.classList.remove('focused');
      if (window.__slotCursor) window.__slotCursor.activeSlotEl = null;
      window.__navCurSlot = null;
      window.lastSelectedKey = null;
      return;
    }

  // ç¥æ—¥/ä¼‘è¨ºæ—¥ã® day ã‚’æ¸¡ã•ã‚ŒãŸå ´åˆã¯ã€Œå–¶æ¥­æ—¥ã®æœ€åˆã®æ ã€ã¸å¯„ã›ã‚‹
  (function normalizeAwayFromHoliday(){
    // â˜… ç·Šæ€¥/è‡¨æ™‚ã¯â€œå¯„ã›ãšâ€ã«ãã®å ´ã§é¸æŠã•ã›ã‚‹
    const isEmOrTemp = el?.classList?.contains('emergency-slot') || el?.classList?.contains('temp-slot');
    if (isEmOrTemp) return;  
    const day = el.closest?.('.day');
    if (!isOffDay(day)) return;
    const days = Array.from(document.querySelectorAll('.day'));
    let idx = days.indexOf(day);
    // å³ï¼ˆç¿Œæ—¥ï¼‰å„ªå…ˆã§å–¶æ¥­æ—¥ã‚’æ¢ã™ â†’ ãªã‘ã‚Œã°å·¦ã¸
    let j = idx + 1, found = null;
    for(; j < days.length; j++){
      if (!isOffDay(days[j])){ found = days[j]; break; }
    }
    if (!found){
      for(j = idx - 1; j >= 0; j--){
        if (!isOffDay(days[j])){ found = days[j]; break; }
      }
    }
    if (found){
      const first = window.findFirstSelectableInDay?.(found);
      if (first) el = first; // â† â€œæ¸¡ã•ã‚ŒãŸç¥æ—¥æ â€ã¯ã“ã“ã§ç½®æ›
    }
  })();
  
    // hiddenRowï¼ˆçµåˆæ tailï¼‰ã®å ´åˆã¯ head ã¸å¯„ã›ã‚‹
    while (el && el.classList.contains('hiddenRow')) el = el.previousElementSibling;

    const prev = window.__slotCursor?.activeSlotEl || document.querySelector('.slot.focused');
    if (prev && prev !== el) prev.classList.remove('focused');

    // çŠ¶æ…‹åŒæœŸ
    if (window.__slotCursor) window.__slotCursor.activeSlotEl = el;
    window.__navCurSlot = el; // ç°¡æ˜“ãƒŠãƒ“ã¨åŒæœŸ
    window.lastSelectedKey = el?.dataset?.key || null;

    // day index æ›´æ–°
    const day = el.closest?.('.day');
    if (day && window.__slotCursor) {
      const idx = Array.from(day.parentElement?.querySelectorAll?.('.day') || []).indexOf(day);
      if (idx >= 0) window.__slotCursor.activeDayIndex = idx;
    }

    // é’æ ï¼‹ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ï¼‹ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    el.classList.add('focused');
    try { el.focus?.({ preventScroll: true }); } catch(_){}
    if (doScroll) try { el.scrollIntoView({ block: 'nearest', inline: 'nearest' }); } catch(_){}
  };

// === é€±ãƒ“ãƒ¥ãƒ¼ï¼šã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ãƒ­ãƒƒãƒˆã‚’ç¸¦æ¨ªã¨ã‚‚ä¸­å¤®ã«å¯„ã›ã‚‹ï¼ˆåˆ‡æ›¿ç›´å¾Œå°‚ç”¨ãƒ»ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰ ===
window.__centerActiveInWeekSoon = function(){
  // â˜… æŠ‘æ­¢ã‚«ã‚¦ãƒ³ã‚¿ã¯ã€Œé€±è¡¨ç¤ºã®ã¨ãã ã‘ã€åŠ¹ã‹ã›ã‚‹ï¼ˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹ä¸­ã¯ç„¡è¦–ï¼‰
  if (!document.body.classList.contains('dayFocus') && window.__suppressCenterN > 0) {
    window.__suppressCenterN--;
    return;
  }

  const run = () => {
    const el =
      (window.getActiveSlot && window.getActiveSlot()) ||
      document.querySelector('.slot.focused');
    if (!el) return;

    try {
      // â˜… å®Ÿéš›ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«ä»»ã›ã¦ã€
      //    ç¸¦æ¨ªã¨ã‚‚ã€Œä¸­å¤®ä»˜è¿‘ã€ã«ä¸€ç™ºã§ã‚¹ãƒŠãƒƒãƒ—ã•ã›ã‚‹
      el.scrollIntoView({
        block:  'center',   // ä¸Šä¸‹æ–¹å‘ â†’ ä¸­å¤®ä»˜è¿‘
        inline: 'center',   // å·¦å³æ–¹å‘ â†’ ä¸­å¤®ä»˜è¿‘
        behavior: 'auto'    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—ï¼ˆç¬æ™‚ï¼‰
      });
    } catch (_e) {
      // scrollIntoView éå¯¾å¿œç’°å¢ƒã¯ã€å˜ç´”ãª nearest ã ã‘ã§ã‚‚ OK
      try { el.scrollIntoView(); } catch(_e2) {}
    }
  };

  // â˜… ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç¢ºå®šå¾Œã«ä¸€åº¦ã ã‘å®Ÿè¡Œï¼ˆ2ãƒ•ãƒ¬ãƒ¼ãƒ å¾…ã¡ã§å®‰å®šã•ã›ã‚‹ï¼‰
  requestAnimationFrame(() => {
    requestAnimationFrame(run);
  });
};


window.__postWeekMoveCenter = function(){
  // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒ¢ãƒ¼ãƒ‰ä¸­ã¯é€±ç§»å‹•æ‰±ã„ã«ã—ãªã„
  if (document.body.classList.contains('dayFocus')) return;

  requestAnimationFrame(() => {
    // 1) æ—¢å­˜ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚’å„ªå…ˆ
    let el =
      (window.getActiveSlot && window.getActiveSlot()) ||
      document.querySelector('.slot.focused');

    // â˜… å‰ã®é€±ãªã©ã€Œä»Šã® DOM ã«å­˜åœ¨ã—ãªã„ã‚¹ãƒ­ãƒƒãƒˆã€ã‚’æ´ã‚“ã§ã„ã‚‹å ´åˆã¯æ¨ã¦ã‚‹
    if (el && !document.body.contains(el)) {
      el = null;
    }

    // 2) ä½•ã‚‚ãªã‘ã‚Œã°ã€Œé€±ã®å…ˆé ­ã®é¸æŠå¯èƒ½ã‚¹ãƒ­ãƒƒãƒˆã€ã‚’æ¢ã™
    if (!el) {
      const days = Array.from(document.querySelectorAll('#schedule .day'));
      for (const d of days) {
        const first =
          (window.findFirstSelectableInDay && window.findFirstSelectableInDay(d)) ||
          d.querySelector('.slot');
        if (first) { el = first; break; }
      }
    }

    // â˜… ãã‚Œã§ã‚‚è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€ä¿é™ºã¨ã—ã¦æœ€åˆã® .slot ã‚’æ‹¾ã†
    if (!el) {
      el = document.querySelector('#schedule .slot');
    }
    if (!el) return;

    // 3) æ­£å¼ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è¨­å®šï¼ˆã“ã“ã§ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ãªã„ï¼‰
    if (typeof window.setActiveSlot === 'function') {
      window.setActiveSlot(el, { scroll: false });
    } else {
      // å¿µã®ãŸã‚å¤ã„ .focused ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰ä»˜ã‘ç›´ã™
      document.querySelectorAll('.slot.focused')
        .forEach(s => s.classList.remove('focused'));
      el.classList.add('focused');
    }

    // â˜… suppress ãŒé‚ªé­”ã—ãªã„ã‚ˆã†ã«ãƒªã‚»ãƒƒãƒˆã—ã¦ã‹ã‚‰ã€ã„ã¤ã‚‚ã®ã‚»ãƒ³ã‚¿ãƒªãƒ³ã‚°é–¢æ•°ã‚’å‘¼ã¶
    window.__suppressCenterN = 0;
    window.__centerActiveInWeekSoon?.();
  });
};



// äº’æ›ï¼šç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ ã‚’å–å¾—
window.getActiveSlot = function(){
  return window.__slotCursor?.activeSlotEl || document.querySelector('.slot.focused') || null;
};
// æ—§APIã¯ç©ºå®Ÿè£…ã«
window.syncFocused = function(){ /* unified into setActiveSlot */ };
 
   window.findFirstSelectableInDay = function(dayEl){
     if (!dayEl) return null;
     const list = dayEl.querySelectorAll('.slot');
     for (const el of list) if (isSelectableSlot(el)) return el;
     return null;
   };
 
   window.ensureInitialSelectionForDay = function(dayEl){
     if (window.__slotCursor.activeSlotEl?.closest?.('.day') === dayEl) return;
     const first = findFirstSelectableInDay(dayEl);
     if (first) setActiveSlot(first);
   };
 
window.moveVertWithinDay = function(fromEl, delta){
  if (!isSelectableSlot(fromEl)) return false;
  const dayEl = fromEl.closest?.('.day');
  if (!dayEl) return false;
  const list = Array.from(dayEl.querySelectorAll('.slot')).filter(isSelectableSlot);
  const i = list.indexOf(fromEl);
  if (i < 0) return false;
  const j = i + (delta > 0 ? 1 : -1);
  if (j < 0 || j >= list.length) return false; // ç«¯ã§ã¯æ­¢ã¾ã‚‹

  const target = list[j];
  setActiveSlot(target);

  const inFocus = document.body.classList.contains('dayFocus');
  if (inFocus) {
    // â˜… ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è¡¨ç¤ºä¸­ï¼šå®Ÿéš›ã®è¡¨ç¤ºæ ã®ä¸­å¤®ã«ã€Œå¿…ãšè¦‹ãˆã‚‹ã‚ˆã†ã«ã€ã‚¹ãƒŠãƒƒãƒ—
    target.scrollIntoView({ block: 'center', inline: 'nearest', behavior: 'auto' });
  } else {
    // â˜… é€±è¡¨ç¤ºä¸­ï¼šsmooth ã‚’ã‚„ã‚ã¦å³æ™‚ã‚»ãƒ³ã‚¿ãƒªãƒ³ã‚°ï¼ˆè¿½å¾“é…ã‚Œã‚’é˜²ãï¼‰
    centerSlotInView(target, { instant: true });
  }

  return true;
}

  // === ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ãƒ­ãƒƒãƒˆã‚’ä¸­å¤®ã«å¯„ã›ã‚‹ ===
  function centerSlotInView(slotEl, opts){
    opts = opts || {};
    const instant = opts.instant === true;  // â˜… true ã®ã¨ãã¯ãƒ‘ãƒƒã¨ï¼ˆsmoothç¦æ­¢ï¼‰
    if (!slotEl) return;
    const dayEl = slotEl.closest('.day');
    if (!dayEl) return;

    const scrollBox = __getScrollParent(dayEl);
    if (!scrollBox) return;

    const boxRect = scrollBox.getBoundingClientRect();
    const slotRect = slotEl.getBoundingClientRect();

    const currentTop = scrollBox.scrollTop;
    const slotTop = slotRect.top - boxRect.top + currentTop;
    const slotCenter = slotTop + slotRect.height / 2;

    // ã‚¹ãƒ­ãƒƒãƒˆã‚’å¯è¦–é ˜åŸŸä¸­å¤®ã«é…ç½®
    let target = slotCenter - scrollBox.clientHeight / 2;

    // 0ã€œæœ€å¤§ç¯„å›²å†…ã«åã‚ã‚‹
    target = Math.max(0, Math.min(target, scrollBox.scrollHeight - scrollBox.clientHeight));

    if (instant) {
      // â˜… ãƒ‘ãƒƒã¨ç§»å‹•ï¼ˆããƒ¼ã£ã¨å‹•ã‹ãªã„ï¼‰
      scrollBox.scrollTop = target;
    } else {
      // ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§è‡ªç„¶ãªå‹•ãã«
      scrollBox.scrollTo({ top: target, behavior: 'smooth' });
    }
  }
 })();
 
    function moveVertWithCrossDay(fromEl, delta) {
  const inFocus = document.body.classList.contains('dayFocus');
  if (inFocus) {
    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è¡¨ç¤ºã§ã¯åŒæ—¥å†…ã®ã¿ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¾ãŸãå¯ï¼‰
    moveVertWithinDay(fromEl, delta);
    return;
  }

  // --- é€±ãƒ¢ãƒ¼ãƒ‰ï¼ˆæ—¥ã¾ãŸãã‚ã‚Šï¼‰ ---
  const curDay = fromEl.closest('.day');
  if (!curDay) return;

  // åŒæ—¥å†…ã«æ¬¡ã‚¹ãƒ­ãƒƒãƒˆãŒã‚ã‚Œã°å„ªå…ˆ
  if (moveVertWithinDay(fromEl, delta)) return;

  // æ—¥ã¾ãŸãå‡¦ç†ï¼ˆâ€œé¸æŠå¯èƒ½ãªã‚¹ãƒ­ãƒƒãƒˆâ€ãŒã‚ã‚‹æ—¥ã ã‘ã¸
  const allDays = Array.from(document.querySelectorAll('.day'));
  const step = (delta > 0 ? 1 : -1);
  let i = allDays.indexOf(curDay) + step;
  // é¸æŠå¯èƒ½åˆ¤å®šï¼šå­˜åœ¨ã™ã‚Œã° window.isSelectableSlot ã‚’å„ªå…ˆ
  const isSel = (el)=>{
    if (typeof window.isSelectableSlot === 'function') return window.isSelectableSlot(el);
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆæœ€ä½é™ï¼‰
    if (!el || !el.classList?.contains('slot')) return false;
    if (el.hidden || el.classList.contains('hiddenRow') || el.classList.contains('disabled') || el.classList.contains('locked')) return false;
    const wrap = el.closest?.('.slots');
    if (wrap?.classList?.contains('section-off')) return false;
    if (el.classList.contains('off')) return false;
    const day = el.closest?.('.day');
    if (day && (day.classList.contains('is-holiday') || day.classList.contains('is-off'))) return false;
    return true;
  };
  while (i >= 0 && i < allDays.length) {
    const nextDay = allDays[i];
    // ãã®æ—¥ã®â€œé¸æŠå¯èƒ½ãªã‚¹ãƒ­ãƒƒãƒˆâ€ã ã‘ã‚’å€™è£œã«ã™ã‚‹
    const list = Array.from(nextDay.querySelectorAll('.slot')).filter(isSel);
    if (!list.length) { i += step; continue; }

    const target = (delta > 0) ? list[0] : list[list.length - 1];
    setActiveSlot(target);

    // â˜… é€±è¡¨ç¤ºã§ã®æ—¥ã¾ãŸãæ™‚ã‚‚ã€å³æ™‚ã‚»ãƒ³ã‚¿ãƒªãƒ³ã‚°ã§å¿…ãšç”»é¢å†…ã«æ•ã¾ãˆã‚‹
    centerSlotInView(target, { instant: true });

    return;
  }
  // ç€åœ°å…ˆãŒç„¡ã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
}

  // åˆæœŸé©ç”¨ï¼†æç”»
  applyLayout(layoutMode);

// âœ…ï¼ˆä»»æ„ï¼‰ç”»é¢ã‚µã‚¤ã‚ºå¤‰æ›´ã§ã‚‚å†èª¿æ•´ã—ãŸã„ãªã‚‰ã“ã“ã«è¿½åŠ 
let _fitT = null;
window.addEventListener('resize', () => {
  clearTimeout(_fitT);
  _fitT = setTimeout(() => autoFitContentLines(), 150);
}, { passive: true });

// ã€Œç·¨é›†ã€ãƒœã‚¿ãƒ³ï¼šé¸æŠä¸­ï¼ˆè¤‡æ•°å¯¾å¿œï¼‰â†’ ãªã‘ã‚Œã°ã‚¢ã‚¯ãƒ†ã‚£ãƒ– â†’ ãã‚Œã‚‚ç„¡ã‘ã‚Œã°å…ˆé ­
editBtn?.addEventListener('click', () => {
  // â˜… RLã‚»ãƒƒãƒˆå¤–å‘¨é¸æŠä¸­ã¯ã€Œã‚»ãƒƒãƒˆæ“ä½œãƒ¢ãƒ¼ãƒ‰ã€ã¨ã¿ãªã—ã€ç·¨é›†ã‚’ãƒ–ãƒ­ãƒƒã‚¯
  //   â†’ ã©ã¡ã‚‰ã‹ã®æ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å˜æ é’æ ã«ã—ã¦ã‹ã‚‰ç·¨é›†ã—ã¦ã‚‚ã‚‰ã†
  if (window.currentRLSetId && document.querySelector('.slot.multiSelected')) {
    // å¿…è¦ãªã‚‰æ¡ˆå†…ã‚’å‡ºã—ã¦ã‚‚ã‚ˆã„ï¼ˆä»Šã¯é™ã‹ã«ç„¡è¦–ï¼‰
    // alert('RLã‚»ãƒƒãƒˆé¸æŠä¸­ã§ã™ã€‚ã©ã¡ã‚‰ã‹ã®æ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‹ã‚‰ç·¨é›†ã—ã¦ãã ã•ã„ã€‚');
    return;
  }

  // ã¾ãš DOM è¦ç´ ã§å€™è£œã‚’é›†ã‚ã‚‹
  const candEls = [];

  if (typeof multiSelected !== 'undefined' && multiSelected.size){
    for (const k of multiSelected){
      const el = document.querySelector(`.slot[data-key="${k}"]`);
      if (el) candEls.push(el);
    }
    // â˜… é€±ã¾ãŸãã§ã‚­ãƒ¼ãŒç„¡åŠ¹ã ã£ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    if (!candEls.length) {
      const cur = getActiveSlot?.() || document.querySelector('.slot.focused');
      if (cur) candEls.push(cur);
      else {
        const first = document.querySelector('.slot');
        if (first) candEls.push(first);
      }
    }
  } else {
     const cur = getActiveSlot?.();
     if (cur) {
       candEls.push(cur);
     } else {
       const first = document.querySelector('.slot');
       if (first) candEls.push(first);
     }
   }

  if (!candEls.length){
    alert('ç·¨é›†ã™ã‚‹æ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    return;
  }

  // â˜… ç¥æ—¥/ä¼‘æ­¢ãƒ­ãƒƒã‚¯ã‚’é™¤å¤–ï¼ˆç·Šæ€¥ãƒ»è‡¨æ™‚ã¯é™¤å¤–ã•ã‚Œãšæ®‹ã‚‹ï¼‰
  const unlockedEls = candEls.filter(el => !isSlotLockedForEdit(el));

  if (!unlockedEls.length){
    // ä½•ã‹é¸ã°ã‚Œã¦ã¯ã„ã‚‹ãŒã€å…¨éƒ¨ãƒ­ãƒƒã‚¯æ ã ã£ãŸ
    alert('ç¥æ—¥/ä¼‘æ­¢ã®ãŸã‚ç·¨é›†ã§ãã‚‹æ ãŒã‚ã‚Šã¾ã›ã‚“');
    return;
  }

  const keys = unlockedEls.map(el => el.dataset.key);
  openEditor(keys);
});

// === ã“ã“ã‹ã‚‰ï¼šé€±è¡¨ç¤ºã‚¹ãƒ­ãƒƒãƒˆç”¨ã€Œå„ªå…ˆè¡¨ç¤ºã€ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆæ©Ÿèƒ½ ===

// ã‚¹ãƒ­ãƒƒãƒˆå·¦å´ã«è¡¨ç¤ºã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å®šç¾©ï¼ˆå„ªå…ˆåº¦ä»˜ãï¼‰
// priority=1: å¹…ãŒç‹­ãã¦ã‚‚å¿…ãšå‡ºã—ãŸã„
// priority=2: å°‘ã—ä½™è£•ãŒã‚ã‚Œã°è¶³ã™
// priority=3: ã ã„ã¶ä½™è£•ãŒã‚ã‚‹ã¨ãã«è¶³ã™
const SLOT_FIELD_DEFS = [
  // â˜… æœ€é‡è¦
  { key: 'io',    priority: 1 }, // å…¥ / å¤– / å½“
  { key: 'name',  priority: 1 }, // æ°å
  { key: 'pid',   priority: 2 }, // IDï¼ˆ#ãªã—10æ¡ï¼‰
  { key: 'age',   priority: 3 }, // å¹´é½¢ï¼ˆåŠè§’æ•°å­—3æ¡ï¼‰  
  { key: 'eye',   priority: 1 }, // çœ¼ï¼ˆR/L/Bï¼‰
  { key: 'iol',   priority: 1 }, // IOLç¨®é¡ãƒ»åº¦æ•°
  { key: 'proc1', priority: 1 }, // è¡“å¼1ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰
  { key: 'proc2', priority: 1 }, // è¡“å¼2
  { key: 'note',  priority: 1 }, // å‚™è€ƒ
];

// ID è¡¨ç¤ºç”¨ï¼š# ã‚’å‰Šã£ã¦æœ€å¤§10æ¡ã«ãã‚ãˆã‚‹
function formatSlotId(raw){
  if (!raw) return '';
  const s = toHalfWidthNum(String(raw)).replace(/^#/, '');
  return s.slice(0, 10);
}

// ã‚¹ãƒ­ãƒƒãƒˆå¹…(px)ã‹ã‚‰ã€Œã©ã® priority ã¾ã§å‡ºã™ã‹ã€ã‚’æ±ºã‚ã‚‹
function getSlotMaxPriority(width){
  if (!width || width <= 0) return 1;

  // â˜… å°åˆ·ãƒ¢ãƒ¼ãƒ‰ä¸­ã¯ã€å¹…ã«é–¢ä¿‚ãªãã€Œå…¨éƒ¨å‡ºã™ã€
  if (document.body && document.body.classList.contains('printMode')){
    return 3;
  }

  // é€šå¸¸ç”»é¢æ™‚ã®ã—ãã„å€¤
  // ã€œ300pxï¼šæœ€å°é™ï¼ˆpriority 1 ã®ã¿ï¼‰
  // ã€œ520pxï¼špriority 1 & 2ï¼ˆIDã¾ã§ï¼‰
  // 520pxã€œ ï¼špriority 1ã€œ3ï¼ˆå¹´é½¢ãƒ»å‚™è€ƒã¾ã§ï¼‰
  if (width < 400) return 1;
  if (width < 520) return 2;
  return 3;
}


/**
 * ã‚¹ãƒ­ãƒƒãƒˆå·¦å´ã®ã€Œå„ªå…ˆè¡¨ç¤ºã€ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆã™ã‚‹
 *  - data : loadWeek() ã§å¾—ãŸ1ä»¶åˆ†ãƒ‡ãƒ¼ã‚¿
 *  - width: ã“ã®ã‚¹ãƒ­ãƒƒãƒˆã®æ¨ªå¹…(px)
 *
 * è¿”ã‚Šå€¤: ã€Œå…¥ï½œæ°åï½œIDï½œçœ¼ï½œIOLï½œè¡“å¼1ï½œâ€¦ã€ã®ã‚ˆã†ãªã€Œï½œã€åŒºåˆ‡ã‚Šãƒ†ã‚­ã‚¹ãƒˆ
 *   ï¼ˆè¡“è€…ã¯ã“ã“ã«ã¯å«ã‚ãªã„ï¼šå³ç«¯ãƒãƒƒã‚¸ã§è¡¨ç¤ºï¼‰
 */
function buildSlotMainText(data, width){
  if (!data) return '';

  const maxPri = getSlotMaxPriority(width);
  const texts = [];

  for (const def of SLOT_FIELD_DEFS){
    // ä»Šå›ã®å¹…ã§ã¯è¡¨ç¤ºå¯¾è±¡å¤–ã® priority ã¯ã‚¹ã‚­ãƒƒãƒ—
    if (def.priority > maxPri) continue;

    let val = '';

    switch(def.key){
      case 'io':
        val = data.io || '';
        break;

      case 'name':
        val = data.name || '';
        break;

      case 'pid':
        val = formatSlotId(data.pid);
        break;

      case 'eye':
        val = (data.eye || '').trim();
        break;

      case 'iol': {
        val = buildIolInlineText(data);
        break;
      }

      case 'proc1': {
        const p1 = String(data.proc1 || '').trim();
        const p2 = String(data.proc2 || '').trim();
        val = [p1, p2].filter(Boolean).join(' ');
        break;
      }

      case 'proc2':
        // proc1 å´ã«çµ±åˆã™ã‚‹ã®ã§ã“ã“ã§ã¯ä½•ã‚‚è¡¨ç¤ºã—ãªã„
        val = '';
        break;

      case 'note':
        val = data.note ? `â€»${data.note}` : '';
        break;

      // age ã‚’ä½¿ã†å ´åˆï¼š
      // case 'age':
      //   val = data.age ? String(toHalfWidthNum(data.age)) : '';
      //   break;
    }

    if (!val) continue;
    texts.push(val);
  }

  if (!texts.length) return '';

  return texts.join('ï½œ');
}

// å¹…ã«å¿œã˜ã¦ã€Œè¡¨ç¤ºã™ã‚‹é …ç›®ã®é…åˆ—ã€ã‚’è¿”ã™ï¼ˆæ–‡å­—åˆ—ã§ã¯ãªãéƒ¨å“ï¼‰
function buildSlotMainParts(data, width){
  if (!data) return [];

  const maxPri = getSlotMaxPriority(width);
  const parts = [];

  for (const def of SLOT_FIELD_DEFS){
    if (def.priority > maxPri) continue;

    let val = '';

    switch(def.key){
      case 'io':
        val = data.io || '';
        break;

      case 'name':
        val = data.name || '';
        break;

      case 'pid':
        val = formatSlotId(data.pid);
        break;
		
     case 'age':
       // åŠè§’æ•°å­—3æ¡ç›¸å½“ã§è¡¨ç¤ºï¼ˆtoHalfWidthNum ã¯æ—¢å­˜é–¢æ•°ï¼‰
       val = data.age ? String(toHalfWidthNum(data.age)) : '';
       break;
 		

      case 'eye':
        val = (data.eye || '').trim();
        break;

      case 'iol': {
        val = buildIolInlineText(data);
        break;
      }

      case 'proc1':
        val = data.proc1 || '';
        break;

      case 'proc2':
        val = data.proc2 || '';
        break;

      case 'note':
        val = data.note ? `â€»${data.note}` : '';
        break;
    }

    if (!val) continue;

    if (def.key === 'proc2'){
      parts.push({ key: def.key, label: val, deviceOrdered: !!data.deviceOrdered });
    } else {
      parts.push({ key: def.key, label: val });
    }
  }

  return parts;
}

// æ—¢å­˜ã® buildSlotMainText ãŒã‚ã‚Œã°ã€ã“ã†ã—ã¦ãŠãã¨ä»–ã®å ´æ‰€ã§ã‚‚ä½¿ãˆã‚‹
function buildSlotMainText(data, width){
  const parts = buildSlotMainParts(data, width);
  return parts.map(p => p.label).join('ï½œ');
}

// === ã“ã“ã¾ã§ï¼šé€±è¡¨ç¤ºã‚¹ãƒ­ãƒƒãƒˆç”¨ã€Œå„ªå…ˆè¡¨ç¤ºã€ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆæ©Ÿèƒ½ ===



// ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã§ç”»é¢ã®å„ã‚¹ãƒ­ãƒƒãƒˆã‚’å¡—ã‚Šç›´ã™
function paintSlotsFromStore(){
  const st = (typeof loadWeek === 'function') ? loadWeek(currentMonday) : {};
  const em = loadEmerg(currentMonday) || {}; // â† ä»Šé€±ã®ç·Šæ€¥ãƒãƒƒãƒ—ã‚’èª­ã‚€

  // â˜… RLã‚»ãƒƒãƒˆæƒ…å ±ã‚’äº‹å‰ã«é›†è¨ˆï¼ˆrlSetId â†’ headã‚­ãƒ¼é…åˆ—ï¼‰
  const rlSets = {};
  Object.keys(st).forEach(k => {
    const rec = st[k];
    if (!rec || rec.tail) return;                // tail ã¯å¯¾è±¡å¤–ï¼ˆheadã ã‘ç›®å°ã«ã™ã‚‹ï¼‰
    const id = rec.meta && rec.meta.rlSetId;
    if (!id) return;
    if (!rlSets[id]) rlSets[id] = [];
    rlSets[id].push(k);
  });
  // DOMé †ã«è¿‘ã„ä¸¦ã³ã«ãªã‚‹ã‚ˆã†ã€ã‚­ãƒ¼æ–‡å­—åˆ—ã§ã‚½ãƒ¼ãƒˆã—ã¦ãŠã
  Object.values(rlSets).forEach(arr => arr.sort());

  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®è¦ªãƒ•ãƒ©ã‚°ã‚’ä¸€åº¦ãƒªã‚»ãƒƒãƒˆ
  document.querySelectorAll('.day, .slots').forEach(n => n.classList.remove('has-emergency'));

  // å†…å®¹ï¼ˆå·¦ãƒ†ã‚­ã‚¹ãƒˆï¼‹è¡“è€…ã‚¿ã‚°ï¼‰
  document.querySelectorAll('.slot').forEach(el=>{
    const key  = el.dataset.key;
    const data = st[key];
    const left = el.querySelector('.content-left');
    const surg = el.querySelector('.surgeon-tag');

    // --- arrival âœ“ï¼ˆè¡¨ç¤ºã®ã¿ï¼šå¤– + arrivalFixed ã®ã¨ãã ã‘ï¼‰---
    const timeEl = el.querySelector('.time');
    let checkEl = timeEl?.querySelector('.arrival-check');

    if (!checkEl){
      checkEl = document.createElement('span');
      checkEl.className = 'arrival-check';
      checkEl.textContent = 'âœ“';
      checkEl.setAttribute('aria-hidden','true');
      timeEl && timeEl.appendChild(checkEl);
      // âœ“ã‚¯ãƒªãƒƒã‚¯ï¼ˆStep3-â‘¡ï¼šarrivalFixed ã‚’ãƒˆã‚°ãƒ«ï¼‰
      checkEl.addEventListener('click', (e)=>{
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();

        // âœ“ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ä¸­ä»¥å¤–ã¯åå¿œã—ãªã„ï¼ˆå®‰å…¨ï¼‰
        if (!arrivalModeOn) return;

        const key = el?.dataset?.key;
        if (!key) return;

        // â˜… currentMonday ã¯ window ã‚’å„ªå…ˆï¼ˆã‚¹ã‚³ãƒ¼ãƒ—äº‹æ•…ã‚’é˜²ãï¼‰
        const week = (window.currentMonday instanceof Date) ? window.currentMonday : currentMonday;
        const st = loadWeek(week) || {};
        const d2 = st[key];
        if (!d2 || d2.tail) return;

        // ã€Œå¤–ã€ã ã‘è¨±å¯ï¼ˆå…¥/å½“ã¯ä¸å¯ï¼‰
        if ((d2.io || '').trim() !== 'å¤–') return;

        // ãƒˆã‚°ãƒ«
        d2.arrivalFixed = !d2.arrivalFixed;
        st[key] = d2;
        saveWeek(week, st);

        // åæ˜ ï¼ˆæœ€å°ï¼šå†æç”»ï¼‰
        if (typeof paintSlotsFromStore === 'function') paintSlotsFromStore();
      }, true);	  
    }
// ===== arrival âœ“ è¡¨ç¤ºæ¡ä»¶ï¼ˆStep3-â‘¡ï¼‰=====
const isGai = data && !data.tail && ((data.io || '').trim() === 'å¤–');
const isOn  = !!(data && data.arrivalFixed);

 // âœ“ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ä¸­ã‹ã©ã†ã‹ã¯ body ã® class ã§åˆ¤å®šï¼ˆã‚¹ã‚³ãƒ¼ãƒ—äº‹æ•…é˜²æ­¢ï¼‰
 const isMode = document.body.classList.contains('arrivalModeOn');

 // Bæ¡ˆï¼šãƒ¢ãƒ¼ãƒ‰ä¸­ã¯ã€Œå¤–ã€ãªã‚‰å¸¸æ™‚è¡¨ç¤ºï¼ˆOFFã¯è–„ãï¼‰ï¼é€šå¸¸æ™‚ã¯ONã®ã¿è¡¨ç¤º
 const show = isGai && (isMode || isOn);
 checkEl.style.display = show ? '' : 'none';
 checkEl.classList.toggle('is-on',  isOn);
 checkEl.classList.toggle('is-off', !isOn);
// âœ“ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ä¸­ã¯ã€Œå¤–ã€ãªã‚‰å¸¸æ™‚è¡¨ç¤ºï¼ˆOFFã¯è–„ãï¼‰
// é€šå¸¸æ™‚ã¯ ONï¼ˆarrivalFixed=trueï¼‰ã®ã¿è¡¨ç¤º



    // ã„ã£ãŸã‚“åˆæœŸåŒ–
    el.classList.remove('empty','mergeHead','hiddenRow',
                        'rl-set-slot','rl-set-top','rl-set-bottom');
    el.style.gridRowEnd = '';

    // â˜… ç·Šæ€¥ãƒ•ãƒ©ã‚°ã‚’DOMã«åæ˜ ï¼ˆã“ã“ãŒå”¯ä¸€ã®åæ˜ ãƒã‚¤ãƒ³ãƒˆã§OKï¼‰
    const isEm = !!(key && em[key]);
    el.classList.toggle('emergency-slot', isEm);
    if (isEm){
      // :has éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶å‘ã‘ã«è¦ªã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ•ãƒ©ã‚°
      el.closest('.day')?.classList.add('has-emergency');
      el.closest('.slots')?.classList.add('has-emergency');
      el.tabIndex = 0; // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰é¸æŠå¯ï¼ˆä»»æ„ï¼‰
    }
 
     // â˜… æ„ŸæŸ“ç—‡ãƒ•ãƒ©ã‚°ã®åæ˜ ï¼ˆé€±è¡¨ç¤ºï¼‰
     const infValue = data?.infection || '';
     el.classList.remove('infection-slot', 'noninfection-slot');
 
     if (infValue === 'ã‚ã‚Š') {
       el.classList.add('infection-slot');
     } else if (infValue === 'ãªã—') {
       el.classList.add('noninfection-slot');
     }

     // â˜… RLã‚»ãƒƒãƒˆç”¨ã®å·¦ãƒãƒ¼ã‚¯ãƒ©ã‚¹ã‚’ä»˜ä¸
     if (data && data.meta && data.meta.rlSetId) {
       const id = data.meta.rlSetId;
       const arr = rlSets[id];
       if (arr && arr.length > 1) {
         el.classList.add('rl-set-slot');
         const pos = arr.indexOf(key);
         if (pos === 0) {
           el.classList.add('rl-set-top');
         }
         if (pos === arr.length - 1) {
           el.classList.add('rl-set-bottom');
         }
       }
     }

    if (data && !data.tail) {
    // æœ¬ä½“ï¼ˆhead ã‚‚å«ã‚€ï¼‰

    const isMergedHead = !!data.head && Number(data.span || 1) > 1;

    try {
      // â–¼ å¹…ã‚’ä¸€åº¦ã ã‘è¨ˆæ¸¬ï¼ˆå˜æ ãƒ»çµåˆæ ã©ã¡ã‚‰ã§ã‚‚å…±é€šï¼‰
      let width = 0;
      const contentWrap = el.querySelector('.content');
      if (contentWrap) {
        const rect = contentWrap.getBoundingClientRect();
        width = (rect && rect.width) || 0;
      }
      const safeWidth = width || 9999;

      if (typeof buildSlotMainParts === 'function') {
        // â˜… å˜æ ã¨åŒã˜å„ªå…ˆè¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ã§ parts ã‚’ä½œã‚‹
        let parts = buildSlotMainParts(data, safeWidth);

        // â˜… çµåˆæ (head)ã®ã¨ãã ã‘ï¼šå‚™è€ƒã‚’ã€ŒãŠã¾ã‘ã€ã§å¿…ãšæœ«å°¾ã«è¿½åŠ 
        if (isMergedHead && data.note) {
          const hasNote = parts.some(p => p.key === 'note');
          if (!hasNote) {
            parts = parts.concat({ key:'note', label:'â€»' + data.note });
          }
        }

        renderSlotColumns(left, parts);

      } else if (typeof fmtContent === 'function') {
        left.innerHTML = fmtContent(data);
      } else {
        const fallbackText = [
          data.io, data.name, data.pid, data.age, data.eye,
          data.iolType, data.iolPower,
          data.note
        ].filter(Boolean).join('ï½œ');
        const fallbackParts = fallbackText.split('ï½œ').map((v,i)=>({ key:'col'+i, label:v }));
        renderSlotColumns(left, fallbackParts);
      }
    } catch (e) {
      // ä½•ã‹ã‚ã£ã¦ã‚‚æ—§ä»•æ§˜ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      if (typeof fmtContent === 'function') {
        left.innerHTML = fmtContent(data);
      } else {
        left.textContent = [
          data.io, data.name, data.pid, data.age, data.eye,
          data.iolType, data.iolPower,
          data.proc1, data.proc2,
          data.note
        ].filter(Boolean).join(' / ');
      }
    }

  surg.textContent = data.surgeon ? String(data.surgeon) : '';
  el.classList.remove('empty');
// ===== arrival âœ“ï¼ˆé€±è¡¨ç¤ºï¼šå¤–ãªã‚‰å¸¸ã«è–„ã„âœ“ã‚’å‡ºã™ / arrivalFixed ã§ONè¡¨ç¤ºï¼‰=====
{
  const isGai = !!(data && !data.tail && ((data.io || '').trim() === 'å¤–'));

  const timeEl = el.querySelector('.time');
  if (timeEl) {
    let checkEl = timeEl.querySelector('.arrival-check');

    // è¦ç´ ãŒç„¡ã‘ã‚Œã°ä½œã‚‹ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰å¾Œã‚‚ã“ã“ã§å¿…ãšå¾©å…ƒã•ã‚Œã‚‹ï¼‰
    if (!checkEl) {
      checkEl = document.createElement('span');
      checkEl.className = 'arrival-check';
      checkEl.textContent = 'âœ“';
      checkEl.setAttribute('aria-hidden', 'true');

      // ã€Œ9:30âœ“ã€ã«ã—ãŸã„ã®ã§ time ã®æœ«å°¾ã¸
      timeEl.appendChild(checkEl);

      // ã‚¯ãƒªãƒƒã‚¯ã¯ arrivalModeOn ã®ã¨ãã ã‘ï¼ˆâ€»ã“ã“ã¯æ—¢ã«å®Ÿè£…æ¸ˆã¿ã®ãƒˆã‚°ãƒ«é–¢æ•°ã«åˆã‚ã›ã¦ãã ã•ã„ï¼‰
      checkEl.addEventListener('click', (e) => {
        e.stopPropagation();
        if (!arrivalModeOn) return;          // é€šå¸¸æ™‚ã¯ç„¡åå¿œ
        // toggleArrivalFixedForKey(key);     // â†ã‚ãªãŸã®å®Ÿè£…åã«åˆã‚ã›ã¦å‘¼ã¶
      }, true);
    }

    // è¡¨ç¤ºåˆ¶å¾¡ï¼šå¤–ãªã‚‰å¸¸ã«è¡¨ç¤ºï¼ˆè–„ã„âœ“ï¼‰ã€ãã‚Œä»¥å¤–ã¯éš ã™
    checkEl.style.display = isGai ? '' : 'none';

    // ON/OFF è¦‹ãŸç›®ï¼ˆarrivalFixed=true ã§æ¿ƒãã™ã‚‹ï¼‰
    const isOn = !!(data && data.arrivalFixed);
    checkEl.classList.toggle('on', isOn);
    checkEl.classList.toggle('off', !isOn);
  }
}

// ===== ãƒ‘ã‚¹ï¼ˆå…¥ï¼å½“ï¼šå³ç«¯ãƒãƒ¼ã‚¯ï¼‰=====
{
  const isInpatient = !!(data && !data.tail && ((data.io || '').trim() === 'å…¥' || (data.io || '').trim() === 'å½“'));
  const timeEl = el.querySelector('.time');
  if (timeEl){
    let pEl = timeEl.querySelector('.path-check');
    if (!pEl){
      pEl = document.createElement('span');
      pEl.className = 'path-check';
      pEl.textContent = 'â—';
      pEl.setAttribute('aria-hidden','true');
      timeEl.appendChild(pEl);   // ã€Œ9:30â—ã€ã«ã—ãŸã„ã®ã§æœ«å°¾ã¸
    }

    if (isInpatient){
      pEl.style.display = '';
      // pathDone=true ãªã‚‰ ONã€æœªè¨­å®š/false ãªã‚‰ OFFï¼ˆ= is-offï¼‰
      if (data.pathDone) pEl.classList.remove('is-off');
      else              pEl.classList.add('is-off');
    } else {
      // å¤–æ¥ã¯å®Œå…¨éè¡¨ç¤ºï¼ˆarrivalâœ“å´ãŒå¤–ã ã‘å‡ºã‚‹è¨­è¨ˆãªã®ã§è¡çªã—ãªã„ï¼‰
      pEl.style.display = 'none';
    }
  }
}


  // â–¼â–¼ çµåˆãƒãƒƒã‚¸ã®è¡¨ç¤ºå†…å®¹ã‚’ã€Œâ—¯â—¯åˆ†ã€ã«ã™ã‚‹ â–¼â–¼
  // å¯¾è±¡ï¼šçµåˆheadï¼ˆspan>1ï¼‰ã€‚æ‰€è¦æ™‚é–“ãŒã‚ã‚Œã°ãã‚Œã‚’å„ªå…ˆã€ãªã‘ã‚Œã° spanÃ—20åˆ†
  (function(){
    const span = Number(data.span || 1);
    if (span <= 1) return; // å˜æ ã¯å¾“æ¥é€šã‚Šãƒãƒƒã‚¸ãªã—
    const durNum = Number(data.duration || 0);
    const displayMin = (Number.isFinite(durNum) && durNum > 0) ? durNum : (span * 20);
    // æ—¢å­˜ã®çµåˆãƒãƒƒã‚¸å€™è£œã‚’æ¢ã™ï¼ˆç’°å¢ƒå·®åˆ†ã«å¯¾å¿œï¼‰
    const badge = el.querySelector('.merge-badge, .span-badge, .mergeSpan-badge, .badge-merge');
    if (badge) {
      badge.textContent = `${displayMin}åˆ†`;      // è¡¨ç¤ºã‚’ã€Œâ—‹â—‹åˆ†ã€ã«
      badge.setAttribute('aria-label', `${displayMin}åˆ†`);
      badge.title = `${displayMin}åˆ†`;
    }
  })();
  // â–²â–² ã“ã“ã¾ã§ â–¼â–¼
 
      // â–¼â–¼ æ„ŸæŸ“ç—‡ãƒãƒƒã‚¸ï¼ˆã™ã¹ã¦ã®ã€Œæ„ŸæŸ“ã‚ã‚Šã€ã‚¹ãƒ­ãƒƒãƒˆï¼‰ ï¼šå‚™è€ƒåˆ—ã®å…ˆé ­ã«è¡¨ç¤º â–¼â–¼
      // æ—¢å­˜ã®æ„ŸæŸ“ç—‡ãƒãƒƒã‚¸ã‚’ä¸€æ—¦å‰Šé™¤
      el.querySelectorAll('.infection-badge')?.forEach(n => n.remove());

      const isInf = data.infection === 'ã‚ã‚Š';

      if (isInf) {
        // rAFã§ä»–è¦ç´ ï¼ˆæœ¬æ–‡ãƒ»å‚™è€ƒï¼‰ã®æç”»å®Œäº†ã‚’å¾…ã£ã¦ã‹ã‚‰å·®ã—è¾¼ã‚€
        requestAnimationFrame(() => {
          if (!document.body.contains(el)) return;

          const badge = document.createElement('span');
          badge.className = 'infection-badge';
          badge.textContent = 'æ„ŸæŸ“'; // 2æ–‡å­—

          // 1) å‚™è€ƒåˆ—ï¼ˆslot-col-noteï¼‰ãŒã‚ã‚Œã°ã€ãã®å…ˆé ­ã«ãƒãƒƒã‚¸ã‚’å…¥ã‚Œã‚‹
          const noteCol = el.querySelector('.slot-col-note');
          if (noteCol) {
            // ã‚³ãƒ¡ãƒ³ãƒˆã®ã€Œæœ«å°¾ã€ã«ãƒãƒƒã‚¸ã‚’ä»˜ã‘ã‚‹
            // å…ˆã«ã‚¹ãƒšãƒ¼ã‚¹ â†’ ãã®ã‚ã¨ãƒãƒƒã‚¸ã‚’è¿½åŠ 
            noteCol.insertAdjacentText('beforeend', ' ');
            noteCol.insertAdjacentElement('beforeend', badge);
            return;
          }

          // 2) å‚™è€ƒåˆ—ãŒãªã„å ´åˆï¼šcontent-left ã®æœ«å°¾ã«ç°¡æ˜“ note åˆ—ã‚’ä½œã£ã¦ãã“ã«å…¥ã‚Œã‚‹
          const left = el.querySelector('.content-left');
          if (left) {
            const wrapper = document.createElement('span');
            wrapper.className = 'slot-col-note';
            wrapper.appendChild(badge);
            left.appendChild(wrapper);
            return;
          }

          // 3) ãã‚Œã‚‚ç„¡ã‘ã‚Œã°æœ€å¾Œã®ä¿é™ºã¨ã—ã¦ time ã®æœ«å°¾ã«ä»˜ã‘ã‚‹
          (el.querySelector('.time') || el).appendChild(badge);
        });
      }
      // â–²â–² ã“ã“ã¾ã§æ„ŸæŸ“ç—‡ãƒãƒƒã‚¸ â–²â–²

    } else if (data && data.tail) {
      // tail è¡Œã¯ã‚ã¨ã§ã¾ã¨ã‚ã¦éè¡¨ç¤ºã«ã™ã‚‹
      left.textContent = 'ï¼ˆç©ºï¼‰';
      surg.textContent = '';
      el.classList.add('empty');

    } else {
      left.textContent = 'ï¼ˆç©ºï¼‰';
      surg.textContent = '';
      el.classList.add('empty');
    }
  });

   // çµåˆè¡¨ç¤ºï¼‹ãƒãƒƒã‚¸ï¼ˆåˆå›æç”»ã‚‚å«ã‚å¸¸ã« applyMerges() ã«çµ±ä¸€ï¼‰
   document.querySelectorAll('.slots').forEach(container=>{
     applyMerges(container, st);
   });
}

// ã€Œé …ç›®ã”ã¨ã®éƒ¨å“é…åˆ—ã€ã‹ã‚‰åˆ—ä»˜ã DOM ã‚’çµ„ã¿ç«‹ã¦ã‚‹
// parts: [{ key:'io', label:'å…¥' }, ...]
function renderSlotColumns(leftEl, parts){
  if (!leftEl) return;
  const items = parts || [];
  if (!items.length){
    leftEl.textContent = 'ï¼ˆç©ºï¼‰';
    return;
  }

  leftEl.textContent = '';

  items.forEach((part, idx) => {
    const key = part.key;
    const label = String(part.label ?? '').trim();
    if (!label) return;

    const prev = items[idx - 1];
    // 2å€‹ç›®ä»¥é™ã®å‰ã«ã€Œï½œã€ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆãŸã ã— proc1 â†’ proc2 ã®é–“ã¯é™¤ãï¼‰
    if (idx > 0){
      const prevKey = prev?.key;
      if (!(prevKey === 'proc1' && key === 'proc2')){
        const sep = document.createElement('span');
        sep.className = 'slot-sep';
        sep.textContent = 'ï½œ';
        leftEl.appendChild(sep);
      }
    }

    const col = document.createElement('span');
    col.className = 'slot-col slot-col-' + key;  // â˜… ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆï¼šã€Œé …ç›®åãƒ™ãƒ¼ã‚¹ã€

    // çœ¼ã ã‘ eye-mark ã§å¼·èª¿
    if (key === 'eye' && (label === 'R' || label === 'L' || label === 'B')){
      const eye = document.createElement('span');
      eye.className = 'eye-mark';
      eye.textContent = label;
      col.appendChild(eye);
    }
    // è¡“å¼2ï¼ˆãƒ‡ãƒã‚¤ã‚¹ç³»ï¼‰ã¯ãƒãƒƒã‚¸è¡¨ç¤º
    else if (key === 'proc2') {
      const badge = document.createElement('span');
      badge.className = 'proc2-badge';
      badge.textContent = label;

      // â˜… device dotï¼ˆproc2 å³ä¸‹ï¼‰
      const dot = document.createElement('span');
      const ordered = !!part.deviceOrdered;
      dot.className = 'device-dot' + (ordered ? '' : ' is-off');
      badge.appendChild(dot);
	  
      col.appendChild(badge);
    }
    // ãã‚Œä»¥å¤–ã¯é€šå¸¸ãƒ†ã‚­ã‚¹ãƒˆ
    else if (key === 'iol') {
      // IOL ã ã‘ã¯ span(.iol-use) ã‚’å«ã‚€ HTML ã‚’ãã®ã¾ã¾è§£é‡ˆã•ã›ã‚‹
      col.innerHTML = label;
    } else {
      col.textContent = label;
    }

    leftEl.appendChild(col);
  });
}


/* ======================  æ—§ç‰ˆâ†’æ–°ã‚³ãƒ¼ãƒ‰ æ‹¡å¼µå±¤  ====================== */

/** é€±ãƒ‡ãƒ¼ã‚¿ï¼ˆæ‰‹è¡“æ ï¼‰ã‚¹ãƒˆã‚¢ï¼šschedule_<week> */
function loadWeek(date){ try{ const k='schedule_'+weekKey(date); return JSON.parse(localStorage.getItem(k))||{}; }catch(_){ return {}; } }
function saveWeek(date,data){
  const k = 'schedule_' + weekKey(date);
  localStorage.setItem(k, JSON.stringify(data || {}));
}


/** Undo ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼†å¾©å…ƒã« schedule ã‚’çµ±åˆ */
const __snapshotState = snapshotState;
snapshotState = function(){
  const base = __snapshotState();
  base.schedule = loadWeek(currentMonday);
  return base;
};
const __restoreState = restoreState;
restoreState = function(snap){
  __restoreState(snap);
  if (snap && snap.schedule){
    localStorage.setItem('schedule_'+weekKey(currentMonday), JSON.stringify(snap.schedule||{}));
  }
};

/** å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
function parseKey(key){ const [d,day,section,idx] = key.split('|'); return {d,day,section:Number(section),idx:Number(idx)}; }
function slotKey(meta){ return `${meta.d}|${meta.day}|${meta.section}|${meta.idx}`; }

// ===== ãƒ•ã‚§ãƒ¼ã‚º1-â‘¢ï¼šå½“æ—¥å…¥é™¢ï¼ˆå½“ï¼‰ é…ç½®ãƒã‚§ãƒƒã‚¯ =====
function __isWeekendDayKey(dayKey){
  return dayKey === 'Weekend' || dayKey === 'Sat' || dayKey === 'Sun';
}
function __getSectionPeriod(dayKey, sectionIdx){
  try{
    const sec = CONFIG?.[dayKey]?.[sectionIdx];
    const title = String(sec?.title || '');
    if (title.includes('åˆå‰')) return 'AM';
    if (title.includes('åˆå¾Œ')) return 'PM';
  }catch(_){}
  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå°†æ¥æ‹¡å¼µã«å¼·ãã™ã‚‹ï¼‰
  if (Number(sectionIdx) === 0) return 'AM';
  return 'PM';
}
function __warnIfTouInMorning(dayKey, sectionIdx){
  if (__isWeekendDayKey(dayKey)) return true;     // é€±æœ«ã¯è­¦å‘Šã—ãªã„æ–¹é‡
  const period = __getSectionPeriod(dayKey, sectionIdx);
  if (period !== 'AM') return true;
  return window.confirm('ã€æ³¨æ„ã€‘åˆå‰æ ã«ã€Œå½“ã€ï¼ˆå½“æ—¥å…¥é™¢ï¼‰ã‚’å…¥ã‚Œã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚\né€šå¸¸ã¯åˆå‰å…¥é™¢â†’åˆå¾Œæ‰‹è¡“ã‚’æƒ³å®šã—ã¾ã™ã€‚\nã“ã®ã¾ã¾ä¿å­˜/ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ');
}


// ã€Œå½“ã€ã‚’ã“ã®destKeyã«ç½®ã„ã¦ã‚ˆã„ã‹ï¼ˆé€±æœ«ã¯å¸¸ã«OKã€åˆå‰ãªã‚‰confirmï¼‰
function __allowTouPlacementForKey(destKey, dataObj){
  try{
    if (!dataObj) return true;
    if ((dataObj.io || '').trim() !== 'å½“') return true;
    const p = parseKey(destKey);
    if (!p) return true;
    return __warnIfTouInMorning(p.day, p.section);
  }catch(_e){
    return true; // å¤±æ•—æ™‚ã¯é‹ç”¨åœæ­¢ã«ãªã‚‰ãªã„ã‚ˆã†é€šã™
  }
}
function deepClone(o){ return JSON.parse(JSON.stringify(o)); }
function toHalfWidthNum(str){ if(str==null) return ""; return String(str).replace(/[ï¼-ï½]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)); }
function normalizeDiopter(s){ if(!s) return ''; const v = Number(String(s).replace(',', '.')); return isFinite(v) ? v.toFixed(1) : s; }
function normalizePatientFields(obj){
  if(!obj) return obj;
  const o = {...obj};
  if(o.pid != null) o.pid = toHalfWidthNum(o.pid).trim();
  if(o.age != null) o.age = toHalfWidthNum(o.age).trim();
  return o;
}

/** ---- å°åˆ·ãƒ•ã‚£ãƒ«ã‚¿ç”¨ï¼šä»˜ã‘å¤–ã—ç°¡æ˜“ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---- */
const __PRINT_HIDDEN = new Set();
function __hideForPrint(el){ if(!el) return; el.classList.add('hide-on-print'); __PRINT_HIDDEN.add(el); }
function __clearPrintHides(){ __PRINT_HIDDEN.forEach(el=>el.classList.remove('hide-on-print')); __PRINT_HIDDEN.clear(); }

/**
 * æŒ‡å®šã®1æ—¥ã®ãƒ©ãƒƒãƒ—ï¼ˆbuildDayãŒè¿”ã™ wrapï¼‰ã§ã€æ®‹ã—ãŸã„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã ã‘ã‚’å°åˆ·ã™ã‚‹ã€‚
 * keepIdxes ã¯ [0]ï¼ˆåˆå‰ï¼‰/ [1]ï¼ˆåˆå¾Œ1ï¼‰/ [2]ï¼ˆåˆå¾Œ8ï¼‰/ [0,1]ï¼ˆåˆå‰+åˆå¾Œ1ï¼‰ãªã©ã€‚
 */
function printDayKeepSections(dayWrap, keepIdxes){
  // ä»–ã®æ›œæ—¥ã¯å…¨éƒ¨éš ã™
  document.querySelectorAll('.day').forEach(d => { if(d !== dayWrap) __hideForPrint(d); });
  // ãƒ˜ãƒƒãƒ€ãƒ¼ä»¥å¤–ã®UIã‚‚éš ã™ï¼ˆtopbarç­‰ï¼‰
  __hideForPrint(document.querySelector('.topbar'));

  // dayWrap å†…ã® .section-title ã¨ ç›´å¾Œã® .slots ã‚’ãƒšã‚¢å–ã‚Š
  const kids = Array.from(dayWrap.children);
  const pairs = [];
  for (let i=0; i<kids.length; i++){
    if (kids[i].classList?.contains('section-title')){
      const t = kids[i];
      const s = kids[i+1] && kids[i+1].classList?.contains('slots') ? kids[i+1] : null;
      if (s) pairs.push([t,s]);
    }
  }
  // ä¸è¦ãªã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éš ã™
  pairs.forEach((pair, idx) => {
    if (!keepIdxes.includes(idx)) {
      __hideForPrint(pair[0]);
      __hideForPrint(pair[1]);
    }
  });

  // å°åˆ· â†’ å¾Œå§‹æœ«
  try { window.print(); }
  finally { __clearPrintHides(); }
}

// --- é¸æŠå°åˆ·ç”¨ï¼šä¸€æ™‚ã‚³ãƒ³ãƒ†ãƒŠ ---
function ensurePrintSandbox(){
  let box = document.getElementById('printSandbox');
  if(!box){
    box = document.createElement('div');
    box.id = 'printSandbox';
    // ç”»é¢ã§ã¯éè¡¨ç¤ºï¼ˆå°åˆ·æ™‚ã ã‘è¡¨ç¤ºï¼‰
    box.style.display = 'none';
    document.body.appendChild(box);
  }
  box.innerHTML = '';
  return box;
}
function clearPrintSandbox(){
  const box = document.getElementById('printSandbox');
  if(box) box.innerHTML = '';
}

// å°åˆ·ç”¨ï¼šæ„ŸæŸ“ç—‡ãƒãƒƒã‚¸ã‚’å‚™è€ƒï¼ˆnoteï¼‰ã®æœ«å°¾ã«å·®ã—è¾¼ã‚€
function addInfectionBadgesForPrint(slotsRoot){
  try {
    const store = loadWeek(currentMonday);
    if (!store) return;

    // å¯¾è±¡ã‚¹ãƒ­ãƒƒãƒˆã‚’èµ°æŸ»
    const slots = slotsRoot.querySelectorAll('.slot[data-key]');
    slots.forEach(slot => {
      // æ—¢å­˜ã®æ„ŸæŸ“ãƒãƒƒã‚¸ã¯ä¸€æ—¦å‰Šé™¤ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
      slot.querySelectorAll('.infection-badge').forEach(n => n.remove());

      const key  = slot.dataset.key;
      const rec  = store[key];
      if (!rec) return;
      if (rec.tail) return;                     // tail è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
      if (rec.infection !== 'ã‚ã‚Š') return;     // æ„ŸæŸ“ãƒ•ãƒ©ã‚°ãªã—

      // ãƒãƒƒã‚¸ç”Ÿæˆ
      const badge = document.createElement('span');
      badge.className = 'infection-badge';
      badge.textContent = 'æ„ŸæŸ“';

      // 1) å‚™è€ƒåˆ—ãŒã‚ã‚Œã°ã€ãã®ã€Œæœ«å°¾ã€ã«å…¥ã‚Œã‚‹
      let noteCol = slot.querySelector('.slot-col-note');
      if (noteCol) {
        noteCol.insertAdjacentText('beforeend', ' ');
        noteCol.insertAdjacentElement('beforeend', badge);
        return;
      }

      // 2) å‚™è€ƒåˆ—ãŒãªã„å ´åˆï¼šcontent-left ã®æœ«å°¾ã«ç°¡æ˜“ note åˆ—ã‚’ä½œæˆã—ã¦ãã“ã«å…¥ã‚Œã‚‹
      const left = slot.querySelector('.content-left');
      if (left) {
        noteCol = document.createElement('span');
        noteCol.className = 'slot-col slot-col-note';
        // ã€Œâ€»ã€ã‚’ä»˜ã‘ã¦ãŠãã¨ä»–ã®å‚™è€ƒã¨ä¸¦ã³ãŒè‡ªç„¶
        noteCol.textContent = 'â€»';
        noteCol.insertAdjacentText('beforeend', ' ');
        noteCol.insertAdjacentElement('beforeend', badge);
        left.appendChild(noteCol);
        return;
      }

      // 3) æœ€å¾Œã®ä¿é™ºï¼štime è¡Œã®æœ«å°¾ã«ä»˜ã‘ã‚‹
      (slot.querySelector('.time') || slot).appendChild(badge);
    });
  } catch (e) {
    console.warn('addInfectionBadgesForPrint failed:', e);
  }
}

function printSection(slotsEl){
  if(!slotsEl) return;

  const box = ensurePrintSandbox();

  // ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆæ›œæ—¥ãƒ»æ—¥ä»˜ãƒ»ã‚»ã‚¯ã‚·ãƒ§ãƒ³åï¼‰ã‚’æ‹¾ã£ã¦è¼‰ã›ã‚‹
  const day = slotsEl.closest('.day');
  const titleEl = day?.querySelector('.day-header-date')?.cloneNode(true) || null;
  const sectionTitle = slotsEl.previousElementSibling?.classList?.contains('section-title')
    ? slotsEl.previousElementSibling.cloneNode(true) : null;

  // å°åˆ·ç”¨ã«æ„ŸæŸ“ãƒãƒƒã‚¸ã‚’æ³¨å…¥ï¼ˆå‚™è€ƒæ¬„ã®æœ«å°¾ï¼‰
  addInfectionBadgesForPrint(slotsEl);

  // è¤‡è£½ï¼ˆè¦‹ãŸç›®ã‚’ä¿ã¤ãŸã‚ slots ã‚’ä¸¸ã”ã¨ cloneï¼‰
  const clone = slotsEl.cloneNode(true);


  // ãƒ©ãƒƒãƒ‘ãƒ¼
  const wrap = document.createElement('section');
  wrap.className = 'day'; // æ—¢å­˜ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãã®ã¾ã¾ä½¿ã†ãŸã‚
  const head = document.createElement('div');
  head.className = 'day-header';
  if(titleEl) head.appendChild(titleEl);
  box.appendChild(wrap);
  wrap.appendChild(head);
  if(sectionTitle) wrap.appendChild(sectionTitle);
  wrap.appendChild(clone);

  // å°åˆ·ãƒ•ãƒ©ã‚°ã‚’ä»˜ã‘ã¦å°åˆ·
  document.body.classList.add('printRange');
  try {
    window.print();
  } finally {
    document.body.classList.remove('printRange');
    clearPrintSandbox();
  }
}

function printDayElement(dayEl){
  if (!dayEl) return;
  const days = document.querySelectorAll('#schedule .day');
  days.forEach(d => { if (d !== dayEl) d.classList.add('hide-on-print'); });

  // ã“ã®æ—¥ã®ç·Šæ€¥/è‡¨æ™‚æ ã®æ•°ã«å¿œã˜ã¦åœ§ç¸®ãƒ¬ãƒ™ãƒ«ã‚’æ±ºã‚ã‚‹
  const cnt = dayEl.querySelectorAll('.slot.emergency-slot, .slot.temp-slot').length;
  let level = 0;
  if (cnt >= 1 && cnt <= 2) {
    dayEl.classList.add('print-tight');
    level = 1;
  } else if (cnt >= 3) {
    dayEl.classList.add('print-tighter');
    level = 2;
  }

  try {
    window.print();
  } finally {
    days.forEach(d => d.classList.remove('hide-on-print'));
    if (level === 1) dayEl.classList.remove('print-tight');
    if (level === 2) dayEl.classList.remove('print-tighter');
  }
}


// ã²ã‚‰ãŒãªâ†’ã‚«ã‚¿ã‚«ãƒŠâ†’åŠè§’ã‚«ã‚¿ã‚«ãƒŠ
function toHalfWidthKana(str){
  if (!str) return "";
  // 1) ã²ã‚‰ãŒãª â†’ ã‚«ã‚¿ã‚«ãƒŠ
  str = str.replace(/[\u3041-\u3096]/g, ch =>
    String.fromCharCode(ch.charCodeAt(0) + 0x60)
  );
  // 2) å…¨è§’ã‚«ã‚¿ã‚«ãƒŠ â†’ åŠè§’ã‚«ã‚¿ã‚«ãƒŠï¼ˆä¸»è¦æ–‡å­—ã‚’ç¶²ç¾…ï¼‰
  const map = {
    'ã€‚':'ï½¡','ã€':'ï½¤','ãƒ»':'ï½¥','ã€Œ':'ï½¢','ã€':'ï½£','ãƒ¼':'ï½°','ã‚›':'ï¾','ã‚œ':'ï¾Ÿ',
    'ã‚¡':'ï½§','ã‚¢':'ï½±','ã‚£':'ï½¨','ã‚¤':'ï½²','ã‚¥':'ï½©','ã‚¦':'ï½³','ã‚§':'ï½ª','ã‚¨':'ï½´','ã‚©':'ï½«','ã‚ª':'ï½µ',
    'ã‚«':'ï½¶','ã‚¬':'ï½¶ï¾','ã‚­':'ï½·','ã‚®':'ï½·ï¾','ã‚¯':'ï½¸','ã‚°':'ï½¸ï¾','ã‚±':'ï½¹','ã‚²':'ï½¹ï¾','ã‚³':'ï½º','ã‚´':'ï½ºï¾',
    'ã‚µ':'ï½»','ã‚¶':'ï½»ï¾','ã‚·':'ï½¼','ã‚¸':'ï½¼ï¾','ã‚¹':'ï½½','ã‚º':'ï½½ï¾','ã‚»':'ï½¾','ã‚¼':'ï½¾ï¾','ã‚½':'ï½¿','ã‚¾':'ï½¿ï¾',
    'ã‚¿':'ï¾€','ãƒ€':'ï¾€ï¾','ãƒ':'ï¾','ãƒ‚':'ï¾ï¾','ãƒƒ':'ï½¯','ãƒ„':'ï¾‚','ãƒ…':'ï¾‚ï¾','ãƒ†':'ï¾ƒ','ãƒ‡':'ï¾ƒï¾','ãƒˆ':'ï¾„','ãƒ‰':'ï¾„ï¾',
    'ãƒŠ':'ï¾…','ãƒ‹':'ï¾†','ãƒŒ':'ï¾‡','ãƒ':'ï¾ˆ','ãƒ':'ï¾‰',
    'ãƒ':'ï¾Š','ãƒ':'ï¾Šï¾','ãƒ‘':'ï¾Šï¾Ÿ','ãƒ’':'ï¾‹','ãƒ“':'ï¾‹ï¾','ãƒ”':'ï¾‹ï¾Ÿ','ãƒ•':'ï¾Œ','ãƒ–':'ï¾Œï¾','ãƒ—':'ï¾Œï¾Ÿ','ãƒ˜':'ï¾','ãƒ™':'ï¾ï¾','ãƒš':'ï¾ï¾Ÿ','ãƒ›':'ï¾','ãƒœ':'ï¾ï¾','ãƒ':'ï¾ï¾Ÿ',
    'ãƒ':'ï¾','ãƒŸ':'ï¾','ãƒ ':'ï¾‘','ãƒ¡':'ï¾’','ãƒ¢':'ï¾“',
    'ãƒ£':'ï½¬','ãƒ¤':'ï¾”','ãƒ¥':'ï½­','ãƒ¦':'ï¾•','ãƒ§':'ï½®','ãƒ¨':'ï¾–',
    'ãƒ©':'ï¾—','ãƒª':'ï¾˜','ãƒ«':'ï¾™','ãƒ¬':'ï¾š','ãƒ­':'ï¾›',
    'ãƒ¯':'ï¾œ','ãƒ²':'ï½¦','ãƒ³':'ï¾','ãƒ´':'ï½³ï¾','ãƒµ':'ï½¶','ãƒ¶':'ï½¹'
  };
  return str.replace(/[\u30A1-\u30FA\u30FC\u309B\u309C\u3001\u3002\u30FB\u300C\u300D]/g, ch => map[ch] || ch);
}

function flipEye(v){ if(!v) return v; if(v==='R') return 'L'; if(v==='L') return 'R'; if(v==='å³') return 'å·¦'; if(v==='å·¦') return 'å³'; return v; }

// === IOLâ‘ ã€œâ‘¢ï¼‹ç”¨é€”ã‚’ 1æœ¬ã®æ–‡å­—åˆ—ã«ã¾ã¨ã‚ã‚‹ ===
function buildIolInlineText(d){
  if (!d) return '';

  const list = [];

  const entries = [
    { idx: 1, t: d.iolType,  p: d.iolPower,  u: d.iolUse1 },
    { idx: 2, t: d.iolType2, p: d.iolPower2, u: d.iolUse2 },
    { idx: 3, t: d.iolType3, p: d.iolPower3, u: d.iolUse3 },
  ];

  for (const e of entries){
    const t = (e.t || '').trim();
    let p = (e.p || '').toString().trim();
    const u = (e.u || '').trim();

    // ç¨®é¡ã‚‚åº¦æ•°ã‚‚ç©ºãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
    if (!t && !p) continue;

    // åº¦æ•°ã¯æ•°å€¤ãªã‚‰ 0.1 ã‚¹ãƒ†ãƒƒãƒ—ã«æ•´å½¢
    if (p && !isNaN(Number(p))) {
      p = Number(p).toFixed(1);
    }

    // â˜… ç™ºæ³¨æ¸ˆãƒ•ãƒ©ã‚°ï¼ˆæœªå®šç¾©ãªã‚‰ false æ‰±ã„ï¼‰
    const ordered = !!d[`iolOrdered${e.idx}`];
    const dotHtml = `<span class="iol-dot ${ordered ? '' : 'is-off'}" data-iol-idx="${e.idx}"></span>`;

 let label = `${[t, p].filter(Boolean).join(' ')}`.trim();
 if (u) {
   // ç”¨é€”ãŒã‚ã‚‹å ´åˆã¯ç”¨é€”ã®å¾Œã‚ã«ãƒ‰ãƒƒãƒˆ
   label += ` <span class="iol-use">(${u})</span>` + dotHtml;
 } else {
   // ç”¨é€”ãŒãªã„å ´åˆã¯ä»Šã¾ã§é€šã‚Š
   label += dotHtml;
 }

    list.push(label);
  }

  // ä½•ã‚‚ãªã‘ã‚Œã°ç©º
  if (!list.length) return '';

  // ã€ŒIOL1 â€¦/IOL2 â€¦/IOL3 â€¦ã€ã®å½¢ã§çµåˆ
  return list.join('ãƒ»');
}

/** é€±è¡¨ç¤ºç”¨ï¼šå„ªå…ˆè¡¨ç¤ºï¼‹ã€Œï½œã€åŒºåˆ‡ã‚Šãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆ */
function fmtContent(d){
  if (!d) return '';

  const core = [];      // é‡è¦é …ç›®ï¼ˆå¸¸ã«å„ªå…ˆã—ã¦å…¥ã‚Œã‚‹ï¼‰
  const optional = [];  // æ ã«ä½™è£•ãŒã‚ã‚‹ã¨ãã«è¶³ã—ã¦ã„ãé …ç›®

  // 1) å…¥é™¢/å¤–æ¥/å½“æ—¥
  let ioLabel = d.io || '';
  if (ioLabel) core.push(ioLabel);

  // 2) æ°å
  if (d.name) core.push(d.name);

  // 3) æ‚£è€…IDï¼ˆ#ãªã—10æ¡ï¼‰
  if (d.pid){
    const id = toHalfWidthNum(String(d.pid))
      .replace(/^#/, '')
      .slice(0, 10);
    core.push(id);
  }

  // 4) çœ¼ï¼ˆå³/å·¦/ä¸¡ï¼‰
  if (d.eye){
    core.push(String(d.eye).trim());
  }

  // 5) IOLâ‘ ã€œâ‘¢ï¼‹ç”¨é€”ï¼ˆä»Šå›ã®ä¸»å½¹ï¼‰
  const iolText = buildIolInlineText(d);
  if (iolText){
    core.push(iolText);
  }

  // 6) è¡“å¼1+2ï¼šã¾ã¨ã‚ã¦1ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨ã—ã¦æ‰±ã†
  if (d.proc1 || d.proc2){
    const procLabel = [d.proc1, d.proc2]
      .map(v => String(v || '').trim())
      .filter(Boolean)
      .join(' ');
    if (procLabel) core.push(procLabel);
  }

  // 7) å‚™è€ƒã¯ã€Œæ ã«ä½™è£•ãŒã‚ã‚‹ã¨ãã€ã«è¿½åŠ 
  if (d.note){
    optional.push('â€»' + d.note);
  }

  // --- ã“ã“ã‹ã‚‰ã€Œé•·ã•ã€ã«å¿œã˜ã¦ã©ã“ã¾ã§å…¥ã‚Œã‚‹ã‹æ±ºã‚ã‚‹ ---

  let text = core.join('ï½œ');
  const lenCore = text.length;

  const MAX_NARROW = 24;
  const MAX_MEDIUM = 40;

  if (optional.length === 0){
    return text;
  }

  if (lenCore <= MAX_NARROW){
    text = core.concat(optional).join('ï½œ');
  } else if (lenCore <= MAX_MEDIUM){
    text = core.concat(optional[0]).join('ï½œ');
  }
  // ãã‚Œä»¥ä¸Šé•·ã„ã¨ãã¯ core ã ã‘ï¼ˆï¼ç‹­ã„æ ã¯é‡è¦é …ç›®ã®ã¿ï¼‰

  return text;
}


/** datalistï¼ˆæœ€ä½é™ï¼‰ */
(function ensureDatalists(){
  const powers=[]; for(let v=15.0; v<=30.001; v+=0.5){ powers.push(v.toFixed(1)); }
  const types=["AcrySof IQ","TECNIS","HOYA Vivinex","PanOptix","EDOF"];
  const dlT = document.getElementById('iolTypes'); const dlP = document.getElementById('iolPowers');
  if(dlT && !dlT.children.length) types.forEach(v=>{const o=document.createElement('option');o.value=v;dlT.appendChild(o);});
  if(dlP && !dlP.children.length) powers.forEach(v=>{const o=document.createElement('option');o.value=v;dlP.appendChild(o);});
})();


const multiSelected = new Set();
function clearMultiSelection(){
  multiSelected.forEach(k=>{
    const el = document.querySelector(`.slot[data-key="${k}"]`);
    if(el) el.classList.remove('multiSelected');
  });
  multiSelected.clear();
}
function addMultiSelect(el){
  const k = el?.dataset?.key; if(!k) return;
  if(!multiSelected.has(k)){ multiSelected.add(k); el.classList.add('multiSelected'); }
}
function findRangeSameDay(aEl,bEl){
  const day = aEl.closest('.day');
  if (!day || day !== bEl.closest('.day')) return [];

  // â˜… åŒã˜ .slotsï¼ˆåŒã˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰å†…ã‹ãƒã‚§ãƒƒã‚¯
  const secA = aEl.closest('.slots');
  const secB = bEl.closest('.slots');
  if (!secA || secA !== secB) return [];  // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¾ãŸãç¦æ­¢

  const list = Array.from(secA.querySelectorAll('.slot'));
  const i = list.indexOf(aEl), j = list.indexOf(bEl);
  if (i < 0 || j < 0) return [];
  const [s,e] = i <= j ? [i,j] : [j,i];
  return list.slice(s, e + 1);
}
// === è¤‡æ•°ç©ºæ é¸æŠ â†’ çµåˆæ ç”Ÿæˆï¼ˆCtrl+M ç”¨ï¼‰ ===
function createMergeFromMultiSelection(){
  if (!multiSelected || multiSelected.size < 2){
    alert('çµåˆæ ã‚’ä½œæˆã™ã‚‹ã«ã¯ã€åŒã˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã®ç©ºæ ã‚’2æ ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„ã€‚');
    return;
  }

  // é©å½“ãª1ã¤ã®ã‚­ãƒ¼ã‹ã‚‰ container(.slots) ã‚’ç‰¹å®š
  const anyKey = Array.from(multiSelected)[0];
  const anyEl  = document.querySelector(`.slot[data-key="${CSS.escape(anyKey)}"]`);
  if (!anyEl){
    alert('é¸æŠä¸­ã®æ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
    return;
  }
  const container = anyEl.closest('.slots');
  if (!container){
    alert('çµåˆæ ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒç‰¹å®šã§ãã¾ã›ã‚“ï¼‰ã€‚');
    return;
  }

  const list = Array.from(container.querySelectorAll('.slot'));
  const selKeys = new Set(Array.from(multiSelected));

  // firstIdx / lastIdx ã‚’æ±‚ã‚ã‚‹
  let firstIdx = -1;
  let lastIdx  = -1;
  for (let i = 0; i < list.length; i++){
    const k = list[i].dataset.key;
    if (selKeys.has(k)){
      if (firstIdx === -1) firstIdx = i;
      lastIdx = i;
    }
  }
  if (firstIdx === -1 || lastIdx === -1){
    alert('é¸æŠç¯„å›²ã‚’ç‰¹å®šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
    return;
  }

  // é€”ä¸­ã«ã€Œé¸æŠã•ã‚Œã¦ã„ãªã„ã€æ ãŒæ··ã˜ã£ã¦ã„ãŸã‚‰NGï¼ˆé€£ç¶šã®ã¿å¯¾å¿œï¼‰
  for (let i = firstIdx; i <= lastIdx; i++){
    const k = list[i].dataset.key;
    if (!selKeys.has(k)){
      alert('é€”ä¸­ã«é¸æŠã•ã‚Œã¦ã„ãªã„æ ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚é€£ç¶šã—ãŸç©ºæ ã ã‘ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
      return;
    }
  }

  // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¦ã€Œç©ºæ ã®ã¿ã€ã‹ãƒã‚§ãƒƒã‚¯
  const st = loadWeek(currentMonday);
  for (let i = firstIdx; i <= lastIdx; i++){
    const el = list[i];
    const k  = el.dataset.key;
    const rec = st[k];

    // hiddenRow ã‚„æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã° NG
    if (el.classList.contains('hiddenRow') || (rec && Object.keys(rec).length > 0)){
      alert('ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã£ã¦ã„ã‚‹æ ã€ã¾ãŸã¯çµåˆæ ã®ä¸€éƒ¨ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ç©ºã®æ ã ã‘ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
      return;
    }
  }

  const span = (lastIdx - firstIdx + 1);
  if (span <= 1){
    alert('çµåˆæ ã‚’ä½œæˆã™ã‚‹ã«ã¯ã€2æ ä»¥ä¸Šã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
    return;
  }

  const headEl  = list[firstIdx];
  const headKey = headEl.dataset.key;
  const { day, section } = parseKey(headKey);

  // æ‰€è¦æ™‚é–“ã¯ã€Œ20åˆ†Ã—æ æ•°ã€ã§è‡ªå‹•è¨­å®š
  const durationMinutes = span * 20;

  // === ã“ã“ã‹ã‚‰ Undo ãƒãƒƒãƒï¼ˆçµåˆï¼‹æœ€åˆã®ç·¨é›†ã¾ã§ã¾ã¨ã‚ã‚‹ï¼‰ ===
  let startedHere = false;
  if (!inUndoBatch()){
    beginUndoBatch();
    startedHere = true;
  }

  try {
    // å¯¾è±¡ç¯„å›²ã®æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯ã„ã£ãŸã‚“å…¨ã‚¯ãƒªã‚¢ï¼ˆå¿µã®ãŸã‚ï¼‰
    for (let i = firstIdx; i <= lastIdx; i++){
      const k = list[i].dataset.key;
      delete st[k];
    }

    // head ã‚’ã‚»ãƒƒãƒˆ
    st[headKey] = {
      head: true,
      span: span,
      duration: durationMinutes
    };

    // tail ã‚’ã‚»ãƒƒãƒˆ
    for (let i = firstIdx + 1; i <= lastIdx; i++){
      const k = list[i].dataset.key;
      st[k] = { tail: true, head: headKey };
    }

    // ã“ã® day/section ã®ã‚¢ãƒ³ã‚«ãƒ¼ã‚’ä¸€æ‹¬å†æ§‹ç¯‰
    rebuildDurationAnchorsForDaySection(day, section, st);

    // ä¿å­˜
    saveWeek(currentMonday, st);

    // æç”»ãƒ»ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¾©å¸°ï¼šhead ã‚’åŸºæº–ã«
    reRenderPreservingFocus(headKey);

    // è¤‡æ•°é¸æŠã¯ã‚¯ãƒªã‚¢ã—ã¦ãŠã
    clearMultiSelection();

    // head ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼†ã‚¨ãƒ‡ã‚£ã‚¿èµ·å‹•
    const headElAfter = document.querySelector(`.slot[data-key="${CSS.escape(headKey)}"]`);
    if (headElAfter) {
      setActiveSlot(headElAfter);
      if (typeof openEditor === 'function') {
        openEditor([headKey]);
      }
    }

    // ã“ã“ã§é–‹ã„ãŸãƒãƒƒãƒã¯ã€Œã‚¨ãƒ‡ã‚£ã‚¿ã®ä¿å­˜ã¾ã§ã€ã¾ã¨ã‚ã¦é–‰ã˜ãŸã„ã®ã§ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
    if (startedHere){
      mergeEditBatchOpen = true;
    }

  } finally {
    // ä¸‡ä¸€ä½•ã‹ã®ç†ç”±ã§ãƒ•ãƒ©ã‚°ãŒç«‹ãŸãªã‹ã£ãŸå ´åˆã®ä¿é™ºï¼ˆé€šå¸¸ã¯ã“ã“ã¯é€šã‚‰ãªã„æƒ³å®šï¼‰
    if (startedHere && !mergeEditBatchOpen){
      try { endUndoBatch(); } catch(_){}
    }
  }
}


// ==== è¤‡æ•°é¸æŠ â†’ è«–ç†ãƒ–ãƒ­ãƒƒã‚¯åŒ–ï¼ˆå˜æ  / çµåˆæ ï¼‰ ====
function buildMultiClipboardFromSelection(store){
  if (!multiSelected || multiSelected.size <= 1) return null;

  // .slot.multiSelected ã‚’æ‹¾ã†ï¼ˆåŒä¸€ã‚»ã‚¯ã‚·ãƒ§ãƒ³å‰æï¼‰
  const selectedEls = Array.from(document.querySelectorAll('.slot.multiSelected'));
  if (selectedEls.length <= 1) return null;

  const container = selectedEls[0].closest('.slots');
  if (!container) return null;
  // å¿µã®ãŸã‚ï¼šåŒã˜ .slots ä»¥å¤–ãŒæ··ã˜ã£ã¦ã„ãŸã‚‰ä¸­æ­¢
  if (selectedEls.some(el => el.closest('.slots') !== container)) {
    alert('è¤‡æ•°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã¾ãŸãç¯„å›²ã‚³ãƒ”ãƒ¼ã¯ã§ãã¾ã›ã‚“ã€‚');
    return null;
  }

  const list = Array.from(container.querySelectorAll('.slot'));
  const selectedKeySet = new Set(selectedEls.map(el => el.dataset.key));

  // é€£ç¶šç¯„å›²ã® first / last index ã‚’æ±ºã‚ã‚‹
  let firstIdx = -1, lastIdx = -1;
  for (let i = 0; i < list.length; i++) {
    const k = list[i].dataset.key;
    if (selectedKeySet.has(k)) {
      if (firstIdx === -1) firstIdx = i;
      lastIdx = i;
    }
  }
  if (firstIdx === -1) return null;

  const blocks = [];
  const usedKeys = new Set();

  for (let i = firstIdx; i <= lastIdx;) {
    const el = list[i];
    const key = el.dataset.key;
    const rec = store[key];

    // ç¯„å›²å†…ã«ã€Œéé¸æŠã‚¹ãƒ­ãƒƒãƒˆã€ãŒæ··ã˜ã£ã¦ã„ãŸã‚‰ä¸­æ­¢ï¼ˆç©´ã‚ãã¯ã¾ã éå¯¾å¿œï¼‰
    if (!selectedKeySet.has(key)) {
      alert('é€”ä¸­ã«éé¸æŠã‚¹ãƒ­ãƒƒãƒˆãŒå«ã¾ã‚Œã‚‹è¤‡æ•°ã‚³ãƒ”ãƒ¼ã¯ã¾ã å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚é€£ç¶šã—ãŸç¯„å›²ã ã‘ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
      return null;
    }

    if (!rec) {
      alert('ç©ºã®æ ã‚’å«ã‚€è¤‡æ•°ã‚³ãƒ”ãƒ¼ã«ã¯ã¾ã å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
      return null;
    }

    // tail ã ã‘ã‹ã‚‰å§‹ã¾ã‚‹ â†’ çµåˆæ ã®é€”ä¸­é¸æŠãªã®ã§ä¸­æ­¢
    if (rec.tail) {
      if (!rec.head || !usedKeys.has(rec.head)) {
        alert('çµåˆæ ã®é€”ä¸­ã ã‘ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã™ã€‚çµåˆæ ã¯å…¨ä½“ã‚’å«ã‚ã¦é¸æŠã—ã¦ãã ã•ã„ã€‚');
        return null;
      }
      i++;
      continue;
    }

    // head ã‹ã¤ span>1 â†’ çµåˆæ ãƒ–ãƒ­ãƒƒã‚¯
    if (rec.head && Number(rec.span || 1) > 1) {
      const span = Number(rec.span || 1);

      // â˜… span åˆ†ã ã‘ä¸‹ã« tail ãŒå­˜åœ¨ã™ã‚‹ã‹ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã«åã¾ã‚‹ã‹ï¼‰ã ã‘ã‚’ç¢ºèª
      if (i + span - 1 >= list.length) {
        alert('çµåˆæ ã®æ§‹é€ ãŒä¸æ­£ã§ã™ï¼ˆç¯„å›²å¤–ã«ä¼¸ã³ã¦ã„ã¾ã™ï¼‰ã€‚');
        return null;
      }

      const keys = [];
      for (let j = 0; j < span; j++) {
        const el2 = list[i + j];
        if (!el2) return null;
        const k2 = el2.dataset.key;
        const rec2 = store[k2];

        if (!rec2) {
          alert('çµåˆæ ã®æ§‹é€ ãŒä¸æ­£ã§ã™ï¼ˆé€”ä¸­ã«ç©ºæ ãŒã‚ã‚Šã¾ã™ï¼‰ã€‚');
          return null;
        }

        if (j === 0) {
          // å…ˆé ­è¡Œï¼šé¸æŠã•ã‚Œã¦ã„ã‚‹ & head ã§ã‚ã‚‹ã“ã¨ã‚’ãƒã‚§ãƒƒã‚¯
          if (!selectedKeySet.has(k2) || !rec2.head) {
            alert('çµåˆæ ã®å…ˆé ­ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚çµåˆæ ã¯å…ˆé ­è¡Œã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„ã€‚');
            return null;
          }
        } else {
          // tail è¡Œï¼štail ã§ã‚ã‚Šã€åŒã˜ head ã‚’æŒ‡ã—ã¦ã„ã‚‹ã“ã¨ã ã‘ç¢ºèª
          // ï¼ˆtail è‡ªä½“ãŒ multiSelected ã§ã‚ã‚‹å¿…è¦ã¯ãªã„ï¼‰
          if (!rec2.tail || rec2.head !== key) {
            alert('çµåˆæ ã®é€”ä¸­ã ã‘ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã™ã€‚');
            return null;
          }
        }

        keys.push(k2);
        usedKeys.add(k2);
      }

      blocks.push({
        kind: 'merge',
        span,
        data: deepClone(rec),
        keys
      });
      i += span;
      continue;
    }


    // é€šå¸¸ã®å˜æ 
    blocks.push({
      kind: 'single',
      span: 1,
      data: deepClone(rec),
      keys: [key]
    });
    usedKeys.add(key);
    i++;
  }

  if (blocks.length === 0) return null;

  const { d, day, section } = parseKey(list[firstIdx].dataset.key);
  return { day, section, blocks };
}

function updateMultiRangeOutline(){
  // æ—¢å­˜ã®æ ã‚’å…¨ã¦å‰Šé™¤
  document.querySelectorAll('.multiRangeOutline').forEach(el => el.remove());

  if (!multiSelected || multiSelected.size === 0) return;

  // ç¾åœ¨ multiSelected ãŒä»˜ã„ã¦ã„ã‚‹ã‚¹ãƒ­ãƒƒãƒˆã‚’å–å¾—
  const all = Array.from(document.querySelectorAll('.slot.multiSelected'));
  if (all.length === 0) return;

  // â˜… åŸºæº–ã«ã™ã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ.slotsï¼‰ã‚’æ±ºã‚ã‚‹
  const container = all[0].closest('.slots');
  if (!container) return;

  // â˜… åŒã˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†… ï¼‹ hiddenRow ä»¥å¤–ã ã‘ã‚’å¯¾è±¡ã«ã™ã‚‹
  const targets = all.filter(el =>
    el.closest('.slots') === container &&
    !el.classList.contains('hiddenRow')
  );
 // å˜æ  or 0æ ãªã‚‰å¤–å‘¨æ ã¯ä¸è¦ï¼ˆé’æ ã¯ .slot.focused ã«ä»»ã›ã‚‹ï¼‰
 if (targets.length <= 1) return;

  const crect = container.getBoundingClientRect();
  let top = Infinity;
  let bottom = -Infinity;

  // é¸æŠã‚¹ãƒ­ãƒƒãƒˆç¾¤ã®æœ€ä¸Šéƒ¨ã¨æœ€ä¸‹éƒ¨ï¼ˆhead ã ã‘ï¼‰ã‚’è¨ˆç®—
  for (const s of targets){
    const r = s.getBoundingClientRect();
    const t = r.top    - crect.top;
    const b = r.bottom - crect.top;
    if (t < top)   top    = t;
    if (b > bottom) bottom = b;
  }

  if (!Number.isFinite(top) || !Number.isFinite(bottom) || bottom <= top) return;

  const outline = document.createElement('div');
  outline.className = 'multiRangeOutline';
  outline.style.top = `${top}px`;
  outline.style.height = `${bottom - top}px`;

  container.appendChild(outline);
}


// === ã‚¹ãƒ­ãƒƒãƒˆå…±é€šã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ï¼ˆå˜ä½“ï¼Shiftã§é€£ç¶šç¯„å›²ï¼‰ ===
document.addEventListener('click', (e) => {
  // å…¥åŠ›ä¸­ï¼ˆã‚¨ãƒ‡ã‚£ã‚¿å†…ãªã©ï¼‰ã¯ç„¡è¦–
  if (typeof isTypingContext === 'function' && isTypingContext(e)) return;

  const slot = e.target.closest('.slot');
  if (!slot) return;

  // schedule å¤–ã® .slot ã¯ç„¡è¦–ï¼ˆå¿µã®ãŸã‚ï¼‰
  const sched = document.getElementById('schedule');
  if (!sched || !sched.contains(slot)) return;

  if (typeof isSlotLockedForEdit === 'function' && isSlotLockedForEdit(slot)) return;

  const cur = (typeof getActiveSlot === 'function') ? getActiveSlot() : null;

  if (e.shiftKey && cur) {
    // Shift + ã‚¯ãƒªãƒƒã‚¯ï¼šåŒã˜æ—¥ã®ä¸­ã§ã€Œå‰å›é’æ ã€œä»Šå›ã‚¯ãƒªãƒƒã‚¯ã€ã¾ã§ã‚’é¸æŠ
    clearMultiSelection();
    findRangeSameDay(cur, slot).forEach(addMultiSelect);
  } else {
    // é€šå¸¸ã‚¯ãƒªãƒƒã‚¯ï¼šRLã‚»ãƒƒãƒˆãŒã‚ã‚Œã°
    //   1å›ç›®ã‚¯ãƒªãƒƒã‚¯ â†’ ã‚»ãƒƒãƒˆå¤–å‘¨ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    //   2å›ç›®ã‚¯ãƒªãƒƒã‚¯ â†’ å˜æ ãƒ¢ãƒ¼ãƒ‰ã«ç§»è¡Œï¼ˆã“ã®RLã‚»ãƒƒãƒˆã‚’ãƒ­ãƒƒã‚¯ï¼‰
    let handledRL = false;

    // Ctrl+ã‚¯ãƒªãƒƒã‚¯æ™‚ã¯æ—¢å­˜ã®ãƒãƒ«ãƒé¸æŠãƒ­ã‚¸ãƒƒã‚¯ã«è­²ã‚‹
    const st = (typeof loadWeek === 'function') ? loadWeek(currentMonday) : null;

    // â˜… ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚¹ãƒ­ãƒƒãƒˆãŒå±ã™ã‚‹ RLã‚»ãƒƒãƒˆID ã‚’å…ˆã«ç‰¹å®š
    let clickedRlId = null;
    if (st && typeof findRLSetRangeForSlot === 'function') {
      const info0 = findRLSetRangeForSlot(slot, st);
      if (info0 && info0.keys && info0.keys.length > 1) {
        const base0 = st[info0.baseKey];
        clickedRlId = base0?.meta?.rlSetId || null;
      }
    }

    // â˜… åˆ¥ã®å ´æ‰€ï¼ˆåˆ¥RLã‚»ãƒƒãƒˆ or éRLæ ï¼‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ãƒ­ãƒƒã‚¯è§£é™¤
    if (window.rlSetSingleLocked && clickedRlId !== window.rlSetSingleLocked) {
      window.rlSetSingleLocked = null;
    }

    if (!e.ctrlKey && st && typeof findRLSetRangeForSlot === 'function') {
      const info = findRLSetRangeForSlot(slot, st);
      if (info && info.keys && info.keys.length > 1) {
        const baseRec = st[info.baseKey];
        const rlId = baseRec?.meta?.rlSetId;
        if (rlId) {
          if (window.rlSetSingleLocked === rlId) {
            // â˜… ã“ã®RLã‚»ãƒƒãƒˆã¯å˜æ ãƒ­ãƒƒã‚¯ä¸­ â†’ å¤–å‘¨ã«ã¯æˆ»ã•ãªã„ï¼ˆé€šå¸¸ã‚¯ãƒªãƒƒã‚¯æ‰±ã„ï¼‰
            // handledRL = false ã®ã¾ã¾ fallback ã¸
          } else if (window.currentRLSetId === rlId) {
            // â˜… 2å›ç›®ã‚¯ãƒªãƒƒã‚¯ï¼šå˜æ ãƒ¢ãƒ¼ãƒ‰ã«ç§»è¡Œã—ã€ã“ã®RLã‚»ãƒƒãƒˆã‚’ãƒ­ãƒƒã‚¯
            clearMultiSelection();
            window.currentRLSetId = null;
            window.rlSetSingleLocked = rlId;
            handledRL = true;
          } else {
            // â˜… 1å›ç›®ã‚¯ãƒªãƒƒã‚¯ï¼šRLã‚»ãƒƒãƒˆå…¨ä½“ã‚’ multiSelected ã«ã—ã¦å¤–å‘¨æ è¡¨ç¤º
            clearMultiSelection();
            info.keys.forEach(k => {
              const el2 = document.querySelector(`.slot[data-key="${CSS.escape(k)}"]`);
              if (el2) addMultiSelect(el2);
            });
            window.currentRLSetId = rlId;
            window.rlSetSingleLocked = null; // ã‚»ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰ä¸­ã¯ãƒ­ãƒƒã‚¯OFF
            handledRL = true;
          }
        }
      }
    }

    if (!handledRL) {
      // RLã‚»ãƒƒãƒˆæ‰±ã„ã«ãªã‚‰ãªã„å ´åˆã¯å¾“æ¥é€šã‚Šï¼šãƒãƒ«ãƒé¸æŠã¯ãƒªã‚»ãƒƒãƒˆã®ã¿
      clearMultiSelection();
      window.currentRLSetId = null;
      // rlSetSingleLocked ã¯ã€clickedRlId åˆ¤å®šã§å¿…è¦ã«å¿œã˜ã¦è§£é™¤æ¸ˆã¿
    }
  }


  // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ ï¼ˆé’æ ï¼‰ã®æ›´æ–°
  if (typeof setActiveSlot === 'function') {
    setActiveSlot(slot);

    // â˜… é€±è¡¨ç¤ºã®ã¨ãã¯ã€ã‚¯ãƒªãƒƒã‚¯é¸æŠã§ã‚‚æ¨ªæ–¹å‘ã‚’ä¸­å¤®å¯„ã›ã—ã¦å¤–æ ãŒè¦‹åˆ‡ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹
    if (!document.body.classList.contains('dayFocus')) {
      slot.scrollIntoView({
        block:  'nearest',  // ç¸¦æ–¹å‘ã¯æ—¢å­˜ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ„Ÿã‚’ã‚ã¾ã‚Šå´©ã•ãªã„
        inline: 'center',   // â˜… æ¨ªæ–¹å‘ã¯ä¸­å¤®å¯„ã›ï¼ˆã“ã“ãŒãƒã‚¤ãƒ³ãƒˆï¼‰
        behavior: 'auto'    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—ã§ä¸€ç™ºã‚¹ãƒŠãƒƒãƒ—
      });
    }
  }

  // é€£ç¶šé¸æŠã®å¤–å‘¨æ ã‚’æ›´æ–°
  updateMultiRangeOutline(); 
  // ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ†ã‚­ã‚¹ãƒˆé¸æŠï¼ˆ(ç©º) ãŒé’ãåè»¢ã™ã‚‹ã‚„ã¤ï¼‰ã‚’æ¶ˆã™
  try {
    const sel = window.getSelection && window.getSelection();
    if (sel && sel.removeAllRanges) sel.removeAllRanges();
  } catch (_){}  
}, true); // â† capture ãƒ•ã‚§ãƒ¼ã‚ºã§å‹•ã‹ã™

/* ---------- çµåˆè¡¨ç¤ºï¼ˆhead/tail/spanï¼‰ ---------- */
function applyMerges(container, store){
  const children = Array.from(container.children);
  for(let i=0;i<children.length;i++){
    const el = children[i];
    const data = store[el.dataset.key];

    // ã¾ãšåˆæœŸåŒ–
    el.style.gridRowEnd = '';
    el.classList.remove('mergeHead','hiddenRow');

    // â˜…æ™‚åˆ»ã‚»ãƒ«å†…ã®å¤ã„ãƒãƒƒã‚¸ã¯æƒé™¤ï¼ˆF5ç›´å¾Œã‚„å†æç”»ã®å–ã‚Šã“ã¼ã—é˜²æ­¢ï¼‰
    const timeEl = el.querySelector('.time');
if (timeEl){
      timeEl.querySelectorAll('.merge-badge').forEach(n => n.remove());
      timeEl.querySelectorAll('.ga-badge').forEach(n => n.remove()); // â† è¿½åŠ 
    }
    // tail ã¯è¦‹ãŸç›®ã‚’éš ã™ã ã‘
    if (data && data.tail){
      el.classList.add('hiddenRow');
      continue;
    }

    // head ã‹ã¤ span>1 ã®ã¨ãï¼šç¸¦æ–¹å‘ã¸çµåˆï¼‹ãƒãƒƒã‚¸ã‚’æ™‚åˆ»ã®ä¸‹ã«ç½®ã
    if (data && data.head && Number(data.span) > 1){
      const span = Number(data.span);
      el.style.gridRowEnd = `span ${span}`;
      el.classList.add('mergeHead');

      // â˜…ã“ã“ã‚’ã€ŒleftEl ã«ä»˜ã‘ã‚‹ã€ã®ã§ã¯ãªã timeEl ã«ä»˜ã‘ã‚‹
      if (timeEl){
        const b = document.createElement('span');
        b.className = 'merge-badge';
        // æ‰€è¦æ™‚é–“å„ªå…ˆï¼ˆæœªå…¥åŠ›ãªã‚‰ spanÃ—20 åˆ†ï¼‰
        const dur = Number(data.duration || 0);
        const minutes = (Number.isFinite(dur) && dur > 0) ? dur : (span * 20);
        const label = formatMinutesColon(minutes);
        b.textContent = label;
        b.setAttribute('aria-label', label);
        b.title = label;
        timeEl.appendChild(b);

// â‘¡ å…¨éº» / å±€éº»ãƒãƒƒã‚¸ï¼ˆspan>=3 ã® head ã‚¹ãƒ­ãƒƒãƒˆã« 1 å€‹ã ã‘ï¼‰
(() => {
  // æ—¢å­˜ã®ãƒãƒƒã‚¸ã‚’ä¸€æ—¦ã‚¯ãƒªã‚¢ï¼ˆå†æç”»æ™‚ã®é‡è¤‡é˜²æ­¢ï¼‰
  el.querySelectorAll('.ga-badge, .local-badge').forEach(b => b.remove());

  const spanNum = Number(data.span || 1);
  // head ãŒä»˜ã„ã¦ã„ã‚‹çµåˆæ ï¼ˆ3æ ä»¥ä¸Šï¼‰ã®å…ˆé ­ã ã‘ã‚’å¯¾è±¡ã«ã™ã‚‹
  const isHead = data.head !== false && data.head != null; // head ãŒ true ã®ã‚‚ã®
  const isMergedHead3Plus = spanNum >= 3 && isHead;

  if (!isMergedHead3Plus) return;

  if (data.ga) {
    const g = document.createElement('span');
    g.className = 'ga-badge';
    g.textContent = 'å…¨éº»';
    timeEl.appendChild(g);  // margin-top:auto ã§æœ€ä¸‹æ®µã«æ¥ã‚‹
  } else if (data.local) {
    const l = document.createElement('span');
    l.className = 'local-badge';
    l.textContent = 'å±€éº»';
    timeEl.appendChild(l);  // å…¨éº»ã¨åŒã˜ä½ç½®
  }
})();
	
      }

      // å¾Œç¶šã® â€œè¦‹ãŸç›®â€ è¡Œã¯éš ã™
      for (let k=1; k<span; k++){
        const t = children[i+k];
        if (t) t.classList.add('hiddenRow');
      }
    }
  }
}


window.addEventListener('load', () => {
  try {
    paintSlotsFromStore();
  } catch (e) {
    console && console.warn && console.warn('paintSlotsFromStore error on load', e);
  }
});

/* ---------- schedule ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’ createSlot ã«ãƒ–ãƒªãƒƒã‚¸ ---------- */
const __createSlot = createSlot; // æ—¢å­˜ç”Ÿæˆã‚’æµç”¨
createSlot = function(meta, time){
  const el = __createSlot(meta, time);
  const key = el.dataset.key;


  // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†ï¼ˆæ™‚é–“ã‚»ãƒ«ã¯æ—¢å­˜ dblclick ã§å æœ‰æ¸ˆã¿ãªã®ã§é™¤å¤–ï¼‰
  el.addEventListener('dblclick',(e)=>{
    if(e.target.closest('.time')) return;
  const slotEl = e.currentTarget.closest('.slot');
  if (isSlotLockedForEdit(slotEl)) return;
    openEditor([key]);
  });

  // ç¥æ—¥ãƒ»ä¼‘æ­¢ã§ã‚‚å³ã‚¯ãƒªãƒƒã‚¯ã¯é€šã‚‹ï¼ˆæ–°ã‚³ãƒ¼ãƒ‰CSSãŒè¨±å¯æ¸ˆã¿ï¼‰

  // ã“ã“ã§ schedule ã‚’åŸ‹ã‚è¾¼ã‚€
  const store = loadWeek(currentMonday);
  const d = store[key];
  const leftEl = el.querySelector('.content-left');
  const surgEl = el.querySelector('.surgeon-tag');
  if (d && !d.tail){
    leftEl.innerHTML = fmtContent(d);
    surgEl.textContent = d.surgeon ? String(d.surgeon) : '';
    el.classList.remove('empty');
    if(d.head) el.classList.add('mergeHead');
  }else{
    leftEl.textContent = 'ï¼ˆç©ºï¼‰';
    surgEl.textContent = '';
    el.classList.add('empty');
  }
  if (d && d.ga) {
    el.classList.add('ga-slot');
  }

  return el;
};

/* ---------- render ã‚’ãƒ•ãƒƒã‚¯ï¼šçµåˆã‚¹ãƒ‘ãƒ³åæ˜  ---------- */
const __render = render;
render = function(){
  __render();
  const store = loadWeek(currentMonday);
  // å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ .slots ã«å¯¾ã—ã¦çµåˆè¡¨ç¤ºã‚’é©ç”¨
  document.querySelectorAll('.slots').forEach(sl => applyMerges(sl, store));
};

// ã²ã‚‰ãŒãªâ†’ã‚«ã‚¿ã‚«ãƒŠã€åŠè§’â†’å…¨è§’ï¼ˆé•·éŸ³ãƒ»æ¿ç‚¹ã¯ãã®ã¾ã¾ï¼‰
function toKatakana(input){
  if (!input) return "";
  // åŠè§’ã‚«ãƒŠç­‰ã‚’æ­£è¦åŒ–ã—ã¦ã‹ã‚‰
  let s = input.normalize('NFKC');
  // ã²ã‚‰ãŒãª(U+3041ã€œ3096)ã‚’ã‚«ã‚¿ã‚«ãƒŠ(U+30A1ã€œ30F6)ã¸
  s = s.replace(/[\u3041-\u3096]/g, ch =>
    String.fromCharCode(ch.charCodeAt(0) + 0x60)
  );
  return s;
}

const editor = document.getElementById('editor');
const toggleIolUseBtn = document.getElementById('toggleIolUseRow');

if (editor && toggleIolUseBtn) {
  toggleIolUseBtn.addEventListener('click', () => {
    const on = editor.classList.toggle('showIolDetail');
    toggleIolUseBtn.textContent = on ? 'IOLâ‘¡ãƒ»â‘¢ã‚’éš ã™' : 'IOLâ‘¡ãƒ»â‘¢ã‚’è¡¨ç¤º';
  });
}

/* ---------- ã‚¨ãƒ‡ã‚£ã‚¿ ---------- */
function openEditor(keys){
  const editor = document.getElementById('editor');

  // æ¯å›ã€ŒIOLâ‘ ã®ã¿ãƒ»ç”¨é€”ãªã—ã€ã®çŠ¶æ…‹ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
  editor.classList.remove('showIolDetail');
  const toggleIolUseBtn = document.getElementById('toggleIolUseRow');
  if (toggleIolUseBtn) {
    toggleIolUseBtn.textContent = 'IOLâ‘¡ãƒ»â‘¢ã‚’è¡¨ç¤º';
  }
  
  const f = document.getElementById('editorForm');
  const st = loadWeek(currentMonday);

  const clearBtn   = f.querySelector('button[value="clear"]');
  const cancelBtn  = f.querySelector('button[value="cancel"]');
  const saveBtn    = f.querySelector('button[value="save"]');
 // â–¼ RLã‚»ãƒƒãƒˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹åˆ¶å¾¡ï¼ˆçœ¼ãŒ R ã®ã¨ãã ã‘æœ‰åŠ¹ï¼‰
 const rlSetCheckbox = f.querySelector('input[name="rlSet"]');
 const eyeSelect     = f.eye;

  // â–¼ æ—¢å­˜RLã‚»ãƒƒãƒˆç·¨é›†æ™‚ï¼šRLã‚»ãƒƒãƒˆãƒã‚§ãƒƒã‚¯ã‚’å¼·åˆ¶OFFï¼†ç„¡åŠ¹åŒ–
  (()=>{
    try {
      const firstKey = keys && keys[0];
      if (!firstKey || !rlSetCheckbox) return;

      // ã“ã®é€±ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ RLã‚»ãƒƒãƒˆç¯„å›²ã‚’ã‚­ãƒ¼ã§æ¤œç´¢
      const info =
        (typeof findRLSetRangeForKey === 'function')
          ? findRLSetRangeForKey(firstKey, st)
          : null;

      const isExistingRL =
        info &&
        info.keys &&
        info.keys.length === 2 &&
        (st[info.baseKey]?.meta?.rlSetId);

      if (isExistingRL) {
        // æ—¢å­˜ã®RLãƒšã‚¢ã®ç‰‡å‰²ã‚Œã‚’ç·¨é›†ä¸­ â†’ æ–°è¦RLä½œæˆã¯ã•ã›ãªã„
        rlSetCheckbox.checked  = false;
        rlSetCheckbox.disabled = true;
      } else {
        // æ—¢å­˜RLã§ãªã‘ã‚Œã°ã€ï¼ˆå…ƒã€…ã®ãƒ­ã‚¸ãƒƒã‚¯ã©ãŠã‚Šï¼‰å¾Œç¶šã§ eye ã«å¿œã˜ã¦æœ‰åŠ¹åŒ–
        // ã“ã“ã§ã¯ disable=false ã«ã›ãšã€ä½•ã‚‚ã—ãªã„ã‹ã€å¿…è¦ãªã‚‰åˆæœŸçŠ¶æ…‹ã ã‘æ•´ãˆã‚‹
        rlSetCheckbox.disabled = false;
      }
    } catch(e){
      console.warn('RL checkbox guard failed:', e);
    }
  })();

 function guardRLSetCheckbox(showAlert){
   if (!rlSetCheckbox || !eyeSelect) return;
   const eyeVal = (eyeSelect.value || '').trim();

   // çœ¼ãŒ R ä»¥å¤–ãªã®ã«ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ãŸã‚‰å¼·åˆ¶OFF
   if (rlSetCheckbox.checked && eyeVal !== 'R') {
     if (showAlert) {
       alert('å¯¾çœ¼ã®é€£ç¶šä½œæˆã¯ã€Œçœ¼ï¼šRã€ã®ã¨ãã«ã®ã¿åˆ©ç”¨ã§ãã¾ã™ã€‚\nå…ˆã«ã€Œçœ¼ã€ã‚’ R ã«ã—ã¦ã‹ã‚‰ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
     }
     rlSetCheckbox.checked = false;
   }
 }

 if (rlSetCheckbox && eyeSelect) {
   // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’æ“ä½œã—ãŸã¨ãï¼šR ä»¥å¤–ãªã‚‰ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‡ºã—ã¦OFFã«æˆ»ã™
   rlSetCheckbox.addEventListener('change', () => {
     guardRLSetCheckbox(true);
   });

   // çœ¼ã®é¸æŠã‚’å¤‰ãˆãŸã¨ãï¼šR ä»¥å¤–ã«ãªã£ãŸã‚‰é™ã‹ã«OFFã«ã™ã‚‹ï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆãªã—ï¼‰
   eyeSelect.addEventListener('change', () => {
     guardRLSetCheckbox(false);
   });

   // ã‚¨ãƒ‡ã‚£ã‚¿åˆæœŸè¡¨ç¤ºæ™‚ã«ã‚‚ä¸€åº¦åˆ¤å®šï¼ˆå‰å›çŠ¶æ…‹ãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆã«å‚™ãˆã¦ï¼‰
   guardRLSetCheckbox(false);
 }  
 
 try {
    f.iolType?.setAttribute('list', 'iolTypes');
    f.proc1?.setAttribute('list', 'procList');
    f.proc2?.setAttribute('list', 'procList2');
    f.surgeon?.setAttribute('list', 'surgeonsList');
   applyDatalists();
  } catch (_) {}
  // tail ã‚’é–‹ã„ãŸã‚‰ head ã«å¯„ã›ã‚‹
  let firstKey = keys[0];
  const d0 = st[firstKey];
  if(d0 && d0.tail && d0.head){ firstKey = d0.head; }
  const first = st[firstKey] || {};
  const isHead = !!first.head;

  document.getElementById('editorTitle').textContent =
    keys.length>1 ? `é¸æŠæ ã®ä¸€æ‹¬ç·¨é›†ï¼ˆ${keys.length}ä»¶ï¼‰` :
    (isHead ? `çµåˆæ ã®ç·¨é›†ï¼ˆ${first.span||1}æ ï¼‰` : 'æ ã®ç·¨é›†');

  // æ—¢å­˜å€¤ã‚’åæ˜ 
  f.name.value = first.name || '';
  f.pid.value  = first.pid  || '';
  f.age.value  = first.age  || '';
  f.eye.value  = first.eye  || '';
  f.io.value   = first.io   || '';

  // IOLâ‘ ã€œâ‘¢ ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ 
  f.iolType.value  = first.iolType  || '';
  f.iolPower.value = first.iolPower || '';
  if (f.iolUse1)  f.iolUse1.value  = first.iolUse1  || '';

  if (f.iolType2)  f.iolType2.value  = first.iolType2  || '';
  if (f.iolPower2) f.iolPower2.value = first.iolPower2 || '';
  if (f.iolUse2)   f.iolUse2.value   = first.iolUse2   || '';

  if (f.iolType3)  f.iolType3.value  = first.iolType3  || '';
  if (f.iolPower3) f.iolPower3.value = first.iolPower3 || '';
  if (f.iolUse3)   f.iolUse3.value   = first.iolUse3   || '';

  f.proc1.value = first.proc1 || '';
  f.proc2.value = first.proc2 || '';

  // â˜… IOLâ‘¡ãƒ»â‘¢ã«ä½•ã‹å…¥ã£ã¦ã„ãŸã‚‰è‡ªå‹•ã§å±•é–‹
  (function(){
    const btn = document.getElementById('toggleIolDetail');
    const hasDetail =
      (f.iolType2  && f.iolType2.value.trim())  ||
      (f.iolPower2 && f.iolPower2.value.trim()) ||
      (f.iolUse1   && f.iolUse1.value.trim())   ||
      (f.iolUse2   && f.iolUse2.value.trim())   ||
      (f.iolType3  && f.iolType3.value.trim())  ||
      (f.iolPower3 && f.iolPower3.value.trim()) ||
      (f.iolUse3   && f.iolUse3.value.trim());

    if (hasDetail) {
      editor.classList.add('showIolDetail');
      if (btn) btn.textContent = 'IOLâ‘¡ãƒ»â‘¢ã‚’éš ã™';
    } else {
      editor.classList.remove('showIolDetail');
      if (btn) btn.textContent = 'IOLâ‘¡ãƒ»â‘¢ã‚’è¡¨ç¤º';
    }
  })();

   // è¡“è€…ï¼šå€™è£œã«ã‚ã‚Œã° selectã€ãªã‘ã‚Œã°ãƒ•ãƒªãƒ¼æ¬„ã¸
   (function(){
     const surgeonName = first.surgeon || '';
     const sel  = f.surgeon;
     const free = f.surgeonFree;
     if (!sel && !free) return;
     if (!surgeonName) {
       if (sel)  sel.value  = '';
       if (free) free.value = '';
       return;
     }
     let matched = false;
     if (sel) {
       for (let i = 0; i < sel.options.length; i++) {
         if (sel.options[i].value === surgeonName) {
           sel.value = surgeonName;
           matched = true;
           break;
         }
       }
     }
     if (matched) {
       if (free) free.value = '';
     } else {
       if (sel)  sel.value  = '';
       if (free) free.value = surgeonName;
     }
   })();
   f.note.value  = first.note || '';
   // æ‰€è¦æ™‚é–“ï¼ˆä¿å­˜å€¤: åˆ†ï¼‰â†’ æ™‚é–“/åˆ†ã®2å…¥åŠ›ã«åˆ†é…ï¼ˆå…¨è§’æ•°å­—ã¯JSä¿å­˜å´ã§å¸åï¼‰
   if (f.durationH && f.durationM) {
     const dmin = Number(first.duration || 0);
     const hh = Math.floor(dmin / 60);
     const mm = dmin % 60;
     f.durationH.value = dmin > 0 ? String(hh) : '';
     f.durationM.value = dmin > 0 ? String(mm) : '';
   }
   // â˜… çµåˆæ æ•°ã®åˆæœŸå€¤
   const initSpan =
     isHead
       ? (first.span || 1)   // æ—¢å­˜ã®çµåˆæ  â†’ ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ span
       : 1;                  // é€šå¸¸ã¯ 1 æ ã‚¹ã‚¿ãƒ¼ãƒˆ
 
   f.mergeSpan.value = initSpan;
   // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¯ã€Œè¡¨ç¤ºä¸Šã®çŠ¶æ…‹ã€ã ã‘åˆã‚ã›ã¦ãŠãï¼ˆå®Ÿéš›ã®åˆ¤å®šã«ã¯ä½¿ã‚ãªã„ï¼‰
   if (f.mergeSlots) {
     f.mergeSlots.checked = initSpan > 1;
   }

   f.ga.checked = !!first.ga;
   if (f.local) {
     f.local.checked = !!first.local;   // â˜… å±€éº»ã®åˆæœŸå€¤åæ˜ 
   }

// æ„ŸæŸ“ç—‡ãƒ•ãƒ©ã‚°ï¼ˆãªã—ãƒ»ã‚ã‚Šãƒ»æœªé¸æŠï¼‰
// â†’ first.infection ãŒ 'ãªã—' ã‹ 'ã‚ã‚Š' ãªã‚‰ãã®å€¤
// â†’ ãã‚Œä»¥å¤–ï¼ˆç©º/undefined/nullï¼‰ã¯ "æœªé¸æŠ"ï¼ˆvalue=""ï¼‰ã«ã™ã‚‹
(function(){
  const radios = f.querySelectorAll('input[name="infection"]');
  const inf = (first.infection === 'ã‚ã‚Š' || first.infection === 'ãªã—')
                ? first.infection
                : '';   // â† æœªé¸æŠæ‰±ã„

  radios.forEach(r => {
    r.checked = (r.value === inf);
  });
})();
// â–¼ æ°åå…¥åŠ›æ¬„ã«IMEã‚«ã‚¿ã‚«ãƒŠãƒ¢ãƒ¼ãƒ‰ã‚’æŒ‡ç¤º
(function(){
  const nameInput = f.name;
  if (nameInput) {
    nameInput.style.imeMode = 'active';
    nameInput.setAttribute('inputmode','katakana');
  }
})();

  editor.returnValue='';
// â–¼ æ°åæ¬„ï¼šIMEç¢ºå®šå¾Œ or éå¤‰æ›å…¥åŠ›ã®ã¨ãã«å³ã‚«ã‚¿ã‚«ãƒŠåŒ–ã™ã‚‹
(function(){
  const nameInput = f.name;
  if (!nameInput) return;

  // å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã®ãƒ’ãƒ³ãƒˆï¼ˆåŠ¹ã‹ãªã„ç’°å¢ƒã‚‚å¤šã„ï¼‰
  nameInput.style.imeMode = 'active';
  nameInput.setAttribute('inputmode', 'katakana');

  let composing = false;

  nameInput.addEventListener('compositionstart', () => { composing = true; });
  nameInput.addEventListener('compositionend', () => {
    composing = false;
    // IMEç¢ºå®šç›´å¾Œã«å¤‰æ›
    const pos = nameInput.selectionStart;
    nameInput.value = toKatakana(nameInput.value);
    // ä½ç½®ã¯åŸºæœ¬åŒé•·ãªã®ã§è»½ãå¾©å…ƒ
    try { nameInput.setSelectionRange(pos, pos); } catch(_) {}
  });

  nameInput.addEventListener('input', () => {
    if (composing) return; // å¤‰æ›ä¸­ã¯è§¦ã‚‰ãªã„
    const pos = nameInput.selectionStart;
    nameInput.value = toKatakana(nameInput.value);
    try { nameInput.setSelectionRange(pos, pos); } catch(_) {}
  });

  // å¿µã®ãŸã‚ãƒ•ã‚©ãƒ¼ã‚«ã‚¹é›¢è„±æ™‚ã«ã‚‚æ­£è¦åŒ–
  nameInput.addEventListener('blur', () => {
    nameInput.value = toKatakana(nameInput.value);
  });
})();

  // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ï¼šç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ä»˜ãã§ clear å®Ÿè¡Œ
  (function(){
    const clearBtn = f.querySelector('button[value="clear"]');
    if (clearBtn) {
      clearBtn.onclick = (e) => {
        e.preventDefault();  // ãƒ•ã‚©ãƒ¼ãƒ ã®æ—¢å®šå‹•ä½œã¯æ­¢ã‚ã‚‹

        // â˜… ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
        const ok = window.confirm('ã“ã®æ ã®å†…å®¹ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ');
        if (!ok) return;

        editor.returnValue = 'clear';
        editor.close();      // close ãƒãƒ³ãƒ‰ãƒ©å´ã§ clear ãƒ­ã‚¸ãƒƒã‚¯ãŒå‹•ã
      };
    }
  })();

   editor.showModal();
 
 
   // ===== EnterãƒŠãƒ“ & 1æ–‡å­—ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ =====
   // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç§»å‹•ã®é †åºï¼ˆã‚ã¨ã§èª¿æ•´ã—ã‚„ã™ã„ã‚ˆã†ã«æ±ºã‚æ‰“ã¡ï¼‰
   const focusOrder = [
    // åŸºæœ¬æƒ…å ±
    f.name,
    f.pid,
    f.age,
	
	// å…¥/å¤–/å½“æ—¥å…¥é™¢
    f.io,
	
    f.eye,

    // è¡“è€…ï¼ˆã‚»ãƒ¬ã‚¯ãƒˆ â†’ ãƒ•ãƒªãƒ¼ï¼‰
    f.surgeon,
   /* f.surgeonFree,*/

    // è¡“å¼1ãƒ»2
    f.proc1,
    f.proc2,

    // å‚™è€ƒ
    f.note,

    // IOL
    f.iolType,
    f.iolPower,

    // æ‰€è¦æ™‚é–“
    f.durationH,
    f.durationM
    // f.mergeSpan ã¯ EnterãƒŠãƒ“ã‹ã‚‰é™¤å¤–
   ].filter(Boolean);
 
   function moveFocusNext(fromEl){
     const idx = focusOrder.indexOf(fromEl);
     if (idx < 0) return;
     const next = focusOrder[idx + 1];
     if (!next) return;
     next.focus();
     // ãƒ†ã‚­ã‚¹ãƒˆç³»ã¯å…¨é¸æŠã—ã¦ãŠãã¨ä¸Šæ›¸ãã—ã‚„ã™ã„
     if (next.select && next.tagName === 'INPUT') {
       try { next.select(); } catch(_) {}
     }
   }
 
  // ===== çµåˆå…ˆã®è¡çª äº‹å‰ãƒã‚§ãƒƒã‚¯ =====
  function precheckMergeConflict(){
    // æ‰€è¦æ™‚é–“ï¼ˆH/Mï¼‰â†’ åˆ†ã«å¤‰æ›ï¼ˆsave ãƒ­ã‚¸ãƒƒã‚¯ã¨åŒã˜ä»•æ§˜ï¼‰
    const hRaw = (f.durationH?.value ?? '').trim();
    const mRaw = (f.durationM?.value ?? '').trim();
    const h = hRaw ? parseInt(toHalfWidthNum(hRaw), 10) : 0;
    const m = mRaw ? parseInt(toHalfWidthNum(mRaw), 10) : 0;
    const okH = Number.isFinite(h) && h >= 0;
    const okM = Number.isFinite(m) && m >= 0;
    const total = (okH ? h : 0) * 60 + (okM ? m : 0);
    const durationMin = total > 0 ? total : '';

    const durNum = Number(durationMin || 0);
    const spanFromDuration =
      (Number.isFinite(durNum) && durNum > 0)
        ? Math.ceil(durNum / 20)
        : 0;

    let span = spanFromDuration > 0
      ? spanFromDuration
      : Math.max(1, parseInt(f.mergeSpan?.value || '1', 10));

    const merge = span > 1;
    if (!merge) return false; // 1æ ãªã‚‰è¡çªãƒã‚§ãƒƒã‚¯ä¸è¦

    // ã“ã® firstKey / keys ã¯ openEditor ã®å¤–å´ã§æ—¢ã«å®šç¾©æ¸ˆã¿
    const data = loadWeek(currentMonday);

    // save ãƒ­ã‚¸ãƒƒã‚¯å†…ã¨åŒã˜ seqKeys ã‚’ã“ã“ã«ã‚‚å®šç¾©
    function seqKeysLocal(headKey, n){
      const {d,day,section,idx} = parseKey(headKey);
      const keysArr = [headKey];
      for(let i=1;i<n;i++){
        keysArr.push(`${d}|${day}|${section}|${idx+i}`);
      }
      return keysArr;
    }

    const keysToUse =
      keys.length>1
        ? keys.slice().sort((a,b)=> a.localeCompare(b))
        : seqKeysLocal(firstKey, span);

    for(let i=1;i<keysToUse.length;i++){
      const d = data[keysToUse[i]];
      if (d && !d.tail) {
        alert('çµåˆå…ˆã«æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚\næ™‚é–“ã‚’çŸ­ãã™ã‚‹ã‹ã€çµåˆå…ˆã®æ ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰ä¿å­˜ã—ã¦ãã ã•ã„ã€‚');
        return true;  // è¡çªã‚ã‚Š
      }
    }
    return false; // è¡çªãªã—
  }
 
   function saveFromKeyboard(){
     // â˜… ã¾ãšè¡çªãƒã‚§ãƒƒã‚¯
     if (precheckMergeConflict()) {
       // è¡çªã‚ã‚Š â†’ ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã¯é–‰ã˜ãªã„
       return;
     }

     try { document.activeElement?.blur(); } catch(_) {}
     editor.returnValue = 'save';
     editor.close(); // close ãƒãƒ³ãƒ‰ãƒ©å´ã§ save ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè¡Œ
   }

  // ä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚‚ saveFromKeyboard() ã«çµ±ä¸€
  (function(){
    if (saveBtn) {
      saveBtn.onclick = (e) => {
        e.preventDefault();   // æ—¢å®šã®ã€Œå³ closeã€ã‚’æ­¢ã‚ã‚‹
        saveFromKeyboard();  // äº‹å‰ãƒã‚§ãƒƒã‚¯ä»˜ãä¿å­˜
      };
    }
  })();

 
  // æ—¢å­˜ãƒãƒ³ãƒ‰ãƒ©å¤šé‡ç™»éŒ²é˜²æ­¢
  if (editor.__editorKeyHandler) {
    editor.removeEventListener('keydown', editor.__editorKeyHandler, true);
  }

  editor.__editorKeyHandler = function(e){
    if (e.isComposing) return;

    const target = e.target;
    const tag = (target.tagName || '').toLowerCase();

    // --- Tab / Shift+Tabï¼šãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ editor å†…ã«é–‰ã˜è¾¼ã‚ã‚‹ ---
    if (e.key === 'Tab') {
      const focusables = Array.from(
        editor.querySelectorAll(
          'button, input, select, textarea, [tabindex]:not([tabindex="-1"])'
        )
      ).filter(el => !el.disabled && el.offsetParent !== null);

      if (!focusables.length) return;

      const idx = focusables.indexOf(target);
      let nextIdx = idx;

      if (e.shiftKey) {
        // Shift+Tabï¼šå…ˆé ­ãªã‚‰æœ«å°¾ã¸
        nextIdx = idx <= 0 ? focusables.length - 1 : idx - 1;
      } else {
        // Tabï¼šæœ«å°¾ãªã‚‰å…ˆé ­ã¸
        nextIdx = idx === focusables.length - 1 ? 0 : idx + 1;
      }

      e.preventDefault();
      focusables[nextIdx].focus();
      return;
    }

    // --- çœ¼ï¼šR/L/B 1æ–‡å­—ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ ---
    if (target === f.eye &&
        !e.ctrlKey && !e.metaKey && !e.altKey &&
        e.key.length === 1) {
      const ch = e.key.toLowerCase();
      const map = { r: 'R', l: 'L', b: 'B' };
      const v = map[ch];
      if (v) {
        e.preventDefault();
        f.eye.value = v;
        moveFocusNext(f.eye);
        return;
      }
    }

    // --- å…¥/å¤–/å½“ï¼šio ã‚»ãƒ¬ã‚¯ãƒˆ 1æ–‡å­—ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ ---
    if (target === f.io &&
        !e.ctrlKey && !e.metaKey && !e.altKey &&
        e.key.length === 1) {
      const ch = e.key.toLowerCase();
      const map = { n: 'å…¥', g: 'å¤–', t: 'å½“' };
      const v = map[ch];
      if (v) {
        e.preventDefault();
        f.io.value = v;
        moveFocusNext(f.io);
        return;
      }
    }

    // --- è¡“è€…ã‚»ãƒ¬ã‚¯ãƒˆï¼šã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼ˆè¨­å®šã‹ã‚‰å¤‰æ›´å¯èƒ½ï¼‰ ---
    if (target === f.surgeon &&
        !e.ctrlKey && !e.metaKey && !e.altKey &&
        e.key.length === 1) {

      const ch = e.key.toLowerCase();
      if (!/[a-z]/.test(ch)) {
        // aã€œzä»¥å¤–ã¯ç„¡è¦–
        return;
      }

      // 1ã€œ2æ–‡å­—ãƒãƒƒãƒ•ã‚¡ã§ã‚³ãƒ¼ãƒ‰åˆ¤å®š
      window.__surKeyBuf = (window.__surKeyBuf || '') + ch;
      if (window.__surKeyBuf.length > 2) {
        window.__surKeyBuf = window.__surKeyBuf.slice(-2);
      }

      const map = window.__surgeonShortcutMap || {};
      let matchedName = null;

      // ã¾ãš 2æ–‡å­—ã‚³ãƒ¼ãƒ‰ï¼ˆmi / mo / ãªã©ï¼‰ã‚’å„ªå…ˆ
      const buf = window.__surKeyBuf;
      if (buf.length >= 2 && map[buf.slice(-2)]) {
        matchedName = map[buf.slice(-2)];
      } else if (map[buf.slice(-1)]) {
        // æ¬¡ã«1æ–‡å­—ã‚³ãƒ¼ãƒ‰ï¼ˆk / o / s ãªã©ï¼‰
        matchedName = map[buf.slice(-1)];
      }

      if (matchedName) {
        e.preventDefault();
        f.surgeon.value = matchedName;
        window.__surKeyBuf = ''; // ä½¿ã„åˆ‡ã£ãŸã®ã§ã‚¯ãƒªã‚¢
        moveFocusNext(f.surgeon);
      } else {
        // ã©ã®ã‚³ãƒ¼ãƒ‰ã«ã‚‚å½“ãŸã‚‰ãªã‘ã‚Œã°ã€æœ€å¾Œã®1æ–‡å­—ã ã‘æ®‹ã—ã¦æ§˜å­ã‚’è¦‹ã‚‹
        if (window.__surKeyBuf.length > 1) {
          window.__surKeyBuf = window.__surKeyBuf.slice(-1);
        }
      }
      return;
    }

    // --- Enterã‚­ãƒ¼ã®æŒ™å‹•ï¼ˆãƒœã‚¿ãƒ³å¯¾å¿œç‰ˆï¼‰ ---
    if (e.key === 'Enter') {

      // â‘  ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ä¸Šã® Enter ã¯ãƒœã‚¿ãƒ³å‹•ä½œã«ã™ã‚‹
      if (clearBtn && target === clearBtn) {
        e.preventDefault();
        // æ—¢ã«ä¸Šã® IIFE ã§ onclick å®šç¾©æ¸ˆã¿ãªã®ã§ click() ã§åŒã˜å‹•ã
        clearBtn.click();
        return;
      }
      if (cancelBtn && target === cancelBtn) {
        e.preventDefault();
        editor.returnValue = 'cancel';
        editor.close();
        return;
      }
      if (saveBtn && target === saveBtn) {
        e.preventDefault();
        // ã‚¯ãƒªãƒƒã‚¯ã¨åŒã˜çµŒè·¯ã§å‡¦ç†
        saveFromKeyboard();
        return;
      }

      // â‘¡ Ctrl+Enter / Cmd+Enter â†’ ä¿å­˜
      if ((e.ctrlKey || e.metaKey) && !e.shiftKey && !e.altKey) {
        e.preventDefault();
        if (typeof saveFromKeyboard === 'function') {
          saveFromKeyboard();
        }
        return;
      }

      // â‘¢ textarea + Shift+Enter â†’ æ”¹è¡Œï¼ˆãƒ¡ãƒ¢ãªã©ï¼‰
      if (tag === 'textarea' && e.shiftKey) return;

      // â‘£ ãã‚Œä»¥å¤–ã® Enter ã¯ã€Œæ¬¡ã®é …ç›®ã¸ç§»å‹•ã€ã€ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã¯ã•ã›ãªã„
      e.preventDefault();
      moveFocusNext(target);
      return;
    }

  };

  editor.addEventListener('keydown', editor.__editorKeyHandler, true);

editor.addEventListener('close', function handler(){
  editor.removeEventListener('close', handler);

  // çµåˆâ†’å³ç·¨é›†ã®ãƒãƒƒãƒãŒé–‹ã„ã¦ã„ãŸã‹ã©ã†ã‹
  const hadMergeBatch = !!mergeEditBatchOpen;

  if (editor.returnValue === 'save') {
  
    // ===== ãƒ•ã‚§ãƒ¼ã‚º1-â‘¢ï¼šä¿å­˜å‰ãƒã‚§ãƒƒã‚¯ï¼ˆåˆå‰Ã—å½“ã¯è­¦å‘Š / é€±æœ«ã¯é™¤å¤–ï¼‰=====
    try{
      const p0 = parseKey(firstKey); // firstKey ã¯ã“ã®ã‚¹ã‚³ãƒ¼ãƒ—ã«æ—¢ã«ã‚ã‚‹æƒ³å®š
      const dayKey = p0?.day;
      const secIdx = p0?.section;
      const isTou  = ((f?.io?.value || '').trim() === 'å½“');
      if (isTou && dayKey && secIdx != null && !__isWeekendDayKey(dayKey)) {
        const period = __getSectionPeriod(dayKey, secIdx); // 'AM' / 'PM'
        if (period === 'AM') {
          const ok = window.confirm(
            'ã€æ³¨æ„ã€‘åˆå‰æ ã«ã€Œå½“ã€ï¼ˆå½“æ—¥å…¥é™¢ï¼‰ã‚’å…¥ã‚Œã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚\n' +
            'é€šå¸¸ã¯åˆå‰å…¥é™¢â†’åˆå¾Œæ‰‹è¡“ã‚’æƒ³å®šã—ã¾ã™ã€‚\n' +
            'ã“ã®ã¾ã¾ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ'
          );
          if (!ok) {
            // â˜… ã“ã“ãŒè‚ï¼šsave å‡¦ç†è‡ªä½“ã‚’ä¸­æ­¢ã—ã¦ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«æ‰±ã„ã€ã«å¯„ã›ã‚‹
            editor.returnValue = 'cancel';
            // çµåˆâ†’å³ç·¨é›†ã®ãƒãƒƒãƒãŒé–‹ã„ã¦ã„ãŸã‚‰é–‰ã˜ã‚‹ï¼ˆsaveä»¥å¤–ãƒ«ãƒ¼ãƒˆã¨åŒç­‰ã«ï¼‰
            return; // â† å¤–å´ï¼ˆsaveãƒ–ãƒ­ãƒƒã‚¯ï¼‰ã‹ã‚‰æŠœã‘ã‚‹ã®ã§ä¿å­˜ã•ã‚Œãªã„
          }
        }
      }
    }catch(e){
      console.warn('tou-in-morning pre-save check skipped:', e);
    }

    // çµåˆã‹ã‚‰ç¶šã„ã¦ã„ã‚‹ãƒãƒƒãƒãŒã‚ã‚Œã°ãã‚Œã‚’å†åˆ©ç”¨ã€ãªã‘ã‚Œã°æ–°è¦ã«é–‹å§‹
    const reuseBatch = hadMergeBatch;
    if (!reuseBatch) {
      beginUndoBatch();
    }

    try {
      // â˜…â˜…â˜… save ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆRLã‚»ãƒƒãƒˆé€£ç¶šä½œæˆå¯¾å¿œç‰ˆï¼‰â˜…â˜…â˜…

      // ä¿å­˜ç›´å¾Œã¯ render ãŒè¤‡æ•°å›èµ°ã‚‹ã“ã¨ãŒã‚ã‚‹ãŸã‚ã€ä¸­å¤®å¯„ã›ã‚’ã€Œ2å›åˆ†ã€æŠ‘æ­¢
      window.__suppressCenterN = (window.__suppressCenterN || 0) + 2;	

      // ãƒ•ã‚©ãƒ¼ãƒ å†…å®¹ â†’ ãƒ¬ã‚³ãƒ¼ãƒ‰ nd
      let nd = {
        name: toHalfWidthKana(f.name.value.trim()),
        pid:  f.pid.value.trim(),
        age:  f.age.value.trim(),
        eye:  f.eye.value,
        io:   f.io.value,

        // IOLâ‘ ã€œâ‘¢
        iolType:  f.iolType.value.trim(),
        iolPower: normalizeDiopter(f.iolPower.value.trim()),
        iolUse1:  (f.iolUse1  ? f.iolUse1.value.trim()  : ''),

        iolType2:  (f.iolType2  ? f.iolType2.value.trim()  : ''),
        iolPower2: (f.iolPower2 ? normalizeDiopter(f.iolPower2.value.trim()) : ''),
        iolUse2:   (f.iolUse2   ? f.iolUse2.value.trim()   : ''),

        iolType3:  (f.iolType3  ? f.iolType3.value.trim()  : ''),
        iolPower3: (f.iolPower3 ? normalizeDiopter(f.iolPower3.value.trim()) : ''),
        iolUse3:   (f.iolUse3   ? f.iolUse3.value.trim()   : ''),

        proc1: f.proc1.value.trim(),
        proc2: f.proc2.value.trim(),
        surgeon: (() => {
          const sel  = f.surgeon;
          const free = f.surgeonFree;
          const freeVal = free ? free.value.trim() : '';
          if (freeVal) return freeVal;   // ãƒ•ãƒªãƒ¼å…¥åŠ›ãŒã‚ã‚Œã°ãã‚Œã‚’å„ªå…ˆ
          const selVal  = sel ? sel.value.trim() : '';
          return selVal;                 // ãªã‘ã‚Œã°ã‚»ãƒ¬ã‚¯ãƒˆã®å€¤
        })(),
        note:  f.note.value.trim(),
        ga: !!f.ga.checked,
        local: !!(f.local && f.local.checked),  // å±€éº»ãƒ•ãƒ©ã‚°
        // æ‰€è¦æ™‚é–“ï¼ˆH/Mï¼‰ï¼šå…¨è§’OK â†’ åŠè§’æ•°å€¤åŒ– â†’ åˆ†ã¸åˆç®—
        duration: (() => {
          const hRaw = (f.durationH?.value ?? '').trim();
          const mRaw = (f.durationM?.value ?? '').trim();
          const h = hRaw ? parseInt(toHalfWidthNum(hRaw), 10) : 0;
          const m = mRaw ? parseInt(toHalfWidthNum(mRaw), 10) : 0;
          const okH = Number.isFinite(h) && h >= 0;
          const okM = Number.isFinite(m) && m >= 0;
          const total = (okH ? h : 0) * 60 + (okM ? m : 0);
          return total > 0 ? total : '';
        })(),
        infection: (() => {
          const checked = f.querySelector('input[name="infection"]:checked');
          return checked ? checked.value : '';
        })()
      };
      nd = normalizePatientFields(nd);

      // â˜… ç·¨é›†â†’ä¿å­˜ã§ IOLãƒ‰ãƒƒãƒˆç­‰ã®ã€Œãƒ¢ãƒ¼ãƒ‰ç³»ãƒ•ãƒ©ã‚°ã€ãŒæ¶ˆãˆãªã„ã‚ˆã†ã«æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å¼•ãç¶™ã
      //   ï¼ˆãƒ•ã‚©ãƒ¼ãƒ ã«é …ç›®ãŒç„¡ã„ï¼ndã«å…¥ã‚‰ãªã„ãŸã‚ã€ä¸Šæ›¸ãã§æ¶ˆãˆã‚‹ã®ã‚’é˜²ãï¼‰
      const __storeForFlags = loadWeek(currentMonday) || {};
      function __carryFlags(prev, next){
        if (!prev || !next) return next;
        // å¿…è¦ã«å¿œã˜ã¦ã“ã“ã«ã€Œæ¶ˆã—ãŸããªã„ãƒ•ãƒ©ã‚°ã€ã‚’è¿½åŠ 
        const keep = [
          // arrival âœ“ ç³»ï¼ˆå°†æ¥æ‹¡å¼µã—ã¦ã‚‚ã“ã“ã§å®ˆã‚Œã‚‹ï¼‰
          'arrivalNotified', 'arrivalChecked', 'arrivalFlag',

          // IOL â— ç³»ï¼ˆã‚ãªãŸã®å®Ÿè£…åã«åˆã‚ã›ã¦ï¼‰
         'iolOrdered', 'iolOrdered1', 'iolOrdered2', 'iolOrdered3',
		 'deviceOrdered',

         // ãƒ‘ã‚¹ â— ç³»
         'pathDone'
        ];
        for (const k of keep){
          if (prev[k] !== undefined && next[k] === undefined){
            next[k] = prev[k];
          }
        }
        return next;
      }

      // openEditor(keys) ã®ã€Œå…ˆé ­ã‚­ãƒ¼ã€ã‚’ä»£è¡¨ã¨ã—ã¦ä¸€æ—¦ carryï¼ˆå˜æ ä¿å­˜ã®äº‹æ•…é˜²æ­¢ï¼‰
      // â€» ã“ã®å¾Œã®ã€Œå„ã‚­ãƒ¼ã«æ›¸ãè¾¼ã‚€ã€ãƒ«ãƒ¼ãƒ—ã§ã‚‚å€‹åˆ¥ã« carry ã—ã¦ãã ã•ã„ï¼ˆä¸‹ã«è¿½åŠ DIFFã‚ã‚Šï¼‰
      const __prev0 = __storeForFlags[keys?.[0]];
      __carryFlags(__prev0, nd);

// â˜… IOLã®ã€Œç¨®é¡ or åº¦æ•°ã€ãŒå¤‰ã‚ã£ãŸã‚‰ã€ãã®IOLã®ç™ºæ³¨ãƒ‰ãƒƒãƒˆ(iolOrdered1/2/3)ã‚’è‡ªå‹•OFFï¼ˆç”¨é€”ã¯ç„¡è¦–ï¼‰
(function(){
  const key0 = keys?.[0];
  const prev = key0 ? __storeForFlags[key0] : null;
  if (!prev || prev.tail) return;

  const normS = v => (v ?? '').toString().trim();
  const normP = v => {
    const s = normS(v);
    if (!s) return '';
    const num = Number(s);
    return Number.isFinite(num) ? num.toFixed(1) : s; // 22 ã¨ 22.0 ã®æºã‚Œå¯¾ç­–
  };

  const pairs = [
    { idx: 1, t: 'iolType',  p: 'iolPower',  flag: 'iolOrdered1' },
    { idx: 2, t: 'iolType2', p: 'iolPower2', flag: 'iolOrdered2' },
    { idx: 3, t: 'iolType3', p: 'iolPower3', flag: 'iolOrdered3' },
  ];

  for (const x of pairs){
    const prevType = normS(prev[x.t]);
    const nextType = normS(nd[x.t]);

    const prevPow  = normP(prev[x.p]);
    const nextPow  = normP(nd[x.p]);

    if (prevType !== nextType || prevPow !== nextPow){
      nd[x.flag] = false; // â˜… ã“ã“ã§OFFï¼ˆç”¨é€”å¤‰æ›´ã§ã¯æ¶ˆãˆãªã„ï¼‰
    }
  }
})();

	  


      // æ‰€è¦æ™‚é–“ â†’ span è‡ªå‹•æ±ºå®š
      const durNum = Number(nd.duration || 0);
      let spanFromDuration = (Number.isFinite(durNum) && durNum > 0)
        ? Math.ceil(durNum / 20)
        : 0;

      // ã€Œå…¥åŠ›ã•ã‚ŒãŸæ‰€è¦æ™‚é–“ãŒå„ªå…ˆã€ã€‚ãªã‘ã‚Œã° mergeSpan ã‚’ä½¿ã†
      let span = spanFromDuration > 0
        ? spanFromDuration
        : Math.max(1, parseInt(f.mergeSpan?.value || '1', 10));
      const merge = span > 1;

      // â–¼ å˜æ /2æ ï¼šå‚™è€ƒå†…ã®ã€Œæ„ŸæŸ“ã€ãƒ¡ãƒ¢ã‚’å‰Šé™¤ï¼ˆãƒãƒƒã‚¸ã«ä¸€æœ¬åŒ–ï¼‰
      if (span <= 2) {
        const note0 = (nd.note || '').trim();
        const cleaned = note0
          .replace(/^(?:â€»\s*)?(?:ï¼ˆ\s*æ„ŸæŸ“\s*ï¼‰|\(\s*æ„ŸæŸ“\s*\)|æ„ŸæŸ“)\s*/u, '')
          .replace(/(?:^|\s)(?:â€»\s*)?æ„ŸæŸ“(?!\S)/u, (m) => (m.startsWith(' ') ? ' ' : ''))
          .replace(/\s+/g, ' ')
          .trim();
        nd.note = cleaned;
      }

      const data = loadWeek(currentMonday);

      // â˜… æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã® meta ã‚’é€€é¿ï¼ˆRLã‚»ãƒƒãƒˆã® rlSetId ãªã©ã‚’ä¿æŒã—ãŸã„ï¼‰
      const prevRec  = data[firstKey];
      const prevMeta = (prevRec && prevRec.meta)
        ? JSON.parse(JSON.stringify(prevRec.meta))
        : null;

      // â˜… arrival âœ“ ã‚’ä¿æŒï¼ˆã‚¨ãƒ‡ã‚£ã‚¿ä¿å­˜ã§æ¶ˆãˆãªã„ã‚ˆã†ã«ï¼‰
      const prevArrivalFixed =
        (prevRec && ('arrivalFixed' in prevRec)) ? !!prevRec.arrivalFixed : undefined;
		
      // ==== RLã‚»ãƒƒãƒˆï¼šäº‹å‰åˆ¤å®šï¼ˆR ã‹ã¤ ãƒã‚§ãƒƒã‚¯ON ã‹ï¼‰=================
      const makeRL = !!(f.rlSet && f.rlSet.checked);
      const eyeVal = (f.eye.value || '').trim();
      let rlEnabled = makeRL && eyeVal === 'R';
      let rlSetId = null;
      let rlLKeys = [];

      if (rlEnabled) {
        // è¤‡æ•°æ ç·¨é›†ã¯ã‚µãƒãƒ¼ãƒˆå¤–ã«ã—ã¦ãŠã
        if (keys.length > 1) {
          alert('è¤‡æ•°æ ç·¨é›†ä¸­ã¯ RLã‚»ãƒƒãƒˆã®é€£ç¶šä½œæˆã¯ã§ãã¾ã›ã‚“ã€‚1æ ã®ã¿é¸æŠã—ã¦ã‹ã‚‰ãŠè©¦ã—ãã ã•ã„ã€‚');
          rlEnabled = false;
        } else {
          const parsed = parseKey(firstKey);
          if (!parsed) {
            rlEnabled = false;
          } else {
            const { d, day, section, idx } = parsed;
            const spanInt = Math.max(1, Number(span || 1));

            // L å´ã«ä½¿ã†æ ï¼ˆRã®çµåˆæ ã®ç›´å¾Œ span å€‹ï¼‰
            for (let i = 0; i < spanInt; i++) {
              rlLKeys.push(`${d}|${day}|${section}|${idx + spanInt + i}`);
            }

            // ãã®æ ãŒåŸ‹ã¾ã£ã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
            let conflictKey = null;
            if (typeof isOccupiedRecord === 'function') {
              for (const k of rlLKeys) {
                const rec = data[k];
                if (rec && isOccupiedRecord(rec)) {
                  conflictKey = k;
                  break;
                }
              }
            }

            if (conflictKey) {
              alert('RLã‚»ãƒƒãƒˆã®å¯¾çœ¼ï¼ˆLï¼‰ã‚’é…ç½®ã™ã‚‹æ ã«æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚\nå…ˆã«ãã®æ ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚');
              rlEnabled = false;
              rlLKeys = [];
            } else {
              rlSetId = 'rl_' + Date.now() + '_' + Math.random().toString(36).slice(2, 7);
            }
          }
        }
      }

      // headKey ã‹ã‚‰ span å€‹ã¶ã‚“ã®ã‚­ãƒ¼åˆ—ã‚’ä½œã‚‹ãƒ˜ãƒ«ãƒ‘
      function seqKeys(headKey, n){
        const {d,day,section,idx} = parseKey(headKey);
        const keys2=[headKey];
        for(let i=1;i<n;i++){ keys2.push(`${d}|${day}|${section}|${idx+i}`); }
        return keys2;
      }

      // æ—¢å­˜ head ç·¨é›†ã¯ä¸€æ—¦è§£é™¤
      if(first.head){
        const oldKeys = seqKeys(firstKey, first.span||1);
        for(const k of oldKeys){ if(data[k]) delete data[k]; }
      }

      if(merge && span>1){
        const keysToUse = keys.length>1 ? keys.slice().sort((a,b)=> a.localeCompare(b)) : seqKeys(firstKey, span);
        for(let i=1;i<keysToUse.length;i++){
          const d2 = data[keysToUse[i]];
          if(d2 && !d2.tail){
            alert('çµåˆå…ˆã«æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚å…ˆã«ã‚¯ãƒªã‚¢ã—ã¦ãã ã•ã„ã€‚');
            return;
          }
        }

        const headKey = keysToUse[0];
        const base = { ...nd, head:true, span: keysToUse.length };

        // â˜… æ—¢å­˜ meta ã¯å¸¸ã«ãƒãƒ¼ã‚¸ã—ã¦ä¿æŒï¼ˆIOLãƒ‰ãƒƒãƒˆç­‰ãŒä¿å­˜ã§æ¶ˆãˆãªã„ã‚ˆã†ã«ï¼‰
        if (prevMeta) {
          base.meta = { ...prevMeta, ...(base.meta || {}) };
        }

        // â˜… arrival âœ“ ã‚’å¼•ãç¶™ã
        if (prevArrivalFixed !== undefined) base.arrivalFixed = prevArrivalFixed;

        data[headKey] = base;

        for (let i=1; i<keysToUse.length; i++){
          data[keysToUse[i]] = { tail:true, head: headKey };
        }
      }else{
        if (Object.values(nd).every(v => !v)) {
          delete data[firstKey];
        } else {
          const base = { ...nd };

          // â˜… æ—¢å­˜ meta ã¯å¸¸ã«ãƒãƒ¼ã‚¸ã—ã¦ä¿æŒï¼ˆIOLãƒ‰ãƒƒãƒˆç­‰ãŒä¿å­˜ã§æ¶ˆãˆãªã„ã‚ˆã†ã«ï¼‰
          if (prevMeta) {
            base.meta = { ...prevMeta, ...(base.meta || {}) };
          }

          // â˜… arrival âœ“ ã‚’å¼•ãç¶™ã
          if (prevArrivalFixed !== undefined) base.arrivalFixed = prevArrivalFixed;

          data[firstKey] = base;
        }

        if (keys.length > 1) {
          for (let i = 1; i < keys.length; i++) {
            if (Object.values(nd).every(v => !v)) {
              delete data[keys[i]];
            } else {
              const k2 = keys[i];
              const prev2 = data[k2];
              const base2 = { ...nd };
              if (prev2 && ('arrivalFixed' in prev2)) base2.arrivalFixed = !!prev2.arrivalFixed;
              data[k2] = base2;
            }
          }
        }
      }


      // ==== RLã‚»ãƒƒãƒˆï¼šRçµåˆæ ã®ç›´å¾Œã« L çµåˆæ ã‚’ä½œæˆ =================
      if (rlEnabled && rlLKeys.length > 0) {
        const rHead = data[firstKey];   // Rãƒ˜ãƒƒãƒ‰ï¼ˆä»Šæ›¸ãè¾¼ã‚“ã ã‚‚ã®ï¼‰
        if (rHead) {
          const spanInt = Math.max(1, Number(span || 1));

          // Rãƒ˜ãƒƒãƒ‰ã« rlSetId ä»˜ä¸
          if (!rHead.meta) rHead.meta = {};
          rHead.meta.rlSetId = rlSetId;
          data[firstKey] = rHead;

          // Lãƒ˜ãƒƒãƒ‰ã‚­ãƒ¼ï¼†ãƒ¬ã‚³ãƒ¼ãƒ‰
          const lHeadKey = rlLKeys[0];
          const lHead = JSON.parse(JSON.stringify(rHead));
          lHead.eye = 'L';
          lHead.head = true;
          lHead.span = spanInt;
          if (!lHead.meta) lHead.meta = {};
          lHead.meta.rlSetId = rlSetId;
          data[lHeadKey] = lHead;

          // Lã® tail ã‚’ä½œã‚‹
          for (let i = 1; i < spanInt; i++) {
            const k = rlLKeys[i];
            data[k] = { tail: true, head: lHeadKey };
          }
        }
      }
	  
      // ==== RLã‚»ãƒƒãƒˆï¼šç›¸æ–¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰é€£å‹•ï¼ˆåŒæ–¹å‘ï¼šç·¨é›†å´ â†’ ç›¸æ–¹ï¼‰ ====
      try {
        const store = data;

        // ä»Šå›ç·¨é›†ã—ãŸæ ã®ã‚­ãƒ¼ï¼ˆtail ãªã‚‰ head ã«å¯„ã›ã‚‹ï¼‰
        let key0 = firstKey;
        const rec0 = store[key0];
        if (!rec0) {
          // å¯¾è±¡ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
        } else {
          if (rec0.tail && rec0.head && typeof rec0.head === 'string' && store[rec0.head]) {
            key0 = rec0.head;   // çµåˆæ ã® tail ã‹ã‚‰é–‹ã„ã¦ã„ãŸã‚‰ head ã«æ­£è¦åŒ–
          }

          // ã‚­ãƒ¼ï¼‹store ã‹ã‚‰ RLã‚»ãƒƒãƒˆç¯„å›²ã‚’åˆ¤å®š
          const info =
            (typeof findRLSetRangeForKey === 'function')
              ? findRLSetRangeForKey(key0, store)
              : null;

          if (info && info.keys && info.keys.length === 2) {
            const rKey = info.keys.find(k => ((store[k]?.eye || '').trim() === 'R'));
            const lKey = info.keys.find(k => ((store[k]?.eye || '').trim() === 'L'));
            const rRec = rKey ? store[rKey] : null;
            const lRec = lKey ? store[lKey] : null;

            if (rRec && lRec) {
              // R/L ãã‚Œãã‚Œã®â€œãƒ˜ãƒƒãƒ‰â€ã‚­ãƒ¼ï¼ˆçµåˆæ ã‚’è€ƒæ…®ï¼‰
              let rHeadKey = rKey;
              if (rRec.tail && typeof rRec.head === 'string' && store[rRec.head]) {
                rHeadKey = rRec.head;
              }
              let lHeadKey = lKey;
              if (lRec.tail && typeof lRec.head === 'string' && store[lRec.head]) {
                lHeadKey = lRec.head;
              }

              // ç·¨é›†å´ãŒã©ã¡ã‚‰ã‹åˆ¤å®š
              let srcKey = null;
              let dstKey = null;
              if (key0 === rHeadKey) {
                // Rå´ã‚’ç·¨é›† â†’ Rã®å€¤ã‚’Lã¸
                srcKey = rHeadKey;
                dstKey = lHeadKey;
              } else if (key0 === lHeadKey) {
                // Lå´ã‚’ç·¨é›† â†’ Lã®å€¤ã‚’Rã¸
                srcKey = lHeadKey;
                dstKey = rHeadKey;
              }

              if (srcKey && dstKey) {
                const srcRec = store[srcKey];
                const dstRec = store[dstKey];
                if (srcRec && dstRec) {
                  // â˜… ä¸¡ç›®ã§å¸¸ã«åŒã˜ã§ã‚ã‚‹ã¹ããƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
                  const linkedFields = ['io', 'name', 'pid', 'age', 'infection', 'ga', 'local'];
                  for (const fName of linkedFields) {
                    dstRec[fName] = srcRec[fName];
                  }
                  store[dstKey] = dstRec;
                }
              }
            }
          }
        }
      } catch (e) {
        console.warn('RL pair sync (both ways) failed:', e);
      }



      // ====== å¾Œç¶šæ ã®æ™‚åˆ»å†è¨ˆç®—ï¼ˆæŠ¼ã—å‡ºã—ï¼‰ ======
      try {
        const { day, section } = parseKey(firstKey);
        if (day && section != null) {
          rebuildDurationAnchorsForDaySection(day, section, data);
        }
      } catch (e) {
        console.warn('time override adjust skipped:', e);
      }
      if (typeof debugTimeOverrides === 'function') {
        debugTimeOverrides('after SAVE duration');
      }

      // --- ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç¶­æŒã®ãŸã‚ã®é€€é¿ ---
      const wasFocus = document.body.classList.contains('dayFocus');
      const focusedDayEl = document.querySelector('.day[data-focus="true"]');
      const focusedDayKey =
        focusedDayEl?.dataset?.day ??
        focusedDayEl?.querySelector('.day-header-date')?.textContent?.trim() ??
        null;
      const lastKeyBefore = window.lastSelectedKey || null;

      saveWeek(currentMonday, data);
      if (wasFocus) exitDayFocus();
      render();
      if (wasFocus && focusedDayKey){
        let dayEl =
          document.querySelector(`.day[data-day="${CSS.escape(focusedDayKey)}"]`) ||
          Array.from(document.querySelectorAll('.day'))
            .find(d => d.querySelector('.day-header-date')?.textContent?.trim() === focusedDayKey);
        if (dayEl) {
          enterDayFocus(dayEl);
          if (lastKeyBefore){
            const sameSlot = dayEl.querySelector(`.slot[data-key="${CSS.escape(lastKeyBefore)}"]`);
            if (sameSlot) setActiveSlot(sameSlot);
            else ensureInitialSelectionForDay(dayEl);
          } else {
            ensureInitialSelectionForDay(dayEl);
          }
        }
      }
      const currentFocused = document.querySelector('.slot.focused');
      if (!currentFocused) {
        const fallbackDay = document.querySelector('.day[data-focus="true"]') || document.querySelector('.day');
        if (fallbackDay) {
          const firstSlot = findFirstSelectableInDay(fallbackDay);
          if (firstSlot) setActiveSlot(firstSlot);
        }
      }

      // â˜…â˜…â˜… save ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆRLã‚»ãƒƒãƒˆå¯¾å¿œï¼‰ã“ã“ã¾ã§ â˜…â˜…â˜…

    } finally {
      // ãƒãƒƒãƒã®é–‰ã˜æ–¹ã‚’åˆ†å²
      try {
        endUndoBatch();
      } catch(_){}

      if (reuseBatch) {
        // çµåˆâ†’å³ç·¨é›†ã®ãƒãƒƒãƒã¯ã“ã“ã§ã‚¯ãƒ­ãƒ¼ã‚ºå®Œäº†
        mergeEditBatchOpen = false;
      }
    }

  } else {
    // save ä»¥å¤–ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ« / clear å«ã‚€ï¼‰ã§ã€çµåˆç”±æ¥ã®ãƒãƒƒãƒãŒé–‹ã„ã¦ã„ãŸã‚‰ã“ã“ã§é–‰ã˜ã¦ãŠã
    if (hadMergeBatch) {
      try { endUndoBatch(); } catch(_){}
      mergeEditBatchOpen = false;
    }

    if (editor.returnValue === 'clear') {
      // â˜… CLEAR ã‚‚ 1 ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¨ã—ã¦ã¾ã¨ã‚ã¦ Undo ã§ãã‚‹ã‚ˆã†ã«ãƒãƒƒãƒåŒ–
      beginUndoBatch();
      try {
        const data   = loadWeek(currentMonday);
        const dHead  = data[firstKey];
        const parsed = parseKey(firstKey); // { d, day, section, idx }
        const { d, day, section, idx } = parsed || {};

        // â˜… å‰Šé™¤å‰ã®æƒ…å ±ã‚’ä½¿ã£ã¦ã€æ‰€è¦æ™‚é–“ã‚¢ãƒ³ã‚«ãƒ¼ã‚’ç‰‡ä»˜ã‘ã‚‹
        cleanupTimeOverrideOnDelete(firstKey, data);

        // --- å®Ÿãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ï¼ˆhead ãªã‚‰ span åˆ†ã¾ã¨ã‚ã¦ã€å˜æ ãªã‚‰ 1 ã¤ï¼‰ ---
        if (dHead && dHead.head) {
          const span = Number(dHead.span || 1);
          for (let i = 0; i < span; i++) {
            const k = `${d}|${day}|${section}|${idx + i}`;
            delete data[k];
          }
        } else {
          delete data[firstKey];
        }

        // â˜… çµåˆæ ã‚¯ãƒªã‚¢å¾Œï¼šã“ã® day/section ã®ã‚¢ãƒ³ã‚«ãƒ¼ã‚’ã¾ã¨ã‚ã¦å†æ§‹ç¯‰
        try {
          if (day != null && section != null) {
            rebuildDurationAnchorsForDaySection(day, section, data);
          }
        } catch (e) {
          console.warn('rebuild-after-clear failed:', e);
        }

        debugTimeOverrides('before CLEAR saveWeek');

        // --- ã“ã“ã‹ã‚‰å…ˆã¯ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç¶­æŒãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå…ƒã®ã¾ã¾ï¼‰ ---
        const wasFocus = document.body.classList.contains('dayFocus');
        const focusedDayEl = document.querySelector('.day[data-focus="true"]');
        const focusedDayKey =
          focusedDayEl?.dataset?.day ??
          focusedDayEl?.querySelector('.day-header-date')?.textContent?.trim() ??
          null;
        const lastKeyBefore = window.lastSelectedKey || null;

        saveWeek(currentMonday, data);
        if (wasFocus) exitDayFocus();
        render();

        if (wasFocus && focusedDayKey) {
          let dayEl =
            document.querySelector(`.day[data-day="${CSS.escape(focusedDayKey)}"]`) ||
            Array.from(document.querySelectorAll('.day'))
              .find(d => d.querySelector('.day-header-date')?.textContent?.trim() === focusedDayKey);
          if (dayEl) {
            enterDayFocus(dayEl);
            if (lastKeyBefore) {
              const sameSlot = dayEl.querySelector(`.slot[data-key="${CSS.escape(lastKeyBefore)}"]`);
              if (sameSlot) setActiveSlot(sameSlot);
              else ensureInitialSelectionForDay(dayEl);
            } else {
              ensureInitialSelectionForDay(dayEl);
            }
          }
        }

        const currentFocused2 = document.querySelector('.slot.focused');
        if (!currentFocused2) {
          const fallbackDay =
            document.querySelector('.day[data-focus="true"]') ||
            document.querySelector('.day');
          if (fallbackDay) {
            const firstSlot = findFirstSelectableInDay(fallbackDay);
            if (firstSlot) setActiveSlot(firstSlot);
          }
        }
      } finally {
        // â˜… CLEAR ãƒ«ãƒ¼ãƒˆå…¨ä½“ã‚’ 1 ã‚¹ãƒ†ãƒƒãƒ—ã® Undo ã«ç¢ºå®š
        endUndoBatch();
      }
    }
  }
}, {once:true});
}

// å…¨éº»ã¨å±€éº»ã¯ç›¸åã•ã›ã‚‹
document.getElementById("ga").addEventListener("change", () => {
  if (ga.checked) {
    local.checked = false;
  }
});

document.getElementById("local").addEventListener("change", () => {
  if (local.checked) {
    ga.checked = false;
  }
});

// æ‰€è¦æ™‚é–“ï¼ˆdurationï¼‰ã‚’å„ªå…ˆã—ã¦ã€æ¬¡ã‚¹ãƒ­ãƒƒãƒˆã®é–‹å§‹æ™‚åˆ»ã‚¢ãƒ³ã‚«ãƒ¼ã‚’æ‰“ã¤
function applyDurationAnchorForHead(headKey, store){
  try {
    // headKey = "2025-11-12|Tue|1|7" ãªã©
    const { d, day, section, idx } = parseKey(headKey);
    const head = store[headKey];
    if (!head || head.tail) return;

    const span = Math.max(1, Number(head.span || 1));
    const dur  = Number(head.duration || 0);
    const effMinutes = (Number.isFinite(dur) && dur > 0) ? dur : (span * 20);

    // å…ˆé ­å®Ÿé–‹å§‹
    const baseStart = (CONFIG?.[day]?.[section]?.start) || '09:30';
    const headHHMM  = getSlotTimeHHMMEx(baseStart, currentMonday, day, section, idx);

    // æ¬¡ã®æ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆçµåˆæ™‚ã¯ head ã®æ¬¡ã®æ ï¼‰
    const nextIdx = idx + span;

    // æ—¢å­˜ã‚¢ãƒ³ã‚«ãƒ¼ã®å¾Œç¶šåˆ†ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã€æ¬¡æ ã«ã€Œé–‹å§‹+æ‰€è¦æ™‚é–“ã€ã§ã‚¢ãƒ³ã‚«ãƒ¼
    clearTimeOverrideFrom(currentMonday, day, section, idx + 1);
    setTimeOverride(currentMonday, day, section, nextIdx, addMinutes(headHHMM, effMinutes));
  } catch(e){
    console.warn('applyDurationAnchorForHead skipped:', e);
  }
}
// === ãã®æ—¥ãƒ»ãã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã® duration ã‚¢ãƒ³ã‚«ãƒ¼ã‚’ä¸€æ‹¬ã§çµ„ã¿ç›´ã™ ===
function rebuildDurationAnchorsForDaySection(dayKey, section, storeOpt, opts){
  try{
    const store   = storeOpt || loadWeek(currentMonday);
    const options = opts || {};
    const keep    = options.keepAnchor || null;   // { idx, hhmm } ãªã©

    // 1) ã“ã® day|section ã® time override ã‚’ãƒªã‚»ãƒƒãƒˆ
    const tovr = loadTimeOverrides(currentMonday);
    const tKey = `${dayKey}|${section}`;

    if (keep && typeof keep.idx === 'number' && keep.hhmm){
      // æŒ‡å®šã•ã‚ŒãŸã‚¢ãƒ³ã‚«ãƒ¼ã ã‘ã‚’æ®‹ã™å½¢ã§ãƒªã‚»ãƒƒãƒˆ
      tovr[tKey] = { [keep.idx]: keep.hhmm };
    } else {
      // å¾“æ¥ã©ãŠã‚Šï¼šå…¨éƒ¨æ¶ˆã™
      if (tovr[tKey]) {
        delete tovr[tKey];
      }
    }
    saveTimeOverrides(currentMonday, tovr);

    // 2) head ã«ãªã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ idx æ˜‡é †ã«é›†ã‚ã‚‹
    const heads = [];
    for (const key of Object.keys(store)){
      const rec = store[key];
      if (!rec || rec.tail) continue;

      const p = parseKey(key);  // { d, day, section, idx }
      if (p.day !== dayKey || p.section !== section) continue;

      const span = Math.max(1, Number(rec.span || 1));
      const dur  = Number(rec.duration || 0);

      // ã€Œçµåˆæ  or durationã‚ã‚Šã€ã ã‘ã‚’å¯¾è±¡
      if (span > 1 || (Number.isFinite(dur) && dur > 0)){
        heads.push({ key, idx: p.idx });
      }
    }

    heads.sort((a,b)=> a.idx - b.idx);

    // 3) å…ˆé ­ã‹ã‚‰é †ã« applyDurationAnchorForHead ã§ã‚¢ãƒ³ã‚«ãƒ¼è¨­å®š
    for (const h of heads){
      applyDurationAnchorForHead(h.key, store);
    }
  }catch(e){
    console.warn('rebuildDurationAnchorsForDaySection skipped:', e);
  }
}


  // ==== RLã‚»ãƒƒãƒˆæ¤œå‡ºãƒ˜ãƒ«ãƒ‘ ====
  // slotEl ã‹ã‚‰ã€Œã“ã®æ ãŒ RL ã‚»ãƒƒãƒˆã«å±ã—ã¦ã„ã‚‹ã‹ã€ã‚’èª¿ã¹ã€
  // è¦‹ã¤ã‹ã£ãŸå ´åˆã¯ { keys:[...], baseKey:"..." } ã‚’è¿”ã™ã€‚
  // ã¾ã  rlSetId ã‚’ä»˜ã‘ã¦ã„ãªã„æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«ã‚‚å¯¾å¿œã§ãã‚‹ã‚ˆã†ã€
  // 1) rlSetId ãŒã‚ã‚Œã°ãã‚Œã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
  // 2) ãªã‘ã‚Œã°ã€ŒåŒã˜æ—¥ãƒ»åŒã˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ»åŒã˜æ‚£è€…ï¼ˆname/pidï¼‰ã§ R/L ãƒšã‚¢ã€ã‚’è¿‘å‚ã‹ã‚‰æ¨å®š
  function findRLSetRangeForSlot(slotEl, storeOpt){
    if (!slotEl) return null;
    const key = slotEl.dataset?.key;
    if (!key) return null;

    const store = storeOpt || loadWeek(currentMonday);
    let rec = store[key];
    if (!rec) return null;

    // tail è¡Œï¼ˆçµåˆæ ã®2ãƒã‚¹ç›®ä»¥é™ï¼‰ã ã£ãŸå ´åˆã¯ head å´ã«å¯„ã›ã¦åˆ¤å®š
    if (rec.tail && rec.head && typeof rec.head === 'string' && store[rec.head]) {
      return findRLSetRangeForKey(rec.head, store);
    }
    return findRLSetRangeForKey(key, store);
  }

  // å†…éƒ¨ç”¨ï¼šã‚­ãƒ¼ã¨ã‚¹ãƒˆã‚¢ã‹ã‚‰ RL ã‚»ãƒƒãƒˆç¯„å›²ã‚’åˆ¤å®š
  function findRLSetRangeForKey(key, store){
    const base = store[key];
    if (!base) return null;

    const eye = (base.eye || '').trim();
    if (eye !== 'R' && eye !== 'L') return null;

    // --- 1) rlSetId ãŒã‚ã‚Œã°ã€ãã‚Œã§ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚° ---
    const setId = base.meta && base.meta.rlSetId;
    if (setId) {
      const keys = Object.keys(store)
        .filter(k => {
          const r = store[k];
          if (!r || r.tail) return false;
          return r.meta && r.meta.rlSetId === setId;
        })
        .sort();

      if (keys.length >= 2) {
        return { keys, baseKey: key };
      }
    }

    // --- 2) Fallbackï¼šåŒã˜æ—¥ãƒ»ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ name/pid ãŒåŒã˜ R/L ãƒšã‚¢ã‚’è¿‘å‚ã‹ã‚‰æ¢ã™ ---
    const p = parseKey(key); // { d, day, section, idx }
    if (!p || p.day == null || p.section == null) return null;

    const baseName = (base.name || '').trim();
    const basePid  = (base.pid  || '').trim();
    if (!baseName && !basePid) return null; // æ‚£è€…æƒ…å ±ãŒç„¡ã‘ã‚Œã°åˆ¤å®šä¸èƒ½

    const partnerEye = (eye === 'R') ? 'L' : 'R';
    const candidates = [];
    const maxOffset = 3; // åŒã˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã§ Â±3 æ ã¶ã‚“ã ã‘ã‚’è¦‹ã‚‹

    for (let off = -maxOffset; off <= maxOffset; off++) {
      if (off === 0) continue;
      const k = `${p.d}|${p.day}|${p.section}|${p.idx + off}`;
      const r = store[k];
      if (!r || r.tail) continue;

      const eye2 = (r.eye || '').trim();
      if (eye2 !== partnerEye) continue;

      const name2 = (r.name || '').trim();
      const pid2  = (r.pid  || '').trim();

      // PID ãŒå…¥ã£ã¦ã„ã‚Œã° PID å„ªå…ˆã€ç„¡ã„å ´åˆã¯æ°åã§åˆ¤å®š
      if (basePid) {
        if (pid2 === basePid) candidates.push(k);
      } else if (baseName) {
        if (name2 === baseName) candidates.push(k);
      }
    }

    if (!candidates.length) return null;

    // ä¸€å¿œã‚½ãƒ¼ãƒˆã—ã¦ã€ä»£è¡¨çš„ãª 2 ä»¶ã‚’ RL ã‚»ãƒƒãƒˆã¨ã¿ãªã™
    candidates.sort();
    const all = [key, ...candidates].sort();
    const keys2 = all.slice(0, 2);

    if (keys2.length < 2) return null;
    return { keys: keys2, baseKey: key };
  }


function formatMinutesColon(min){
  const m = Number(min)||0;
  if (m <= 0) return '';
  const h = Math.floor(m/60), r = m%60;
  if (h && r) return `${h}:${r.toString().padStart(2,'0')}`;
  if (h) return `${h}:00`;
  return `${r}`;
}


/* ---------- ã‚³ãƒ”ãƒ¼ / è²¼ã‚Šä»˜ã‘ / åˆ‡ã‚Šå–ã‚Šï¼ˆå˜æ ï¼†çµåˆå¯¾å¿œã®æœ€å°æ ¸ï¼‰ ---------- */
const appClipboard = { type:null, data:null };
let lastCopySourceKey = null;

function isOccupiedRecord(rec){
  if (!rec) return false;
  const f = ['head','tail','name','pid','age','eye','iolType','iolPower','proc1','proc2','surgeon','note','io','linkWith'];
  return f.some(k => !!rec[k]);
}

function copySlotOrMerge(){
  const st = loadWeek(currentMonday);

  // 0) RLã‚»ãƒƒãƒˆé¸æŠä¸­ãªã‚‰ã€RLã‚»ãƒƒãƒˆå˜ä½ã§ã‚³ãƒ”ãƒ¼
  const activeEl = getActiveSlot?.();
  if (window.currentRLSetId && activeEl && typeof findRLSetRangeForSlot === 'function') {
    const info    = findRLSetRangeForSlot(activeEl, st);
    const baseRec = info && st[info.baseKey];
    const rlId    = baseRec?.meta?.rlSetId;

    if (info && rlId && rlId === window.currentRLSetId && info.keys && info.keys.length > 1) {
      const blocks = [];
      for (const headKey of info.keys) {
        const rec = st[headKey];
        if (!rec) continue;

        const span = rec.head ? Math.max(1, Number(rec.span || 1)) : 1;
        const kind = (rec.head && span > 1) ? 'merge' : 'single';

        blocks.push({
          kind,
          span,
          data: deepClone(rec),
          keys: [headKey]
        });
      }

      if (blocks.length) {
        const p = parseKey(info.keys[0]);
        const clipMulti = {
          day:     p.day,
          section: p.section,
          blocks
        };

        appClipboard.type = 'multi';
        appClipboard.data = clipMulti;

        // è¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼šå¤–å‘¨é¸æŠä¸­ã®æ ã‚’è»½ãã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        document.querySelectorAll('.slot.multiSelected').forEach(el => {
          el.animate([{opacity:1},{opacity:0.4},{opacity:1}], {duration:160});
        });
        return;
      }
    }
  }

  // 1) ã¾ãšè¤‡æ•°é¸æŠã‚’è©¦ã™
  if (multiSelected && multiSelected.size > 1) {
    const clipMulti = buildMultiClipboardFromSelection(st);
    if (clipMulti) {
      appClipboard.type = 'multi';
      appClipboard.data = clipMulti;

      // è¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼šé¸æŠç¯„å›²ã‚’ãµã‚ã£ã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      document.querySelectorAll('.slot.multiSelected').forEach(el => {
        el.animate([{opacity:1},{opacity:0.4},{opacity:1}], {duration:160});
      });
      return;
    }
    // ã“ã“ã«æ¥ã‚‹ã®ã¯ã€Œç¯„å›²ãŒãŠã‹ã—ãã¦ alert æ¸ˆã¿ã€ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãªã®ã§ã€
    // ãã®ã¾ã¾å˜æ ã‚³ãƒ”ãƒ¼ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¦ã‚‚ã‚ˆã„ã—ã€return ã§ã‚‚ã‚ˆã„ã€‚
    // ã²ã¨ã¾ãšãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¦ãŠãã€‚
  }

  // 2) é€šå¸¸ã®å˜æ ï¼çµåˆæ ã‚³ãƒ”ãƒ¼ï¼ˆå¾“æ¥ã©ãŠã‚Šï¼‰
  const el = getActiveSlot?.();
  if(!el){ alert('ã‚¹ãƒ­ãƒƒãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  const key = el.dataset.key;
  const d   = st[key];
  if(!d){ alert('ã‚³ãƒ”ãƒ¼å¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“'); return; }

  if (d.head && Number(d.span||1)>1){
    appClipboard.type = 'merge';
    appClipboard.data = { headKey:key, span:Number(d.span), headData:deepClone(d) };
  }else{
    appClipboard.type = 'single';
    appClipboard.data = { key, data:deepClone(d) };
    lastCopySourceKey = key;
  }
  el.animate([{opacity:1},{opacity:.5},{opacity:1}], {duration:160});
}


function pasteToActive({flip=false}={}){
  const clip = appClipboard;
  if(!clip?.type){ alert('ã‚³ãƒ”ãƒ¼ã•ã‚Œã¦ã„ã¾ã›ã‚“'); return; }
  const tEl = getActiveSlot?.(); if(!tEl){ alert('è²¼ã‚Šä»˜ã‘å…ˆã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  const tKey = tEl.dataset.key;
  const st = loadWeek(currentMonday);

  // ====== â˜… è¤‡æ•°æ è²¼ã‚Šä»˜ã‘ï¼ˆmultiï¼‰ ======
if (clip.type === 'multi') {
  const blocks = clip.data?.blocks;
  if (!blocks || !blocks.length) {
    alert('è¤‡æ•°ã‚³ãƒ”ãƒ¼å†…å®¹ãŒä¸æ­£ã§ã™'); return;
  }

  const container = tEl.closest('.slots');
  if (!container) { alert('è²¼ã‚Šä»˜ã‘å…ˆãŒä¸æ­£ã§ã™'); return; }

  const list = Array.from(container.querySelectorAll('.slot'));
  let base = list.indexOf(tEl);
  if (base < 0) { alert('è²¼ã‚Šä»˜ã‘å…ˆãŒä¸æ­£ã§ã™'); return; }

  // 1) äº‹å‰ãƒã‚§ãƒƒã‚¯ï¼šã¯ã¿å‡ºã—ãƒ»ä¸Šæ›¸ãç¢ºèª
  let probe = base;
  for (const b of blocks) {
    const span = Number(b.span || 1);
    if (probe + span - 1 >= list.length) {
      alert('è²¼ã‚Šä»˜ã‘ç¯„å›²ãŒã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å¤–ã«ã¯ã¿å‡ºã—ã¾ã™'); return;
    }
    for (let j = 0; j < span; j++) {
      const k = list[probe + j].dataset.key;
      if (isOccupiedRecord(st[k])) {
        alert('è²¼ã‚Šä»˜ã‘å…ˆã«æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™'); return;
      }
    }
    probe += span;
  }

  // â˜… 1-b) äº‹å‰ãƒã‚§ãƒƒã‚¯ï¼šå½“æ—¥å…¥é™¢ï¼ˆå½“ï¼‰Ã— åˆå‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯è­¦å‘Šï¼ˆé€±æœ«ã¯é™¤å¤–ï¼‰
  probe = base;
  for (const b of blocks) {
    const span = Number(b.span || 1);
    // single ã¯ãã®1æ ã€merge ã¯ headData ãŒä»£è¡¨
    const would =
      (b.kind === 'single') ? b.data :
      (b.kind === 'merge')  ? b.data : null;
    if (would && (would.io || '').trim() === 'å½“') {
      const destKey = list[probe].dataset.key; // ä»£è¡¨ã‚­ãƒ¼ï¼ˆmergeã‚‚headãŒprobeï¼‰
      if (!__allowTouPlacementForKey(destKey, would)) return;
    }
    probe += span;
  }

  // 2) å®Ÿéš›ã®æ›¸ãè¾¼ã¿ï¼‹ä¿å­˜ã‚’1ãƒãƒƒãƒã«ã¾ã¨ã‚ã‚‹
  beginUndoBatch();
  try {
    let idx = base;

    // â˜… RLã‚»ãƒƒãƒˆIDã®æŒ¯ã‚Šç›´ã—ç”¨ãƒãƒƒãƒ—
    const rlIdMap = {};
    function remapRLId(obj){
      if (!obj) return;
      const meta = obj.meta;
      const oldId = meta && meta.rlSetId;
      if (!oldId) return;
      if (!rlIdMap[oldId]) {
        rlIdMap[oldId] = `rl_${Date.now()}_${Math.random().toString(16).slice(2)}`;
      }
      meta.rlSetId = rlIdMap[oldId];
    }

    for (const b of blocks) {
      if (b.kind === 'single') {
        const destKey = list[idx].dataset.key;
        const data = deepClone(b.data);
        if (flip && data.eye) data.eye = flipEye(data.eye);
        // â˜… RLã‚»ãƒƒãƒˆIDã‚’è²¼ã‚Šä»˜ã‘ç”¨ã«æŒ¯ã‚Šç›´ã—
        remapRLId(data);
        delete data.linkWith;

        st[destKey] = data;
        if (st[destKey] && !st[destKey].tail && !('span' in st[destKey])) {
          st[destKey].span = 1;   // duration ç”¨ã® span=1 ä»˜ä¸ã ã‘
        }
        idx += 1;

      } else if (b.kind === 'merge') {
        const span = Number(b.span || 1);
        const headData = deepClone(b.data);
        delete headData.head;
        delete headData.tail;
        delete headData.span;
        delete headData.linkWith;
        if (flip && headData.eye) headData.eye = flipEye(headData.eye);
        // â˜… çµåˆæ ãƒ˜ãƒƒãƒ‰ã«ã‚‚æ–°ã—ã„ rlSetId ã‚’ä»˜ä¸
        remapRLId(headData);

        const destKeys = [];
        for (let j = 0; j < span; j++) {
          destKeys.push(list[idx + j].dataset.key);
        }
        const headKey = destKeys[0];
        st[headKey] = { ...headData, head: true, span };
        for (let j = 1; j < span; j++) {
          st[destKeys[j]] = { tail: true, head: headKey };
        }
        idx += span;
      }
    }

    // â˜… è²¼ã‚Šä»˜ã‘å¾Œï¼šã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æ‰€è¦æ™‚é–“ã‚¢ãƒ³ã‚«ãƒ¼ã‚’ä¸€æ‹¬ã§çµ„ã¿ç›´ã™
    const { day, section } = parseKey(tKey);
    rebuildDurationAnchorsForDaySection(day, section, st);

    saveWeek(currentMonday, st);
  } finally {
    endUndoBatch();
  }

  reRenderPreservingFocus(tKey); // è²¼ã‚Šä»˜ã‘å…ˆã‚’åŸºæº–ã«å¾©å¸°
  return;
}


  // ====== ã“ã“ã‹ã‚‰ä¸‹ã¯å¾“æ¥ã©ãŠã‚Š single / merge è²¼ã‚Šä»˜ã‘ ======
if (clip.type === 'single') {
  if (isOccupiedRecord(st[tKey])) {
    alert('æ—¢ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™'); 
    return;
  }

  beginUndoBatch();            // â˜… 1ã‚¹ãƒ†ãƒƒãƒ—ã«ã¾ã¨ã‚ã‚‹
  try {
    const data = deepClone(clip.data.data);
    if (flip && data.eye) data.eye = flipEye(data.eye);
    delete data.linkWith;

    // â˜… å½“æ—¥å…¥é™¢ï¼ˆå½“ï¼‰Ã— åˆå‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯è­¦å‘Šï¼ˆé€±æœ«ã¯é™¤å¤–ï¼‰
    if (!__allowTouPlacementForKey(tKey, data)) return;

    // è²¼ã‚Šä»˜ã‘å…ˆã«æ›¸ãè¾¼ã¿
    st[tKey] = data;

    // duration ç”¨ã« span=1 ã‚’ä»˜ã‘ã¦ãŠãï¼ˆtail ã§ãªã„ã¨ãã ã‘ï¼‰
    if (st[tKey] && !st[tKey].tail && !('span' in st[tKey])) {
      st[tKey].span = 1;
    }

    // â˜… ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³å…¨ä½“ã®ã‚¢ãƒ³ã‚«ãƒ¼ã‚’çµ„ã¿ç›´ã™
    const { day, section } = parseKey(tKey);
    rebuildDurationAnchorsForDaySection(day, section, st);

    saveWeek(currentMonday, st);
  } finally {
    endUndoBatch();            // â˜… ãƒãƒƒãƒçµ‚äº†
  }

  // æç”»ã¯ãƒãƒƒãƒå¤–ã§OK
  reRenderPreservingFocus(tKey);
  return;
}



if (clip.type === 'merge') {
  const span = Number(clip.data.span || 1);
  if (span <= 1) {
    alert('çµåˆæƒ…å ±ãŒä¸æ­£ã§ã™');
    return;
  }

  const day = tEl.closest('.day');
  if (!day) {
    alert('è²¼ã‚Šä»˜ã‘å…ˆãŒä¸æ­£ã§ã™');
    return;
  }

  const list = Array.from(day.querySelectorAll('.slot'));
  const base = list.indexOf(tEl);
  if (base < 0 || base + span - 1 >= list.length) {
    alert('è²¼ã‚Šä»˜ã‘ç¯„å›²ãŒæ—¥ã¯ã¿å‡ºã—ã¾ã™');
    return;
  }

  // ã¯ã¿å‡ºã—ãƒ»ä¸Šæ›¸ããƒã‚§ãƒƒã‚¯
  const destKeys = [];
  for (let i = 0; i < span; i++) {
    const k = list[base + i].dataset.key;
    destKeys.push(k);
    if (isOccupiedRecord(st[k])) {
      alert('è²¼ã‚Šä»˜ã‘å…ˆã«æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™');
      return;
    }
  }

  // â˜… ã“ã“ã‹ã‚‰ã¾ã¨ã‚ã¦ 1 ã¤ã® undo ã«ã™ã‚‹
  beginUndoBatch();
  try {
    // head ãƒ‡ãƒ¼ã‚¿
    const headData = deepClone(clip.data.headData || {});
    delete headData.head;
    delete headData.tail;
    delete headData.span;
    delete headData.linkWith;
    if (flip && headData.eye) headData.eye = flipEye(headData.eye);

    const headKey = destKeys[0];
    st[headKey] = { ...headData, head: true, span };

    // tail ã‚’æ›¸ãè¾¼ã¿
    for (let i = 1; i < span; i++) {
      st[destKeys[i]] = { tail: true, head: headKey };
    }

    // â˜… ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³å…¨ä½“ã®ã‚¢ãƒ³ã‚«ãƒ¼ã‚’çµ„ã¿ç›´ã™
    const { day: dayKey, section } = parseKey(headKey);
    rebuildDurationAnchorsForDaySection(dayKey, section, st);

    // ä¿å­˜ã—ã¦ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¾©å¸°
    saveWeek(currentMonday, st);
  } finally {
    endUndoBatch();  // â˜… ã¾ã¨ã‚ã¦1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«ç¢ºå®š
  }

  reRenderPreservingFocus(tKey);
  return;
}
}


function cutActive(){
  const storeNow = loadWeek(currentMonday);

  // --- ã©ã®æ ã‚’å‰Šé™¤ã™ã‚‹ã‹ã€å‰Šé™¤ãƒ—ãƒ©ãƒ³ã‚’ä½œã‚‹ ---
  const deletePlan = [];
  let clipboardData = null;

  // 1) RLã‚»ãƒƒãƒˆé¸æŠä¸­ãªã‚‰ã€RLã‚»ãƒƒãƒˆå˜ä½ã§ cut
  let handledRL = false;
  const activeEl = getActiveSlot?.();
  if (window.currentRLSetId && activeEl && typeof findRLSetRangeForSlot === 'function') {
    const info    = findRLSetRangeForSlot(activeEl, storeNow);
    const baseRec = info && storeNow[info.baseKey];
    const rlId    = baseRec?.meta?.rlSetId;

    if (info && rlId && rlId === window.currentRLSetId && info.keys && info.keys.length > 1) {
      const blocks = [];

      for (const headKey of info.keys) {
        const rec = storeNow[headKey];
        if (!rec) continue;

        const span = rec.head ? Math.max(1, Number(rec.span || 1)) : 1;
        const kind = (rec.head && span > 1) ? 'merge' : 'single';

        blocks.push({
          kind,
          span,
          data: deepClone(rec),
          keys: [headKey]
        });

        if (kind === 'merge') {
          deletePlan.push({ type:'merge', headKey });
        } else {
          deletePlan.push({ type:'single', key: headKey });
        }
      }

      if (blocks.length) {
        const p = parseKey(info.keys[0]);
        clipboardData = {
          day:     p.day,
          section: p.section,
          blocks
        };
        appClipboard.type = 'multi';
        appClipboard.data = clipboardData;
        handledRL = true;
      }
    }
  }

  // 2) è¤‡æ•°é¸æŠã‚ã‚Š â†’ multi cut
  if (!handledRL && multiSelected && multiSelected.size > 1) {
    const clipMulti = buildMultiClipboardFromSelection(storeNow);
    if (!clipMulti) return;  // é€”ä¸­ã«ç©´ãƒ»ä¸æ­£ãŒã‚ã‚Œã°ä¸­æ­¢ï¼ˆbuildMultiå†…ã§alertæ¸ˆï¼‰

    // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ multi ã‚’æ ¼ç´
    appClipboard.type = 'multi';
    appClipboard.data = clipMulti;
    clipboardData = clipMulti;

    // blocks ã‹ã‚‰å‰Šé™¤ãƒ—ãƒ©ãƒ³ã‚’ä½œæˆ
    for (const b of clipMulti.blocks) {
      if (b.kind === 'merge') {
        // çµåˆæ ï¼šå…ˆé ­ã‚­ãƒ¼ã ã‘ã‚’ head ã¨ã—ã¦æ‰±ã†
        const headKey = b.keys[0];
        deletePlan.push({ type: 'merge', headKey });
      } else if (b.kind === 'single') {
        const key = b.keys[0];
        deletePlan.push({ type: 'single', key });
      }
    }
  } else {
    // 2) é€šå¸¸ã®å˜æ  / çµåˆæ  1ã¤ã ã‘ã® cut
    const el = getActiveSlot?.(); 
    if (!el) return;

    const key = el.dataset.key;
    const rec = storeNow[key];
    if (!rec) return;

    // ã¾ãšå˜æ /çµåˆæ ã¨ã—ã¦ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
    copySlotOrMerge();   // ã“ã“ã§ appClipboard.type = 'single' or 'merge'

    if (rec.head && Number(rec.span || 1) > 1) {
      // çµåˆæ  head
      deletePlan.push({ type: 'merge', headKey: key });
    } else {
      // å˜æ 
      deletePlan.push({ type: 'single', key });
    }
  }

  if (deletePlan.length === 0) return;

  // --- ã“ã“ã‹ã‚‰å…ˆã‚’ 1 ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¨ã—ã¦ Undo ã§ãã‚‹ã‚ˆã†ã«ã¾ã¨ã‚ã‚‹ ---
  beginUndoBatch();
  try {
    const st = loadWeek(currentMonday);

    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç¶­æŒç”¨ã®æƒ…å ±ã‚’å…ˆã«è¨˜éŒ²
    const wasFocus = document.body.classList.contains('dayFocus');
    const focusedDayEl = document.querySelector('.day[data-focus="true"]');
    const focusedDayKey =
      focusedDayEl?.dataset?.day ??
      focusedDayEl?.querySelector('.day-header-date')?.textContent?.trim() ?? null;
    const lastKeyBefore = window.lastSelectedKey || null;

    // --- å®Ÿéš›ã®å‰Šé™¤å‡¦ç† ---
    for (const item of deletePlan) {
      if (item.type === 'merge') {
        const headKey = item.headKey;
        const rec = st[headKey];
        if (!rec) continue;

        // æ‰€è¦æ™‚é–“ã‚¢ãƒ³ã‚«ãƒ¼ã‚’å…ˆã«ç‰‡ä»˜ã‘ã‚‹
        cleanupTimeOverrideOnDelete(headKey, st);

        const span = Math.max(1, Number(rec.span || 1));
        const { d, day, section, idx } = parseKey(headKey);
        for (let i = 0; i < span; i++) {
          const k = `${d}|${day}|${section}|${idx + i}`;
          delete st[k];
        }
      } else if (item.type === 'single') {
        const key = item.key;
        const rec = st[key];
        if (!rec) continue;

        cleanupTimeOverrideOnDelete(key, st);
        delete st[key];
      }
    }
    // â˜… å‰Šé™¤å¾Œï¼šã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¢ãƒ³ã‚«ãƒ¼ã‚’ä¸€æ‹¬ã§çµ„ã¿ç›´ã™
    if (deletePlan.length > 0) {
      const firstKey =
        deletePlan[0].type === 'merge'
          ? deletePlan[0].headKey
          : deletePlan[0].key;
      const { day, section } = parseKey(firstKey);
      rebuildDurationAnchorsForDaySection(day, section, st);
    }
    // è¤‡æ•°é¸æŠã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ã‚¯ãƒªã‚¢
    clearMultiSelection();

    // ä¿å­˜ â†’ å†æç”»ï¼ˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç¶­æŒãƒ‘ã‚¿ãƒ¼ãƒ³ã¯å¾“æ¥ã©ãŠã‚Šï¼‰
    saveWeek(currentMonday, st);
    if (wasFocus) exitDayFocus();
    render();
    if (wasFocus && focusedDayKey){
      let dayEl =
        document.querySelector(`.day[data-day="${CSS.escape(focusedDayKey)}"]`) ||
        Array.from(document.querySelectorAll('.day'))
          .find(d => d.querySelector('.day-header-date')?.textContent?.trim() === focusedDayKey);
      if (dayEl) {
        enterDayFocus(dayEl);
        // å¯èƒ½ãªã‚‰åŒã˜ã‚­ãƒ¼ã¸å†é¸æŠã€ç„¡ã‘ã‚Œã°å½“æ—¥å…ˆé ­
        if (lastKeyBefore){
          const same = dayEl.querySelector(`.slot[data-key="${CSS.escape(lastKeyBefore)}"]`);
          if (same) setActiveSlot(same);
          else ensureInitialSelectionForDay(dayEl);
        } else {
          ensureInitialSelectionForDay(dayEl);
        }
      }
    }
  } finally {
    endUndoBatch();
  }
}



/* ---------- ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼ˆCtrl/Cmd + C/V/X, Delete, Enterï¼‰ ---------- */
document.addEventListener('keydown',(e)=>{
  if(isTypingContext(e)) return;
  
  // â˜… è¿½åŠ ï¼šã‚¨ãƒ‡ã‚£ã‚¿ or è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒé–‹ã„ã¦ã„ã‚‹é–“ã¯
  //    ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼ˆUndo/Redo/Enterç·¨é›†ï¼‰ã‚’ç„¡åŠ¹åŒ–
  {
    const ed = document.getElementById('editor');
    const st = document.getElementById('settings');
    const dialogOpen =
      (ed && (ed.open || ed.classList?.contains('is-open'))) ||
      (st && (st.open || st.classList?.contains('is-open')));
    if (dialogOpen) return;
  }
  
  const k = e.key.toLowerCase();

  if((e.ctrlKey||e.metaKey) && k==='c'){ e.preventDefault(); copySlotOrMerge(); }
  if((e.ctrlKey||e.metaKey) && k==='v'){ e.preventDefault(); pasteToActive({flip:e.shiftKey}); }
  if((e.ctrlKey||e.metaKey) && k==='x'){ e.preventDefault(); cutActive(); }

  if(k==='delete' || k==='backspace'){
    e.preventDefault();
    const el = getActiveSlot?.(); if(!el) return;

  // ============================================
  // ğŸ”µ è¤‡æ•°é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆï¼šã¾ã¨ã‚ã¦å‰Šé™¤
  // ============================================
  if (multiSelected && multiSelected.size >= 2) {
    const keysToDelete = Array.from(multiSelected);
    if (!window.confirm(`é¸æŠã•ã‚ŒãŸ ${keysToDelete.length} æ ã‚’ã¾ã¨ã‚ã¦å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
      return;
    }

    beginUndoBatch();
    try {
      const st = loadWeek(currentMonday) || {};
      let anyHeadKey = null;

      for (const k of keysToDelete) {
        const rec = st[k];
        if (!rec) continue;

        // head ã‚’ç‰¹å®šã™ã‚‹ï¼ˆçµåˆæ å‰æï¼‰
        const { d, day, section, idx } = parseKey(k);
        const baseEl = document.querySelector(`.slot[data-key="${k}"]`);
        const headEl = (function resolveHead(n){
          let p = n;
          while (p && p.classList && p.classList.contains('slot')) {
            if (p.classList.contains('mergeHead')) return p;
            if (!p.classList.contains('hiddenRow')) return p;
            p = p.previousElementSibling;
          }
          return n;
        })(baseEl);

        const headKey = headEl?.dataset?.key;
        if (!headKey) continue;
        if (!anyHeadKey) anyHeadKey = headKey;

        // span ã‚’å–å¾—
        function getSpan(h){
          const s = h && h.style ? h.style.gridRowEnd : '';
          const m = s && s.match(/span\s+(\d+)/i);
          if (m){ const n = parseInt(m[1],10); if (Number.isFinite(n) && n>0) return n; }
          const d = h && h.dataset ? h.dataset : {};
          const raw = d.span || d.mergeSpan;
          const n2 = parseInt(raw,10);
          return (Number.isFinite(n2) && n2>0) ? n2 : 1;
        }

        const span = getSpan(headEl);

        // head + tail ã‚’å‰Šé™¤
        for (let i = 0; i < span; i++) {
          const key2 = `${d}|${day}|${section}|${idx + i}`;
          delete st[key2];
        }
      }

      // time override ã‚’ã¾ã¨ã‚ã¦å†æ§‹ç¯‰ï¼ˆä»£è¡¨ headKey ã‚’ä½¿ç”¨ï¼‰
      if (anyHeadKey && typeof autoRebuildTimeOverridesForSectionAfterDelete === 'function') {
        autoRebuildTimeOverridesForSectionAfterDelete(anyHeadKey, st);
      }

      saveWeek(currentMonday, st);
      preserveScrollWhile(()=> render());
      clearMultiSelection();

    } finally {
      endUndoBatch();
    }

    return; // â† ä¸€æ‹¬å‰Šé™¤ã¯ã“ã“ã§å‡¦ç†çµ‚äº†
  }
    // ============================
    // ğŸ”µ RLã‚»ãƒƒãƒˆé¸æŠä¸­ãªã‚‰ã‚»ãƒƒãƒˆå‰Šé™¤
    // ============================
    const storeForDel = loadWeek(currentMonday);
    if (window.currentRLSetId && typeof findRLSetRangeForSlot === 'function') {
      const info    = findRLSetRangeForSlot(el, storeForDel);
      const baseRec = info && storeForDel[info.baseKey];
      const rlId    = baseRec?.meta?.rlSetId;

      // ç¾åœ¨ã® RL ã‚»ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¨ä¸€è‡´ã—ã¦ã„ã¦ã€R/L 2ãƒ˜ãƒƒãƒ‰ä»¥ä¸Šã‚ã‚‹ã¨ãã ã‘ç™ºå‹•
      if (info && rlId && rlId === window.currentRLSetId && info.keys && info.keys.length > 1) {
        if (!window.confirm('ã“ã®RLã‚»ãƒƒãƒˆã‚’ã¾ã¨ã‚ã¦å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
          return;
        }

        beginUndoBatch();
        try {
          for (const headKey of info.keys) {
            const rec = storeForDel[headKey];
            if (!rec) continue;

            const span = rec.head ? Math.max(1, Number(rec.span || 1)) : 1;

            // æ‰€è¦æ™‚é–“ã‚¢ãƒ³ã‚«ãƒ¼ã®ç‰‡ä»˜ã‘
            if (typeof cleanupTimeOverrideOnDelete === 'function') {
              cleanupTimeOverrideOnDelete(headKey, storeForDel);
            }

            const { d, day, section, idx } = parseKey(headKey);
            for (let i = 0; i < span; i++) {
              const k2 = `${d}|${day}|${section}|${idx + i}`;
              delete storeForDel[k2];
            }
          }

          // time override ã®å†æ§‹ç¯‰
          if (typeof autoRebuildTimeOverridesForSectionAfterDelete === 'function') {
            autoRebuildTimeOverridesForSectionAfterDelete(info.keys[0], storeForDel);
          }

          saveWeek(currentMonday, storeForDel);
          preserveScrollWhile(() => render());

          // RLã‚»ãƒƒãƒˆé¸æŠçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
          if (typeof clearMultiSelection === 'function') {
            clearMultiSelection();
          }
          window.currentRLSetId = null;

        } finally {
          endUndoBatch();
        }
        return; // RLã‚»ãƒƒãƒˆå‰Šé™¤ã¯ã“ã“ã§çµ‚äº†
      }
    }

    // â˜… ã“ã“ã§ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ã¯ã•ã‚€
    if (!window.confirm('ã“ã®æ ã®å†…å®¹ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
      return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãªã‚‰ä½•ã‚‚ã—ãªã„
    }
	
    // â˜… ã“ã®å‰Šé™¤æ“ä½œå…¨ä½“ã‚’ã€ŒUndo 1ã‚¹ãƒ†ãƒƒãƒ—ã€ã«ã¾ã¨ã‚ã‚‹
    beginUndoBatch();
    try { 
 
     // 1) head ã‚’ç‰¹å®šï¼ˆtail ã‚’é¸ã‚“ã§ã„ã¦ã‚‚å·»ãæˆ»ã™ï¼‰
     const head = (function resolveHead(n){
       let p = n;
       while (p && p.classList && p.classList.contains('slot')){
         if (p.classList.contains('mergeHead')) return p; // æ˜ç¤º head
         if (!p.classList.contains('hiddenRow')) return p; // å˜ç‹¬ï¼headæ‰±ã„
         p = p.previousElementSibling;
       }
       return n;
     })(el);
 
     // 2) span ã‚’å–å¾—ï¼ˆstyle > dataset > æ—¢å®š1ï¼‰
     function getSpan(h){
       const s = h && h.style ? h.style.gridRowEnd : '';
       const m = s && s.match(/span\s+(\d+)/i);
       if (m){ const n = parseInt(m[1],10); if (Number.isFinite(n) && n>0) return n; }
       const d = h && h.dataset ? h.dataset : {};
       const raw = d.span || d.mergeSpan;
       const n2 = parseInt(raw,10);
       return (Number.isFinite(n2) && n2>0) ? n2 : 1;
     }
     const span = getSpan(head);
 
     // 3) é€±ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿ã€head ã¨ tail å…¨éƒ¨ã®ã‚­ãƒ¼ã‚’å‰Šé™¤
     const st = loadWeek(currentMonday);
     const headKey = head?.dataset?.key || null;
     // â€» ã“ã®æ™‚ç‚¹ã§ã¯ time override ã¯ã¾ã è§¦ã‚‰ãªã„ï¼ˆautoRebuild ã«ä¸€ä»»ï¼‰
 	 
     if (head.dataset && head.dataset.key) delete st[head.dataset.key];
     let p = head.nextElementSibling;
     for (let i=1; i<span && p; i++){
       if (!(p.classList && p.classList.contains('slot'))) break;
       // tail å´ã® state ã‚‚æ¶ˆã™ï¼ˆâ†ã“ã‚ŒãŒè‚ï¼‰
       if (p.dataset && p.dataset.key) delete st[p.dataset.key];
       // 4) DOM ä¸Šã‚‚ hiddenRow ã‚’å…ˆã«å¤–ã—ã¦ãŠãï¼ˆæƒé™¤ã§æ¶ˆã•ã‚Œã‚‹ã®ã‚’é˜²æ­¢ï¼‰
       p.classList.remove('hiddenRow');
       p = p.nextElementSibling;
     }
     // head ã®çµåˆè¡¨ç¤ºã‚‚å¤–ã™ï¼ˆä»»æ„ï¼šè¦‹ãŸç›®ã®ãƒãƒ©ã¤ãæŠ‘æ­¢ï¼‰
     head.classList.remove('mergeHead');
     if (head.style) head.style.gridRowEnd = '';
     if (head.dataset){ delete head.dataset.span; delete head.dataset.mergeSpan; }
 
      // â˜… 4. åŒã˜æ—¥ãƒ»åŒã˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã® time override ã‚’ã“ã“ã§ä¸¸ã”ã¨çµ„ã¿ç›´ã™
      if (headKey){
        autoRebuildTimeOverridesForSectionAfterDelete(headKey, st);
      }
 
      // 5) ä¿å­˜â†’å†æç”»ï¼ˆapplyMerges ã¯ã‚‚ã† tail ã‚’éš ã›ãªã„ï¼‰
      saveWeek(currentMonday, st);
      preserveScrollWhile(()=> render());
    } finally {
      endUndoBatch();
    }	  
  }

if(k==='enter'){
  e.preventDefault();
  // â˜… RLã‚»ãƒƒãƒˆå¤–å‘¨é¸æŠä¸­ã¯ Enter ç·¨é›†ã‚’ç„¡åŠ¹åŒ–
  //   â†’ ã©ã¡ã‚‰ã‹ã®æ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å˜æ é’æ ã«ã—ã¦ã‹ã‚‰ Enter ã—ã¦ã‚‚ã‚‰ã†
  if (window.currentRLSetId && document.querySelector('.slot.multiSelected')) {
    return;
  }

  const el = getActiveSlot?.() || document.querySelector('.slot');
  if(!el) return;

  // â˜… ç¥æ—¥/ä¼‘æ­¢ã‚¬ãƒ¼ãƒ‰ã‚’è¿½åŠ 
  if (isSlotLockedForEdit(el)) {
    // å¿…è¦ãªã‚‰æ¡ˆå†…ã‚’å‡ºã™
    // alert('ã“ã®æ ã¯ç¥æ—¥/ä¼‘æ­¢ã®ãŸã‚ç·¨é›†ã§ãã¾ã›ã‚“');
    return;
  }

  openEditor([el.dataset.key]);
}
}, true);

 <!-- Ctrl+â†ï¼â†’ çµ±åˆãƒãƒ³ãƒ‰ãƒ©ï¼šé€±ï¼å‰é€±/æ¬¡é€±ã€ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ï¼å‰æ—¥/ç¿Œæ—¥ -->
 (()=> {
   if (window.__bindCtrlArrowsUnified) return; window.__bindCtrlArrowsUnified = true;
 
   const isEditable = (t)=>{ const tag=t?.tagName?.toLowerCase(); return tag==='input'||tag==='textarea'||t?.isContentEditable; };
   const isDialogOpen = ()=> {
     const ed=document.getElementById('editor'), st=document.getElementById('settings');
     return !!((ed&&(ed.open||ed.classList?.contains('is-open'))) || (st&&(st.open||st.classList?.contains('is-open'))));
   };
   const z = n => String(n).padStart(2,'0');
   const ymd = d => `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;
 
   document.addEventListener('keydown', (e)=>{
     if (!e.ctrlKey) return;
     const isLeft  = (e.key === 'ArrowLeft');
     const isRight = (e.key === 'ArrowRight');
     if (!(isLeft || isRight)) return;
     if (isEditable(e.target) || isDialogOpen()) return;
 
     const dir = isRight ? +1 : -1; // é€±ï¼šÂ±7æ—¥ / ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ï¼šÂ±1æ—¥
 
     // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒ¢ãƒ¼ãƒ‰ï¼šå‰æ—¥/ç¿Œæ—¥
     if (document.body.classList.contains('dayFocus')) {
       const hasJump = (typeof window.jumpFocusTo === 'function');
       const getFd   = (typeof window.getFocusDate === 'function') ? window.getFocusDate : null;
       let d = getFd ? getFd() : null;
       if (!(d instanceof Date) || isNaN(+d)) {
         const wp=document.getElementById('weekPicker');
         if (wp?.value){ const [y,m,dd]=wp.value.split('-').map(Number); d=new Date(y,m-1,dd); }
         else d = new Date();
       }
       d.setDate(d.getDate() + dir);
       if (typeof window.snapWeekendDir === 'function') d = window.snapWeekendDir(d, dir);
       e.preventDefault(); e.stopImmediatePropagation();
       if (hasJump){
         window.jumpFocusTo(d, dir);
       } else {
         // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã¯é€±ãƒœã‚¿ãƒ³ãŒã€Œå‰æ—¥/ç¿Œæ—¥ã€ã«ç½®æ›ã•ã‚Œã¦ã„ã‚‹
         const btn = document.getElementById(dir > 0 ? 'nextWeek' : 'prevWeek');
         btn?.click();
       }
       return;
     }
 
     // é€±ãƒ¢ãƒ¼ãƒ‰ï¼šå‰é€±/æ¬¡é€±
     const wp = document.getElementById('weekPicker'); if (!wp) return;
     const base = (window.currentMonday instanceof Date)
       ? new Date(window.currentMonday)
       : (wp.value ? new Date(wp.value) : new Date());
     base.setDate(base.getDate() + (dir * 7));
     e.preventDefault(); e.stopImmediatePropagation();
     // â† åŸºæº–é€±ã‚’å³æ™‚æ›´æ–°ã—ã¦â€œç¾åœ¨ã®é€±â€ã‚’æ­£ã—ãè¿½å¾“ã•ã›ã‚‹
     window.currentMonday = new Date(base.getFullYear(), base.getMonth(), base.getDate());	 
     wp.value = ymd(base);
    // â˜… é€±ç§»å‹•ç›´å¾Œã®ä¸­å¤®å¯„ã›æŠ‘æ­¢ï¼ˆé€£ç¶šrenderä¿é™ºã¨ã—ã¦+2ï¼‰
    window.__suppressCenterN = (window.__suppressCenterN|0) + 2;
    window.__snapTopOnNextRender = true;
    window.__snapTopTargetISO   = ymd(base); // base ã¯æœˆæ›œï¼ˆcurrentMondayåŸºæº–ï¼‹7/âˆ’7ï¼‰	
    wp.dispatchEvent(new Event('change', { bubbles:true }));
    window.__postWeekMoveCenter?.();	 
   }, { capture:true });
 })();

 <!-- Ctrlï¼‹.ï¼šé€±è¡¨ç¤ºâ†’ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è¡¨ç¤ºã§ä»Šæ—¥ã«ã‚¸ãƒ£ãƒ³ãƒ— -->
 (() => {
   if (window.__bindCtrlDotFocus) return; window.__bindCtrlDotFocus = true;
 
   const isEditable = t => { const tag = t?.tagName?.toLowerCase(); return tag==='input'||tag==='textarea'||t?.isContentEditable; };
   const isDialogOpen = () => {
     const ed = document.getElementById('editor'), st = document.getElementById('settings');
     return !!((ed&&(ed.open||ed.classList?.contains('is-open'))) || (st&&(st.open||st.classList?.contains('is-open'))));
   };
 
   document.addEventListener('keydown', e => {
     if (!(e.ctrlKey && e.key === '.')) return;
     if (isEditable(e.target) || isDialogOpen()) return;
 
     e.preventDefault(); e.stopImmediatePropagation();
 
     // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è¡¨ç¤ºã¸ç¢ºå®Ÿã«åˆ‡æ›¿ã—ã¦ã€Œä»Šæ—¥ã€ã«åˆã‚ã›ã‚‹
     (async ()=>{
       const today = new Date();
       if (typeof window.jumpFocusTo === 'function') {
         window.jumpFocusTo(today, 0);
         return;
       }
       // â–¼ jumpFocusTo ãŒã‚°ãƒ­ãƒ¼ãƒãƒ«ã§ä½¿ãˆãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
       const z = n => String(n).padStart(2,'0');
       const ymd = d => `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;
       // æœˆæ›œå§‹ã¾ã‚Šã®å½“é€±ï¼ˆæœˆæ›œ=0..æ—¥æ›œ=6ï¼‰
       const mon0 = (d)=> (d.getDay()+6)%7;
       const mondayOf = (d)=>{ const t=new Date(d.getFullYear(),d.getMonth(),d.getDate()); t.setDate(t.getDate()-mon0(t)); return t; };
 
       // 1) å½“é€±ã¸åˆã‚ã›ã¦å†æç”»
       const needWeek = !(window.currentMonday instanceof Date) ||
                        window.currentMonday.getTime() !== mondayOf(today).getTime();
       if (needWeek){
         window.currentMonday = mondayOf(today);
         if (typeof window.render === 'function') window.render();
         // DOMç¢ºå®šã‚’2ãƒ•ãƒ¬ãƒ¼ãƒ å¾…ã¤
         await new Promise(r => requestAnimationFrame(()=>requestAnimationFrame(r)));
       }
       // 2) ä»Šæ—¥ã®åˆ—ã‚’ç‰¹å®šã—ã¦ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã¸
       const days = document.querySelectorAll('.day');
       const idx  = Math.min(mon0(today), Math.max(0, days.length-1));
       const hit  = days[idx];
       if (hit && typeof window.enterDayFocus === 'function') {
         window.enterDayFocus(hit);
       }
       document.body.classList.add('dayFocus'); // å¿µã®ãŸã‚
       // 3) ãƒ”ãƒƒã‚«ãƒ¼/æ›œæ—¥ãƒãƒƒã‚¸ã‚’åŒæœŸ
       const picker = document.getElementById('weekPicker');
       if (picker){ picker.value = ymd(today); picker.dispatchEvent(new Event('change',{bubbles:true})); }
       window.__setWeekdayFromISO?.(ymd(today));
	   window.__postWeekMoveCenter?.();   
     })();
   }, { capture:true });
 })();

 <!-- Ctrlï¼‹,ï¼šä»Šé€±ã¸ï¼ˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹ä¸­ã¯é€±è¡¨ç¤ºã«æˆ»ã™ï¼‰ -->
 (()=> {
   if (window.__bindCtrlCommaWeek) return; window.__bindCtrlCommaWeek = true;
   const isEditable = t => { const tag=t?.tagName?.toLowerCase(); return tag==='input'||tag==='textarea'||t?.isContentEditable; };
   const isDialogOpen = () => {
     const ed=document.getElementById('editor'), st=document.getElementById('settings');
     return !!((ed&&(ed.open||ed.classList?.contains('is-open'))) || (st&&(st.open||st.classList?.contains('is-open'))));
   };
   const z = n => String(n).padStart(2,'0');
   const ymd = d => `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;
   const mondayOf = (d)=>{ const t=new Date(d.getFullYear(),d.getMonth(),d.getDate()); t.setDate(t.getDate()-((t.getDay()+6)%7)); return t; };
 
   document.addEventListener('keydown', (e)=>{
     if (!(e.ctrlKey && e.key === ',')) return;
     if (isEditable(e.target) || isDialogOpen()) return;
     const picker = document.getElementById('weekPicker'); if (!picker) return;
 
     e.preventDefault(); e.stopImmediatePropagation();
     // ä»Šæ—¥ï¼ˆå¿…è¦ãªã‚‰é€±æœ«ã‚¹ãƒŠãƒƒãƒ—ï¼‰
     let today = new Date();
     if (typeof window.snapWeekendDir === 'function') today = window.snapWeekendDir(today, 0);
     // â–¼ ä»Šé€±ã®ã€Œæœˆæ›œã€ã‚’å³å¯†ã«ç®—å‡º
     const mon = mondayOf(today);
 
    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ä¸­ãªã‚‰é€±è¡¨ç¤ºã¸æˆ»ã™ï¼ˆä¸Šå¯„ã›ï¼‹å…ˆé ­é¸æŠã‚’äºˆç´„ï¼å¾©å…ƒã‚¹ã‚­ãƒƒãƒ—ï¼‰
     if (document.body.classList.contains('dayFocus')) {
      // â˜… é€±ç§»å‹•ç›´å¾Œã®ä¸­å¤®å¯„ã›æŠ‘æ­¢ï¼†â€œæœ€ä¸Šéƒ¨ã‚¹ãƒŠãƒƒãƒ—â€ã‚’äºˆç´„
      window.__suppressCenterN = (window.__suppressCenterN|0) + 2;
      window.__snapTopOnNextRender = true;
      window.__snapTopTargetISO   = ymd(mon);
      // â˜… ä»Šé€±ã®å…ˆé ­â€œé¸æŠå¯èƒ½â€æ ã®é¸æŠã‚‚äºˆç´„
      window.__selectFirstOnNextRender = true;	  
      // â˜… ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¾©å…ƒãƒ­ã‚¸ãƒƒã‚¯ã¯èµ°ã‚‰ã›ãªã„ï¼ˆä¸Šå¯„ã›ã«å§”ã­ã‚‹ï¼‰
      window.__skipRestoreOnExit = true;
      if (typeof window.exitDayFocus === 'function') window.exitDayFocus();
      else document.body.classList.remove('dayFocus');
     }
     // ä»Šé€±ã¸ï¼šãƒ”ãƒƒã‚«ãƒ¼ã‚‚ currentMonday ã‚‚â€œæœˆæ›œâ€ã§çµ±ä¸€ã—ã¦ã‹ã‚‰ change ç™ºç«
     window.currentMonday = mon;
     picker.value = ymd(mon);                  // â† æœ¬æ—¥ã®æ›œæ—¥ã§ã¯ãªãâ€œä»Šé€±ã®æœˆæ›œâ€ã‚’ã‚»ãƒƒãƒˆ
    // â˜… é€±è¡¨ç¤ºæ™‚ã‚‚åŒæ§˜ã«ã€Œæœ€ä¸Šéƒ¨ã‚¹ãƒŠãƒƒãƒ—ï¼‹å…ˆé ­é¸æŠã€ã‚’äºˆç´„
    window.__suppressCenterN      = (window.__suppressCenterN|0) + 2;
    window.__snapTopOnNextRender  = true;
    window.__snapTopTargetISO     = ymd(mon);
    window.__selectFirstOnNextRender = true;
    // â˜… å¤ã„é¸æŠã®å¾©å…ƒã‚’æŠ‘æ­¢ï¼ˆåŒé€±ãƒªãƒ¬ãƒ³ãƒ€æ™‚ã®å†é©ç”¨ã‚’é˜²ãï¼‰
    window.lastSelectedKey = null;
    if (window.__slotCursor) window.__slotCursor.activeSlotEl = null;
    document.querySelector('.slot.focused')?.classList?.remove('focused');
     picker.dispatchEvent(new Event('change', { bubbles:true }));
     // æ›œæ—¥ãƒãƒƒã‚¸ç­‰ã¯ã€Œä»Šæ—¥ã€ã‚’ç¤ºã—ãŸã„å ´åˆã®ã¿ä»»æ„ã§åŒæœŸ
     window.__setWeekdayFromISO?.(ymd(today));	 
   }, { capture:true });
 })();

 (function bindArrowNavOnce(){
   if (window.__slotNavBound) return; window.__slotNavBound = true;

  // --- åˆæœŸè‡ªå‹•é¸æŠï¼š.focused ãŒç„¡ã‘ã‚Œã°ã€å·¦ä¸Šã‹ã‚‰æœ€åˆã®é¸æŠå¯èƒ½ã‚¹ãƒ­ãƒƒãƒˆã‚’é’æ ã«ã™ã‚‹ ---
  function ensureInitialSelectionGlobal(){
    if (document.querySelector('.slot.focused')) return; // æ—¢ã«é’æ ãŒã‚ã‚Œã°ä½•ã‚‚ã—ãªã„
    const days = Array.from(document.querySelectorAll('.day'));
    for (const d of days){
      const first = window.findFirstSelectableInDay?.(d);
      if (first) { window.setActiveSlot(first, {scroll:false}); return; }
    }
  }
  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
  if (document.readyState !== 'loading') { ensureInitialSelectionGlobal(); }
  document.addEventListener('DOMContentLoaded', ensureInitialSelectionGlobal, {once:true});
  window.addEventListener('load', ensureInitialSelectionGlobal, {once:true});
  // é€±å¤‰æ›´å¾Œï¼ˆrender ç­‰ã®ç›´å¾Œã«ãªã‚‹ã‚ˆã†ã€ã‚¼ãƒ­é…å»¶ã§ã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°ï¼‰
  (function(){
    const wp = document.getElementById('weekPicker');
    if (!wp) return;
    wp.addEventListener('change', ()=> setTimeout(ensureInitialSelectionGlobal, 0));
  })();  
   document.addEventListener('keydown', (e)=>{
    if (e.defaultPrevented) return;
    if (e.key !== 'ArrowUp' && e.key !== 'ArrowDown') return;
    // CtrlæŠ¼ä¸‹æ™‚ãƒ»å…¥åŠ›ä¸­ãƒ»ãƒ€ã‚¤ã‚¢ãƒ­ã‚°é–‹ä¸­ã¯ç„¡åŠ¹åŒ–ï¼ˆã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼ç·¨é›†å„ªå…ˆï¼‰
    if (e.ctrlKey) return;
    const t = e.target, tag = t?.tagName?.toLowerCase();
    if (tag==='input' || tag==='textarea' || t?.isContentEditable) return;
    const ed=document.getElementById('editor'), st=document.getElementById('settings');
    if ((ed&&(ed.open||ed.classList?.contains('is-open'))) ||
        (st&&(st.open||st.classList?.contains('is-open')))) return;
 
     const inFocus = document.body.classList.contains('dayFocus');
     let cur = getActiveSlot?.();
 
     // æœªé¸æŠã®ã¨ãï¼šè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦å½“æ—¥å…ˆé ­/é€±ã®æ—¢å®šæ—¥å…ˆé ­ã‚’é¸ã¶
     if (!cur) {
       if (inFocus) {
         const dayEl = document.querySelector('.day[data-focus="true"]');
         if (dayEl) ensureInitialSelectionForDay(dayEl);
         cur = getActiveSlot?.();
       } else {
        // é€±è¡¨ç¤ºï¼šé’æ ãŒç„¡ã‘ã‚Œã°å…¨ä½“ã®å·¦ä¸Šã‹ã‚‰åˆæœŸè‡ªå‹•é¸æŠ
        ensureInitialSelectionGlobal();
        cur = getActiveSlot?.();
       }
       if (!cur) return; // ã¾ã ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
     }
 
     // ä¸Šä¸‹ç§»å‹•ï¼šé€±ãƒ¢ãƒ¼ãƒ‰ã§ã¯æ—¥ã¾ãŸãã‚ã‚Šã€ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã§ã¯åŒæ—¥ã§æ­¢ã¾ã‚‹
     e.preventDefault();
     const delta = (e.key === 'ArrowDown' ? +1 : -1);
     moveVertWithCrossDay(cur, delta);
   });
 })();
  </script>
  <script>
(function(){
  const JP = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];

  function ensureBadge(){
    const picker = document.getElementById('weekPicker');
    if (!picker) return null;
    let badge = document.getElementById('weekPickerWeekday');
    if (!badge) {
      badge = document.createElement('span');
      badge.id = 'weekPickerWeekday';
      picker.insertAdjacentElement('afterend', badge);
    }
    return badge;
  }

function setWeekdayFromISO(iso){
  const badge = ensureBadge();
  if (!badge || !iso) return;
  const [y,m,d] = iso.split('-').map(Number);
  const dt = new Date(Number(y), Number(m) - 1, Number(d), 12, 0, 0, 0);
  dt.setHours(12,0,0,0); // â† ã“ã®è¡Œã‚’è¿½åŠ ï¼ˆæ­£åˆå›ºå®šï¼‰
  if (!isNaN(dt)) badge.textContent = `ï¼ˆ${JP[dt.getDay()]}ï¼‰`;
}



  // ãƒ”ãƒƒã‚«ãƒ¼æ“ä½œã§ã‚‚æ›´æ–°
  const picker = document.getElementById('weekPicker');
  if (picker) {
  picker.addEventListener('input',  () => {
    if (window.__suppressWeekChange) return;
    window.__setWeekdayFromISO?.(document.getElementById('weekPicker')?.value);
  });
  picker.addEventListener('change', () => {
    if (window.__suppressWeekChange) return;
    window.__setWeekdayFromISO?.(document.getElementById('weekPicker')?.value);
  });
    // åˆæœŸè¡¨ç¤º
    setWeekdayFromISO(picker.value);
  }

  // ä»–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰ä½¿ãˆã‚‹ã‚ˆã†ã«å…¬é–‹ï¼ˆ1è¡Œå‘¼ã¶ã ã‘ï¼‰
  window.__setWeekdayFromISO = setWeekdayFromISO;
})();

 // ===== ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒ¢ãƒ¼ãƒ‰ä¸­ã«ã€Œé€±ãƒœã‚¿ãƒ³/ãƒ”ãƒƒã‚«ãƒ¼ã€ã‚’æ—¥ç§»å‹•ã«åˆ‡ã‚Šæ›¿ãˆã‚‹æ‹¡å¼µ =====
(()=> {
  // ---- ãƒœã‚¿ãƒ³ï¼ãƒ”ãƒƒã‚«ãƒ¼ ----
  const $prev   = document.getElementById('prevWeek');
  const $next   = document.getElementById('nextWeek');
  const $today  = document.getElementById('todayBtn');
  const $picker = document.getElementById('weekPicker');
  if (!$prev || !$next || !$today || !$picker) return;

  // ---- çŠ¶æ…‹åˆ¤å®šï¼ˆå½“åˆã†ã¾ãã„ã£ã¦ã„ãŸè»½é‡ç‰ˆï¼‰----
  const inDayFocus = () =>
    document.body.classList.contains('dayFocus');

  // ---- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ----
  const pad = n => String(n).padStart(2,'0');
  const ymd = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const mon0 = d => (d.getDay() + 6) % 7;     // Mon=0..Sun=6ï¼ˆã‚ãªãŸã®ãƒ«ãƒ¼ãƒ«ï¼‰
  const mondayOf = dt => startOfWeek(dt);     // æ—¢å­˜ã® startOfWeek ã‚’åˆ©ç”¨
   // æ–¹å‘ä»˜ã é€±æœ«ã‚¹ã‚­ãƒƒãƒ—
   // dir: -1=å‰æ—¥æ–¹å‘ / +1=ç¿Œæ—¥æ–¹å‘ / 0=ä»Šæ—¥ï¼ˆé€±æœ«ã¯æœˆæ›œã¸å¯„ã›ã‚‹ï¼‰
   const snapWeekendDir = (date, dir=0) => {
     const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
     const wd = d.getDay(); // 0:Sun ... 6:Sat
     if (dir > 0) {               // ç¿Œæ—¥æ–¹å‘ï¼šFri(+1)=>Satâ†’Mon / Satâ†’Mon / Sunâ†’Mon
       if (wd === 6) d.setDate(d.getDate()+2); // Sat -> Mon
       else if (wd === 0) d.setDate(d.getDate()+1); // Sun -> Mon
     } else if (dir < 0) {        // å‰æ—¥æ–¹å‘ï¼šMon(-1)=>Sunâ†’Fri / Sunâ†’Fri / Satâ†’Fri
       if (wd === 0) d.setDate(d.getDate()-2); // Sun -> Fri
       else if (wd === 6) d.setDate(d.getDate()-1); // Sat -> Fri
     } else {                     // ä»Šæ—¥ãƒœã‚¿ãƒ³ãªã©ï¼šé€±æœ«ã¯å–¶æ¥­æ—¥ã«å¯„ã›ã‚‹ï¼ˆSun->Mon / Sat->Friï¼‰
       if (wd === 0) d.setDate(d.getDate()+1); // Sun -> Mon
       if (wd === 6) d.setDate(d.getDate()-1); // Sat -> Fri
     }
     return d;
   };
  const sameWeek = (a,b) => mondayOf(a).getTime() === mondayOf(b).getTime();

  // ---- ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ—¥ã‚¹ãƒˆã‚¢ ----
  function getFocusDate(){
    if (window.currentFocusDate instanceof Date) return new Date(window.currentFocusDate);
    if ($picker.value){ const [y,m,d]= $picker.value.split('-').map(Number); return new Date(y,m-1,d); }
    return new Date();
  }
  function setFocusDateStore(d){
    window.currentFocusDate = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  }

  // ---- æ—¢å­˜ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å°ã‚’å¿…ãšã‚¯ãƒªã‚¢ï¼ˆå¤šé‡ãƒ•ã‚©ãƒ¼ã‚«ã‚¹é˜²æ­¢ï¼‰----
  function clearFocusedDays(){
    document.querySelectorAll('.day[data-focus="true"]').forEach(el => el.removeAttribute('data-focus'));
  }

  // ---- ãƒ©ãƒ™ãƒ«åˆ‡æ›¿ï¼ˆå½“åˆã®æ–¹å¼ï¼‰----
  function updateLabels(){
    const prev  = document.getElementById('prevWeek');
    const next  = document.getElementById('nextWeek');
    const today = document.getElementById('todayBtn');
    if (!prev || !next || !today) return;
    if (inDayFocus()){
      prev.textContent  = 'Â« å‰æ—¥';
      next.textContent  = 'ç¿Œæ—¥ Â»';
      today.textContent = 'ä»Šæ—¥';
    } else {
      prev.textContent  = 'Â« å‰é€±';
      next.textContent  = 'æ¬¡é€± Â»';
      today.textContent = 'ä»Šé€±';
    }
  }
  new MutationObserver(updateLabels).observe(document.body, {attributes:true, attributeFilter:['class']});
  updateLabels();

  // ---- æ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼ dblclick ã§ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã«å…¥ã£ãŸç¬é–“ã€å½“æ—¥ã‚’ä¿å­˜ï¼†ãƒ”ãƒƒã‚«ãƒ¼åŒæœŸ ----
  document.addEventListener('dblclick', (e)=>{
    const hdr = e.target.closest('.day-header-date, .day-header, .date, .date-cell, .day-title, .hdr');
    if (!hdr) return;
    const m = (hdr.textContent||'').match(/(\d{4})\/(\d{2})\/(\d{2})/);
    if (m){
      const d = new Date(+m[1], +m[2]-1, +m[3]);
      setFocusDateStore(d);
      if (inDayFocus()) $picker.value = ymd(d);
      requestAnimationFrame(updateLabels);
    }
  }, true);

  // ---- ã‚³ã‚¢ï¼šæ—¥ã‚¸ãƒ£ãƒ³ãƒ—ï¼ˆé€±è·¨ãOKãƒ»é€±æœ«ã‚¹ã‚­ãƒƒãƒ—ãƒ»å¸¸ã«æ—¥ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç¶­æŒï¼‰----
   async function jumpFocusTo(targetDate, dir=0){
    let target = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate());
     target = snapWeekendDir(target, dir);         // æ–¹å‘ä»˜ãã§é€±æœ«è£œæ­£
    setFocusDateStore(target);

    // 1) é€±ãŒå¤‰ã‚ã‚‹ãªã‚‰ currentMonday ã‚’æ›´æ–°ã—ã¦æ—¢å­˜ã® render() å®Ÿè¡Œ
    if (!sameWeek(target, currentMonday)) {
      currentMonday = mondayOf(target);
	  currentMonday = mondayOf(target);
      render();
      // DOMç¢ºå®šå¾…ã¡ï¼ˆ2ãƒ•ãƒ¬ãƒ¼ãƒ ï¼‰
      await new Promise(r => requestAnimationFrame(()=> requestAnimationFrame(r)));
    }

    // 2) å¯¾è±¡åˆ—ã‚’ index ã§å–å¾—ï¼ˆMon=0.. â†’ days.length ã«ã‚¯ãƒªãƒƒãƒ—ï¼‰
    clearFocusedDays();
    const days = document.querySelectorAll('.day');
    let idx = mon0(target);
    idx = Math.min(Math.max(0, idx), Math.max(0, days.length-1));
    const hit = days[idx];
    if (!hit){ exitDayFocus(); return; }

    // 3) ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è¡¨ç¤ºã«ã™ã‚‹
    enterDayFocus(hit);                            // æ—¢å­˜ã®é–¢æ•°ã‚’ãã®ã¾ã¾ä½¿ã†
    document.body.classList.add('dayFocus'); // å¿µã®ãŸã‚

    // 4) å®Ÿéš›ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹â€œãã®åˆ—ã®æ—¥ä»˜â€ã‚’å³å¯†ã«åæ˜ ï¼ˆãƒ”ãƒƒã‚«ãƒ¼/ã‚¹ãƒˆã‚¢ã‚’æƒãˆã‚‹ï¼‰
    const shown = new Date(currentMonday.getFullYear(), currentMonday.getMonth(), currentMonday.getDate());
    shown.setDate(shown.getDate() + idx);
    setFocusDateStore(shown);
    $picker.value = ymd(shown);

    updateLabels();
	window.__setWeekdayFromISO?.(ymd(shown));
  }

  // ---- ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ä¸­ã®ã¿ã€é€±ãƒœã‚¿ãƒ³ã‚’ã€Œå‰æ—¥/ç¿Œæ—¥/ä»Šæ—¥ã€ã«å·®ã—æ›¿ãˆï¼ˆå½“åˆã®ã‚­ãƒ£ãƒ—ãƒãƒ£æ–¹å¼ï¼‰----
  function captureWhenFocus(fn){
    return function(e){
      if (inDayFocus()){
        e.preventDefault();
        e.stopImmediatePropagation();
        fn();
      }
    };
  }
   $prev .addEventListener('click', captureWhenFocus(()=>{ const d=getFocusDate(); d.setDate(d.getDate()-1); jumpFocusTo(d, -1); }), true);
   $next .addEventListener('click', captureWhenFocus(()=>{ const d=getFocusDate(); d.setDate(d.getDate()+1); jumpFocusTo(d, +1); }), true);
   $today.addEventListener('click', captureWhenFocus(()=>{ jumpFocusTo(new Date(), 0); }), true);

  // ---- ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ä¸­ã®ãƒ”ãƒƒã‚«ãƒ¼ï¼šãã®æ—¥ã«ç›´æ¥ã‚¸ãƒ£ãƒ³ãƒ—ï¼ˆé€±ãƒ­ã‚¸ãƒƒã‚¯ã¯é€šã•ãªã„ï¼‰----
   $picker.addEventListener('change', (e)=>{
    if (!inDayFocus()) return;     // é€±ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯æ—¢å­˜ã®é€±ãƒ­ã‚¸ãƒƒã‚¯ã«ä»»ã›ã‚‹
    e.preventDefault();
    e.stopImmediatePropagation();
    const v = $picker.value; if (!v) return;
    const [y,m,d] = v.split('-').map(Number);
     jumpFocusTo(new Date(y, m-1, d), 0);  // ãƒ”ãƒƒã‚«ãƒ¼ã¯ã€Œãã®æ—¥ã€åŸºæº–ã€‚é€±æœ«ã¯å–¶æ¥­æ—¥ã«å¯„ã›ã‚‹
  }, true);
})();

// ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºå¤‰æ›´æ™‚ã«ã‚‚ã‚¹ãƒ­ãƒƒãƒˆè¡¨ç¤ºã‚’å†è¨ˆç®—ã™ã‚‹
(function(){
  let resizeTimer = null;
  window.addEventListener('resize', () => {
    if (resizeTimer) clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
      try {
        paintSlotsFromStore();
      } catch (e) {
        // å¤±æ•—ã—ã¦ã‚‚ã‚¢ãƒ—ãƒªå…¨ä½“ãŒæ­»ãªãªã„ã‚ˆã†ã«ã—ã¦ãŠã
        console && console.warn && console.warn('paintSlotsFromStore error on resize', e);
      }
    }, 200); // é€£ç¶šresizeã‚’å°‘ã—å¾…ã£ã¦ã‹ã‚‰å®Ÿè¡Œ
  });
})();

// ================================
// â˜… JSON ä¿å­˜ï¼èª­ã¿è¾¼ã¿ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
//   - å˜ä¸€ JSON ãƒ•ã‚¡ã‚¤ãƒ«ã§ localStorage ã®ä¸­èº«ã‚’ä¿å­˜ãƒ»å¾©å…ƒ
//   - ãƒ¡ã‚¿æƒ…å ±ï¼ˆä¿å­˜æ—¥æ™‚ãƒ»PCåï¼‰ã‚’è¨˜éŒ²
//   - ç¾åœ¨ã®ã‚¢ãƒ—ãƒªã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«ã¯æ‰‹ã‚’è§¦ã‚Œãªã„
// ================================

// ã“ã®PCã®åå‰ï¼ˆä¾‹ï¼šå¤–æ¥PC1ã€è‡ªå®…PC ãªã©ï¼‰ã‚’ä¿å­˜ãƒ»å–å¾—
function getPcName() {
  let name = localStorage.getItem('__pcName');
  if (!name) {
    name = window.prompt('ã“ã®PCã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šè‡ªå®…PC, å¤–æ¥PC1 ãªã©ï¼‰', '');
    if (name) {
      localStorage.setItem('__pcName', name);
    } else {
      name = '';
    }
  }
  return name;
}

// ç”»é¢å³ä¸Šã®ã€Œæœ€çµ‚ä¿å­˜ï¼šâ€¦ã€è¡¨ç¤ºã‚’æ›´æ–°
function updateSaveInfo(meta) {
  const el = document.getElementById('saveInfo');
  if (!el) return;

  if (!meta) {
    // ä¿å­˜ãƒ¡ã‚¿æƒ…å ±ã‚’ localStorage ã‹ã‚‰å¾©å…ƒã‚’è©¦ã¿ã‚‹
    try {
      const s = localStorage.getItem('__lastMeta');
      if (s) meta = JSON.parse(s);
    } catch (e) {
      // ç„¡è¦–
    }
  }

  if (!meta) {
    el.textContent = 'æœ€çµ‚ä¿å­˜ï¼šæœªä¿å­˜';
    return;
  }

  const when = meta.savedAtLocal || meta.savedAt || '';
  const who  = meta.savedBy || '';
  el.textContent = `æœ€çµ‚ä¿å­˜ï¼š${when}${who ? ' by ' + who : ''}`;
}

// localStorage ã®ä¸­èº«ã‚’å…¨éƒ¨ã¾ã¨ã‚ã¦å–å¾—ï¼ˆã“ã®HTMLã‚¢ãƒ—ãƒªå°‚ç”¨ã®ã‚ªãƒªã‚¸ãƒ³ãªã®ã§åŸºæœ¬å®‰å…¨ï¼‰
function collectStorageForExport() {
  const data = {};
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    // ã“ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ç”¨ã®å†…éƒ¨ã‚­ãƒ¼ã¯é™¤å¤–
    if (key === '__backup_last' || key === '__backup_beforeImport' || key === '__lastMeta' || key === '__pcName') continue;
    data[key] = localStorage.getItem(key);
  }
  return data;
}

// ç¾åœ¨ã®çŠ¶æ…‹ã‚’ JSON ã«ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã›ã‚‹
function exportScheduleToJson() {
  const now = new Date();
  const meta = {
    savedAt: now.toISOString(),
    savedAtLocal: now.toLocaleString(),
    savedBy: getPcName()
  };

  const storage = collectStorageForExport();
  const payload = { meta, storage };

  const json = JSON.stringify(payload, null, 2);

  // ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ã—ã¦ã‚‚ä¿æŒï¼ˆç·Šæ€¥ç”¨ï¼‰
  try {
    localStorage.setItem('__backup_last', json);
    localStorage.setItem('__lastMeta', JSON.stringify(meta));
  } catch (e) {
    console.warn('ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
  }

  // ç”»é¢ã®è¡¨ç¤ºæ›´æ–°
  updateSaveInfo(meta);

  // ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åã¯å›ºå®šï¼šschedule_data.jsonï¼‰
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'schedule_data.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ localStorage ã‚’å¾©å…ƒ
function importScheduleFromJson(file) {
  const reader = new FileReader();
  reader.onload = function (e) {
    try {
      const text = e.target.result;
      const obj = JSON.parse(text);
      if (!obj || typeof obj !== 'object' || !obj.storage) {
        throw new Error('ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã™ï¼ˆstorage ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼‰ã€‚');
      }

      // ã„ã¾ã®çŠ¶æ…‹ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ã—ã¦ä¿æŒã—ã¦ãŠãï¼ˆä¸‡ä¸€ã®å·»ãæˆ»ã—ç”¨ï¼‰
      try {
        const backup = {};
        for (let i = 0; i < localStorage.length; i++) {
          const k = localStorage.key(i);
          backup[k] = localStorage.getItem(k);
        }
        localStorage.setItem('__backup_beforeImport', JSON.stringify(backup));
      } catch (e2) {
        console.warn('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‰ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã«å¤±æ•—:', e2);
      }

      // ã„ã£ãŸã‚“ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰å¾©å…ƒ
      localStorage.clear();
      if (obj.storage && typeof obj.storage === 'object') {
        for (const [k, v] of Object.entries(obj.storage)) {
          localStorage.setItem(k, v);
        }
      }
      if (obj.meta) {
        localStorage.setItem('__lastMeta', JSON.stringify(obj.meta));
      }

      // ã‚¢ãƒ—ãƒªå…¨ä½“ã‚’å†æç”»ï¼ˆæ—¢å­˜ã® render() ã‚’ä¿¡é ¼ï¼‰
      if (typeof render === 'function') {
        render();
      }

      updateSaveInfo(obj.meta || null);
      window.alert('JSONã‹ã‚‰ã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
    } catch (err) {
      console.error(err);
      window.alert('JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼š' + err.message);
    }
  };
  reader.readAsText(file, 'utf-8');
}

// èª­è¾¼ï¼ä¿å­˜ãƒœã‚¿ãƒ³ã¨ input ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã¤ãªã
 document.addEventListener('DOMContentLoaded', () => {
   // === ãƒ˜ãƒ«ãƒ—ãƒœã‚¿ãƒ³ã®å·¦ã«ã€Œèª­è¾¼ã€ã€Œä¿å­˜ã€ã€Œæœ€çµ‚ä¿å­˜ï¼šâ€¦ã€ã‚’è‡ªå‹•æŒ¿å…¥ ===
   const helpBtn = document.getElementById('helpBtn');
   if (helpBtn && !document.getElementById('saveJsonBtn')) {
     const parent =
       helpBtn.parentElement ||
       helpBtn.closest('div,header,form') ||
       document.body;

   // ã‚°ãƒ«ãƒ¼ãƒ—ç”¨ã‚³ãƒ³ãƒ†ãƒŠ
   const group = document.createElement('span');
   group.id = 'jsonControls';
   group.className = 'json-controls';

     const loadBtn = document.createElement('button');
     loadBtn.id = 'loadJsonBtn';
     loadBtn.type = 'button';
     loadBtn.textContent = 'èª­è¾¼';

     const saveBtn = document.createElement('button');
     saveBtn.id = 'saveJsonBtn';
     saveBtn.type = 'button';
     saveBtn.textContent = 'ä¿å­˜';

     const infoSpan = document.createElement('span');
     infoSpan.id = 'saveInfo';
     infoSpan.className = 'save-info';
     infoSpan.textContent = 'æœ€çµ‚ä¿å­˜ï¼šæœªä¿å­˜';

   // ã‚°ãƒ«ãƒ¼ãƒ—ã®ä¸­ã«ã¾ã¨ã‚ã¦å…¥ã‚Œã¦ã‹ã‚‰ã€helpBtn ã®ç›´å‰ã«å·®ã—è¾¼ã‚€
   group.appendChild(loadBtn);
   group.appendChild(saveBtn);
   group.appendChild(infoSpan);
   parent.insertBefore(group, helpBtn);
   }

   // éè¡¨ç¤ºã® <input type="file"> ã‚’å¿…è¦ãªã‚‰ä½œæˆ
   let fileInput = document.getElementById('jsonFileInput');
   if (!fileInput) {
     fileInput = document.createElement('input');
     fileInput.id = 'jsonFileInput';
     fileInput.type = 'file';
     fileInput.accept = 'application/json';
     fileInput.style.display = 'none';
     document.body.appendChild(fileInput);
   }

   // åˆæœŸè¡¨ç¤ºæ™‚ã«ä¿å­˜æƒ…å ±ã‚’æ›´æ–°
   updateSaveInfo();

   const saveBtn = document.getElementById('saveJsonBtn');
   const loadBtn = document.getElementById('loadJsonBtn');

   if (saveBtn) {
     saveBtn.addEventListener('click', () => {
       exportScheduleToJson();
     });
   }

   if (loadBtn && fileInput) {
     loadBtn.addEventListener('click', () => {
       fileInput.click();
     });

     fileInput.addEventListener('change', (e) => {
       const file = e.target.files[0];
       if (file) {
         importScheduleFromJson(file);
       }
       // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¶šã‘ã¦é¸ã¹ã‚‹ã‚ˆã†ã« value ã‚’ãƒªã‚»ãƒƒãƒˆ
       e.target.value = '';
     });
   }
 });

</script>

  <button id="helpBtn" aria-haspopup="dialog" aria-controls="helpDialog">â”</button>
 
  <script>
  (function(){
    const btn = document.getElementById('helpBtn');
    if(!btn) return;
    // å€™è£œã¨ãªã‚‹ãƒ„ãƒ¼ãƒ«ãƒãƒ¼è¦ç´ ï¼ˆå­˜åœ¨ã™ã‚‹ã‚‚ã®ã«æŒ¿å…¥ï¼‰
    const selectors = [
      '#topbar','.topbar','#toolbar','.toolbar',
      '.header-actions','#header .actions',
      '#controls','.controls','#rightButtons'
    ];
    const host = selectors.map(s=>document.querySelector(s)).find(el=>el);
    if(host){
      btn.classList.add('docked');
      host.appendChild(btn);
    }
  })();
  </script>
  <dialog id="helpDialog">
    <div style="min-width:420px;max-width:640px;padding:20px;">
      <h2>æ“ä½œãƒ˜ãƒ«ãƒ—</h2>
      <table class="help-table">
        <tr><th><kbd>â†‘</kbd> / <kbd>â†“</kbd> / <kbd>â†</kbd> / <kbd>â†’</kbd></th><td>ã‚¹ãƒ­ãƒƒãƒˆã‚’ä¸Šä¸‹å·¦å³ã«ç§»å‹•</td></tr>r>
        <tr><th><kbd>Enter</kbd></th><td>ç·¨é›†é–‹å§‹ï¼ˆç·¨é›†ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ãï¼‰</td></tr>
        <tr><th><kbd>ESC</kbd></th><td>ç·¨é›†çµ‚äº†ï¼é€±è¡¨ç¤ºã«æˆ»ã‚‹</td></tr>
        <tr><th>æ—¥ä»˜ã‚»ãƒ«ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯</th><td>ãã®æ—¥ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è¡¨ç¤ºã¸åˆ‡æ›¿</td></tr>
        <tr><th>æ™‚åˆ»ã‚»ãƒ«ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯</th><td>é–‹å§‹æ™‚åˆ»ã‚’ç·¨é›†ï¼ˆä¾‹ï¼š<code>1100</code> â†’ <code>11:00</code>ï¼‰</td></tr>
        <tr><th><kbd>Shift</kbd>ï¼‹ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯<br><small>ï¼ˆæ™‚åˆ»ã‚»ãƒ«ï¼‰</small></th><td>ãã®æ—¥ã®å…¨ã‚¹ãƒ­ãƒƒãƒˆã®ã€Œæ™‚åˆ»ã€ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ä¸€æ‹¬ãƒªã‚»ãƒƒãƒˆ</td></tr>
        <tr><th><kbd>Alt</kbd>ï¼‹ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯<br><small>ï¼ˆæ™‚åˆ»ã‚»ãƒ«ï¼‰</small></th><td>ãã®ã‚¹ãƒ­ãƒƒãƒˆã®ã¿ã€Œæ™‚åˆ»ã€ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãƒªã‚»ãƒƒãƒˆ</td></tr>
        <tr><th><kbd>Ctrl</kbd>ï¼‹<kbd>C</kbd> / <kbd>V</kbd> / <kbd>X</kbd></th><td>ã‚³ãƒ”ãƒ¼ï¼è²¼ã‚Šä»˜ã‘ï¼åˆ‡ã‚Šå–ã‚Š</td></tr>
        <tr><th><kbd>Ctrl</kbd>ï¼‹<kbd>Z</kbd> / <kbd>Y</kbd></th><td>å…ƒã«æˆ»ã™ï¼ã‚„ã‚Šç›´ã—</td></tr>
		<tr><th><kbd>Ctrl</kbd>ï¼‹<kbd>.</kbd> ï¼ <kbd>,</kbd></th><td><kbd>Ctrl</kbd>ï¼‹<kbd>.</kbd>ï¼šæœ¬æ—¥ã¸ç§»å‹•ã€€ï¼ã€€<kbd>Ctrl</kbd>ï¼‹<kbd>,</kbd>ï¼šä»Šé€±ã¸ç§»å‹•</td></tr>
		<tr><th><kbd>Ctrl</kbd>ï¼‹<kbd>â†</kbd> ï¼ <kbd>â†’</kbd></th><td>é€±è¡¨ç¤ºï¼šå‰é€±ï¼ç¿Œé€±ã€€ï½œã€€ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è¡¨ç¤ºï¼šå‰æ—¥ï¼ç¿Œæ—¥</td></tr>
		<tr><th><kbd>Ctrl</kbd>ï¼‹<kbd>ï¿¥</kbd>or<kbd>ï¼¼</kbd></th><td>é¸æŠä¸­ã®ã‚¹ãƒ­ãƒƒãƒˆã‚’ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è¡¨ç¤ºã€€ï½œã€€é€±è¡¨ç¤ºã«æˆ»ã‚‹</td></tr>
		<tr><th><kbd>Ctrl</kbd>ï¼‹<kbd>2</kbd> / <kbd>4</kbd> / <kbd>5</kbd></th><td>ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆ‡æ›¿ï¼ˆ2åˆ—ï¼4åˆ—ï¼5åˆ—è¡¨ç¤ºï¼‰</td></tr>
      </table>
      <p style="margin-top:1rem;">ãã®ä»–ã®æ“ä½œã¯é †æ¬¡ã“ã“ã«è¿½è¨˜äºˆå®šã§ã™ã€‚</p>
      <button id="helpCloseBtn">é–‰ã˜ã‚‹</button>
    </div>
  </dialog>  
  <script>
  (function(){
    const btn = document.getElementById('helpBtn');
    const dlg = document.getElementById('helpDialog');
    const closeBtn = document.getElementById('helpCloseBtn');
    if(!btn || !dlg) return;
 
    // é–‹ã
    btn.addEventListener('click', ()=> {
      if (!dlg.open) dlg.showModal();
    });
 
    // é–‰ã˜ã‚‹ï¼ˆãƒœã‚¿ãƒ³ï¼‰
    closeBtn?.addEventListener('click', ()=> dlg.close());
 
    // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    dlg.addEventListener('click', (e)=>{
      if (e.target === dlg) dlg.close();
    });
  })();
  </script>
  <script>
  (function(){
    const dlg = document.getElementById('helpDialog');
    if(!dlg) return;
    // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°å†…ã®ESCã¯å¤–ã¸ä¼æ’­ã•ã›ãªã„ï¼ˆé€±è¡¨ç¤ºã¸ã®åˆ‡æ›¿ãªã©ã‚’é˜²æ­¢ï¼‰
    dlg.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape'){ e.stopPropagation(); }
    });
    // é–‹é–‰ã«ã‚ã‚ã›ã¦ãƒ•ãƒ©ã‚°ã‚’ä»˜ä¸ï¼ˆä»–ã®ESCåˆ¶å¾¡ãŒå‚ç…§ã§ãã‚‹ã‚ˆã†ã«ï¼‰
    dlg.addEventListener('close', ()=> { delete document.body.dataset.modalOpen; });
    dlg.addEventListener('cancel', (e)=>{ e.stopPropagation(); }); // å¿µã®ãŸã‚
    const openObs = new MutationObserver(()=>{
      if(dlg.open) document.body.dataset.modalOpen = '1';
    });
    openObs.observe(dlg, { attributes:true, attributeFilter:['open'] });
  })();
  </script>
<!-- Ctrl+Â¥ï¼ˆBackslashï¼‰: é€±è¡¨ç¤ºã§â€œã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ—¥ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹â€ã¸å…¥ã‚‹ -->
<script>
(()=> {
  if (window.__bindCtrlBackslashFocus) return; window.__bindCtrlBackslashFocus = true;

  const isEditable = t => { const tag=t?.tagName?.toLowerCase(); return tag==='input'||tag==='textarea'||t?.isContentEditable; };
  const isDialogOpen = () => {
    const ed=document.getElementById('editor'), st=document.getElementById('settings');
    return !!((ed&&(ed.open||ed.classList?.contains('is-open'))) || (st&&(st.open||st.classList?.contains('is-open'))));
  };

  document.addEventListener('keydown', (e)=>{
    if (!e.ctrlKey) return;
    const isBackslash = (e.code==='Backslash'||e.code==='IntlYen'||['\\','Â¥','ï¿¥'].includes(e.key));
    if (!isBackslash) return;
    if (isEditable(e.target) || isDialogOpen()) return;

  // ğŸ” ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ä¸­ã¯ã€Œé€±è¡¨ç¤ºã«æˆ»ã‚‹ã€
  if (document.body.classList.contains('dayFocus')) {
    e.preventDefault(); e.stopImmediatePropagation();

    // â˜… ã„ã¾ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ã¦ã„ã‚‹ã‚¹ãƒ­ãƒƒãƒˆã‚’æ§ãˆã¦ãŠã
    const cur =
      (typeof window.getActiveSlot === 'function' && window.getActiveSlot()) ||
      document.querySelector('.slot.focused');

    // å¾“æ¥ã©ãŠã‚Šã€Œå¾©å…ƒãƒ­ã‚¸ãƒƒã‚¯ã¯ exitDayFocus å†…ã§ã¯ã‚¹ã‚­ãƒƒãƒ—ã€
    window.__skipRestoreOnExit = true;
    if (typeof window.exitDayFocus === 'function') window.exitDayFocus();

    if (cur) {
      // â˜… é€±è¡¨ç¤ºã«æˆ»ã£ãŸâ€œã‚ã¨â€ã§å…ƒã®ã‚¹ãƒ­ãƒƒãƒˆã‚’å†ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–ï¼†ã‚»ãƒ³ã‚¿ãƒªãƒ³ã‚°
      requestAnimationFrame(() => {
        // suppress ãŒé‚ªé­”ã—ãªã„ã‚ˆã†ã«ã‚¯ãƒªã‚¢ã—ã¦ãŠãï¼ˆå¿µã®ãŸã‚ï¼‰
        window.__suppressCenterN = 0;

        if (typeof window.setActiveSlot === 'function') {
          // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯ã“ã“ã§ã¯ã•ã›ãšã€ã‚ã¨ã§ __centerActiveInWeekSoon ã«ä»»ã›ã‚‹
          window.setActiveSlot(cur, { scroll: false });
        } else {
          // ä¿é™ºï¼šsetActiveSlot ãŒç„¡ã„å ´åˆ
          document.querySelectorAll('.slot.focused')
            .forEach(el => el.classList.remove('focused'));
          cur.classList.add('focused');
        }

        // â˜… ã„ã¤ã‚‚ã®ã€Œã‚·ãƒ³ãƒ—ãƒ«ãƒ»ç¢ºå®Ÿã‚»ãƒ³ã‚¿ãƒªãƒ³ã‚°ã€ã§ä¸­å¤®ä»˜è¿‘ã¸
        window.__centerActiveInWeekSoon?.();
      });
    }
    return;
  }


    const slot = document.querySelector('.slot.focused');
    if (!slot) return; // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã—
    const dayEl = slot.closest('.day');
    if (!dayEl) return;

    e.preventDefault(); e.stopImmediatePropagation();
    if (typeof window.enterDayFocus === 'function') {
      window.enterDayFocus(dayEl);
    }
  }, {capture:true});
})();

// --- å°åˆ·æ™‚ï¼š4åˆ—/5åˆ—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ä¸€æ™‚è§£é™¤ã—ã¦2åˆ—ç›¸å½“ã§å°åˆ·ã™ã‚‹ ---
(function(){
  let prevColsClass = null;

  function beforePrintCols(){
    const body = document.body;
    if (!body) return;
    // ã™ã§ã«å‡¦ç†æ¸ˆã¿ãªã‚‰ä½•ã‚‚ã—ãªã„
    if (prevColsClass !== null) return;

    if (body.classList.contains('fiveCols')) {
      prevColsClass = 'fiveCols';
    } else if (body.classList.contains('fourCols')) {
      prevColsClass = 'fourCols';
    } else {
      // 2åˆ—è¡¨ç¤ºãªã©ã€ç‰¹ã«åˆ‡ã‚Šæ›¿ãˆä¸è¦ãªã¨ã
      prevColsClass = null;
      return;
    }
    // å°åˆ·ç”¨ã« 4/5åˆ—ã‚¯ãƒ©ã‚¹ã‚’ä¸€æ™‚çš„ã«å¤–ã™ â†’ 2åˆ—ç›¸å½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«æˆ»ã‚‹
    body.classList.remove('fourCols', 'fiveCols');
  }

  function afterPrintCols(){
    const body = document.body;
    if (!body) return;
    // å…ƒã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«æˆ»ã™
    if (prevColsClass) {
      body.classList.add(prevColsClass);
    }
    prevColsClass = null;
  }

  window.addEventListener('beforeprint', beforePrintCols);
  window.addEventListener('afterprint',  afterPrintCols);
})();
// --- å°åˆ·æ™‚ï¼šIDãƒ»å¹´é½¢ãªã©ã‚’å«ã‚ãŸã€Œãƒ•ãƒ«è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã€ã«ã—ã¦å†æç”» ---
(function(){
  function addPrintMode(){
    const body = document.body;
    if (!body) return;
    if (body.classList.contains('printMode')) return;

    body.classList.add('printMode');

    // â˜… å°åˆ·ç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆ2åˆ— & printModeï¼‰ã§å¹…ã‚’è¨ˆæ¸¬ã—ç›´ã—ã¦å†æç”»
    if (typeof paintSlotsFromStore === 'function'){
      paintSlotsFromStore();
    }
  }

  function removePrintMode(){
    const body = document.body;
    if (!body) return;
    if (!body.classList.contains('printMode')) return;

    body.classList.remove('printMode');

    // â˜… é€šå¸¸è¡¨ç¤ºç”¨ã«æˆ»ã—ãŸçŠ¶æ…‹ã§ã‚‚ã†ä¸€åº¦å†æç”»
    if (typeof paintSlotsFromStore === 'function'){
      paintSlotsFromStore();
    }
  }

  window.addEventListener('beforeprint', addPrintMode);
  window.addEventListener('afterprint',  removePrintMode);
})();

// ===== ãƒ•ã‚§ãƒ¼ã‚º2ï¼šå…¨ãƒ‡ãƒ¼ã‚¿æ¨ªæ–­æ¤œç´¢ï¼ˆStep1ï¼šè¡¨ç¤ºã®ã¿ï¼‰ =====
const globalSearchBtn   = document.getElementById('globalSearchBtn');
const globalSearchDlg   = document.getElementById('globalSearchDialog');
const globalSearchInput = document.getElementById('globalSearchInput');
const globalSearchExec  = document.getElementById('globalSearchExec');
const globalSearchRes   = document.getElementById('globalSearchResult');

globalSearchBtn.addEventListener('click', ()=>{
  globalSearchInput.value = '';
  globalSearchRes.innerHTML = '';
  globalSearchDlg.showModal();
  globalSearchInput.focus();
});

function searchAllWeeks(keyword){
  const hits = [];
  if(!keyword) return hits;
  const kw = keyword.trim();

  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(!k)  continue;
    const raw = localStorage.getItem(k);
    if(!raw) continue;
    // JSONã£ã½ããªã„ã‚‚ã®ã¯é™¤å¤–ï¼ˆ__pcNameç­‰ï¼‰
    if(raw[0] !== '{' && raw[0] !== '[') continue;
    let store = null;
    try{
      store = JSON.parse(raw);
    }catch(_e){
      continue; // å£Šã‚ŒãŸ/éJSONã¯ç„¡è¦–
    }
    if(!store || typeof store !== 'object') continue;
	
    for(const key in store){
      const d = store[key];
      if(!d || d.tail) continue;
     const name = d.name || '';
     const pid  = d.pid  || '';
     const nName = normalizeJa(name);
     const nPid  = normalizeJa(pid);
     const nKw   = normalizeJa(kw);
     if(nName.includes(nKw) || nPid.includes(nKw)){
        hits.push({
          weekKey: k,
          key,
          name,
          pid,
          time: d.time || ''
        });
      }
    }
  }
  return hits;
}

function renderSearchResult(list){
  if(!list.length){
    globalSearchRes.innerHTML = '<div style="opacity:.6">è©²å½“ãªã—</div>';
    return;
  }
  const __JP_DOW = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  const __fmtDateDow = (iso)=>{
    if(!iso) return '';
    const dt = new Date(iso);
    if(!Number.isFinite(dt.getTime())) return iso;
    return `${iso}ï¼ˆ${__JP_DOW[dt.getDay()]}ï¼‰`;
  };  
  globalSearchRes.innerHTML = list.map(r=>`
    ${(()=>{
      const p = (typeof parseKey==='function') ? parseKey(r.key) : null;
      const dateISO = (p && p.d) ? p.d : '';
      const dateLabel = __fmtDateDow(dateISO);
      const timeLabel = (r.time || '').trim();
      return `  
    <div class="search-row"
         data-week="${r.weekKey}"
         data-slot="${r.key}"
         style="padding:6px 4px;border-bottom:1px solid #eee;cursor:pointer">
      <span style="opacity:.75">${dateLabel || ''}</span>
      <span style="opacity:.65;margin-left:6px">${timeLabel || ''}</span>
      <strong style="margin-left:8px">${r.name || '(æ°åãªã—)'}</strong>
      <span style="opacity:.7;margin-left:6px">${r.pid || ''}</span>
    </div>
      `;
    })()}
  `).join('');
}

globalSearchExec.addEventListener('click', ()=>{
  const list = searchAllWeeks(globalSearchInput.value);
  renderSearchResult(list);
});

globalSearchInput.addEventListener('keydown',(e)=>{
  if(e.key === 'Enter'){
    e.preventDefault();
    globalSearchExec.click();
  }
});

// æ¤œç´¢çµæœã‚¯ãƒªãƒƒã‚¯ â†’ é€±ã‚¸ãƒ£ãƒ³ãƒ—ï¼‹slotã¸ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ï¼ˆé’æ ã‚‚å¯¾è±¡ã«ï¼‰
globalSearchRes.addEventListener('click', (e)=>{
  const row = e.target.closest('.search-row');
  if(!row) return;

  const weekKey = row.dataset.week;   // â˜… ã“ã‚ŒãŒæŠœã‘ã¦ã„ã‚‹ã¨ä½•ã‚‚ã§ããªã„
  const slotKey = row.dataset.slot;   // data-key ã¨åŒã˜
  if(!weekKey || !slotKey) return;

  // â˜… é€±ç§»å‹•ç›´å¾Œã®ã€Œå…ˆé ­ã‚’é¸ã¶ï¼ä¸Šå¯„ã›ã€äºˆç´„ãŒæ®‹ã£ã¦ã„ã‚‹ã¨ã€æ¤œç´¢å…ˆãŒä¸Šæ›¸ãã•ã‚Œã‚‹ã®ã§å¿…ãšè§£é™¤
  window.__snapTopOnNextRender = false;
  window.__snapTopTargetISO    = null;
  window.__selectFirstOnNextRender = false;

  // â˜… å¾©å…ƒé¸æŠã®ä»•çµ„ã¿ã«ã€Œã“ã®ã‚­ãƒ¼ã‚’é¸ã¹ã€ã¨å…ˆã«æŒ‡ç¤ºã—ã¦ãŠã
  window.lastSelectedKey = slotKey;

  // slotKey ã‹ã‚‰æ—¥ä»˜ã‚’å–å¾— â†’ ãã®é€±ã®æœˆæ›œã¸ã‚¸ãƒ£ãƒ³ãƒ—
  const p = parseKey(slotKey); // { d, day, section, idx }
  if(!p || !p.d) return;

  const d = new Date(p.d);
  const monday = new Date(d);
  monday.setDate(d.getDate() - ((d.getDay() + 6) % 7));
  const isoMon = monday.toISOString().slice(0,10);

  // é€±ç§»å‹•
  weekPicker.value = isoMon;
  weekPicker.dispatchEvent(new Event('change', { bubbles:true }));

  // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
  globalSearchDlg.close();

  // â˜… DOMç¢ºå®šå¾Œã«ã€Œæœ€å¾Œã®ä¸€æŠ¼ã—ã€ã§å¿…ãšæ¤œç´¢ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼†é’æ 
  requestAnimationFrame(()=>{
    requestAnimationFrame(()=>{
      const el = document.querySelector(`.slot[data-key="${slotKey}"]`);
      if(!el) return;

      // æ—¢å­˜ã®é’æ ã‚’æ•´ç†ã—ã¦ã‹ã‚‰ã€å¯¾è±¡ã‚’æ­£å¼é¸æŠ
      document.querySelectorAll('.slot.focused').forEach(x=>x.classList.remove('focused'));
      window.setActiveSlot?.(el, { scroll:false });

      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯æ˜ç¤ºçš„ã«æ¤œç´¢ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¸
      try{
        el.scrollIntoView({ block:'center', inline:'nearest', behavior:'auto' });
      }catch(_){
        try{ el.scrollIntoView(); }catch(_2){}
      }
    });
  });
});

// ===== æ¤œç´¢ç”¨ æ­£è¦åŒ–ï¼šåŠè§’/å…¨è§’ã‚«ãƒŠï¼‹ã²ã‚‰ãŒãª/ã‚«ã‚¿ã‚«ãƒŠã‚’å¸å =====
function normalizeJa(str){
  if(!str) return '';
  // 1) Unicodeæ­£è¦åŒ–ï¼ˆåŠè§’â†’å…¨è§’ãªã©ï¼‰
  let s = str.normalize('NFKC');
  // 2) ã²ã‚‰ãŒãªâ†’ã‚«ã‚¿ã‚«ãƒŠ
  s = s.replace(/[\u3041-\u3096]/g, ch =>
    String.fromCharCode(ch.charCodeAt(0) + 0x60)
  );
  // 3) å‰å¾Œç©ºç™½é™¤å»ï¼ˆå¿µã®ãŸã‚ï¼‰
  return s.trim();
}

document.addEventListener('DOMContentLoaded', ()=>{
// ===== ãƒ•ã‚§ãƒ¼ã‚º2ï¼šâœ“ï¼â— æœªå®Œäº†ãƒªã‚¹ãƒˆï¼ˆåˆ¥è¡¨ç¤ºï¼‰ =====
const todoListBtn   = document.getElementById('todoListBtn');
const todoListDlg   = document.getElementById('todoListDialog');
const todoListExec  = document.getElementById('todoListExec');
const todoArrivalEl = document.getElementById('todoArrivalList');
const todoIolEl     = document.getElementById('todoIolList');
const todoPathEl    = document.getElementById('todoPathList');

// è¿½åŠ ï¼šIOLå¯¾è±¡ã‹ã©ã†ã‹ï¼ˆIOLæ¬„ãŒ1ã¤ã§ã‚‚åŸ‹ã¾ã£ã¦ã„ã‚‹ï¼‰
function needsIOL(d){
  const hasIol = !!(
    (d.iolType || d.iolPower || d.iolUse1) ||
    (d.iolType2 || d.iolPower2 || d.iolUse2) ||
    (d.iolType3 || d.iolPower3 || d.iolUse3)
  );
  const hasDev = !!String(d.proc2 || '').trim();   // â˜… ãƒ‡ãƒã‚¤ã‚¹ï¼ˆproc2ï¼‰
  return hasIol || hasDev;  
}

function slotKeyExistsInCurrentConfig(slotKey){
  const p = parseKey(slotKey); // { d, day, section, idx }
  if(!p) return false;

  const dayCfg = CONFIG[p.day];
  if(!dayCfg) return false;

  const sec = dayCfg[p.section];
  if(!sec) return false;

  return p.idx >= 0 && p.idx < sec.slots;
}

todoListBtn.addEventListener('click', ()=>{
  todoArrivalEl.innerHTML = '';
  todoIolEl.innerHTML = '';
  todoPathEl.innerHTML = '';
  todoListDlg.showModal();
  todoListExec.click(); // é–‹ã„ãŸã‚‰è‡ªå‹•æ›´æ–°
});

function scanAllWeeksTodos(){
  const arrivalsMap = new Map(); // key: rlSetId or slotKey
  const iols = [];
  const pathsMap = new Map();    // key: rlSetId or slotKey
  for(let i=0;i<localStorage.length;i++){
    const weekKey = localStorage.key(i);
    if(!weekKey) continue;
    const raw = localStorage.getItem(weekKey);
    if(!raw) continue;
    if(raw[0] !== '{' && raw[0] !== '[') continue;
    let store = null;
    try{ store = JSON.parse(raw); }catch(_e){ continue; }
    if(!store || typeof store !== 'object') continue;

    for(const slotKey in store){
      const d = store[slotKey];
      if(!d || d.tail) continue;               // headã®ã¿
    if(!(d.name || d.pid)) continue;

    // â˜… æ—§æ§‹æˆ/æ®‹éª¸ã‚­ãƒ¼ã‚’é™¤å¤–ï¼ˆè¡¨ç¤ºã•ã‚Œãªã„æ â†’å…ˆé ­ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å•é¡Œã‚’é˜²ãï¼‰
    if(!slotKeyExistsInCurrentConfig(slotKey)) continue;

      const p = parseKey(slotKey);
      if(!p || !p.d) continue;
	  
	  if(!slotKeyExistsInCurrentConfig(slotKey)) continue;

      const dateISO = p.d;                     // YYYY-MM-DD
      const timeStr = d.time || '';            // è¡¨ç¤ºç”¨ï¼ˆç„¡ã‘ã‚Œã°ç©ºï¼‰

      const row = {
        weekKey,
        slotKey,
        dateISO,
        timeStr,
        name: d.name || '(æ°åãªã—)',
        pid: d.pid || ''
      };
	  
      const rlId = d?.meta?.rlSetId;
      const groupKey = rlId ? `RL:${rlId}` : `SLOT:${slotKey}`;	  

      // A) âœ“æœªï¼šå¤–ã ã‘
      if(d.io === 'å¤–' && d.arrivalFixed !== true){
        if(!arrivalsMap.has(groupKey)) arrivalsMap.set(groupKey, row);
      }
      // B) â—æœªï¼šIOLå¯¾è±¡ã ã‘ï¼ˆç™½å†…éšœãªã©ï¼‰
      const hasIol = !!(
        (d.iolType || d.iolPower || d.iolUse1) ||
        (d.iolType2 || d.iolPower2 || d.iolUse2) ||
        (d.iolType3 || d.iolPower3 || d.iolUse3)
      );
      const hasDev = !!String(d.proc2 || '').trim();
      const iolNG = hasIol && d.iolOrdered1 !== true;      // ä»£è¡¨ã¯å¾“æ¥é€šã‚Šâ‘ 
      const devNG = hasDev && d.deviceOrdered !== true;

if(needsIOL(d) && (iolNG || devNG)){
  const reasons = [];
  if (iolNG) reasons.push('IOL');
  if (devNG) reasons.push('DEV');

  iols.push({
    ...row,
    reason: reasons.join(',')
  });
}

      // C) ãƒ‘ã‚¹æœªï¼šå…¥ï¼å½“ã ã‘
      if((d.io === 'å…¥' || d.io === 'å½“') && d.pathDone !== true){
        if(!pathsMap.has(groupKey)) pathsMap.set(groupKey, row);
      }	  
    }
  }

  // æ‰‹è¡“æ—¥ãŒè¿‘ã„é †ï¼ˆåŒæ—¥ãªã‚‰æ™‚åˆ»æ–‡å­—åˆ—ã§è»½ãæ•´åˆ—ï¼‰
  const cmp = (a,b)=> (a.dateISO.localeCompare(b.dateISO) || a.timeStr.localeCompare(b.timeStr) || a.name.localeCompare(b.name));
  const arrivals = [...arrivalsMap.values()];
  const paths = [...pathsMap.values()];

  arrivals.sort(cmp);
  iols.sort(cmp);
  paths.sort(cmp);

  return { arrivals, iols, paths };
}

function renderTodoList(container, list){
  if(!list.length){
    container.innerHTML = '<div style="padding:8px;opacity:.6">è©²å½“ãªã—</div>';
    return;
  }
  const __JP_DOW2 = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  const __fmtDateDow2 = (iso)=>{
    if(!iso) return '';
    const dt = new Date(iso);
    if(!Number.isFinite(dt.getTime())) return iso;
    return `${iso}ï¼ˆ${__JP_DOW2[dt.getDay()]}ï¼‰`;
  };  
  container.innerHTML = list.map(r=>`
    <div class="todo-row"
         data-week="${r.weekKey}"
         data-slot="${r.slotKey}"
         style="padding:6px 8px;border-bottom:1px solid #eee;cursor:pointer">
      <span style="opacity:.75">${__fmtDateDow2(r.dateISO)}</span>
      <span style="opacity:.65;margin-left:6px">${r.timeStr || ''}</span>
      <strong style="margin-left:8px">${r.name}</strong>
      <span style="opacity:.7;margin-left:6px">${r.pid}</span>
	  ${r.reason ? `<span style="margin-left:6px;font-size:11px;opacity:.6">(${r.reason})</span>` : ''}
    </div>
  `).join('');
}

todoListExec.addEventListener('click', ()=>{
  const {arrivals, iols, paths} = scanAllWeeksTodos();
  renderTodoList(todoArrivalEl, arrivals);
  renderTodoList(todoIolEl, iols);
  renderTodoList(todoPathEl, paths);
});

function jumpToSlotByKey(slotKey){
  // æ¤œç´¢ã¨åŒã˜å®‰å…¨ç­–ï¼šå…ˆé ­æ ãƒ•ã‚©ãƒ¼ã‚«ã‚¹äºˆç´„ã‚’è§£é™¤
  window.__snapTopOnNextRender = false;
  window.__snapTopTargetISO    = null;
  window.__selectFirstOnNextRender = false;
  window.lastSelectedKey = slotKey;

  const p = parseKey(slotKey);
  if(!p || !p.d) return;

  const d = new Date(p.d);
  const monday = new Date(d);
  monday.setDate(d.getDate() - ((d.getDay() + 6) % 7));
  const isoMon = monday.toISOString().slice(0,10);

  weekPicker.value = isoMon;
  weekPicker.dispatchEvent(new Event('change', { bubbles:true }));

  requestAnimationFrame(()=>{
    requestAnimationFrame(()=>{
      const el = document.querySelector(`.slot[data-key="${slotKey}"]`);
      if(!el) return;
      document.querySelectorAll('.slot.focused').forEach(x=>x.classList.remove('focused'));
      window.setActiveSlot?.(el, { scroll:false });
      try{ el.scrollIntoView({ block:'center', inline:'nearest', behavior:'auto' }); }
      catch(_){ try{ el.scrollIntoView(); }catch(_2){} }
    });
  });
}

// ã‚¯ãƒªãƒƒã‚¯ã§ã‚¸ãƒ£ãƒ³ãƒ—ï¼ˆA/B å…±é€šï¼‰
todoArrivalEl.addEventListener('click', (e)=>{
  const row = e.target.closest('.todo-row');
  if(!row) return;
  const slotKey = row.dataset.slot;
  if(!slotKey) return;
  todoListDlg.close();
  jumpToSlotByKey(slotKey);
});
todoIolEl.addEventListener('click', (e)=>{
  const row = e.target.closest('.todo-row');
  if(!row) return;
  const slotKey = row.dataset.slot;
  if(!slotKey) return;
  todoListDlg.close();
  jumpToSlotByKey(slotKey);
});
todoPathEl.addEventListener('click', (e)=>{
  const row = e.target.closest('.todo-row');
  if(!row) return;
  const slotKey = row.dataset.slot;
  if(!slotKey) return;
  todoListDlg.close();
  jumpToSlotByKey(slotKey);
});
});

 function fmtDateDowTime(weekKey, slotKey){
   // slotKey: YYYY-MM-DD|Day|section|idx
   const p = parseKey(slotKey);
   if(!p) return '';
   const d = new Date(p.d);
   const dow = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][d.getDay()];
   const sec = CONFIG[p.day]?.[p.section];
   if(!sec) return `${p.d}(${dow})`;
   const [hh, mm] = sec.start.split(':').map(Number);
   const t = new Date(d);
   t.setHours(hh, mm + (p.idx||0)*20, 0, 0); // 20åˆ†æ å‰æï¼ˆæ—¢å­˜ä»•æ§˜ï¼‰
   const time = `${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}`;
   return `${p.d}(${dow}) ${time}`;
 }

</script>  
    <dialog id="todoListDialog">
      <form method="dialog" style="min-width:560px;max-width:760px;padding:16px">
        <h3 style="margin:0 0 8px;">
          âœ“ <span class="todo-dot iol"></span><span class="todo-dot path"></span> æœªå®Œäº†ãƒªã‚¹ãƒˆ
        </h3>

        <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
          <button id="todoListExec" type="button" class="primary">æ›´æ–°</button>
          <div style="opacity:.7;font-size:12px">ï¼ˆé–²è¦§å°‚ç”¨ï¼šã‚¯ãƒªãƒƒã‚¯ã§é€±ã¸ã‚¸ãƒ£ãƒ³ãƒ—ï¼‰</div>
        </div>
    
        <div style="margin:10px 0 6px;font-weight:700;">A) æ¥é™¢æ™‚åˆ» æœªé€£çµ¡ âœ“</div>
        <div id="todoArrivalList" style="max-height:26vh;overflow:auto;font-size:13px;border:1px solid #eee;"></div>
    
        <div style="margin:14px 0 6px;font-weight:700;">
          B) IOL / DEV æœªç¢ºèª <span class="todo-dot iol"></span>
        </div>
        <div id="todoIolList" style="max-height:26vh;overflow:auto;font-size:13px;border:1px solid #eee;"></div>
   
        <div style="margin:14px 0 6px;font-weight:700;">
          C) ãƒ‘ã‚¹ æœªå…¥åŠ› <span class="todo-dot path"></span>
        </div>
       <div id="todoPathList" style="max-height:26vh;overflow:auto;font-size:13px;border:1px solid #eee;"></div>
    
        <menu style="display:flex;justify-content:flex-end;margin-top:10px">
          <button value="cancel">é–‰ã˜ã‚‹</button>
        </menu>
      </form>
    </dialog> 
 </body>
</html>
